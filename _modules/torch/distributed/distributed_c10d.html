<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.distributed.distributed_c10d — PyTorch main documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://pytorch.org/docs/stable/_modules/torch/distributed/distributed_c10d.html">
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css">
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/katex-math.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/css/jit.css" type="text/css">
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css">
    <link rel="index" title="Index" href="../../../genindex.html">
    <link rel="search" title="Search" href="../../../search.html">

<!--
  Search engines should not index the main version of documentation.
  Stable documentation are built without release == 'main'.
-->
<meta name="robots" content="noindex">


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head><body class="pytorch-body"><div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">学习</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/get-started">
                  <span class="dropdown-title">开始使用</span>
                  <p>在本地运行 PyTorch 或快速开始使用支持的云平台之一</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials">
                  <span class="dropdown-title">教程</span><p></p>
                  <p>PyTorch 教程中有什么新内容</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">学习基础知识</span><p></p>
                  <p>熟悉 PyTorch 的概念和模块</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch 烹饪技巧</span><p></p>
                  <p>精简型、可直接部署的 PyTorch 代码示例</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">PyTorch 入门 - YouTube 系列</span><p></p>
                  <p>通过我们引人入胜的 YouTube 教程系列掌握 PyTorch 基础知识</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">生态系统</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
                  <span class="dropdown-title">工具</span><p></p>
                  <p>了解 PyTorch 生态系统中的工具和框架</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">社区</span>
                  <p>加入 PyTorch 开发者社区，贡献、学习并获得问题解答</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">论坛</span>
                  <p>讨论 PyTorch 代码、问题、安装、研究的地方</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">开发者资源</span>
                  <p>查找资源并解答问题</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem/contributor-awards-2024">
                  <span class="dropdown-title">贡献者奖项 - 2024</span><p></p>
                  <p>本届 PyTorch 会议揭晓获奖者</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/edge">
                  <span class="dropdown-title">关于 PyTorch Edge</span><p></p>
                  <p>为边缘设备构建创新和隐私感知的 AI 体验</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span><p></p>
                  <p>针对移动和边缘设备实现设备端推理能力的端到端解决方案</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/executorch/stable/index.html">
                  <span class="dropdown-title">ExecuTorch 文档</span><p></p>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">文档</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span><p></p>
                  <p>探索文档以获取如何使用 PyTorch 的全面指南</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/pytorch-domains">
                  <span class="dropdown-title">PyTorch 领域</span><p></p>
                  <p>阅读 PyTorch 领域的文档以了解更多关于特定领域的库</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">博客与新闻</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
                  <span class="dropdown-title">PyTorch 博客</span><p></p>
                  <p>跟上最新的技术新闻和动态</p>
                </a>
                 <a class="nav-dropdown-item" href="https://pytorch.org/community-blog">
                  <span class="dropdown-title">社区博客</span><p></p>
                  <p>PyTorch 生态系统故事</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/videos">
                  <span class="dropdown-title">视频</span><p></p>
                  <p>了解最新的 PyTorch 教程、新内容等</p>
                </a><a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">社区故事</span><p></p>
                  <p>了解我们的社区如何使用 PyTorch 解决真实、日常的机器学习问题</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">活动</span><p></p>
                  <p>查找活动、网络研讨会和播客</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/newsletter">
                  <span class="dropdown-title">通讯</span><p></p>
                  <p>保持最新更新</p>
                </a>
            </div>
          </div></li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">关于</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch 基金会</span><p></p>
                  <p>了解更多关于 PyTorch 基金会的信息</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
                  <span class="dropdown-title">管理委员会</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/credits">
                  <span class="dropdown-title">云信用计划</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/tac">
                  <span class="dropdown-title">技术顾问委员会</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/staff">
                  <span class="dropdown-title">员工</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/contact-us">
                  <span class="dropdown-title">联系我们</span><p></p>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://pytorch.org/join" data-cta="join">成为会员</a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>



   

    

    <div class="table-of-contents-link-wrapper">
      <span>目录</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href="https://pytorch.org/docs/versions.html">主页 (2.7.0+cpu ) ▼</a>
    </div>
    <div id="searchBox">
    <div class="searchbox" id="googleSearchBox">
      <script async="" src="https://cse.google.com/cse.js?cx=e65585f8c3ea1440e"></script>
      <div class="gcse-search"></div>
    </div>
    <div id="sphinxSearchBox" style="display: none;">
      <div role="search">
        <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
          <input type="text" name="q" placeholder="Search Docs">
          <input type="hidden" name="check_keywords" value="yes">
          <input type="hidden" name="area" value="default">
        </form>
      </div>
    </div>
  </div>
  <form id="searchForm">
    <label style="margin-bottom: 1rem">
      <input type="radio" name="searchType" value="google" checked="">Google 搜索</label>
    <label style="margin-bottom: 1rem">
      <input type="radio" name="searchType" value="sphinx">经典搜索</label>
  </form>

  <script>
     document.addEventListener('DOMContentLoaded', function() {
      const searchForm = document.getElementById('searchForm');
      const googleSearchBox = document.getElementById('googleSearchBox');
      const sphinxSearchBox = document.getElementById('sphinxSearchBox');
      // Function to toggle search box visibility
      function toggleSearchBox(searchType) {
        googleSearchBox.style.display = searchType === 'google' ? 'block' : 'none';
        sphinxSearchBox.style.display = searchType === 'sphinx' ? 'block' : 'none';
      }
      // Determine the default search type
      let defaultSearchType;
      const currentUrl = window.location.href;
      if (currentUrl.startsWith('https://pytorch.org/docs/stable')) {
        // For the stable documentation, default to Google
        defaultSearchType = localStorage.getItem('searchType') || 'google';
      } else {
        // For any other version, including docs-preview, default to Sphinx
        defaultSearchType = 'sphinx';
      }
      // Set the default search type
      document.querySelector(`input[name="searchType"][value="${defaultSearchType}"]`).checked = true;
      toggleSearchBox(defaultSearchType);
      // Event listener for changes in search type
      searchForm.addEventListener('change', function(event) {
        const selectedSearchType = event.target.value;
        localStorage.setItem('searchType', selectedSearchType);
        toggleSearchBox(selectedSearchType);
      });
      // Set placeholder text for Google search box
      window.onload = function() {
        var placeholderText = "Search Docs";
        var googleSearchboxText = document.querySelector("#gsc-i-id1");
        if (googleSearchboxText) {
          googleSearchboxText.placeholder = placeholderText;
          googleSearchboxText.style.fontFamily = 'FreightSans';
          googleSearchboxText.style.fontSize = "1.2rem";
          googleSearchboxText.style.color = '#262626';
        }
      };
    });
  </script>

          </div>

          

<div>
  <a style="color:#F05732" href="https://pytorch.org/docs/stable/_modules/torch/distributed/distributed_c10d.html">您正在查看不稳定开发者预览文档。请点击此处查看最新稳定版本的文档。</a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">社区</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/build_ci_governance.html">PyTorch 治理 | 构建 + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/contribution_guide.html">PyTorch 贡献指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/design.html">PyTorch 设计哲学</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance.html">PyTorch 治理 | 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/persons_of_interest.html">PyTorch 治理 | 维护者</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发者笔记</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/amp_examples.html">自动混合精度示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/autograd.html">Autograd 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/broadcasting.html">广播语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">CPU 多线程和 TorchScript 推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/cuda.html">CUDA 语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/custom_operators.html">PyTorch 自定义算子页面</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/ddp.html">分布式数据并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.html">扩展 PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/extending.func.html">扩展 torch.func 与 autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/fsdp.html">FSDP 笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/get_start_xpu.html">在 Intel GPU 上入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/gradcheck.html">毕业审核机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/hip.html">HIP (ROCm) 语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/large_scale_deployments.html">大规模部署功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/libtorch_stable_abi.html">LibTorch 稳定 ABI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/modules.html">模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/mps.html">MPS 后端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/multiprocessing.html">多进程最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/numerical_accuracy.html">数值精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/randomness.html">可重复性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/serialization.html">序列化语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notes/windows.html">Windows 常见问题解答</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">语言绑定</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_attributes.html">Tensor 属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensor_view.html">张量视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../accelerator.html">torch 加速器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu.html">torch.cpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch_cuda_memory.html">理解 CUDA 内存使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch_cuda_memory.html#generating-a-snapshot">生成快照</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch_cuda_memory.html#using-the-visualizer">使用可视化器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch_cuda_memory.html#snapshot-api-reference">快照 API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xpu.html">torch.xpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mtia.html">torch.mtia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mtia.memory.html">torch.mtia.memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../meta.html">元设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../export.html">torch.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.html">torch.distributed.tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.fsdp.fully_shard.html">torch.distributed.fsdp.fully_shard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.pipelining.html">torch.distributed.pipelining</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fx.experimental.html">torch.fx.experimental</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nn.attention.html">torch.nn.attention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../complex_numbers.html">复数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ddp_comm_hooks.html">DDP 通信钩子</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quantization.html">量化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rpc.html">分布式 RPC 框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../size.html">torch.Size</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../storage.html">torch 存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../utils.html">torch.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deterministic.html">torch.utils.deterministic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../module_tracker.html">torch.utils.module_tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../type_info.html">类型信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../named_tensor.html">命名张量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../name_inference.html">命名张量操作覆盖率</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../future_mod.html">torch.__future__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../logging.html">torch._logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../torch_environment_variables.html">Torch 环境变量</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">库</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/torchrec">火炬推荐</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/xla/">PyTorch 在 XLA 设备上</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pytorch.org/ao">torchao</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        文档 &gt;</li>

        
          <li>模块代码 &gt;</li>
        
          <li><a href="../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../distributed.html">torch.distributed</a> &gt;</li>
        
      <li>torch.distributed.distributed_c10d</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">快捷键</div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>torch.distributed.distributed_c10d 的源代码</font></font></font></h1><div class="highlight"><pre><span></span><span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># mypy: 允许未类型化定义</span>
<span class="sd">分布式集体通信（c10d）</span>

<span class="kn">导入</span> <span class="nn">collections.abc</span>
<span class="kn">导入</span> <span class="nn">contextlib</span>
<span class="kn">导入</span> <span class="nn">ctypes</span>
<span class="kn">导入</span> <span class="nn">hashlib</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入/输出</span>
<span class="kn">导入</span> <span class="nn">itertools</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">记录日志</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作系统</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">酸菜</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">系统</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span>
<span class="kn">来自</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名元组</span>
<span class="kn">来自</font></font></font></span> <span class="nn">datetime</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</span>
<span class="kn">来自</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打字</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型检查</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</span>
<span class="kn">来自</font></font></font></span> <span class="nn">typing_extensions</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已弃用</span>

<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch._C</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_DistStore 错误_</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">DistStore 错误</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch._C._distributed_c10d</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="p">(</span>
    <span class="n">_分布式后端选项</span><span class="p">,</span>
    <span class="n">_注册进程组</span><span class="p">,</span>
    <span class="n">_resolve_process_group</span><span class="p">,</span>
    <span class="n">_注销所有进程组</span><span class="p">,</span>
    <span class="n">_注销进程组</span><span class="p">,</span>
    <span class="n">Allgather 选项</span><span class="p">,</span>
    <span class="n">Allreduce 合并选项</span><span class="p">,</span>
    <span class="n">Allreduce 选项</span><span class="p">,</span>
    <span class="n">AllToAll 选项</span><span class="p">,</span>
    <span class="n">障碍选项</span><span class="p">,</span>
    <span class="n">广播选项</span><span class="p">,</span>
    <span class="n">调试等级</span><span class="p">,</span>
    <span class="n">收集选项</span><span class="p">,</span>
    <span class="n">获取调试级别</span><span class="p">,</span>
    <span class="n">前缀存储</span><span class="p">,</span>
    <span class="n">流程组</span><span class="p">,</span>
    <span class="n">ReduceOp</span><span class="p">,</span>
    <span class="n">减少选项</span><span class="p">,</span>
    <span class="n">减少散布选项</span><span class="p">,</span>
    <span class="n">散点选项</span><span class="p">,</span>
    <span class="n">存储</span><span class="p">,</span>
    <span class="n">工作</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch._utils_internal</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">从 justknobs 设置 pytorch 分布式环境</span>
<span class="kn">from</span> <span class="nn">torch.monitor</span> <span class="kn">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_等待计数器</span>
<span class="kn">from</span> <span class="nn">torch.overrides</span> <span class="kn">导入</font></font></font></span> <span class="n">handle_torch_function</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有 torch 功能</span>
<span class="kn">from</span> <span class="nn">torch.utils._typing_utils</span> <span class="kn">导入</span> <span class="n">not_none</span>

<span class="kn">from</span> <span class="nn">.c10d_logger</span> <span class="kn">导入</font></font></font></span> <span class="n">_exception_logger</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间记录器</span>
<span class="kn">from</span> <span class="nn">.常量</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG NCCL 超时</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG 超时</span>
<span class="kn">from</span> <span class="nn">.会合点</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册会合处理程序</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">约会</span>  <span class="c1"># noqa: F401</span>


<span class="n">全部</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">后端</span><span class="p">,</span>
    <span class="s2">后端配置</span><span class="p">,</span>
    <span class="s2">群成员</span><span class="p">,</span>
    <span class="s2">"P2P 广播"</span><span class="p">,</span>
    <span class="s2">"全局聚合"</span><span class="p">,</span>
    <span class="s2">all_gather_coalesced</span><span class="p">,</span>
    <span class="s2">"all_gather_object"</span><span class="p">,</span>
    <span class="s2">全局归约</span><span class="p">,</span>
    <span class="s2">"all_reduce_coalesced"</span><span class="p">,</span>
    <span class="s2">全对全</span><span class="p">,</span>
    <span class="s2">全向单播</span><span class="p">,</span>
    <span class="s2">障碍</span><span class="p">,</span>
    <span class="s2">batch_isend_irecv</span><span class="p">,</span>
    <span class="s2">广播</span><span class="p">,</span>
    <span class="s2">发送对象列表</span><span class="p">,</span>
    <span class="s2">"接收对象列表"</span><span class="p">,</span>
    <span class="s2">"广播对象列表"</span><span class="p">,</span>
    <span class="s2">"销毁进程组"</span><span class="p">,</span>
    <span class="s2">"聚集"</span><span class="p">,</span>
    <span class="s2">收集对象</span><span class="p">,</span>
    <span class="s2">"获取后端配置"</span><span class="p">,</span>
    <span class="s2">"获取后端"</span><span class="p">,</span>
    <span class="s2">"获取设备默认后端"</span><span class="p">,</span>
    <span class="s2">"获取排名"</span><span class="p">,</span>
    <span class="s2">"获取世界大小"</span><span class="p">,</span>
    <span class="s2">"获取进程组数量"</span><span class="p">,</span>
    <span class="s2">"分组"</span><span class="p">,</span>
    <span class="s2">"初始化进程组"</span><span class="p">,</span>
    <span class="s2">"irecv"</span><span class="p">,</span>
    <span class="s2">"gloo 是否可用"</span><span class="p">,</span>
    <span class="s2">"已初始化"</span><span class="p">,</span>
    <span class="s2">"mpi 是否可用"</span><span class="p">,</span>
    <span class="s2">"是否支持后端"</span><span class="p">,</span>
    <span class="s2">"是否支持 NCCL"</span><span class="p">,</span>
    <span class="s2">"是否已启动 torchelastic"</span><span class="p">,</span>
    <span class="s2">"是否支持 UCC"</span><span class="p">,</span>
    <span class="s2">"is_xccl_available"</span><span class="p">,</span>
    <span class="s2">"isend"</span><span class="p">,</span>
    <span class="s2">"monitored_barrier"</span><span class="p">,</span>
    <span class="s2">"new_group"</span><span class="p">,</span>
    <span class="s2">"新子组"</span><span class="p">,</span>
    <span class="s2">"按枚举创建新子组"</span><span class="p">,</span>
    <span class="s2">"接收"</span><span class="p">,</span>
    <span class="s2">"减少"</span><span class="p">,</span>
    <span class="s2">"减少散射"</span><span class="p">,</span>
    <span class="s2">"散射"</span><span class="p">,</span>
    <span class="s2">"散射对象列表"</span><span class="p">,</span>
    <span class="s2">"发送"</span><span class="p">,</span>
    <span class="s2">支持复杂</span><span class="p">,</span>
    <span class="s2">AllreduceCoalescedOptions</span><span class="p">,</span>
    <span class="s2">AllreduceOptions</span><span class="p">,</span>
    <span class="s2">AllToAllOptions</span><span class="p">,</span>
    <span class="s2">"屏障选项"</span><span class="p">,</span>
    <span class="s2">"广播选项"</span><span class="p">,</span>
    <span class="s2">"收集选项"</span><span class="p">,</span>
    <span class="s2">"前缀存储"</span><span class="p">,</span>
    <span class="s2">"流程组"</span><span class="p">,</span>
    <span class="s2">"减少操作"</span><span class="p">,</span>
    <span class="s2">"减少选项"</span><span class="p">,</span>
    <span class="s2">"减少分散选项"</span><span class="p">,</span>
    <span class="s2">"散点选项"</span><span class="p">,</span>
    <span class="s2">"存储"</span><span class="p">,</span>
    <span class="s2">"调试级别"</span><span class="p">,</span>
    <span class="s2">"获取调试级别"</span><span class="p">,</span>
    <span class="s2">工作</span><span class="p">,</span>
    <span class="s2">default_pg_timeout</span><span class="p">,</span>
    <span class="s2">获取组排名</span><span class="p">,</span>
    <span class="s2">获取全局排名</span><span class="p">,</span>
    <span class="s2">"获取进程组排名"</span><span class="p">,</span>
    <span class="s2">"归约操作"</span><span class="p">,</span>
    <span class="s2">"所有聚合到张量中"</span><span class="p">,</span>
    <span class="s2">"归约散射张量"</span><span class="p">,</span>
    <span class="s2">get_node_local_rank</span><span class="p">,</span>
    <span class="s2">split_group</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_MPI_AVAILABLE</span> <span class="o">=</span> <span class="kc">真实</span>
<span class="n">_NCCL_AVAILABLE</span> <span class="o">=</span> <span class="kc">真实</span>
<span class="n">_GLOO 可用</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
<span class="n">_UCC_AVAILABLE</span> <span class="o">=</span> <span class="kc">真实</span>
<span class="n">_XCCL_AVAILABLE</span> <span class="o">=</span> <span class="kc">真实</span>

<span class="n">_pickler</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">挑选器</span>
<span class="n">_反挑选器</font></font></font></span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">反挑选器</span>


<span class="c1"># 将所有从 torch._C._distributed_c10d 导入且为公开的类型的 __module__ 改为</span>
<span class="k">定义</font></font></font></span> <span class="nf">_export_c_types</span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
    <span class="n">可更改模块的公共类型</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Allreduce 合并选项</span><span class="p">,</span>
        <span class="n">Allreduce 选项</span><span class="p">,</span>
        <span class="n">AllToAll 选项</span><span class="p">,</span>
        <span class="n">障碍选项</span><span class="p">,</span>
        <span class="n">广播选项</span><span class="p">,</span>
        <span class="n">收集选项</span><span class="p">,</span>
        <span class="n">前缀存储</span><span class="p">,</span>
        <span class="n">流程组</span><span class="p">,</span>
        <span class="n">ReduceOp</span><span class="p">,</span>
        <span class="n">减少选项</span><span class="p">,</span>
        <span class="n">减少散布选项</span><span class="p">,</span>
        <span class="n">散点选项</span><span class="p">,</span>
        <span class="n">存储</span><span class="p">,</span>
        <span class="n">调试等级</span><span class="p">,</span>
        <span class="n">获取调试级别</span><span class="p">,</span>
        <span class="n">工作</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="nb">类型</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">_public_types_to_change_module</span><span class="p">:</span>
        <span class="nb">类型</font></font></font></span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch.distributed.distributed_c10d</span>


<span class="n">_export_c_types</span><span class="p">()</span>

<span class="k">尝试</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">torch._C._distributed_c10d</span> <span class="kn">导入</span> <span class="n">ProcessGroupMPI</span>

    <span class="n">ProcessGroupMPI</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2">torch.distributed.distributed_c10d</span>
    <span class="n">全部</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"ProcessGroupMPI"</span><span class="p">]</span>
<span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入错误</span><span class="p">:</span>
    <span class="n">_MPI_AVAILABLE</span> <span class="o">=</span> <span class="kc">假</span>

<span class="k">尝试</span><span class="p">:</span>
    <span class="kn">来自</font></font></font></span> <span class="nn">torch._C._distributed_c10d</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="n">ProcessGroupNCCL</span>

    <span class="n">ProcessGroupNCCL</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2">torch.distributed.distributed_c10d</span>
    <span class="n">全部</font></font></font></span> <span class="o">+=</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">ProcessGroupNCCL</span><span class="p">]</span>
<span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入错误</span><span class="p">:</span>
    <span class="n">_NCCL_AVAILABLE</span> <span class="o">=</span> <span class="kc">假</span>

<span class="k">尝试</span><span class="p">:</span>
    <span class="kn">来自</font></font></font></span> <span class="nn">torch._C._distributed_c10d</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组包装器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">网格流程组 Gloo</span>

    <span class="n">网格流程组 Gloo</font></font></font></span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch.distributed.distributed_c10d</span>
    <span class="n">全部</font></font></font></span> <span class="o">+=</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"Gloo 进程组"</span><span class="p">]</span>
<span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入错误</span><span class="p">:</span>
    <span class="n">_GLOO 可用</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>

<span class="k">尝试</span><span class="p">:</span>
    <span class="kn">来自</font></font></font></span> <span class="nn">torch._C._distributed_c10d</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">UCC 进程组</span>

    <span class="n">UCC 进程组</font></font></font></span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch.distributed.distributed_c10d</span>
    <span class="n">全部</font></font></font></span> <span class="o">+=</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">ProcessGroupUCC</span><span class="p">]</span>
<span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入错误</span><span class="p">:</span>
    <span class="n">_UCC_AVAILABLE</span> <span class="o">=</span> <span class="kc">假</span>

<span class="k">尝试</span><span class="p">:</span>
    <span class="kn">来自</font></font></font></span> <span class="nn">torch._C._distributed_c10d</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="n">ProcessGroupXCCL</span>

    <span class="n">ProcessGroupXCCL</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="s2">torch.distributed.distributed_c10d</span>
    <span class="n">全部</font></font></font></span> <span class="o">+=</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">ProcessGroupXCCL</span><span class="p">]</span>
<span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入错误</span><span class="p">:</span>
    <span class="n">_XCCL_AVAILABLE</span> <span class="o">=</span> <span class="kc">假</span>

<span class="n">记录器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">记录</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取日志记录器</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">PG 包装器存储前缀</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_wrapper</span>


<span class="c1"># 一些不支持复数的 reduce 操作将导致错误。</span>
<span class="c1">我们目前通过查看为分布式 API 提供复杂支持</span>
<span class="c1">将复数张量视为实数（torch.view_as_real），意味着调用</span>
<span class="c1">这些不受支持的运算将返回垃圾值而不是错误退出。</span>
<span class="c1"># (例如：max(2+3i, 3+2i) = 3+3i)</span>
<span class="c1">我们希望对不支持的操作调用错误输出，而不是返回垃圾值。</span>
<span class="c1">而不是返回垃圾值。</span>
<span class="k">def</span> <span class="nf">支持复数</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">简化运算符</span><span class="p">:</span> <span class="n">ReduceOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">如果支持减少操作，则返回 true。否则返回 false。</span>
    <span class="n">禁用列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ReduceOp</span><span class="o">.</span><span class="n">MAX</span><span class="p">,</span>
        <span class="n">ReduceOp</span><span class="o">.</span><span class="n">MIN</span><span class="p">,</span>
        <span class="n">ReduceOp</span><span class="o">.</span><span class="n">产品</span><span class="p">,</span>
        <span class="n">ReduceOp</span><span class="o">.</span><span class="n">带宽</span><span class="p">,</span>
        <span class="n">ReduceOp</span><span class="o">.</span><span class="n">逻辑或</span><span class="p">,</span>
        <span class="n">ReduceOp</span><span class="o">.</span><span class="n">逻辑异或</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">减少操作</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">禁用列表</span>


<span class="c1"># TODO 将其重构为枚举/强枚举</span>
<div class="viewcode-block" id="Backend"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.Backend">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>  <span class="c1"># noqa: SLOT000</span>
<span class="w">    </span><span class="sd">""</span>
<span class="sd">后端枚举类</span>

<span class="sd">可用后端：GLOO、NCCL、UCC、MPI、XCCL 以及其他已注册后端。</span>

<span class="sd">该类的值是小写字符串，例如："gloo"。它们可以作为属性访问，例如：`Backend.NCCL`。</span>
<span class="sd">可以作为属性访问，例如：`Backend.NCCL`。</span>

<span class="sd">该类可以直接调用以解析字符串，例如，</span>
<span class="sd">``Backend(backend_str)`` 将检查 ``backend_str`` 是否有效，</span>
<span class="sd">如果有效则返回解析后的小写字符串。它也接受大写字符串，</span>
<span class="sd">例如，``Backend("GLOO")`` 返回 ``"gloo"``。</span>

<span class="sd">.. note:: 后端项 ``Backend.UNDEFINED`` 存在，但仅用作</span>
<span class="sd">某些字段的初始值。用户不应直接使用</span>
<span class="sd">不假设其存在。</span>
<span class="sd">"沉浸式翻译"</span>

    <span class="n">未定义</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"未定义"</span>
    <span class="n">GLOO</span> <span class="o">=</span> <span class="s2">"水凝胶"</span>
    <span class="n">NCCL</span> <span class="o">=</span> <span class="s2">"nccl"</span>
    <span class="n">UCC</span> <span class="o">=</span> <span class="s2">"ucc"</span>
    <span class="n">MPI</span> <span class="o">=</span> <span class="s2">"mpi"</span>
    <span class="n">XCCL</span> <span class="o">=</span> <span class="s2">"xccl"</span>

    <span class="n">_BackendPlugin</span> <span class="o">=</span> <span class="n">命名元组</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"_后端插件"</font></font></font></span><span class="p">,</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"创建者函数"</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"扩展 API"</span><span class="p">])</span>

    <span class="n">_插件</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端插件</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">后端列表</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未定义</span><span class="p">,</span> <span class="n">GLOO</span><span class="p">,</span> <span class="n">NCCL</span><span class="p">,</span> <span class="n">XCCL</span><span class="p">,</span> <span class="n">UCC</span><span class="p">,</span> <span class="n">MPI</span><span class="p">]</span>

    <span class="c1">第三方设备可以在此处注册默认后端支持</span>
    <span class="n">默认设备后端映射</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">cpu</span><span class="p">:</span> <span class="n">GLOO</span><span class="p">,</span>
        <span class="s2">cuda</span><span class="p">:</span> <span class="n">NCCL</span><span class="p">,</span>
        <span class="s2">XPU</span><span class="p">:</span> <span class="n">XCCL</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">后端能力</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">GLOO</span><span class="p">:</span> <span class="p">[</span><span class="s2">"cpu"</span><span class="p">,</span> <span class="s2">cuda</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">NCCL</span><span class="p">:</span> <span class="p">[</span><span class="s2">cuda</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">XCCL</span><span class="p">:</span> <span class="p">[</span><span class="s2">XPU</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">UCC</span><span class="p">:</span> <span class="p">[</span><span class="s2">"cpu"</span><span class="p">,</span> <span class="s2">cuda</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">MPI</span><span class="p">:</span> <span class="p">[</span><span class="s2">"cpu"</span><span class="p">,</span> <span class="s2">cuda</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="p">}</span>

    <span class="n">后端类型映射</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">未定义</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未定义</span><span class="p">,</span>
        <span class="n">GLOO</span><span class="p">:</span> <span class="n">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">GLOO</span><span class="p">,</span>
        <span class="n">NCCL</span><span class="p">:</span> <span class="n">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">NCCL</span><span class="p">,</span>
        <span class="n">XCCL</span><span class="p">:</span> <span class="n">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">XCCL</span><span class="p">,</span>
        <span class="n">UCC</span><span class="p">:</span> <span class="n">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UCC</span><span class="p">,</span>
        <span class="n">MPI</span><span class="p">:</span> <span class="n">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">MPI</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">定义</font></font></font></span> <span class="fm">__new__</span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">创建并返回该类的新实例。</span>
        <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">):</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端构造函数参数必须是字符串类型</span><span class="p">)</span>
        <span class="n">值</font></font></font></span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</font></font></font></span><span class="p">(),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未定义</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">值</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未定义</span><span class="p">:</span>
            <span class="n">值</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</span><span class="p">()</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span>

<div class="viewcode-block" id="Backend.register_backend"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.Backend.register_backend">[文档]</a>    <span class="nd">@classmethod</span>
    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册后端</span><span class="p">(</span>
        <span class="bp">类</span><span class="p">,</span>
        <span class="n">名称</span><span class="p">,</span>
        <span class="n">函数</span><span class="p">,</span>
        <span class="n">扩展 API</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
        <span class="n">设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">使用给定的名称和实例化函数注册新的后端。</span>

<span class="sd">此类方法由第三方 `ProcessGroup` 扩展使用。</span>
<span class="sd">注册新的后端。</span>

<span class="sd">参数：</span>
<span class="sd">name (str): `ProcessGroup` 扩展的后端名称。它</span>
<span class="sd">应与 `init_process_group()` 中的匹配。</span>
<span class="sd">func (函数): 实例化后端的函数处理器。</span>
<span class="sd">函数应在后端扩展中实现</span>
<span class="sd">并接受四个参数，包括</span>
<span class="sd">``store``、``rank``、``world_size`` 和 ``timeout``。</span>
<span class="sd">extended_api (bool, optional): 后端是否支持扩展参数结构。</span>
<span class="sd">默认：``False``。如果设置为 ``True``，后端</span>
<span class="sd">将获取一个 ``c10d::DistributedBackendOptions`` 的实例，</span>
<span class="sd">一个由后端实现定义的过程组选项对象。</span>
<span class="sd">设备（str 或 str 列表，可选）：此后端支持的设备类型</span>
<span class="sd">支持，例如："cpu"、"cuda"等。如果`None`，</span>
<span class="sd">假设“cpu”和“cuda”</span>

<span class="sd">.. 注意：对第三方后端的支持是实验性的，可能会发生变化。</span>

<span class="sd">        """</span>
        <span class="c1"># 这负责处理树外后端类型，后端列表中的更新表示可用性</span>
        <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</span><span class="p">()):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">后端</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</font></font></font></span><span class="p">(),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端列表</span><span class="p">:</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端列表</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">设备</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">设备</font></font></font></span> <span class="o">!=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="o">!=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">:</span>
                    <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认设备后端映射</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</span><span class="p">()</span>
        <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型映射</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义</span>

        <span class="c1"># 在后端类中更新设备能力矩阵</span>
        <span class="k">if</span> <span class="n">设备</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="c1"># 这更多的是对像 `threaded` 这样的组的向后兼容支持</span>
            <span class="c1"># 假设默认设备为 "cpu" 和 "cuda"，但会发出警告</span>
            <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"设备能力为"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未指定，假设为 `cpu` 和 </span>
                <span class="s2">"`cuda`。请通过 `devices` 参数指定它。"</span>
                <span class="s2">"注册后端。"</span>
            <span class="p">)</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端能力</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">]</span>
        <span class="k">如果...否则</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">):</span>
            <span class="c1"># 单个设备字符串指定。直接转换为列表。</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端能力</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端能力</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span>

        <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_插件</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</font></font></font></span><span class="p">()]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端插件</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">扩展 API</span><span class="p">)</span></div></div>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""后端配置类。"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">后端</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">):</span>
<span class="w">        </span><span class="sd">初始化。</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">设备后端映射</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未定义</span><span class="p">:</span>
            <span class="c1"># 检测机器上的加速器。如果没有加速器，则返回 CPU。</span>
            <span class="c1"># 如果没有可用，则返回 CPU。</span>
            <span class="n">设备类型</font></font></font></span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取加速器</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span>
            <span class="k">尝试</span><span class="p">:</span>
                <span class="n">后端字符串</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认设备后端映射</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">设备后端映射</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</span><span class="p">)</span>
            <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键错误</span><span class="p">:</span>
                <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"我们检测到加速器"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在您的机器上。</span>
                    <span class="sa">f</span><span class="s2">但我们不知道该为这个加速器使用哪个通信后端。</span>
                    <span class="sa">f</span><span class="s2">请在`init_process_group`调用中指定`backend`参数。</span>
                <span class="p">)</span> <span class="kn">来自</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端列表</span><span class="p">:</span>
            <span class="c1">当后端是单个字符串（不包含设备类型）时的案例</span>
            <span class="c1">例如 "nccl"，"gloo"，"ucc"，"mpi"</span>
            <span class="n">支持的设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端能力</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</span><span class="p">()]</span>
            <span class="n">后端值</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">设备后端映射</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持的设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端值</span><span class="p">)</span>
        <span class="k">如果...否则</font></font></font></span> <span class="s2">":"</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</span><span class="p">():</span>
            <span class="c1"># 后端指定在 "device:backend" 格式</span>
            <span class="c1"># 确保后端字符串格式正确</span>
            <span class="c1"># "{设备类型 1}:{后端 1},{设备类型 2}:{后端 2}"</span>
            <span class="c1">cpu:gloo,cuda:nccl</span>
            <span class="n">后端错误信息字符串</font></font></font></span> <span class="o">=</span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"自定义后端字符串参数无效："</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">自定义后端字符串是一个实验性功能，后端字符串必须遵循以下格式：</span>
<span class="s2">"&lt;设备类型 1&gt;:&lt;后端 1&gt;,&lt;设备类型 2&gt;:&lt;后端 2&gt;...". 例如：'cpu:gloo,cuda:nccl'"</span>

            <span class="c1">解析后端字符串并填充设备后端映射</span>
            <span class="k">for</span> <span class="n">设备后端对字符串</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</span><span class="p">(</span><span class="s2">","</span><span class="p">):</span>
                <span class="n">设备后端配对</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端配对字符串</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“：”</span><span class="p">)</span>
                <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端对</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"无效设备：后端配对失败："</span><span class="se">\</span>
<span class="s2">                                     </span><span class="si">{</span><span class="n">设备后端配对字符串</font></font></font></span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端错误信息</span><span class="si">}</span><span class="s2">"</span>
                    <span class="p">)</span>
                <span class="n">设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端配对</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</span><span class="p">:</span>
                    <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">"重复设备类型"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">在后端字符串中：</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端错误信息</span><span class="si">}</span><span class="s2">"</span>
                    <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">设备后端映射</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">用户指定了一个后端名称，其设备功能是</span>
            <span class="c1">未知，假设它可以支持 PyTorch 的默认设备</span>
            <span class="c1">（cpu 和 cuda）</span>
            <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"设备能力为"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未知，假设`cpu`和"</span>
                <span class="s2">"`cuda`。您可以在`device:backend`格式中指定它"</span>
                <span class="s2">"调用 `init_process_group`。"</span>
            <span class="p">)</span>
            <span class="n">后端值</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
            <span class="bp">我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">cpu</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端值</span><span class="p">,</span>
                <span class="s2">cuda</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端值</span><span class="p">,</span>
                <span class="s2">XPU</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端值</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用后端配置：</font></font></font></span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">返回所有以逗号分隔的设备：后端对。</span>
        <span class="k">返回</font></font></font></span> <span class="s2">","</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">连接</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">设备</font></font></font></span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自身</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取设备后端映射</font></font></font></span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自身</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">        </span><span class="sd">返回设备的后端映射</span>
        <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</span>


<span class="k">类</span> <span class="nc">_reduce_op</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">""</span>
<span class="sd">已废弃的枚举类。</span>

<span class="sd">对于求和、乘积、最小值和最大值等求约简操作：</span>

<span class="sd">建议使用 :class:`~torch.distributed.ReduceOp`。</span>
<span class="sd">"沉浸式翻译"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">无</span><span class="p">:</span>
        <span class="c1"># __members__ 是一个存储枚举类键值对的字典</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">在</font></font></font></span> <span class="n">ReduceOp</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">红操作类型</font></font></font></span><span class="o">.</span><span class="n">__members__</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">成员</font></font></font></span> <span class="o">=</span> <span class="n">ReduceOp</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">红操作类型</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">成员</span>

    <span class="nd">@deprecated</span><span class="p">(</span>
        <span class="s2">"torch.distributed.reduce_op 已弃用，"</span>
        <span class="s2">"请使用 torch.distributed.ReduceOp 代替"</span><span class="p">,</span>
        <span class="n">分类</font></font></font></span><span class="o">=</span><span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未来警告</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">键</span><span class="p">):</span>
        <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span>


<span class="n">reduce_op</span> <span class="o">=</span> <span class="n">_reduce_op</span><span class="p">()</span>


<div class="viewcode-block" id="P2POp"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.P2POp">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">P2P 流</span><span class="p">:</span>
<span class="w">    </span><span class="sd">""</span>
<span class="sd">一个用于构建针对 ``batch_isend_irecv`` 的点对点操作的类。</span>

<span class="sd">这个类构建了 P2P 操作类型、通信缓冲区、节点排名</span>
<span class="sd">进程组，并标记。此类实例将被传递到</span>
<span class="sd">用于点对点通信的 `batch_isend_irecv`。</span>

<span class="sd">参数：</span>
<span class="sd">op（可调用对象）：一个用于向或从对等进程发送或接收数据的函数。</span>
<span class="sd">``op``的类型可以是``torch.distributed.isend``或</span>
<span class="sd">``torch.distributed.irecv``。</span>
<span class="sd">tensor（张量，Tensor）：要发送或接收的张量。</span>
<span class="sd">peer（int，可选）：目标或源 rank。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">tag（整型，可选）：用于匹配发送与接收的标签。</span>
<span class="sd">group_peer（整型，可选）：目标或源排名。</span>
<span class="sd">"沉浸式翻译"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</span><span class="p">,</span>
        <span class="n">张量</font></font></font></span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
        <span class="n">同行</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">标签</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">整型</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">小组对等</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">初始化。</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">对等方</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">同行</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小组对等</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">群组对等</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">同行</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小组对等</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">类</span><span class="p">,</span>
        <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</span><span class="p">,</span>
        <span class="n">张量</font></font></font></span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
        <span class="n">同行</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">标签</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">整型</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">小组对等</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">创建并返回该类的新实例。</span>
        <span class="n">_检查操作</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
        <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"张量"</span><span class="p">)</span>

        <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">我的群组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
        <span class="n">操作名称</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="bp">我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">group_name</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自身</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认分页</span>
        <span class="k">如果</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">我的群组排名</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">自身</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组对等</span>
        <span class="k">如果...否则</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">自身</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组对等</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">我的群组排名</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超级</span><span class="p">()</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

        <span class="k">返回</font></font></font></span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">P2POp(</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="si">}</span><span class="s2"> pg=</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</font></font></font></span><span class="si">}</span><span class="s2">, group_src=</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">, group_dst=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">,  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">形状</font></font></font></span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</span><span class="si">}</span><span class="s2">)"</span></div>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_集合操作</span><span class="p">:</span>
<span class="w">    </span><span class="sd">""</span>
<span class="sd">捕获集体操作的类。</span>

<span class="sd">参数：</span>
<span class="sd">op (Callable)：集体函数，例如 ``torch.distributed.all_reduce``。</span>
<span class="sd">tensor (Tensor)：要操作的张量。</span>
<span class="sd">dst_tensor (Tensor, 可选)：当源张量和目标张量不同时提供。</span>
<span class="sd">redop（ReduceOp，可选）：减少操作。</span>
<span class="sd">root（int，可选）：广播或减少的根。</span>
<span class="sd">"沉浸式翻译"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</span><span class="p">,</span>
        <span class="n">张量</font></font></font></span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
        <span class="n">目标张量</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">红操</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n">ReduceOp</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">根</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">目标张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标张量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">红色</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">红色</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">根</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根</span>


<span class="c1"># DO NOT USE THESE FIELDS DIRECTLY.</span>
<span class="c1"># Use them through the _world object to make sure the _world override mechanism</span>
<span class="n">_pg_map</span><span class="p">:</span> <span class="nb">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元组</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_pg_names</span><span class="p">:</span> <span class="nb">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_pg_group_ranks</span><span class="p">:</span> <span class="nb">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># 对于 pg，它是一个从 ProcessGroup 到 BackendConfig 的映射</span>
<span class="n">_pg 后端配置</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_组计数</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_标签到 pg</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_pg 到标签</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">后端</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="p">:</span>
<span class="w">    </span><span class="sd">""</span>
<span class="sd">c10d 进程组状态的容器类。</span>

<span class="sd">在注册和查找 PG 状态时使用。</span>

<span class="sd">..警告:: 这是一个实验性 API，旨在暴露内部工作原理。</span>
<span class="sd">c10d 的版本，可能随时更改。</span>
<span class="sd">"沉浸式翻译"</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">无</span><span class="p">:</span>
        <span class="bp">自我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_默认_pg</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_合并状态_postgresql</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_集合操作</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">默认页面</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">        </span><span class="sd">""</span>
<span class="sd">包含集群所有 rank 的进程组。</span>

<span class="sd">当需要进程组但未提供时，c10d API 将使用此默认进程组。</span>
<span class="sd">但未提供。</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_默认_pg</span>

    <span class="nd">@default_pg</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">默认页面</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="bp">我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_默认_pg</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span>

    <span class="nd">@property</span>
    <span class="k">定义</font></font></font></span> <span class="nf">pg_map</span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自身</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元组</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">提供从进程组到后端名称和存储的映射并存储。</span>

<span class="sd">对于 NCCL 和 GLOO 进程组，它是一个从进程组到（后端，存储）的映射。</span>
<span class="sd">对于 MPI 进程组，它是一个从进程组到（后端，无）的映射。</span>

<span class="sd">TODO 不要暴露地图，暴露细粒度操作</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="k">全局</span> <span class="n">_pg_map</span>
        <span class="k">返回</span> <span class="n">_pg_map</span>

    <span class="nd">@property</span>
    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb">str</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">        </span><span class="sd">""</span>
<span class="sd">处理组名称，从 ProcessGroup 到字符串的映射。</span>

<span class="sd">TODO 不要暴露地图，暴露细粒度操作</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="k">全局</span> <span class="n">_pg_names</span>
        <span class="k">返回</span> <span class="n">_pg_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pg_group_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
<span class="w">        </span><span class="sd">""</span>
<span class="sd">进程组的全局排名到本地排名映射。</span>

<span class="sd">TODO 不要暴露地图，暴露细粒度操作</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="k">全局</span> <span class="n">_pg_group_ranks</span>
        <span class="k">返回</span> <span class="n">_pg_group_ranks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PostgreSQL 后端配置</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb">str</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">        </span><span class="sd">""</span>
<span class="sd">处理组后端配置。</span>

<span class="sd">TODO 不要暴露地图，暴露细粒度操作</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="k">全局</span> <span class="n">_pg_backend_config</span>
        <span class="k">返回</span> <span class="n">_pg_backend_config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">群组计数</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">""</span>
<span class="sd">默认命名下的进程组数量。</span>

<span class="sd">TODO 不要暴露群组数量，使用其他代替。</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_组计数</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_组计数</span>

    <span class="nd">@group_count</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">群组计数</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">        </span><span class="sd">用于在全局同步时计算 ProcessGroups 的名称。</span>
        <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_组计数</span>
        <span class="n">_组计数</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">标签转 PostgreSQL</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
        <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_标签转 PostgreSQL</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_标签转 PostgreSQL</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">PostgreSQL 转标签</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb">str</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_ pg_to_tag</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_ pg_to_tag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pg_coalesce_state_合并状态</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_集合操作</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
        <span class="k">返回</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg_coalesce_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pg_config_info</span><span class="p">(</span><span class="bp">我</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
<span class="w">        </span><span class="sd">""</span>
<span class="sd">返回包含进程组和后端及其唯一 ID 和配置（类型和排名）的字典列表。</span>

<span class="sd">以及它们的配置信息（类型和排名）。</span>
<span class="sd">"沉浸式翻译"</span>
        <span class="n">配置信息</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
        <span class="n">默认 pg 大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取组大小</font></font></font></span><span class="p">(</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pg</span> <span class="ow">在</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
            <span class="n">排名</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
            <span class="n">配置信息</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">pg 名称</font></font></font></span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="p">[</span><span class="n">pg</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
                    <span class="s2">"pg_desc"</span><span class="p">:</span> <span class="n">pg</span><span class="o">.</span><span class="n">群组描述</span><span class="p">,</span>
                    <span class="s2">"后端配置"</font></font></font></span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</font></font></font></span><span class="p">[</span><span class="n">pg</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
                    <span class="s2">排名</span><span class="p">:</span> <span class="p">(</span>
                        <span class="nb">列表</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span><span class="p">())</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">)</span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 pg 大小</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
                    <span class="p">),</span>  <span class="c1"># '排名'是一个空列表，当所有排名都参与 pg 时</span>
                    <span class="s2">"小组大小"</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">),</span>
                    <span class="s2">"组数"</font></font></font></span><span class="p">:</span> <span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自身</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组计数</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">配置信息</span>


<span class="n">_世界</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="p">()</span>
<span class="sd">保存了 c10 使用的``_世界``单例实例。实验性扩展点，用于覆盖它</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界元数据</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">元类，用于“group”和“GroupMember”。</span>

<span class="sd">允许它们具有类属性“WORLD”。</span>
<span class="sd">"沉浸式翻译"</span>

    <span class="c1"># 初始化后指向默认的 PG。</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">世界</font></font></font></span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span>

    <span class="nd">@WORLD</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">世界</font></font></font></span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span><span class="p">,</span> <span class="n">pg</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span> <span class="o">=</span> <span class="n">pg</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元类</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界元数据</span><span class="p">):</span>
<span class="w">    </span><span class="sd">“分组类。占位符。”</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元类</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界元数据</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"小组成员类。"</span>

    <span class="n">非群组成员</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>


<span class="k">def</span> <span class="nf">_获取默认超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</span><span class="p">:</span>
    <span class="c1"># 关于 nccl 与其他后端超时（constants.py）的说明</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">NCCL</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG NCCL 超时</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</span><span class="p">):</span>
            <span class="c1"># TODO：今天在 CPU 上初始化 pgnccl 后端时，触发了 CI 中的这个断言</span>
            <span class="c1"># 警告：应修复 moco 模型。</span>
            <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                <span class="s2">尝试获取 nccl 后端的默认超时时间，但未编译 NCCL 支持</span>
            <span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG 超时</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG nccl 超时</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG 超时</span>


<span class="k">def</span> <span class="nf">_检查有效超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">预期超时参数应为 datetime.timedelta 类型，实际得到</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>


<span class="c1">默认进程组状态</span>
<span class="n">默认 PG 初始化方法</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

<span class="n">店铺基础屏障前缀</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">store_based_barrier_key</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">.. 注意:: 这是一个内部辅助工具，不具有回溯功能</span>
<span class="sd">兼容性，请谨慎使用。</span>

<span class="sd">返回与“group”一起用于对象集合的设备类型</span>
<span class="sd">屏障</span>

<span class="sd">选择规则如下：</span>
<span class="sd">1. 如果用户在 `init_process_group` 调用中指定了恰好一个后端：</span>
<span class="sd">使用该后端</span>
<span class="sd">2. 否则如果用户在 `init_process_group` 中指定了多个 "device:backend" 对：</span>
<span class="sd">如果“cpu”在这些对中，则使用“cpu”（因为对象位于 cpu 内存中）；</span>
<span class="sd">否则，使用第一个后端（有点像随机选择）。</span>

<span class="sd">参数：</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>

<span class="sd">返回：</span>
<span class="sd">使用对象集合的 ``group`` 的设备类型。</span>

<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">):</span>
        <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">您正在使用一个后端</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为进程组。</span>
            <span class="s2">自 PyTorch 2.0 起，此用法已弃用。请使用公共 API。</span>
            <span class="s2">PyTorch 分布式代替。</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1">向后兼容，以应对传入的 `group` 实际上是后端（如 `ProcessGroupGloo`）而非 PT 2.0 中的 `ProcessGroup` 的情况</span>
        <span class="c1">实际上是一个后端（如 `ProcessGroupGloo`）而不是 PT 2.0 意义上的 `ProcessGroup`</span>
        <span class="c1">RPC 使用 Gloo 进行对象集合</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">网格流程组 Gloo</span><span class="p">):</span>
            <span class="c1"># RPC 使用 Gloo 进行对象集合</span>
            <span class="k">返回</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"期望得到一个流程组，但得到了一个"</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span><span class="si">}</span><span class="s2">."</span><span class="p">)</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">``group._device_types`` 是一个 pybind 属性，返回设备</span>
<span class="sd">("cpu", "cuda" 等) 由 ``group`` 支持的设备。如果 ``group`` 支持多个设备，则可以有多个</span>
<span class="sd">``group`` 支持多个设备。</span>
<span class="sd">    """</span>
    <span class="n">设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="o">.</span><span class="n">_device_types</span>

    <span class="k">if</span> <span class="nb">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 用户在`init_process_group`中恰好修复了一个后端</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span>
    <span class="k">如果...否则</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 没有与此 PG 注册任何后端（可能是因为没有）</span>
        <span class="c1">集体已经运行了吗？我们选择 CPU 作为默认，希望</span>
        <span class="c1"># 这将懒加载初始化 Gloo 或其他可用的 CPU 后端。</span>
        <span class="k">返回</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</span>
    <span class="k">如果...否则</font></font></font></span> <span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
        <span class="c1">该 PG 中有多个后端，CPU 就是其中之一。</span>
        <span class="c1">由于对象位于 CPU 内存中，因此优先选择 CPU，无需使用设备。</span>
        <span class="c1">复制。</span>
        <span class="k">返回</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">后端列表中没有 CPU，随机选择第一个后端。</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span>


<span class="k">定义</font></font></font></span> <span class="nf">_get_pg_default_device</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">.. 注意:: 此方法将被弃用，它仅保留用于</span>
<span class="sd">向后兼容的原因。替代方案：</span>

<span class="sd">- 如果您需要为对象集合查找设备，请使用</span>
<span class="sd">        `_get_object_coll_device(group)`.</span>

<span class="sd">如果您需要查询组支持的设备类型，请使用</span>
<span class="sd">        `_device_capability(group)`.</span>

<span class="sd">返回注册的 ``group`` 设备类型。</span>

<span class="sd">例如，如果调用了 `init_process_group("nccl", ...)`，则返回的</span>
<span class="sd">值将是 `torch.device("cuda")`。</span>

<span class="sd">如果没有注册设备，则出错。</span>

<span class="sd">参数：</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>

<span class="sd">返回：</span>
<span class="sd">torch.device：与`group`注册的设备类型。</span>
<span class="sd">    """</span>

    <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
        <span class="s2">`_get_pg_default_device` 将会被弃用，它仅保留用于</span>
        <span class="s2">向后兼容性原因。如果您需要为对象“</span>
        <span class="s2">集体，请使用 `_get_object_coll_device`。如果您需要查询“</span>
        <span class="s2">支持该组设备的类型，请使用“</span>
        <span class="s2">"设备能力组(group)。"</span>
    <span class="p">)</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">):</span>
        <span class="c1">向后兼容，以应对传入的 `group` 实际上是后端（如 `ProcessGroupGloo`）而非 PT 2.0 中的 `ProcessGroup` 的情况</span>
        <span class="c1">实际上是一个后端（如 `ProcessGroupGloo`）而不是 PT 2.0 意义上的 `ProcessGroup`</span>
        <span class="c1">RPC 使用 Gloo 进行对象集合</span>
        <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">您正在使用一个后端</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为进程组。</span>
            <span class="s2">自 PyTorch 2.0 起，此用法已弃用。请使用公共 API。</span>
            <span class="s2">PyTorch 分布式代替。</span><span class="p">,</span>
            <span class="ne">未来警告</span><span class="p">,</span>
            <span class="n">栈级别</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1">大多数用户使用私有 API 创建 Gloo 以进行对象聚合。</span>
        <span class="k">返回</font></font></font></span> <span class="n">torch</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</span><span class="p">)</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">``group._device_types`` 是一个 pybind 属性，返回设备</span>
<span class="sd">("cpu", "cuda" 等) 由 ``group`` 支持的设备。如果 ``group`` 支持多个设备，则可以有多个</span>
<span class="sd">``group`` 支持多个设备。</span>
<span class="sd">    """</span>
    <span class="n">设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="o">.</span><span class="n">_device_types</span>

    <span class="k">if</span> <span class="nb">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 用户在`init_process_group`中恰好修复了一个后端</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">如果...否则</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
            <span class="s2">"默认设备未找到，因为没有注册后端。"</span>
            <span class="s2">"与此流程组相关。"</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 此流程组中有多个后端。</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpu</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">设备</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
            <span class="s2">"已在此进程组中注册了多个后端。我们无法"</span>
            <span class="sa">f</span><span class="s2">确定哪个是默认的。返回</font></font></font></span><span class="si">{</span><span class="n">rv</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">. </span>
            <span class="s2">请考虑使用其他 API。</span>
        <span class="p">)</span>
        <span class="k">返回</span> <span class="n">rv</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备能力</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回由 `group` 支持的设备类型。</span>

<span class="sd">参数：</span>
<span class="sd">group（进程组，可选）：要查询的进程组。如果为 None，则使用默认进程组。</span>
<span class="sd">则使用默认进程组。</span>

<span class="sd">返回：</span>
<span class="sd">List[str]：由 `group` 支持的设备类型列表。</span>
<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="k">返回</font></font></font></span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</span><span class="p">]</span>


<span class="nd">@_time_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">基于商店的屏障</span><span class="p">(</span>
    <span class="n">排名</span><span class="p">,</span>
    <span class="n">店铺</span><span class="p">,</span>
    <span class="n">群组名称</span><span class="p">,</span>
    <span class="n">集合计数</span><span class="p">,</span>
    <span class="n">超时时间</span><span class="p">,</span>
    <span class="n">日志记录间隔</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">秒数</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
<span class="p">)</span> <span class="o">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">基于存储的同步进程同步屏障。</span>

<span class="sd">基于存储的屏障，用于在进程同步后使用</span>
<span class="sd">``init_process_group`` 或 ``new_group``。仅适用于这两种方法，不是 ``barrier()`` 的通用替代方案。</span>
<span class="sd">这些方法，不是 ``barrier()`` 的通用替代方案。</span>
<span class="sd">    """</span>
    <span class="n">store_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">店铺基础前缀</font></font></font></span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">店铺</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储键</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加键：</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">保存用于排名：</font></font></font></span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储键</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>

    <span class="c1">现在等待所有工作者与商店确认。</span>
    <span class="n">世界大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合计数</span>
    <span class="n">工作人员数量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储键</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">最后一个工作键</font></font></font></span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储键</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">:最后一个工作</span>
    <span class="k">if</span> <span class="n">工作人员数量</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</span><span class="p">:</span>
        <span class="n">店铺</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最后一个工作人员键</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">)</span>

    <span class="c1"># 将超时时间调整为至少 10 秒 + 每千个排名加 1 秒，以降低超时的可能性</span>
    <span class="c1">在规模测试中经验性地找到的值</span>
    <span class="n">日志记录间隔</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大值</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">日志记录间隔</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">秒数</font></font></font></span><span class="o">=</span><span class="mi">10</span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>

    <span class="n">开始</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间</span><span class="p">()</span>
    <span class="k">当</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span><span class="p">:</span>
        <span class="k">尝试</span><span class="p">:</span>
            <span class="c1">这将在我们打印日志的日志间隔之后抛出异常</span>
            <span class="c1">群组状态或超时正式抛出运行时错误</span>
            <span class="n">店铺</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最后一个工作人员键</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">日志记录间隔</span><span class="p">)</span>
            <span class="k">断开</span>
        <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">工作人员数量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储键</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># 定期打印状态以保持跟踪。</span>
            <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试</span><span class="p">(</span>
                <span class="s2">"在商店基于屏障等待初始化进程组"</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">秒</span>
                <span class="s2">"rank: "</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">，键：</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">world_size=</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">，num_workers_joined=</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">, 超时=</span><span class="si">%s</span><span class="s2"> error=</span><span class="si">%s</span><span class="s2">)"</span><span class="p">,</span>
                <span class="n">时间</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间</font></font></font></span><span class="p">()</span> <span class="o">-</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">开始</span><span class="p">,</span>
                <span class="n">排名</span><span class="p">,</span>
                <span class="n">存储键</span><span class="p">,</span>
                <span class="n">世界大小</span><span class="p">,</span>
                <span class="n">工作者数量</span><span class="p">,</span>
                <span class="n">超时时间</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">时间差</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">秒数</font></font></font></span><span class="o">=</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间</font></font></font></span><span class="p">()</span> <span class="o">-</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">开始</font></font></font></span><span class="p">))</span> <span class="o">&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">:</span>
                <span class="k">抛出</span> <span class="n">DistStoreError</span><span class="p">(</span>  <span class="c1"># noqa: B904</span>
                    <span class="s2">"在“store based barrier”上初始化进程组超时"</span>
                    <span class="sa">f</span><span class="s2">"排名"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">，对于键：</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储键</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">world_size=</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">，"</span>
                    <span class="sa">f</span><span class="s2">num_workers_joined=</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作者数量</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">, 超时=</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="si">}</span><span class="s2"> error=</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">)"</span>
                <span class="p">)</span>

    <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">(</span>
        <span class="s2">排名</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">完成基于键的存储屏障</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">的</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">节点。</span><span class="p">,</span>
        <span class="n">排名</span><span class="p">,</span>
        <span class="n">存储键</span><span class="p">,</span>
        <span class="n">世界大小</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">])</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</span><span class="p">:</span>
<span class="w">    </span><span class="sd">检查当前进程的 rank 是否不在给定组中。</span>
    <span class="k">if</span> <span class="n">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非群组成员</span>


<span class="k">定义</font></font></font></span> <span class="nf">_warn_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
    <span class="n">全球排名</font></font></font></span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n">WORLD</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">()</span>
    <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">运行</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“不属于”</span>
        <span class="s2">“的给定组。”</span>
    <span class="p">)</span>


<div class="viewcode-block" id="get_group_rank"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_group_rank(group: ProcessGroup, global_rank: int) -&gt; int:
"""
将全局排名转换为组排名。

``global_rank`` 必须是 ``group`` 的一个部分，否则会引发 RuntimeError。

Args:
群组 (ProcessGroup)：查找相对排名的群组。
global_rank (int)：查询的全局排名。

Returns:
``global_rank`` 相对于 ``group`` 的全局排名

注意。在默认进程组上调用此函数将返回恒等值
"""
如果 group 是 GroupMember.WORLD:
返回全局排名
如果 group 不在 _world.pg_group_ranks 中：
raise ValueError(
f"组 {group} 未注册，请使用 torch.distributed.new_group API 创建组"
        )
group_ranks = _world.pg_group_ranks[group]
if global_rank not in group_ranks:
raise ValueError(f"全局排名 {global_rank} 不属于组 {group}")

return group_ranks[global_rank]</font></font></font></div>


<div class="viewcode-block" id="get_global_rank"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_global_rank(group: ProcessGroup, group_rank: int) -&gt; int:
"""
将组排名转换为全局排名。

``group_rank`` 必须是 `group` 的一部分，否则会引发 RuntimeError。

Args:
group (ProcessGroup): 要查找全局排名的 ProcessGroup。
group_rank (int): 要查询的组排名。

返回值：
``group_rank`` 相对于 ``group`` 的全局排名

注意：在默认进程组上调用此函数返回恒等值
"""
如果组是 GroupMember.WORLD:
返回组等级
如果组不在_world.pg_group_ranks 中:
抛出 ValueError 异常(
组 {group} 未注册，请使用 torch.distributed.new_group API 创建组
        )
对于 rank 和 grp_rank 在 _world.pg_group_ranks[group].items() 中：
如果 grp_rank 等于 group_rank：
返回排名
抛出 ValueError 异常(f"组排名 {group_rank} 不属于组 {group}")</font></font></font></div>


<span class="c1"># TODO: 在生态系统迁移后删除此条</span>
<span class="nd">@deprecated</span><span class="p">(</span>
    <span class="s2">`torch.distributed.distributed_c10d._get_global_rank` 已弃用，</span>
    <span class="s2">"请使用 `torch.distributed.distributed_c10d.get_global_rank` 代替"</span><span class="p">,</span>
    <span class="n">分类</font></font></font></span><span class="o">=</span><span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未来警告</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">定义</font></font></font></span> <span class="nf">_get_global_rank</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">使用 get_global_rank 作为此方法已弃用。</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取全球排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>


<div class="viewcode-block" id="get_process_group_ranks"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_process_group_ranks(group: ProcessGroup) -&gt; list[int]:
"""
获取与 ``group`` 相关的所有排名。

Args:
group (ProcessGroup)：获取所有排名的 ProcessGroup。

返回：
按组排名顺序排列的全局排名列表。
"""
return list(_world.pg_group_ranks[group].keys())</font></font></font></div>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取组大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">获取指定组的全球大小。</span>
    <span class="k">if</span> <span class="n">群组</font></font></font></span> <span class="ow">is</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n">WORLD</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">默认页面</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">()</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">()</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取按名称获取组大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n">_resolve_process_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">()</span>


<span class="k">定义</font></font></font></span> <span class="nf">_resolve_group_name_by_ranks_and_tag</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
    <span class="c1"># TODO(yifu): 在 ranks + tag 不再受支持后删除此函数</span>
    <span class="c1"># 功能性集体进程组的标识符</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n">_find_pg_by_ranks_and_tag</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="o">.</span><span class="n">group_name</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">检查参数 `param_name` 是否为单个张量。</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">无效的函数参数。期望参数 `</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">`of type torch.Tensor`</span>
<span class="s2">但是得到了</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">)</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">`而不是。`</span>
        <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">检查参数 `param_name` 是否为张量列表。</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">无效的函数参数。期望参数 `</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</span>
<span class="s2">但是得到了</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">)</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">`而不是。`</span>
        <span class="p">)</span>
    <span class="k">如果...否则</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">所有</font></font></font></span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">无效的函数参数。期望参数 `</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">` 的类型为 List[torch.Tensor]</span>
<span class="s2">但是得到了</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">)</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">具有类型元素的</font></font></font></span><span class="si">{</span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span><span class="w"> </span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</span><span class="p">]</span><span class="si">}</span><span class="s2">."""</span>
        <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</span><span class="p">:</span>
        <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</span><span class="p">(</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">,</span>
    <span class="n">全球排名</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组排名</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">返回全局</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔值</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
<span class="p">)</span> <span class="o">翻译</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">辅助方法，用于接受全局排名或组排名，并生成组排名。</span>

<span class="sd">如果 'return_global' 为 true，则生成全局排名而不是组排名。</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">组排名</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">全球排名</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不能同时指定 group_rank 和 global_rank</span><span class="p">)</span>
        <span class="n">全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取全球排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">全球排名</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"必须指定全球排名或群组排名"</span><span class="p">)</span>
        <span class="n">组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span> <span class="k">if</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组排名</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_检查非自身排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名类型</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">()</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">无效</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名类型</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名：</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名类型</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名不应与 "</span>
            <span class="s2">"当前进程的排名。"</span>
        <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为可迭代对象</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</font></font></font></span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span><span class="p">:</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">)</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</span><span class="p">,)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
    <span class="n">最后的数据类型</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">for</span> <span class="n">张量</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">地图</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为可迭代对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)):</span>
        <span class="n">张量数据类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="o">.</span><span class="n">dtype</span>
        <span class="c1">复杂类型及其元素类型可以混合</span>
        <span class="k">if</span> <span class="n">张量数据类型</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</span><span class="p">:</span>
            <span class="n">张量数据类型</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">float32</span> <span class="k">if</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量数据类型</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">complex64</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">complex128</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">最后的数据类型</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">最后的数据类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量数据类型</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">最后的数据类型</font></font></font></span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量数据类型</span><span class="p">:</span>
                <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                    <span class="s2">无效使用不同数据类型的张量</span>
                    <span class="sa">f</span><span class="s2">"找到"</font></font></font></span><span class="si">{</span><span class="n">last_dtype</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_检查操作</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"检查 ``op`` 是否为 isend 或 irecv。"</span>
    <span class="k">if</span> <span class="n">操作符</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="p">[</span><span class="n">isend</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"无效的 ``op``。期望 ``op`` "</span>
            <span class="s2">"为 ``torch.distributed.isend`` 类型或 "</span>
            <span class="s2">"``torch.distributed.irecv``。"</span>
        <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_检查 P2P 操作列表</font></font></font></span><span class="p">(</span><span class="n">p2p_op_list</span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">检查`p2p_op_list`是否为 P2POp 实例的列表。</span>

<span class="sd">此外，还需检查所有操作使用的是同一个组。</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p2p_op_list</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">所有</span><span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">p2p 操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">P2P 流</font></font></font></span><span class="p">)</span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作列表</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"无效的 ``p2p_op_list``。每个操作应 "</span>
            <span class="s2">"为 ``torch.distributed.P2POp`` 类型。"</span>
        <span class="p">)</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n">p2p_op_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">所有</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">p2p_op_list</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">所有操作都需要使用相同的组。</span><span class="p">)</span>


<div class="viewcode-block" id="is_mpi_available"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def is_mpi_available() -&gt; bool:
"""检查 MPI 后端是否可用。"""
return _MPI_AVAILABLE</font></font></font></div>


<div class="viewcode-block" id="is_nccl_available"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def is_nccl_available() -&gt; bool:
检查 NCCL 后端是否可用。
返回_NCCL_AVAILABLE</font></font></font></div>


<div class="viewcode-block" id="is_gloo_available"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def is_gloo_available() -&gt; bool:
检查 Gloo 后端是否可用。
return _GLOO_AVAILABLE</font></font></font></div>


<span class="k">定义</span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">is_ucc_available
不可用</font></font></font></span><span class="p">()</span> <span class="o">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</span><span class="p">:</span>
<span class="w">    </span><span class="sd">检查 UCC 后端是否可用。</span>
    <span class="k">返回</span> <span class="n">_UCC_AVAILABLE</span>


<div class="viewcode-block" id="is_xccl_available"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def is_xccl_available() -&gt; bool:
检查 XCCL 后端是否可用。
return _XCCL_AVAILABLE</font></font></font></div>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是后端可用</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">检查后端可用性。</span>

<span class="sd">检查指定的后端是否可用以及是否支持内置后端。</span>
<span class="sd">通过函数 `Backend.register_backend` 注册第三方后端。</span>

<span class="sd">参数：</span>
<span class="sd">后端 (str)：后端名称。</span>
<span class="sd">返回：</span>
<span class="sd">bool：如果后端可用则返回 true，否则返回 false。</span>
<span class="sd">    """</span>
    <span class="c1">如果后端有 `is_backend_available` 函数，则直接返回该函数的结果。</span>
    <span class="n">可用功能</font></font></font></span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分布式</font></font></font></span><span class="p">,</span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"is_"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_可用"</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">可用功能</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可用功能</span><span class="p">()</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小写</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端列表</span>


<div class="viewcode-block" id="is_initialized"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def is_initialized() -&gt; bool:
"""检查默认进程组是否已初始化。"""
return GroupMember.WORLD 不为 None</font></font></font></div>


<div class="viewcode-block" id="is_torchelastic_launched"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def is_torchelastic_launched() -&gt; bool:
"""
检查此进程是否使用 ``torch.distributed.elastic`` (即 torchelastic) 启动

存在 ``TORCHELASTIC_RUN_ID`` 环境变量
变量用作代理以确定当前进程
启动了 torchelastic。这是一个合理的代理，因为
``TORCHELASTIC_RUN_ID`` 映射到会合 ID，该 ID 始终是
表示用于对等发现目的的工作 ID 的非空值。
"""
返回 os.getenv("TORCHELASTIC_RUN_ID") 是否不为空。</font></font></font></div>


<span class="k">定义</font></font></font></span> <span class="nf">_is_barrier_after_init</span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1">控制是否在进程组初始化后执行</span>
    <span class="c1">障碍的环境变量。默认值是 0，即没有障碍。如果您</span>
    <span class="c1">遇到这个问题设置，您可以设置</span>
    <span class="c1">`TORCH_DIST_INIT_BARRIER=1` 以添加障碍。</span>
    <span class="k">返回</font></font></font></span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取环境变量</span><span class="p">(</span><span class="s2">"TORCH_DIST_INIT_BARRIER"</span><span class="p">,</span> <span class="s2">"0"</span><span class="p">))</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</font></font></font></span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"获取由 init_process_group 创建的默认进程组。"</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已初始化</span><span class="p">():</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"默认进程组尚未初始化，"</span>
            <span class="s2">"请确保已调用 init_process_group。"</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">类型检查</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</span><span class="o">.</span><span class="n">WORLD</span>


<span class="k">定义</font></font></font></span> <span class="nf">_get_default_store</span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"获取由 init_process_group 创建的默认存储。"</span>
    <span class="k">if</span> <span class="ow">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已初始化</span><span class="p">():</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"默认进程组尚未初始化，"</span>
            <span class="s2">"请确保已调用 init_process_group。"</span>
        <span class="p">)</span>
    <span class="n">默认页面</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">默认商店</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span><span class="p">]</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认商店</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_更新默认数据库</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span> <span class="o">=</span> <span class="n">pg</span>
    <span class="n">排名</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">()</span> <span class="k">if</span> <span class="n">pg</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n">pg</span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非群组成员</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式_c10d</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置全局排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端配置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回指定进程组的后端配置。</span>

<span class="sd">参数：</span>
<span class="sd">组（ProcessGroup，可选）：要工作的进程组。</span>
<span class="sd">默认是通用主进程组。如果另一个特定组</span>
<span class="sd">指定后，调用进程必须是：attr:`group`的一部分。</span>

<span class="sd">返回：</span>
<span class="sd">给定进程组的后端配置，作为小写字符串。</span>

<span class="sd">    """</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n">pg</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无效的过程组指定</span><span class="p">)</span>
    <span class="n">backend_config</span> <span class="o">=</span> <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</span><span class="p">))</span>


<div class="viewcode-block" id="get_backend"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_backend(group: Optional[ProcessGroup] = None) -&gt; Backend:
"""
返回给定进程组的后端。

参数:
组（ProcessGroup，可选）：要工作的进程组。
默认为主流程组。如果另一个特定组
指定后，调用进程必须是：attr:`group`的一部分。

返回：
给定进程组的后端作为小写字符串。

"""
pg = group or _get_default_group()
如果 _rank_not_in_group(pg):
指定的进程组无效，请抛出 ValueError 异常
如果 pg 在 _world.pg_map 中，则 pg_store = _world.pg_map[pg]，否则 pg_store = None
返回 Backend(not_none(pg_store)[0])</font></font></font></div>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取设备的默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">])</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回给定设备的默认后端。</span>

<span class="sd">参数：</span>
<span class="sd">Union[str, torch.device]: 获取默认后端所需的设备。</span>

<span class="sd">返回：</span>
<span class="sd">给定设备的默认后端，以小写字符串形式表示。</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">):</span>
        <span class="n">设备字符串</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">设备字符串</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span>

    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认设备后端映射</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备字符串</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">后端</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"默认后端未为设备注册："</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取进程组 UID</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">尝试</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">))</span>
    <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">:</span>
        <span class="k">通过</span>
    <span class="k">if</span> <span class="n">检查 NCCL 是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">):</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">用户 ID</span>
    <span class="k">返回</span> <span class="o">-</span><span class="mi">1</span>


<span class="k">定义</font></font></font></span> <span class="nf">_get_pg_config</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回给定进程组的 pg 配置。</span>

<span class="sd">    """</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="k">返回</span> <span class="p">{</span>
        <span class="s2">pg 名称</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取进程组名称</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span>
        <span class="s2">"pg_desc"</span><span class="p">:</span> <span class="n">pg</span><span class="o">.</span><span class="n">群组描述</span><span class="p">,</span>
        <span class="s2">"后端配置"</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端配置</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span>
        <span class="s2">pg_size</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取组大小</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span>
        <span class="s2">排名</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取进程组排名</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span>
    <span class="p">}</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取所有 pg 配置</font></font></font></span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回所有进程组的 pg 配置。</span>

<span class="sd">    """</span>
    <span class="n">配置信息</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_get_pg_config</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="k">for</span> <span class="n">pg</span> <span class="ow">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">配置信息</span>


<span class="k">定义</font></font></font></span> <span class="nf">get_pg_count</span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回进程组的数量。</span>

<span class="sd">    """</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">group_count</span>


<span class="k">定义</font></font></font></span> <span class="nf">get_node_local_rank</span><span class="p">(</span><span class="n">fallback_rank</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">返回当前进程相对于节点的本地排名。</span>

<span class="sd">从语义上讲，这是一个将进程映射到设备的有用概念。</span>
<span class="sd">例如，在一个有 8 个加速器的节点上，您可以使用节点本地排名来决定</span>
<span class="sd">将进程绑定到哪个加速器设备。</span>

<span class="sd">实际上，节点本地排名的分配由 PyTorch 之外的进程启动器处理，</span>
<span class="sd">并且通过`LOCAL_RANK`环境变量进行通信。</span>

<span class="sd">Torchrun 会自动填充`LOCAL_RANK`，但其他启动器可能不会。如果未指定`LOCAL_RANK`，</span>
<span class="sd">此 API 将回退到提供的`fallback_rank`参数（如果指定），否则将引发错误。</span>
<span class="sd">意图是允许编写一个可以在单设备或多设备环境中运行而不会出现错误的应用程序。</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="s2">本地排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n">os</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">环境</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">环境</font></font></font></span><span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">本地排名</span><span class="p">])</span>
    <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">回退排名</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</span> <span class="nb">int</span><span class="p">(</span><span class="n">fallback_rank</span><span class="p">)</span>
    <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
        <span class="s2">"LOCAL_RANK 不在环境中。请考虑传递 fallback_rank 以允许`get_node_local_rank`工作，"</span>
        <span class="s2">"假设您不在多设备环境中运行，并且希望代码在本地运行。"</span>
    <span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_为所有 pgs 添加临时超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">该 API 为所有本地 PG 添加了短暂的超时扩展</span>
<span class="sd">在一个 rank 上。当第一个集体操作发出后，超时将被重置</span>
<span class="sd">在 API 调用完成后。</span>
<span class="sd">注意：目前我们仅支持为 cuda 后端设置超时。</span>
<span class="sd">注意：虽然此功能</span>
<span class="sd">在特定场景中提供灵活性，但它引入了有状态性</span>
<span class="sd">超时设置。因此，建议谨慎使用此 API</span>
<span class="sd">考虑其他方法，例如直接设置超时</span>
<span class="sd">或使用屏障集体（可以为屏障设置任何超时）</span>
<span class="sd">尽可能。</span>

<span class="sd">参数：</span>
<span class="sd">超时（timedelta）：扩展超时的增量。</span>

<span class="sd">返回：</span>
<span class="sd">无。</span>
<span class="sd">    """</span>
    <span class="k">for</span> <span class="n">pg</span> <span class="ow">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
        <span class="n">设备</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">_device_types</span>
        <span class="k">if</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
            <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">检查 NCCL 是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">):</span>
                <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加临时超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置 PG 超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">设置用户希望使用不同于默认值的超时时，给定进程组的超时时间。</span>
<span class="sd">默认值。</span>

<span class="sd">参数：</span>
<span class="sd">超时（timedelta）：用户想要设置的针对进程组操作的超时时间。默认值为 NCCL 的 10 分钟和其他后端的 30 分钟。</span>
<span class="sd">超时（timedelta）：用户想要设置的针对进程组操作的超时时间。默认值为 NCCL 的 10 分钟和其他后端的 30 分钟。</span>
<span class="sd">这是集体异步终止后的持续时间，之后进程将崩溃。</span>
<span class="sd">这是因为 CUDA 执行是异步的，继续执行用户代码不再安全。</span>
<span class="sd">失败的异步 NCCL 操作可能会导致后续 CUDA 操作在损坏的数据上运行。</span>
<span class="sd">当设置 TORCH_NCCL_BLOCKING_WAIT 时，进程将阻塞并等待此超时。</span>

<span class="sd">组（ProcessGroup，可选）：要工作的进程组。</span>
<span class="sd">默认是通用主进程组。如果另一个特定组</span>
<span class="sd">指定后，调用进程必须是：attr:`group`的一部分。</span>

<span class="sd">返回：</span>
<span class="sd">无</span>
<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无效的过程组指定</span><span class="p">)</span>
    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">)</span>
    <span class="n">设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="o">.</span><span class="n">_device_types</span>
    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</span><span class="p">()</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gloo 是否可用</span><span class="p">():</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">))</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">网格流程组 Gloo</span><span class="p">):</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">检查 NCCL 是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">):</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gloo 是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">网格流程组 Gloo</span><span class="p">):</span>
            <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"设置超时现在仅支持 nccl 或 gloo。"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">后端</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_设置默认超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>


<div class="viewcode-block" id="init_process_group"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.init_process_group">[文档]</a><span class="nd">@_exception_logger</span>
<span class="nd">@_time_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化进程组</span><span class="p">(</span>
    <span class="n">后端</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">初始化方法</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">超时时间</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">世界大小</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">整型</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">排名</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">整型</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">店铺</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组名称</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">,</span>
    <span class="n">PG 选项</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备 ID</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">初始化默认分布式进程组。</span>

<span class="sd">这也将初始化分布式包。</span>

<span class="sd">初始化进程组主要有两种方式：</span>
<span class="sd">1. 明确指定 `store`、`rank` 和 `world_size`。</span>
<span class="sd">指定 ``init_method``（一个 URL 字符串），表示如何/在哪里发现对等节点。</span>
<span class="sd">可选指定 ``rank`` 和 ``world_size``，或者将所有必需参数编码在 URL 中并省略它们。</span>
<span class="sd">如果两者都没有指定，则假定 ``init_method`` 为 "env://"。</span>

<span class="sd">如果两者都没有指定，则假定 ``init_method`` 为 "env://"。</span>


<span class="sd">参数：</span>
<span class="sd">后端（str 或 Backend，可选）：要使用的后端。根据构建时配置，有效值包括`mpi`、`gloo`、`nccl`、`ucc`或由第三方插件注册的值。</span>
<span class="sd">构建时配置，有效值包括 `mpi`、`gloo`、`nccl`、`ucc` 或一个由第三方插件注册的值。</span>
<span class="sd">`nccl`、`ucc` 或一个由第三方插件注册的值。</span>
<span class="sd">。</span>
<span class="sd">自 2.6 版本起，如果未提供 ``backend``，c10d 将使用默认后端</span>
<span class="sd">为由 `device_id` 关键字参数指定的设备类型注册</span>
<span class="sd">（如果提供）。目前已知的默认注册包括：``nccl``</span>
<span class="sd">对于 ``cuda``，对于 ``cpu`` 使用 ``gloo``。</span>
<span class="sd">如果没有提供 ``backend`` 或 ``device_id``，c10d 将在运行时机器上检测加速器并使用为该检测到的加速器注册的后端（或 ``cpu``）。</span>
<span class="sd">此字段可以提供一个小写字符串（例如，``"gloo"``）。</span>
<span class="sd">该字段可以提供一个小写字符串（例如，``"gloo"``）。</span>
<span class="sd">此字段可以提供一个小写字符串（例如，``"gloo"``）。</span>
<span class="sd">也可以通过 :class:`Backend` 属性访问（例如，</span>
<span class="sd">            ``Backend.GLOO``).</span>
<span class="sd">如果使用每台机器多个进程与 `nccl` 后端，每个</span>
<span class="sd">进程必须独占访问它所使用的每个 GPU，因为共享</span>
<span class="sd">进程间使用 GPU 可能导致死锁或 NCCL 无效使用。</span>
<span class="sd">``ucc``后端是实验性的。</span>
<span class="sd">init_method (str, 可选): 指定如何初始化进程组的 URL。默认为"env://"如果没有指定。</span>
<span class="sd">process group. 默认是 "env://" 如果没有指定。</span>
<span class="sd">``init_method`` 或 ``store`` 被指定。</span>
<span class="sd">与 ``store`` 互斥。</span>
<span class="sd">world_size (int, 可选): 参与作业的进程数。</span>
<span class="sd">如果指定了 ``store``，则必须提供。</span>
<span class="sd">rank（int，可选）：当前进程的排名（它应该是一个介于 0 和 ``world_size``-1 之间的数字）。</span>
<span class="sd">number between 0 and ``world_size``-1）。</span>
<span class="sd">                              Required if ``store`` is specified.</span>
<span class="sd">store（Store，可选）：所有工作者可访问的键/值存储，用于</span>
<span class="sd">交换连接/地址信息。</span>
<span class="sd">与 `init_method` 互斥。</span>
<span class="sd">超时（timedelta，可选）：对操作执行的超时时间</span>
<span class="sd">进程组。默认值为 NCCL 的 10 分钟和其他后端的 30 分钟。</span>
<span class="sd">这是集体异步终止后的持续时间，之后进程将崩溃。</span>
<span class="sd">这是因为 CUDA 执行是异步的，继续执行用户代码不再安全。</span>
<span class="sd">失败的异步 NCCL 操作可能会导致后续 CUDA 操作在损坏的数据上运行。</span>
<span class="sd">当设置 TORCH_NCCL_BLOCKING_WAIT 时，进程将阻塞并等待此超时。</span>

<span class="sd">group_name（str，可选，已弃用）：组名。此参数将被忽略</span>
<span class="sd">pg_options（ProcessGroupOptions，可选）：进程组选项</span>
<span class="sd">在构建特定进程组时需要指定哪些附加选项</span>
<span class="sd">目前，我们支持的是 ``ProcessGroupNCCL.Options`` 选项，用于 ``nccl`` 后端，可以指定 ``is_high_priority_stream`` 以确保</span>
<span class="sd">我们支持的是 ``ProcessGroupNCCL.Options`` 选项，用于 ``nccl`` 后端，可以指定 ``is_high_priority_stream`` 以确保</span>
<span class="sd">可以指定 ``is_high_priority_stream`` 以确保</span>
<span class="sd">nccl 后端可以抓取高优先级的 cuda 流，当有计算内核等待时。</span>
<span class="sd">对于配置 nccl 的其他可用选项，请参阅。</span>
<span class="sd">请见 https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/api/types.html#ncclconfig-t</span>
<span class="sd">device_id（torch.device，可选）：一个单独的、特定的设备。</span>
<span class="sd">将此进程绑定到，允许针对后端特定</span>
<span class="sd">优化。目前这有两个效果，仅在</span>
<span class="sd">NCCL：通信器立即形成（调用）</span>
<span class="sd">立即调用 `ncclCommInit*` 而不是正常的延迟</span>
<span class="sd">调用)和子组将使用`ncclCommSplit`以避免创建组的额外开销。如果您想尽早了解 NCCL 初始化错误，也可以使用此字段。</span>
<span class="sd">如果可能，则可以使用此方法避免创建组的额外开销。如果您想尽早了解 NCCL 初始化错误，也可以使用此字段。</span>
<span class="sd">如果想尽早了解 NCCL 初始化错误，您也可以使用此字段。</span>
<span class="sd">。</span>

<span class="sd">.. 注意:: 要启用 ``backend == Backend.MPI``，PyTorch 需要从源代码构建</span>
<span class="sd">在支持 MPI 的系统上。</span>

<span class="sd">.. 注意:: 多个后端支持是实验性的。当前如果没有指定后端，</span>
<span class="sd">则将创建 ``gloo`` 和 ``nccl`` 后端。``gloo`` 后端</span>
<span class="sd">将用于具有 CPU 张量的集体，而 ``nccl`` 后端将被使用</span>
<span class="sd">用于具有 CUDA 张量的集体。可以通过传递一个字符串来指定自定义后端，格式为 ":,:"，例如</span>
<span class="sd">"cpu:gloo,cuda:custom_backend"。</span>
<span class="sd">"cpu:gloo,cuda:custom_backend"。</span>

<span class="sd">    """</span>

    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>

    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span>
    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PostgreSQL 初始化方法</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n">WORLD</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">尝试两次初始化默认进程组！</span><span class="p">)</span>

    <span class="n">从 justknobs 设置 PyTorch 分布式环境</span><span class="p">()</span>

    <span class="c1"># 在导入顺序中，某些 trace_rules 函数可能会被评估</span>
    <span class="c1"># 在导入阶段，这些函数可能不会正确地</span>
    <span class="c1"># 添加与分布式相关的规则，因为存在导入循环依赖。</span>
    <span class="c1">我们需要在运行时清除 lru_cache 以确保正确性</span>
    <span class="c1">这些 trace_rules 的数量。</span>
    <span class="c1">#</span>
    <span class="c1"># 由于此 API 必须在编译所有分布式代码之前调用，</span>
    <span class="c1">清除这里的缓存应该是安全的。</span>
    <span class="k">如果</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch._dynamo</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">模块</span><span class="p">:</span>
        <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">_dynamo</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">跟踪规则</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清除 lru 缓存</span><span class="p">()</span>

    <span class="k">断言</font></font></font></span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化方法</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">"不能同时指定初始化方法和存储。"</span>
    <span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"使用 store 时，world_size 必须为正数"</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">≥</font></font></font></span> <span class="mi">0</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"使用 store 时，rank 必须为非负数"</span>
    <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化方法</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">初始化方法</span> <span class="o">=</span> <span class="s2">"env://"</span>

    <span class="c1"># 如果用户没有提供后端字符串，但提供了设备 ID，例如</span>
    <span class="c1"># &gt;&gt;&gt; 初始化进程组（device_id=device）</span>
    <span class="c1"># 我们尝试根据设备类型确定后端名称。</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="c1"># 第三方设备可以通过以下默认后端进行注册。</span>
        <span class="c1"># 默认映射如下。</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认设备后端映射</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">)</span>

    <span class="c1">如果我们仍然无法弄清楚，例如</span>
    <span class="c1">&gt;&gt;&gt; 初始化进程组()</span>
    <span class="c1">我们将其设置为 `undefined` 并依赖懒加载初始化。</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"未定义"</span>

    <span class="c1"># 转换字符串为 `Backend` 类型</span>
    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取默认超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>

    <span class="n">_检查有效超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">用户除非访问 c10d 内部，否则无法看到组名。</span>
<span class="sd">这意味着我们可以忽略他们提供的值，因为这些值没有以公开的方式暴露。</span>
<span class="sd">因为它们没有以公开的方式暴露，所以我们忽略他们提供的值。</span>
<span class="sd">    """</span>
    <span class="n">group_name</span> <span class="o">=</span> <span class="n">_process_group_name</span><span class="p">([],</span> <span class="n">使用哈希名称</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">MPI</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">对于 MPI 后端，world_size（</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">) 和排名 (</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)</span>
                <span class="s2">"被忽略，因为它们是由 "</span>
                <span class="s2">"MPI 运行时分配的。"</span>
            <span class="p">)</span>

        <span class="n">默认页面</font></font></font></span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">新流程组助手</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">[]</span>
            <span class="n">后端</span><span class="p">,</span>
            <span class="n">存储</font></font></font></span><span class="p">(),</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">占位符值，因为存储不能为空</span>
            <span class="n">群组名称</span><span class="p">,</span>
            <span class="n">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">,</span>
            <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 pg</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_更新默认数据库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">兼容旧版 API</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">集合迭代器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">预约</span><span class="p">(</span>
                <span class="n">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化方法</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
            <span class="p">)</span>
            <span class="n">店铺</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">下一</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合迭代器</span><span class="p">)</span>
            <span class="n">店铺</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>

            <span class="c1">使用 PrefixStore 以避免意外覆盖由键</span>
            <span class="c1">多租户存储的情况下，不同的系统（例如 RPC）。</span>
            <span class="n">存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 pg</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</span><span class="p">)</span>

        <span class="n">默认页面</font></font></font></span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">新流程组助手</span><span class="p">(</span>
            <span class="n">世界大小</span><span class="p">,</span>
            <span class="n">排名</span><span class="p">,</span>
            <span class="p">[]</span>
            <span class="n">后端</span><span class="p">,</span>
            <span class="n">店铺</span><span class="p">,</span>
            <span class="n">群组名称</span><span class="p">,</span>
            <span class="n">后端选项</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PG 选项</span><span class="p">,</span>
            <span class="n">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">,</span>
            <span class="n">设备 ID</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">,</span>
            <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 pg</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_更新默认数据库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span><span class="p">)</span>

    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">忽略索引</span>
        <span class="n">i</span><span class="p">:</span> <span class="n">i</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</font></font></font></span><span class="p">())</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 类型：忽略[已定义]</span>
    <span class="p">}</span>
    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">默认 PostgreSQL 初始化方法</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化方法</span>

    <span class="n">旧钩子</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常处理钩子</span>
    <span class="n">异常钩子前缀</font></font></font></span> <span class="o">=</span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"[排名"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span><span class="si">}</span><span class="s2">]"</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式异常处理钩子</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</span><span class="p">):</span>
        <span class="n">旧的 stderr</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准错误</span>
        <span class="n">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准错误</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">缓冲区</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入/输出</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">尝试</span><span class="p">:</span>
            <span class="n">旧钩子</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</span><span class="p">)</span>
        <span class="k">最后</span><span class="p">:</span>
            <span class="n">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准错误</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">旧的 stderr</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">缓冲区</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取值</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">"</span><span class="se">输入文本翻译为简体中文为：\n</font></font></font></span><span class="s2">"</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">连接</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">异常处理钩子前缀</font></font></font></span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">"</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n">s</span> <span class="o">!=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">请提供需要翻译的文本</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">请提供需要翻译的文本</font></font></font></span> <span class="k">for</span> <span class="n">s</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2">"</span><span class="se"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准错误输出</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">写</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">)</span>
        <span class="n">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准错误输出</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清空</span><span class="p">()</span>

    <span class="n">系统模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常处理钩子</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分布式异常处理钩子</span>

    <span class="k">如果</span> <span class="n">_is_barrier_after_init</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 防止在从该方法返回时出现问题的障碍</span>
        <span class="c1">处理包括全局变量（如有）在内的进程组</span>
        <span class="c1">正确地在所有等级上。</span>
        <span class="c1"># 更新 2023 年 4 月：对于大规模运行，这个障碍（尤其是基于存储的）</span>
        <span class="c1"># 障碍可能代价高昂且/或无法扩展。此外，在许多情况下，</span>
        <span class="c1">这些障碍可能是不必要的，因为绿色 CI 已经证明</span>
        <span class="c1">移除后。已添加环境变量 `TORCH_DIST_INIT_BARRIER`，当设置为 1 时才启用此障碍。</span>
        <span class="c1">仅在初始化 ProcessGroup 后执行屏障。</span>
        <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试</span><span class="p">(</span>
            <span class="s2">由于 "Performing barrier after ProcessGroup initialization since "</span>
            <span class="s2">"TORCH_DIST_INIT_BARRIER = 1"</span>
        <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">MPI</span><span class="p">:</span>
            <span class="c1"># MPI 后端不使用 store。</span>
            <span class="n">障碍</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 由于 barrier()使用了多个默认设备，这里使用基于 store 的 barrier()。</span>
            <span class="c1"># 默认设备会导致 NCCL 内部状态混乱。</span>
            <span class="n">基于商店的屏障</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span></div>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取分割源</span><span class="p">(</span><span class="n">pg</span><span class="p">):</span>
    <span class="n">分割从</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">如果</font></font></font></span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span><span class="p">:</span>
        <span class="n">分割从</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span><span class="p">)</span>
    <span class="k">如果...否则</font></font></font></span> <span class="n">pg</span> <span class="ow">is</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span><span class="p">:</span>
        <span class="k">尝试</span><span class="p">:</span>
            <span class="n">分割从</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">))</span>
        <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">:</span>
            <span class="c1">与此后端无关联的 CUDA 设备</span>
            <span class="k">通过</span>

    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持分割</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="c1">如有必要，通过剥皮工艺找到可分割的后端</span>
    <span class="c1">将我们可能包装的过程组中的包装器分组</span>
    <span class="k">当</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_GLOO 可用</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组包装器</span><span class="p">):</span>
        <span class="n">分割从</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包裹的页面</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">新流程组助手</span><span class="p">(</span>
    <span class="n">组大小</span><span class="p">,</span>
    <span class="n">群组排名</span><span class="p">,</span>
    <span class="n">全局组内排名</span><span class="p">,</span>
    <span class="n">后端</span><span class="p">,</span>
    <span class="n">店铺</span><span class="p">,</span>
    <span class="n">群组名称</span><span class="p">,</span>
    <span class="n">后端选项</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">超时时间</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">pg_tag</span><span class="o">=</span><span class="kc">无</span><span class="p">,</span>
    <span class="n">设备 ID</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">创建一个新的分布式进程组。</span>

<span class="sd">此函数必须由全局组中的所有进程调用，即使</span>
<span class="sd">调用进程不属于新创建的组。在这种情况下，</span>
<span class="sd">该函数返回 GroupMember.NON_GROUP_MEMBER。</span>

<span class="sd">当默认组中的 global_ranks_in_group 为空列表时，将调用此函数。</span>
<span class="sd">    """</span>
    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>

    <span class="k">如果</font></font></font></span> <span class="n">group_name</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span><span class="p">():</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"指定的群组名称已存在，请使用不同的群组名称"</span>
            <span class="s2">"已创建，请使用不同的群组名称"</span>
        <span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span> <span class="o">==</span> <span class="s2">"cpu"</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"init_process_group 设备 ID 参数必须是一个具有索引的加速器"</span>
        <span class="p">)</span>

    <span class="c1"># 注意：_new_process_group_helper 只从 init_process_group 调用，该函数始终提供超时值</span>
    <span class="n">_检查有效超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n">pg_tag</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="p">[</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="c1">使用相同的标签和排名设置将产生相同的底层 PG</span>
        <span class="n">已存在的组</font></font></font></span> <span class="o">=</span> <span class="n">_find_pg_by_ranks_and_tag</span><span class="p">(</span><span class="n">pg_tag</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局组内排名</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">现有组</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">前缀存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">现有组</span><span class="p">]</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">现有组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</span>

    <span class="n">群组描述</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"未定义"</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span>

    <span class="c1">如果我们正在创建默认组，则组等级列表为空。</span>
    <span class="n">是否为默认组</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局组内排名</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># nccl 及可能的其他后端允许创建</span>
    <span class="c1">基于现有沟通者，可节省</span>
    <span class="c1">初始化时间。由于惰性初始化，</span>
    <span class="c1">在某些后端中，我们必须要小心，只有当我们知道默认的 PG 已经开始了通信者初始化时，我们才进行拆分。</span>
    <span class="c1">我们知道这一点，如果我们已经将设备 ID 绑定到了默认的 pg（急切初始化）。</span>
    <span class="c1">我们知道这一点，如果我们已经将设备 ID 绑定到了默认的 pg（急切初始化）。</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已初始化</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span><span class="p">:</span>
        <span class="n">分割从</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取分割源</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">分割从</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="c1">如果这是一个子组（即已指定 group_ranks），</span>
    <span class="c1">我们检查当前进程是否是新的组成员。</span>
    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否为默认组</span><span class="p">:</span>
        <span class="n">全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">()</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局组内排名</span><span class="p">:</span>
            <span class="c1">如果我们使用 `ncclCommSplit`（或类似的分割）来创建通信器，我们需要在新的组父组中的所有等级上调用 `ncclCommSplit`，即使那些不在新组中的等级也是如此。</span>
            <span class="c1"># other APIs) 来创建通信器，我们将会在新的组父组中的所有等级上调用 `ncclCommSplit`，即使那些不在新组中的等级也是如此。</span>
            <span class="c1"># call `ncclCommSplit` on *all* ranks in this new group's parent group, even those not in the new group.  This is</span>
            <span class="c1"># necessary to ensure that the communicator is properly initialized for all ranks.</span>
            <span class="c1">NCCL API 的一个要求，否则我们会得到</span>
            <span class="c1">不同步。</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</span><span class="p">:</span>
                <span class="n">分割从</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">执行无颜色分割</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span><span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非群组成员</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="n">前缀存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“”</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</span><span class="p">)</span>
    <span class="c1">PG 的后端将在稍后根据 BackendConfig 中的内容进行设置。</span>
    <span class="c1">并且超时设置在每个后端选项中。</span>
    <span class="n">pg</span><span class="p">:</span> <span class="n">进程组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">(</span>
        <span class="n">prefix_store</span><span class="p">,</span>
        <span class="n">群组排名</span><span class="p">,</span>
        <span class="n">组大小</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">backend_config</span> <span class="o">=</span> <span class="n">后端配置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
    <span class="c1"># 设置当传入单个后端时的默认后端。</span>
    <span class="k">如果</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">逗号</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="s2">":"</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">):</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型映射</font></font></font></span><span class="p">,</span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"未知后端类型"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未定义</span><span class="p">:</span>
            <span class="c1"># 当前当后端为 UNDEFINED 时，同时使用 ``gloo`` 和 ``nccl`` 后端</span>
            <span class="c1">如果有 CUDA 可用，我们将使用 nccl 或默认的 gloo</span>
            <span class="c1">后端，这样我们就可以在 ProcessGroup 中正确调用 getDefaultBackend</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n">NCCL</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取设备后端映射</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span><span class="p">():</span>
                <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">NCCL</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">GLOO</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型映射</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">])</span>
    <span class="c1">为了正确调用 pg._has_hooks()，我们应该设置默认后端</span>
    <span class="c1">当传入多个后端时</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n">NCCL</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span><span class="p">():</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">NCCL</span><span class="p">)</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_插件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
            <span class="n">自定义后端</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">下一</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_插件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">()))</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义后端</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备后端映射</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span><span class="p">():</span>
                <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">GLOO</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">:</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">绑定设备 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span>
    <span class="n">后端类</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式_c10d</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span>
    <span class="k">for</span> <span class="n">设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取设备后端映射</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">():</span>
        <span class="c1">在默认存储中，使用组名作为前缀</span>
        <span class="c1">一个门店可以被多个组重复使用。</span>
        <span class="n">后端前缀存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“”</span><span class="p">,</span> <span class="n">prefix_store</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">MPI</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否支持 MPI</span><span class="p">():</span>
                <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
                    <span class="s2">“分布式包未内置 MPI。”</span>
                    <span class="s2">"MPI 仅在你从"</span>
                    <span class="s2">"已安装 MPI 的主机源代码构建 PyTorch 时包含。"</span>
                <span class="p">)</span>
            <span class="n">backend_class</span> <span class="o">=</span> <span class="n">ProcessGroupMPI</span><span class="o">.</span><span class="n">创建</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局组内排名</span><span class="p">)</span>
            <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">MPI</span>
            <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</span><span class="p">:</span>
                <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非群组成员</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
            <span class="c1">创建具有准确排名和大小的新的进程组</span>
            <span class="k">如果</font></font></font></span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">pg</span> <span class="o">=</span> <span class="n">流程组</span><span class="p">(</span>
                    <span class="n">后端前缀存储</span><span class="p">,</span>
                    <span class="n">后端类</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">(),</span>
                    <span class="n">后端类</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型</span><span class="p">)</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">GLOO</span><span class="p">:</span>
            <span class="c1"># TODO: 在延迟初始化支持后删除此检查</span>
            <span class="c1"># 如果 pg_options 不为 None:</span>
            <span class="c1">#     raise RuntimeError("GLOO 选项不受支持")</span>
            <span class="n">backend_class</span> <span class="o">=</span> <span class="n">网格流程组 Gloo</span><span class="p">(</span>
                <span class="n">后端前缀存储</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
            <span class="p">)</span>
            <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">GLOO</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">NCCL</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查 NCCL 是否可用</span><span class="p">():</span>
                <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分布式包未内置 NCCL</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端选项</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端选项</font></font></font></span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">),</span> <span class="p">(</span>
                    <span class="s2">"期望 backend_options 参数为 ProcessGroupNCCL.Options 类型"</span>
                <span class="p">)</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_超时</font></font></font></span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">:</span>
                    <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                        <span class="s2">"已指定 backend_options._timeout，"</span>
                        <span class="s2">"但是 timeout 参数有一个默认值，它将始终覆盖它。"</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># NCCL 的默认 backend_options</span>
                <span class="n">后端选项</font></font></font></span> <span class="o">=</span> <span class="n">ProcessGroupNCCL</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">()</span>
                <span class="n">后端选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">高优先级流</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
            <span class="n">后端选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>

            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</span><span class="p">:</span>
                <span class="n">后端选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</span>
                <span class="n">后端选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割颜色</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_处理组颜色</span><span class="p">(</span>
                    <span class="n">global_ranks_in_group</span>
                <span class="p">)</span>
            <span class="n">后端选项</span><span class="o">.</span><span class="n">global_ranks_in_group</span> <span class="o">=</span> <span class="n">global_ranks_in_group</span>
            <span class="n">后端选项</span><span class="o">.</span><span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span>
            <span class="n">backend_class</span> <span class="o">=</span> <span class="n">ProcessGroupNCCL</span><span class="p">(</span>
                <span class="n">后端前缀存储</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端选项</span>
            <span class="p">)</span>
            <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">NCCL</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n">UCC</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">is_ucc_available
不可用</font></font></font></span><span class="p">():</span>
            <span class="c1"># TODO: 一旦 UCC 插件完全弃用，请删除</span>
            <span class="c1"># 从上面的 elif 条件中删除 is_ucc_available()并抛出异常</span>
            <span class="c1">如果 is_ucc_available()返回 false 则抛出 RuntimeError。</span>

            <span class="n">backend_class</span> <span class="o">=</span> <span class="n">UCC 进程组</span><span class="p">(</span>
                <span class="n">后端前缀存储</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
            <span class="p">)</span>
            <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">UCC</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">XCCL</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否支持 xccl</span><span class="p">():</span>
                <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分布式包未内置 XCCL</span><span class="p">)</span>
            <span class="n">backend_class</span> <span class="o">=</span> <span class="n">ProcessGroupXCCL</span><span class="p">(</span>
                <span class="n">后端前缀存储</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span>
            <span class="p">)</span>
            <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">XCCL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_插件</span><span class="p">,</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">未知 c10d 后端类型</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>

            <span class="n">后端插件</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_插件</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</span><span class="p">()]</span>
            <span class="n">创建者函数</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端插件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建者函数</span>
            <span class="n">扩展 API</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端插件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">扩展 API</span>
            <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义</span>

            <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">扩展 API</span><span class="p">:</span>
                <span class="n">backend_class</span> <span class="o">=</span> <span class="n">创建者函数</span><span class="p">(</span>
                    <span class="n">后端前缀存储</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">分布式后端选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式后端选项</span><span class="p">()</span>
                <span class="n">dist_backend_opts</span><span class="o">.</span><span class="n">存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端前缀存储</span>
                <span class="n">dist_backend_opts</span><span class="o">.</span><span class="n">组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组排名</span>
                <span class="n">dist_backend_opts</span><span class="o">.</span><span class="n">组大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span>
                <span class="n">dist_backend_opts</span><span class="o">.</span><span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
                <span class="n">dist_backend_opts</span><span class="o">.</span><span class="n">群组 ID</span> <span class="o">=</span> <span class="n">group_name</span>
                <span class="n">dist_backend_opts</span><span class="o">.</span><span class="n">global_ranks_in_group</span> <span class="o">=</span> <span class="n">global_ranks_in_group</span>

                <span class="n">backend_class</span> <span class="o">=</span> <span class="n">创建者函数</font></font></font></span><span class="p">(</span><span class="n">dist_backend_opts</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端选项</span><span class="p">)</span>

        <span class="c1"># 为 gloo 和 nccl 后端设置序列号。</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">GLOO</span><span class="p">:</span>
            <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">网格流程组 Gloo</span><span class="p">)</span>
            <span class="n">后端类</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为组设置序列号</span><span class="p">()</span>
        <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">NCCL</span><span class="p">:</span>
            <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">)</span>
            <span class="n">后端类</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为组设置序列号</span><span class="p">()</span>

        <span class="c1">如果类型是 ProcessGroup 的子类，则立即返回此进程组</span>
        <span class="c1"># TODO: 对于 PythonProcessGroups，这默认为旧行为，会覆盖</span>
        <span class="c1"># ProcessGroup 实例</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">派生类</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">):</span>
            <span class="n">pg</span> <span class="o">=</span> <span class="n">backend_class</span>  <span class="c1"># 类型：忽略[赋值]</span>
            <span class="k">断开</span>

        <span class="c1">当设置 TORCH_DISTRIBUTED_DEBUG 时，为支持的 PGs 处理组包装初始化</span>
        <span class="k">如果</span> <span class="p">(</span>
            <span class="n">后端字符串</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n">GLOO</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n">NCCL</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">UCC</span><span class="p">]</span>
            <span class="ow">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端字符串</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_插件</span>
        <span class="p">):</span>
            <span class="c1"># 在调试模式且 GLOO 可用时，用 PG 包装器包裹</span>
            <span class="c1"># 启用增强的集体检查以提高调试性。</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取调试级别</font></font></font></span><span class="p">()</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试等级</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">详细信息</span><span class="p">:</span>
                <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_GLOO 可用</span><span class="p">:</span>
                    <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">"将 TORCH_DISTRIBUTED_DEBUG 设置为 DETAIL，但</span>
<span class="sd">GLOO 不可用。请使用 GLOO 进行构建，</span>
<span class="sd">以在调试模式下创建包装进程组，</span>
<span class="sd">以帮助集体不同步调试。"</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">backend_class</span> <span class="o">=</span> <span class="n">创建进程组包装器</span><span class="p">(</span>
                        <span class="n">包装的 PG</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</span><span class="p">,</span>
                        <span class="n">存储前缀</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">,</span>
                        <span class="n">店铺</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端前缀存储</span><span class="p">,</span>
                        <span class="n">排名</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</span><span class="p">,</span>
                        <span class="n">世界大小</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">,</span>
                        <span class="n">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="c1">当所有 get_device_backend_map 值都相同时，仅注册单个后端</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取设备后端映射</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取设备后端映射</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
                <span class="n">pg</span><span class="o">.</span><span class="n">注册后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</span><span class="p">)</span>

            <span class="c1"># 跳出外部循环以不创建更多后端</span>
            <span class="k">断开</span>

        <span class="n">pg</span><span class="o">.</span><span class="n">注册后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</span><span class="p">)</span>

    <span class="c1">设置 group_name 和 group_dsec 为后端</span>
    <span class="k">断言</font></font></font></span> <span class="n">group_name</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="n">pg</span><span class="o">.</span><span class="n">设置群组名称</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">)</span>
    <span class="n">pg</span><span class="o">.</span><span class="n">设置群组描述</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持分割</span><span class="p">:</span>
        <span class="n">贪婪后端</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">)</span>
        <span class="n">贪婪后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">主动连接单个设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">)</span>

    <span class="c1">更新全局状态</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">prefix_store</span><span class="p">)</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_name</span>
    <span class="n">_注册进程组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">,</span> <span class="n">pg</span><span class="p">)</span>

    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</font></font></font></span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</span><span class="p">)</span>
    <span class="c1"># "" 是用户 PG 的默认标签</span>
    <span class="k">如果</font></font></font></span> <span class="n">pg_tag</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="p">[</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">pg_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">ptd:</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">,</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空列表</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pg_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"用户："</span><span class="si">{</span><span class="n">pg_tag</span><span class="si">}</span><span class="s2">"</span>

    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">pg_tag</span><span class="p">,</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空列表</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_tag</span>
    <span class="k">返回</font></font></font></span> <span class="n">pg</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">销毁进程组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">销毁指定的进程组，并反初始化分布式包。</span>

<span class="sd">参数：</span>
<span class="sd">group（进程组，可选）：要销毁的进程组，如果</span>
<span class="sd">group.WORLD 被指定，则销毁所有进程</span>
<span class="sd">默认组以及其它组将被销毁</span>
<span class="sd">将被销毁。</span>
<span class="sd">    """</span>
    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非群组成员</span><span class="p">:</span>
        <span class="k">返回</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">组成员</span><span class="o">.</span><span class="n">WORLD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">群组</span>

    <span class="k">断言</font></font></font></span> <span class="n">pg</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无效的过程组指定</span><span class="p">)</span>

    <span class="c1">当用户在 Python 上注册 onCompletion 钩子时，这些钩子将在主线程之外的线程上运行。</span>
    <span class="c1">然而，ProcessGroup 析构函数会等待该线程。但是，析构函数可能在 Python 解释器退出后完成。</span>
    <span class="c1">之后，为了获取 Python 钩子的 GIL，可能会导致崩溃。</span>
    <span class="c1">因此，在 Python 钩子中获取 GIL 可能会导致崩溃。</span>
    <span class="c1">我们可以运行钩子时恢复解释器，或者保持主解释器不变</span>
    <span class="c1"># 存活直到所有工作和钩子完成。当前实现这样做。</span>
    <span class="c1">因此，我们在此显式调用 _wait_for_pending_works() 以等待</span>
    <span class="c1">等待挂起的钩子完成。</span>
    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">)</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进程组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</span> <span class="n">pg</span><span class="o">.</span><span class="n">_has_hooks</span><span class="p">():</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">_wait_for_pending_works</span><span class="p">()</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</span><span class="p">:</span>
        <span class="c1"># 关闭所有后端，按照 pg 名称的顺序。按顺序关闭是因为</span>
        <span class="c1"># 在某些版本的 NCCL 中，ncclCommAbort() 是一个 '集体' 调用。</span>
        <span class="k">for</span> <span class="n">停止 PostgreSQL</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序</span><span class="p">(</span>
            <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="p">[</span><span class="n">x</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n">reverse</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
        <span class="p">):</span>
            <span class="n">停止 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</span><span class="p">()</span>

        <span class="n">_更新默认数据库</font></font></font></span><span class="p">(</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_注销所有进程组</span><span class="p">()</span>

        <span class="c1">当进程组没有显式名称（只有 WORLD（默认））</span>
        <span class="c1">进程组可以有一个显式名称），我们使用全局 _world.group_count</span>
        <span class="c1"># 生成名称。在销毁时我们需要重置计数器。</span>
        <span class="c1">允许在重新创建进程时生成一致的价值</span>
        <span class="c1"># 一些训练器从故障中恢复后，我们才重置组</span>
        <span class="c1">#</span>
        <span class="c1"># 只有在 WORLD 被销毁时才重置，因为如果我们在 WORLD</span>
        <span class="c1">处理组状态良好，我们目前没有处理故障。</span>
        <span class="n">_世界</span><span class="o">.</span><span class="n">group_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">关闭</span><span class="p">()</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">如果</font></font></font></span> <span class="n">pg</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
            <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                <span class="s2">"一些合并的集体尚未启动，当 "</span>
                <span class="s2">"进程组被销毁。它们将被清理。"</span>
            <span class="p">)</span>
            <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>

        <span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">尝试</span><span class="p">:</span>
                <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以...开头</span><span class="p">(</span><span class="s2">"ptd:"</span><span class="p">):</span>
                    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
            <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常</span><span class="p">:</span>
                <span class="k">通过</span>
        <span class="n">_注销进程组</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf">_abort_process_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">终止指定的进程组。如果给定 group.WORLD（即`None`），则包括默认进程组在内的所有进程组都将被终止。</span>
<span class="sd">终止包括默认进程组在内的所有进程组。</span>

<span class="sd">参数：</span>
<span class="sd">要终止的进程组（ProcessGroup，可选）：</span>

<span class="sd">.. 注意：此 API 为实验性 API，目前仅与 NCCL 后端兼容</span>
<span class="sd">后端。</span>

<span class="sd">.. 注意：应使用 `TORCH_NCCL_ASYNC_ERROR_HANDLING` 使用此 API</span>
<span class="sd">关闭（即设置为 0）。否则，ProcessGroupNCCL 的看门狗可能会</span>
<span class="sd">自动为您处理错误或超时，包括终止进程组。</span>
<span class="sd">。</span>
<span class="sd">    """</span>
    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非群组成员</span><span class="p">:</span>
        <span class="k">返回</span>

    <span class="n">pg</span> <span class="o">=</span> <span class="n">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</span><span class="o">.</span><span class="n">WORLD</span>

    <span class="k">断言</font></font></font></span> <span class="n">pg</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"指定的进程组无效或已被销毁。"</span><span class="p">)</span>

    <span class="k">尝试</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">))</span>
    <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</span><span class="p">:</span>
        <span class="c1">在 ncclGroupStart|End 语义中中止所有后端。</span>
        <span class="c1">这确保了不同的 NCCL 通信器的中止调用不会</span>
        <span class="c1">互相死锁。</span>
        <span class="c1">https://github.com/pytorch/pytorch/issues/119797</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查 NCCL 是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">):</span>
            <span class="n">后端</span><span class="o">.</span><span class="n">_group_start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pg_to_abort</span> <span class="ow">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序</span><span class="p">(</span>
            <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="p">[</span><span class="n">x</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n">reverse</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
        <span class="p">):</span>
            <span class="n">pg_to_abort</span><span class="o">.</span><span class="n">终止</span><span class="p">()</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查 NCCL 是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">):</span>
            <span class="n">后端</span><span class="o">.</span><span class="n">_group_end</span><span class="p">()</span>

        <span class="n">_更新默认数据库</font></font></font></span><span class="p">(</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="n">_注销所有进程组</span><span class="p">()</span>

        <span class="c1">当进程组没有显式名称（只有 WORLD（默认））</span>
        <span class="c1">进程组可以有一个显式名称），我们使用全局 _world.group_count</span>
        <span class="c1"># 生成名称。在销毁时我们需要重置计数器。</span>
        <span class="c1">允许在重新创建进程时生成一致的价值</span>
        <span class="c1"># 一些训练器从故障中恢复后，我们才重置组</span>
        <span class="c1">#</span>
        <span class="c1"># 只有在 WORLD 被销毁时才重置，因为如果我们在 WORLD</span>
        <span class="c1">处理组状态良好，我们目前没有处理故障。</span>
        <span class="n">_世界</span><span class="o">.</span><span class="n">group_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">终止</span><span class="p">()</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">如果</font></font></font></span> <span class="n">pg</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
            <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                <span class="s2">"一些合并的集体尚未启动，当 "</span>
                <span class="s2">"进程组被中断。它们将被清理。"</span>
            <span class="p">)</span>
            <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>

        <span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
        <span class="k">删除</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">尝试</span><span class="p">:</span>
                <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以...开头</span><span class="p">(</span><span class="s2">"ptd:"</span><span class="p">):</span>
                    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
            <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常</span><span class="p">:</span>
                <span class="k">通过</span>
        <span class="n">_注销进程组</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">)</span>


<div class="viewcode-block" id="get_rank"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_rank(group: Optional[ProcessGroup] = None) -&gt; int:
"""
返回当前进程在提供的 ``group`` 中的排名，默认情况下返回。

每个进程在分布式系统中都有一个唯一的标识符，称为 Rank。
它们总是连续的整数，范围从 0 到 world_size。
Args:

参数：
group（进程组，可选）：要工作的进程组。如果为 None，
则使用默认进程组。

返回：
进程组的排名
不是该组成员时，返回-1

"""
如果 _rank_not_in_group(group):
返回-1

default_pg = _get_default_group()
if group is None or group is GroupMember.WORLD:
return default_pg.rank()

return get_group_rank(group, default_pg.rank())</font></font></font></div>


<div class="viewcode-block" id="get_world_size"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_world_size(group: Optional[ProcessGroup] = None) -&gt; int:
"""
返回当前进程组中的进程数量。

参数:
group (ProcessGroup, 可选): 要工作的进程组。如果为 None，
默认将使用进程组。

返回：
进程组的世界大小
不是该组成员时，返回-1

"""
如果 _rank_not_in_group(group):
返回-1

返回 _get_group_size(group)</font></font></font></div>


<div class="viewcode-block" id="isend"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def isend(
tensor: torch.Tensor,
dst: Optional[int] = None,
group: 可选[ProcessGroup] = None,
tag: int = 0,
group_dst: 可选[int] = None,
) -&gt; 可选[Work]:
"""
异步发送张量。

.. 警告::
在请求完成之前修改 ``tensor`` 将导致未定义的行为。
行为。

.. 警告::
``tag`` 在 NCCL 后端中不受支持。

与 send 不同，send 是阻塞的，而 isend 允许 src == dst rank，即发送到自身。

Args:
tensor (Tensor): 要发送的张量。
dst (int): 在全局进程组中的目标 rank（无论``group``参数如何）。
group (ProcessGroup, optional): 要工作的进程组。如果为 None，
默认将使用进程组。
标签（int，可选）：用于匹配发送与远程接收的标签
group_dst（int，可选）：在 ``group`` 上的目标 rank。不能同时指定 ``dst`` 和 ``group_dst``

返回值：
分布式请求对象。
如果不是组的一部分，则为空。

"""
group = _group_or_default_group(group)
group_dst = _canonicalize_group_rank(group, dst, group_dst)
_check_single_tensor(tensor, "tensor")
if _rank_not_in_group(group):
_warn_not_in_group("isend")
返回 None

如果 tensor.is_complex():
tensor = torch.view_as_real(tensor)

return group.send([tensor], group_dst, tag)</font></font></font></div>


<div class="viewcode-block" id="irecv"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def irecv(
tensor: torch.Tensor,
src: Optional[int] = None,
group: Optional[ProcessGroup] = None,
tag: 整数 = 0,
group_src: 可选整数 = None,
) -&gt; 可选[工作]:
"""
异步接收张量。

.. 警告::
NCCL 后端不支持 ``tag``。

与 recv 不同，recv 是阻塞的，irecv 允许 src == dst rank，即从自身接收。

Args:
tensor (Tensor): 要填充接收到的数据的张量。
src (int, 可选): 在全局进程组上的源排名（无论 ``group`` 参数如何）。
如果未指定，将从任何进程接收。
group（进程组，可选）：要工作的进程组。如果为 None，则使用默认进程组。
默认进程组将被使用。
tag（整数，可选）：用于匹配接收与远程发送的标签
group_src（整数，可选）：在``group``上的目标 rank。不能同时指定``src``和``group_src``。

返回值：
分布式请求对象。
无，如果不是组的一部分。

"""
_检查单个张量(tensor, "tensor")
如果_rank_not_in_group(group)
_警告不在组("irecv")
返回 None

if tensor.is_complex():
tensor = torch.view_as_real(tensor)

group = _group_or_default_group(group)
if src is None and group_src is None:
return group.recv_anysource([tensor], tag)
else:
group_src = _canonicalize_group_rank(group, src, group_src)
return group.recv([tensor], group_src, tag)</font></font></font></div>


<div class="viewcode-block" id="send"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@_异常记录器
def 发送(
tensor: torch.Tensor,
dst: Optional[int] = None,
group: 可选[ProcessGroup] = None,
tag: int = 0,
group_dst: 可选[int] = None,
) -&gt; None:
"""
同步发送张量。

.. 警告::
``tag`` 在 NCCL 后端中不受支持。

Args:
tensor (Tensor): 要发送的张量。
dst (int): 全局进程组中的目标 rank（无论``group``参数如何）。
目标 rank 不应与当前进程的 rank 相同。
group（进程组，可选）：要工作的进程组。如果为 None，则使用默认进程组。
默认进程组将被使用。
tag（整数，可选）：匹配远程接收的标签。
group_dst（整数，可选）：在``group``上的目标 rank。同时指定``dst``和``group_dst``是无效的。

"""
group = _group_or_default_group(group)
group_dst = _canonicalize_group_rank(group, dst, group_dst)
_check_not_self_rank(group, group_dst, "destination")
work = isend(tensor, group=group, tag=tag, group_dst=group_dst)
if work is not None:
work.wait()</font></font></font></div>


<div class="viewcode-block" id="recv"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@_exception_logger
def recv(
tensor: torch.Tensor,
src: 可选[int] = None,
group: 可选[ProcessGroup] = None,
tag: 整数 = 0,
group_src: 可选[int] = None,
) -&gt; 整数:
"""
同步接收张量。

.. 警告::
NCCL 后端不支持 ``tag``。

参数:
张量（Tensor）：用于填充接收到的数据的张量。
src（int，可选）：全局进程组上的源排名（无论是否指定 group 参数）。
如果未指定，将从任何进程接收。
group（ProcessGroup，可选）：要工作的进程组。如果为 None，
默认将使用进程组。
标签（int，可选）：用于匹配接收与远程发送的标签。
group_src（int，可选）：在 ``group`` 上的目标 rank。不能同时指定 ``src`` 和 ``group_src``。
返回值：
发送者排名
-1，如果不在组内

"""
work = irecv(tensor, src=src, group=group, tag=tag, group_src=group_src)
如果工作为空：
返回-1
work.wait()
如果 src 为空：
如果 group_src 为 None：
group_src = work._source_rank()
group = _group_or_default_group(group)
_check_not_self_rank(group, group_src, "source")
src = 获取全局排名(group, group_src)
返回 src</font></font></font></div>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非法工作</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">):</span>
    <span class="k">定义</font></font></font></span> <span class="fm">__getattribute__</span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自我</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="p">[</span>
            <span class="s2">is_success</span><span class="p">,</span>
            <span class="s2">"异常"</span><span class="p">,</span>
            <span class="s2">等待</span><span class="p">,</span>
            <span class="s2">"源排名"</span><span class="p">,</span>
            <span class="s2">"_源排名"</span><span class="p">,</span>
            <span class="s2">"结果"</span><span class="p">,</span>
            <span class="s2">"同步"</span><span class="p">,</span>
        <span class="p">]</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非法调用</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在 IllegalWork 对象上</span><span class="p">)</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">合并管理器</span><span class="p">:</span>
    <span class="k">定义</font></font></font></span> <span class="fm">__init__</span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自我</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="bp">自我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>

    <span class="k">定义</font></font></font></span> <span class="nf">append</span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自我</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">:</span>
            <span class="bp">自我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</font></font></font></span><span class="p">(</span><span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自我</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">工作</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自我</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">:</span>
            <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">合并管理器</span><span class="p">(</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">异步操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">尝试合并集体或 P2P 操作时使用的上下文管理器。</span>

<span class="sd">参数：</span>
<span class="sd">组（`ProcessGroup`，可选）：要工作的进程组。如果为 None，则</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">设备（`torch.device`，可选）：默认为 None，如果后端没有`**_coalesced`实现，则设置到设备上。</span>
<span class="sd">没有后端提供的`**_coalesced`实现。</span>
<span class="sd">async_ops (`bool`, 可选): 是否合并操作为异步操作。</span>

<span class="sd">示例：</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP("no rank")</span>
<span class="sd">&gt;&gt;&gt; # 同步操作</span>
<span class="sd">        &gt;&gt;&gt; with _coalescing_manager():</span>
<span class="sd">        &gt;&gt;&gt;     for i in range(num_colls):</span>
<span class="sd">        &gt;&gt;&gt;         dist.all_reduce(tensors[i])</span>
<span class="sd">&gt;&gt;&gt; # 异步操作</span>
<span class="sd">        &gt;&gt;&gt; with _coalescing_manager(async_ops=True) as cm:</span>
<span class="sd">        &gt;&gt;&gt;     for i in range(num_colls):</span>
<span class="sd">        &gt;&gt;&gt;         dist.all_reduce(tensors[i])</span>
<span class="sd">        &gt;&gt;&gt; cm.wait()</span>

<span class="sd">.. 警告::</span>
<span class="sd">func:`_coalescing_manager` 目前不支持合并</span>
<span class="sd">使用不同归约算子的 all-reduce，例如 `ReduceOp.SUM` 混合</span>
<span class="sd">使用 `ReduceOp.PRODUCT`。</span>
<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">操作列表</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[]</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">"合并操作开始时，ProcessGroup 具有非空的操作列表"</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
        <span class="n">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">开始合并</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span>
    <span class="n">厘米</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">合并管理器</span><span class="p">()</span>
    <span class="k">产生</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">厘米</span>
    <span class="n">操作列表</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流行</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</span><span class="p">:</span>
        <span class="c1">支持快速路径合并的集体被捕获。</span>
        <span class="c1">请参阅相应集体 API 中的实现。</span>
        <span class="c1">当前支持：</span>
        <span class="c1"># - 合并 `all_reduce`</span>
        <span class="c1"># - 合并 `all_gather_into_tensor`</span>
        <span class="c1"># - 合并 `reduce_scatter_tensor`</span>
        <span class="n">op0</span> <span class="o">=</span> <span class="n">操作列表</font></font></font></span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</span>
        <span class="k">如果</font></font></font></span> <span class="n">op0</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全量归约</span><span class="p">:</span>
            <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</span><span class="p">]</span>
            <span class="n">全局减少选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">Allreduce 合并选项</span><span class="p">()</span>
            <span class="n">all_reduce_opts</span><span class="o">.</span><span class="n">减少操作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</font></font></font></span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">红操</span><span class="p">)</span>
            <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">allreduce_coalesced</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span> <span class="n">all_reduce_opts</span><span class="p">)</span>
        <span class="k">如果...否则</span> <span class="n">op0</span> <span class="o">==</span> <span class="n">all_gather_into_tensor</span><span class="p">:</span>
            <span class="n">输入</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
            <span class="n">输出</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
            <span class="k">for</span> <span class="n">操作符</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</span><span class="p">:</span>
                <span class="n">输入</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>
                <span class="n">输出</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标张量</span><span class="p">))</span>
            <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">allgather_into_tensor_coalesced</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">)</span>
        <span class="k">如果...否则</span> <span class="n">op0</span> <span class="o">==</span> <span class="n">reduce_scatter_tensor</span><span class="p">:</span>
            <span class="n">输入</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
            <span class="n">输出</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
            <span class="k">for</span> <span class="n">操作符</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</span><span class="p">:</span>
                <span class="n">输入</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>
                <span class="n">输出</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标张量</span><span class="p">))</span>
            <span class="n">reduce_opts</span> <span class="o">=</span> <span class="n">减少散布选项</span><span class="p">()</span>
            <span class="n">简化选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">减少操作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非空</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作列表</font></font></font></span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">红操</span><span class="p">)</span>
            <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">简化散列张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">简化选项</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">断言错误</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">合并管理器不支持快速路径合并</font></font></font></span><span class="si">{</span><span class="n">op0</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">，"</span>
                <span class="sa">f</span><span class="s2">yet</font></font></font></span><span class="si">{</span><span class="n">op0</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">仍然记录在操作列表中。这是 c10d 的内部错误。</span>
            <span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">:</span>
        <span class="c1"># 旧式允许每个 coll 在上下文管理器中通过 Python 绑定调用 C++对应部分</span>
        <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">结合并发</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异步操作</span><span class="p">:</span>
        <span class="n">cm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">工作</span><span class="p">)</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span>  <span class="c1"># type: ignore[possibly-undefined]</span>


<div class="viewcode-block" id="batch_isend_irecv"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.batch_isend_irecv">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批量异步发送或接收张量并返回请求列表</font></font></font></span><span class="p">(</span><span class="n">p2p_op_list</span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">P2P 流</font></font></font></span><span class="p">])</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">处理 `p2p_op_list` 中的每个操作并返回相应的请求。目前支持 NCCL、Gloo 和 UCC 后端。</span>

<span class="sd">处理 `p2p_op_list` 中的每个操作并返回相应的请求。</span>
<span class="sd">目前支持 NCCL、Gloo 和 UCC 后端。</span>

<span class="sd">参数：</span>
<span class="sd">p2p_op_list: 点对点操作列表（每个操作员的类型为）</span>
<span class="sd">``torch.distributed.P2POp``). 列表中 isend/irecv 的顺序很重要，需要与远程端的对应 isend/irecv 相匹配。</span>
<span class="sd">            matters and it needs to match with corresponding isend/irecv on the</span>
<span class="sd">            remote end.</span>

<span class="sd">返回：</span>
<span class="sd">调用相应方法返回的分布式请求对象列表</span>
<span class="sd">op 在 op_list 中。</span>

<span class="sd">示例：</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP("no rank")</span>
<span class="sd">&gt;&gt;&gt; send_tensor = torch.arange(2, 数据类型=torch.float32) + 2 * 级别</span>
<span class="sd">&gt;&gt;&gt; recv_tensor = torch.randn(2, 数据类型=torch.float32)</span>
<span class="sd">        &gt;&gt;&gt; send_op = dist.P2POp(dist.isend, send_tensor, (rank + 1) % world_size)</span>
<span class="sd">        &gt;&gt;&gt; recv_op = dist.P2POp(</span>
<span class="sd">        ...     dist.irecv, recv_tensor, (rank - 1 + world_size) % world_size</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; reqs = batch_isend_irecv([send_op, recv_op])</span>
<span class="sd">        &gt;&gt;&gt; for req in reqs:</span>
<span class="sd">        &gt;&gt;&gt;     req.wait()</span>
<span class="sd">        &gt;&gt;&gt; recv_tensor</span>
<span class="sd">&gt;&gt;&gt; tensor([2, 3])     # Rank 0</span>
<span class="sd">        tensor([0, 1])     # Rank 1</span>

<span class="sd">.. note:: 注意，当使用 NCCL PG 后端调用此 API 时，用户必须使用 `torch.cuda.set_device` 设置当前 GPU 设备，否则将</span>
<span class="sd">lead to unexpected hang issues.</span>
<span class="sd">导致意外的挂起问题。</span>

<span class="sd">此外，如果这是该 API 在“group”中的第一次集体调用</span>
<span class="sd">传递给 `dist.P2POp`，`group` 的所有等级都必须参与</span>
<span class="sd">此 API 调用；否则，行为未定义。如果此 API 调用是</span>
<span class="sd">不是该“组”第一次集体呼吁，批量 P2P 操作</span>
<span class="sd">仅允许使用“group”的子集等级。</span>
<span class="sd">    """</span>
    <span class="n">_检查 P2P 操作列表</span><span class="p">(</span><span class="n">p2p_op_list</span><span class="p">)</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n">p2p_op_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">设备</font></font></font></span> <span class="o">=</span> <span class="n">p2p_op_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">同义词参数</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">P2P 流</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="nb">int</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">"组目标"</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"组源"</span>
        <span class="k">返回</font></font></font></span> <span class="p">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">小组对等</span><span class="p">}</span>

    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进程组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持合并</span><span class="p">:</span>
        <span class="c1"># NCCL 风格合并</span>
        <span class="k">与</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">合并管理器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异步操作</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span><span class="p">)</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="n">cm</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2p 操作</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">p2p_op_list</span><span class="p">:</span>
                <span class="n">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">(</span>
                    <span class="n">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
                    <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
                    <span class="n">标签</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">同义词参数</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</span><span class="p">),</span>
                <span class="p">)</span>

        <span class="k">返回</font></font></font></span> <span class="n">cm</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 后端不支持合并</span>
        <span class="n">需求</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
        <span class="k">for</span> <span class="n">p2p 操作</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">p2p_op_list</span><span class="p">:</span>
            <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">(</span>
                <span class="n">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
                <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
                <span class="n">标签</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">,</span>
                <span class="o">**</span><span class="n">同义词参数</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">p2p 操作</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">:</span>
                <span class="n">需求</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">需求</span></div>


<div class="viewcode-block" id="broadcast"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@_异常记录器
def 广播(
tensor: torch.Tensor,
src: 可选[int] = None,
group: 可选[进程组] = None,
async_op: 布尔 = False,
group_src: 可选[int] = None,
):
"""
向整个组广播张量。

所有进程中的 ``tensor`` 必须具有相同数量的元素
参与集体

Args:
tensor (Tensor): 如果 ``src`` 是当前进程的 rank，则发送的数据
处理，并保存接收到的数据所使用的张量。
src (int)：全局进程组上的源排名（无论``group``参数如何）。
group (ProcessGroup，可选)：要工作的进程组。如果为 None，
则使用默认进程组。
async_op (bool, 可选): 是否将此操作设置为异步操作
group_src (int): 在 ``group`` 上的源排名。必须指定 ``group_src`` 和 ``src`` 中的一个，但不能同时指定两个。
并且 ``src`` 但不能同时指定两个。

返回值：
异步工作处理，如果 async_op 设置为 True。
如果不是 async_op 或者不是组的一部分，则为 None。

"""
group = _group_or_default_group(group)
group_src = _canonicalize_group_rank(group, src, group_src, return_global=False)
_check_single_tensor(tensor, "tensor")
if _rank_not_in_group(group):
_warn_not_in_group("broadcast")
返回

opts = 广播选项()
opts.rootRank = 群组源
opts.rootTensor = 0
opts.asyncOp = 异步操作
work = 群组广播([tensor]，opts)
if 异步操作:
返回 work
else:
work.wait()</font></font></font></div>


<div class="viewcode-block" id="all_reduce"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.all_reduce">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全量归约</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">在所有机器上以相同的方式减少张量数据，使所有机器都获得最终结果。</span>

<span class="sd">调用 `tensor` 之后，所有进程中的 `tensor` 将是位运算上完全相同的。</span>

<span class="sd">支持复杂张量。</span>

<span class="sd">参数：</span>
<span class="sd">tensor（张量）：集体的输入和输出。该函数</span>
<span class="sd">在原地操作。</span>
<span class="sd">op（可选）：从以下值中选择</span>
<span class="sd">            ``torch.distributed.ReduceOp``</span>
<span class="sd">枚举。指定用于逐元素减少的操作。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否将此操作设置为异步操作</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">示例：</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP("no rank")</span>
<span class="sd">&gt;&gt;&gt; # 以下所有张量均为 torch.int64 类型。</span>
<span class="sd">&gt;&gt;&gt; # 我们有 2 个进程组，2 个 rank。</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(f"cuda:{rank}")</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.arange(2, dtype=torch.int64, device=device) + 1 + 2 * rank</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([1, 2], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([3, 4], device='cuda:1') # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; dist.all_reduce(tensor, op=ReduceOp.SUM)</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([4, 6], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([4, 6], device='cuda:1') # Rank 1</span>

<span class="sd">&gt;&gt;&gt; # 所有下面的张量都是 torch.cfloat 类型。</span>
<span class="sd">&gt;&gt;&gt; # 我们有 2 个进程组，2 个 rank。</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.tensor(</span>
<span class="sd">        ...     [1 + 1j, 2 + 2j], dtype=torch.cfloat, device=device</span>
<span class="sd">        ... ) + 2 * rank * (1 + 1j)</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([1.+1.j, 2.+2.j], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([3.+3.j, 4.+4.j], device='cuda:1') # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; dist.all_reduce(tensor, op=ReduceOp.SUM)</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([4.+4.j, 6.+6.j], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([4.+4.j, 6.+6.j], device='cuda:1') # Rank 1</span>

<span class="sd">    """</span>
    <span class="c1">Dynamo 内置逻辑将旧版分布式操作映射到功能集体。</span>
    <span class="c1">让我们重定向到一个可以模拟此逻辑的 torch 函数模式，该模式在 Dynamo 之外。</span>
    <span class="c1">（例如，非严格导出实现了这样的 torch 函数模式）。</span>
    <span class="n">相关参数</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有 torch 功能</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">):</span>
        <span class="k">返回</span> <span class="n">handle_torch_function</span><span class="p">(</span>
            <span class="n">全量归约</span><span class="p">,</span>
            <span class="n">relevant_args</span><span class="p">,</span>
            <span class="n">张量</span><span class="p">,</span>
            <span class="n">操作</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span>
            <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
            <span class="n">async_op</span><span class="o">=</span><span class="n">async_op</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"张量"</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">全局归约</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</span><span class="p">():</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持复数</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">):</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"all_reduce 不支持"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在复数张量上</span><span class="p">)</span>
        <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">Allreduce 选项</span><span class="p">()</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">减少操作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
        <span class="c1">我们处于合并上下文，不要执行单个操作，只需追加集体表示</span>
        <span class="n">合并</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_集合操作</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全量归约</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</span><span class="p">)</span>
        <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非法工作</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">allreduce</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<span class="nd">@_exception_logger</span>
<span class="nd">@deprecated</span><span class="p">(</span>
    <span class="s2">`torch.distributed.all_reduce_coalesced` 将会被弃用。如果必须</span>
    <span class="s2">使用它，请稍后重新查看我们的文档</span>
    <span class="s2">https://pytorch.org/docs/main/分布式.html#集体函数</span><span class="p">,</span>
    <span class="n">分类</font></font></font></span><span class="o">=</span><span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未来警告</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局归约合并</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">警告：目前尚未在节点间实现单个形状检查。</span>

<span class="sd">例如，如果 0 阶节点传递[torch.rand(4), torch.rand(2)]和</span>
<span class="sd">这种缺乏形状检查导致性能显著提升，但此功能的使用者需要注意。</span>
<span class="sd">这种缺乏形状检查导致性能显著提升，但此功能的使用者需要注意。</span>
<span class="sd">这种缺乏形状检查导致性能显著提升，但此功能的使用者需要注意。</span>
<span class="sd">函数应格外小心，确保每个节点传递的</span>
<span class="sd">张量在节点之间形状匹配。</span>

<span class="sd">在所有机器上对同一设备上的张量（tensors）进行归约</span>
<span class="sd">以便所有节点都得到最终结果。</span>

<span class="sd">电话结束后，所有进程中的张量都将进行位运算相同</span>
<span class="sd">。</span>

<span class="sd">支持复杂张量。</span>

<span class="sd">参数：</span>
<span class="sd">张量（Union[List[Tensor], Tensor]）：集体的输入和输出。</span>
<span class="sd">函数在原地操作。</span>
<span class="sd">op (可选[ReduceOp])：来自以下值之一</span>
<span class="sd">``torch.distributed.ReduceOp`` 枚举。指定用于</span>
<span class="sd">元素级归约的操作。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op（可选[bool]）：此操作是否应为异步操作。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">):</span>
        <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">]</span>
    <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"张量"</span><span class="p">)</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"all_reduce_coalesced"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持复数</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"all_reduce 不支持"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在复数张量上</span><span class="p">)</span>

    <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">]</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">Allreduce 合并选项</span><span class="p">()</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">减少操作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">allreduce_coalesced</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取未来</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span>


<div class="viewcode-block" id="reduce"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@_异常记录器
def 减少(
tensor: torch.Tensor,
dst: 可选[int] = None,
op=ReduceOp.SUM,
group: 可选[ProcessGroup] = None,
async_op: 布尔型 = False,
group_dst: 可选[int] = None,
):
"""
在所有机器上减少张量数据。

只有具有 ``dst`` 等级的进程将接收最终结果。

参数：
tensor (Tensor): 集合的输入和输出。该函数
在原地操作。
dst (int): 全局进程组上的目标排名（无论 ``group`` 参数如何）
op (可选): ``torch.distributed.ReduceOp`` 中的一个值
``torch.distributed.ReduceOp``
枚举。指定用于逐元素减少的操作。
group（ProcessGroup，可选）：要工作的进程组。如果为 None，
则将使用默认进程组。
async_op（bool，可选）：此操作是否应为异步操作
group_dst (int): 目标 ``group`` 的排名。必须指定 ``group_dst`` 或 ``dst`` 中的一个，但不能同时指定。
和 ``dst`` 但不能同时指定。

返回：
如果 async_op 设置为 True，则返回异步工作句柄。
如果不是异步操作或不是组的一部分，则为空

"""
group = _group_or_default_group(group)
group_dst = _canonicalize_group_rank(group, dst, group_dst, return_global=False)
_检查单个张量(tensor, "tensor")
如果_rank_not_in_group(group):
_警告不在组("reduce")中
返回

opts = ReduceOptions()
opts.reduceOp = op
opts.rootRank = group_dst
work = group.reduce([tensor], opts)
if async_op:
返回工作
else:
work.wait()</font></font></font></div>


<span class="k">定义</font></font></font></span> <span class="nf">_object_to_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
    <span class="k">与</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待计数器</font></font></font></span><span class="p">(</span><span class="s2">"pytorch.wait_counter.c10d._object_to_tensor"</span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">守护者</span><span class="p">():</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">输入/输出</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">pickler</font></font></font></span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导出</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</span><span class="p">)</span>
        <span class="n">字节存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字节存储</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">从缓冲区读取</font></font></font></span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取值</font></font></font></span><span class="p">())</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 类型：忽略[已定义]</span>
        <span class="c1"># 不要用 torch.tensor 指定 dtype 来替换 `torch.ByteTensor` 或 `torch.LongTensor`。</span>
        <span class="c1"># 否则会导致速度降低 100 倍。</span>
        <span class="c1"># 查看：https://github.com/pytorch/pytorch/issues/65696</span>
        <span class="n">字节张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">ByteTensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字节存储</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">到</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取调试级别</font></font></font></span><span class="p">()</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试等级</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">详细信息</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查 NCCL 是否可用</span><span class="p">():</span>
            <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">NCCL</span><span class="p">:</span>
                <span class="nb">哈希</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式_c10d</font></font></font></span><span class="o">.</span><span class="n">_hash_tensors</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字节张量</span><span class="p">])</span>
                <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                    <span class="s2">"_object_to_tensor 大小："</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">哈希值：</span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span>
                    <span class="n">字节张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元素数量</span><span class="p">(),</span>
                    <span class="nb">哈希</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">local_size</span> <span class="o">=</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">LongTensor</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字节张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元素数量</font></font></font></span><span class="p">()])</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">到</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字节张量</span><span class="p">,</span> <span class="n">local_size</span>


<span class="k">定义</font></font></font></span> <span class="nf">_tensor_to_object</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
    <span class="k">与</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待计数器</font></font></font></span><span class="p">(</span><span class="s2">"pytorch.wait_counter.c10d._tensor_to_object"</span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">守护者</span><span class="p">():</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取调试级别</font></font></font></span><span class="p">()</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试等级</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">详细信息</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查 NCCL 是否可用</span><span class="p">():</span>
            <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">NCCL</span><span class="p">:</span>
                <span class="nb">哈希</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式_c10d</font></font></font></span><span class="o">.</span><span class="n">_hash_tensors</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">])</span>
                <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
                    <span class="s2">"_tensor_to_object 大小："</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">哈希值：</font></font></font></span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元素数量</font></font></font></span><span class="p">(),</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">哈希</span>
                <span class="p">)</span>
        <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">缓冲区</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()[:</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</span><span class="p">]</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_反序列化器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入/输出</font></font></font></span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">缓冲区</font></font></font></span><span class="p">))</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载</span><span class="p">()</span>


<div class="viewcode-block" id="all_gather_object"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.all_gather_object">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局收集对象</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">从整个组中收集可序列化的对象到列表中。</span>

<span class="sd">与 :func:`all_gather` 类似，但可以传递 Python 对象。</span>
<span class="sd">请注意，对象必须可序列化才能被收集。</span>

<span class="sd">参数：</span>
<span class="sd">object_list（列表[任何类型]）：输出列表。它的大小应该正确。</span>
<span class="sd">组的大小为此集体并将包含输出。</span>
<span class="sd">obj（任何类型）：从当前进程广播的可选择 Python 对象。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">默认将使用默认进程组。默认为 ``None``。</span>

<span class="sd">返回：</span>
<span class="sd">``None``。如果调用方排名属于该组，则集体输出将被填充到输入 ``object_list`` 中。如果调用方排名不属于该组，则传入的 ``object_list`` 将</span>
<span class="sd">被填充到输入 ``object_list`` 中。如果调用方排名不属于该组，则传入的 ``object_list`` 将</span>
<span class="sd">被填充到输入 ``object_list`` 中。如果调用方排名不属于该组，则传入的 ``object_list`` 将</span>
<span class="sd">保持不变。</span>

<span class="sd">注意，此 API 与 :func:`all_gather` 有细微差别</span>
<span class="sd">因为它不提供 ``async_op`` 处理句柄，因此</span>
<span class="sd">将是一个阻塞调用。</span>

<span class="sd">.. 注意:: 对于基于 NCCL 处理的组，内部张量表示</span>
<span class="sd">对象必须在通信之前移动到 GPU 设备上</span>
<span class="sd">地点。在这种情况下，所使用的设备由</span>
<span class="sd">torch.cuda.current_device() 和它是用户的责任</span>
<span class="sd">确保每个等级都分配了独立的 GPU</span>
<span class="sd">torch.cuda.set_device()</span>

<span class="sd">.. 警告::</span>
<span class="sd">func:`all_gather_object` 隐式使用 ``pickle`` 模块，这</span>
<span class="sd">已知不安全。可能构造恶意 pickle 数据</span>
<span class="sd">在反序列化过程中将执行任意代码。仅调用此</span>
<span class="sd">使用您信任的数据。</span>

<span class="sd">.. 警告::</span>
<span class="sd">使用 GPU 张量调用:func:`all_gather_object`不受良好支持</span>
<span class="sd">并且效率低下，因为它会引发 GPU -&gt; CPU 的传输，因为张量将被</span>
<span class="sd">请考虑使用：func:`all_gather`。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">&gt;&gt;&gt; 假设 world_size 为 3。</span>
<span class="sd">&gt;&gt;&gt; gather_objects = ["foo", 12, {1: 2}] # 任何可序列化的对象</span>
<span class="sd">        &gt;&gt;&gt; output = [None for _ in gather_objects]</span>
<span class="sd">        &gt;&gt;&gt; dist.all_gather_object(output, gather_objects[dist.get_rank()])</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        ['foo', 12, {1: 2}]</span>
<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"all_gather_object"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">输入张量</font></font></font></span><span class="p">,</span> <span class="n">local_size</span> <span class="o">=</span> <span class="n">_object_to_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>

    <span class="c1"># 收集所有局部大小。这是为了找到最大大小，并索引</span>
    <span class="c1">直到反序列化张量达到正确大小时。</span>
    <span class="n">组大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取世界大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">对象尺寸张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">零值</span><span class="p">(</span>
        <span class="n">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span>
    <span class="p">)</span>
    <span class="n">物体尺寸列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">物体尺寸张量</font></font></font></span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">展平</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">暗</font></font></font></span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1">张量大小汇总</span>
    <span class="n">全局聚合</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">本地大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">最大对象大小</font></font></font></span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大值</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小列表</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">())</span>  <span class="c1"># type: ignore[type-var]</span>
    <span class="c1"># 将张量调整到所有 rank 中的最大尺寸。</span>
    <span class="n">输入张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调整大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大对象大小</span><span class="p">)</span>
    <span class="n">合并输出张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>
        <span class="n">最大对象大小</font></font></font></span> <span class="o">*</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span>
    <span class="p">)</span>
    <span class="c1">输出张量是非重叠的合并输出张量视图</span>
    <span class="n">output_tensors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">合并输出张量</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大对象大小</font></font></font></span> <span class="o">*</span> <span class="n">i</span> <span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大对象大小</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">全局聚合</font></font></font></span><span class="p">(</span><span class="n">output_tensors</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="c1">反序列化输出回对象</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">张量</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</span><span class="p">(</span><span class="n">output_tensors</span><span class="p">):</span>
        <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">张量大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小列表</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">对象列表</font></font></font></span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tensor_to_object</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span></div>


<div class="viewcode-block" id="gather_object"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.gather_object">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">收集对象</span><span class="p">(</span>
    <span class="n">对象</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</span><span class="p">,</span>
    <span class="n">物体收集列表</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">目标</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组目标</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">从整个组中收集可序列化的对象。</span>

<span class="sd">与 :func:`gather` 类似，但可以传入 Python 对象。注意，对象必须是可序列化的才能被收集。</span>
<span class="sd">对象必须是可序列化的才能被收集。</span>

<span class="sd">参数：</span>
<span class="sd">obj (任何类型): 输入对象。必须是可序列化的。</span>
<span class="sd">object_gather_list (list[Any]): 输出列表。在 ``dst`` 节点上，它</span>
<span class="sd">应该正确地调整大小以匹配该集合的大小，并将包含输出。在非 dst</span>
<span class="sd">节点上必须为 ``None``。默认为 ``None``。</span>
<span class="sd">（默认为 ``None``）</span>
<span class="sd">dst (int, 可选): 目标全局进程组中的进程排名（无论 ``group`` 参数如何）。</span>
<span class="sd">（如果 ``dst`` 和 ``group_dst`` 都为 None，则默认为全局排名 0）</span>
<span class="sd">group: (ProcessGroup, 可选): 要工作的进程组。如果为 None，则</span>
<span class="sd">默认将使用默认进程组。默认为 ``None``。</span>
<span class="sd">group_dst（int，可选）：在 ``group`` 上的目标排名。不能同时指定 ``dst`` 和 ``group_dst``。</span>

<span class="sd">返回：</span>
<span class="sd">无。在 `dst` 端，`object_gather_list` 将包含集体操作的输出。</span>
<span class="sd">集体操作的输出。</span>

<span class="sd">.. 注意:: 注意，此 API 与`gather`集体操作略有不同，</span>
<span class="sd">因为它不提供`async_op`句柄，因此将是阻塞的。</span>
<span class="sd">调用。</span>

<span class="sd">.. 注意:: 对于基于 NCCL 处理的组，内部张量表示</span>
<span class="sd">对象必须在通信之前移动到 GPU 设备上</span>
<span class="sd">地点。在这种情况下，所使用的设备由</span>
<span class="sd">torch.cuda.current_device() 和它是用户的责任</span>
<span class="sd">确保每个等级都分配了独立的 GPU</span>
<span class="sd">torch.cuda.set_device()</span>

<span class="sd">.. 警告::</span>
<span class="sd">`:func:`gather_object` 隐式使用 `pickle` 模块，其中是</span>
<span class="sd">已知不安全。可能构造恶意 pickle 数据</span>
<span class="sd">在反序列化过程中将执行任意代码。仅调用此</span>
<span class="sd">使用您信任的数据。</span>

<span class="sd">.. 警告::</span>
<span class="sd">调用：func:`gather_object`使用 GPU 张量支持不佳</span>
<span class="sd">并且效率低下，因为它会引发 GPU -&gt; CPU 的传输，因为张量将被</span>
<span class="sd">请考虑使用 :func:`gather` 代替。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">&gt;&gt;&gt; 假设 world_size 为 3。</span>
<span class="sd">&gt;&gt;&gt; gather_objects = ["foo", 12, {1: 2}] # 任何可序列化的对象</span>
<span class="sd">        &gt;&gt;&gt; output = [None for _ in gather_objects]</span>
<span class="sd">        &gt;&gt;&gt; dist.gather_object(</span>
<span class="sd">        ...     gather_objects[dist.get_rank()],</span>
<span class="sd">        ...     output if dist.get_rank() == 0 else None,</span>
<span class="sd">        ...     dst=0</span>
<span class="sd">        ... )</span>
<span class="sd">&gt;&gt;&gt; # 在排名 0</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        ['foo', 12, {1: 2}]</span>
<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">dst</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n">group_dst</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">global_dst</span> <span class="o">=</span> <span class="n">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">收集对象</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="c1">确保已适当指定对象收集列表。</span>
    <span class="n">我的全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="n">验证输出列表以排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体收集列表</span><span class="p">)</span>
    <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">输入张量</font></font></font></span><span class="p">,</span> <span class="n">local_size</span> <span class="o">=</span> <span class="n">_object_to_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>

    <span class="c1"># 收集所有局部大小。这是为了找到最大大小，并索引</span>
    <span class="c1">直到反序列化张量达到正确大小时。</span>
    <span class="n">组大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取世界大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">对象尺寸张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">零值</span><span class="p">(</span>
        <span class="n">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span>
    <span class="p">)</span>
    <span class="n">物体尺寸列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">物体尺寸张量</font></font></font></span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">展平</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">暗</font></font></font></span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># 所有聚集张量的大小。尽管这里不需要聚集，但由于每个 rank 都需要广播一个相同（最大）的张量，所以这里需要进行全聚集。</span>
    <span class="c1"># 聚集，因为每个 rank 都需要广播一个相同（最大）的张量。</span>
    <span class="c1">尺寸</span>
    <span class="n">全局聚合</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">本地大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">最大对象大小</font></font></font></span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大值</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小列表</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">())</span>  <span class="c1"># type: ignore[type-var]</span>
    <span class="c1"># 将张量调整到所有 rank 中的最大尺寸。</span>
    <span class="n">输入张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调整大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大对象大小</span><span class="p">)</span>
    <span class="c1">如果在此 rank 上不会收集结果，则避免填充输出张量。</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球目标</span><span class="p">:</span>
        <span class="n">合并输出张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>
            <span class="n">最大对象大小</font></font></font></span> <span class="o">*</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span>
        <span class="p">)</span>
        <span class="c1">输出张量是非重叠的合并输出张量视图</span>
        <span class="n">output_tensors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">合并输出张量</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大对象大小</font></font></font></span> <span class="o">*</span> <span class="n">i</span> <span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大对象大小</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="c1">所有排名调用 gather，使用等大小的张量。</span>
    <span class="n">收集</span><span class="p">(</span>
        <span class="n">输入张量</span><span class="p">,</span>
        <span class="n">gather 列表</font></font></font></span><span class="o">=</span><span class="n">output_tensors</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">==</span> <span class="n">global_dst</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
        <span class="n">目标</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球目标</span><span class="p">,</span>
        <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球目标</span><span class="p">:</span>
        <span class="k">返回</span>

    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象收集列表</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"必须在目标 rank 上提供对象收集列表"</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">张量</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</span><span class="p">(</span><span class="n">output_tensors</span><span class="p">):</span>
        <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">张量大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小列表</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">物体收集列表</font></font></font></span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tensor_to_object</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span></div>


<div class="viewcode-block" id="send_object_list"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.send_object_list">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送对象列表</span><span class="p">(</span>
    <span class="n">对象列表</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="n">目标</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组目标</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">同步发送 `object_list` 中的可序列化对象。</span>

<span class="sd">与 :func:`send` 类似，但可以传递 Python 对象。</span>
<span class="sd">注意，为了发送，`object_list` 中的所有对象都必须是可序列化的。</span>
<span class="sd">才能发送。</span>

<span class="sd">参数：</span>
<span class="sd">输入对象列表（List[Any]）：要发送的输入对象列表。</span>
<span class="sd">每个对象必须是可序列化的。接收方必须提供大小相等的列表。</span>
<span class="sd">dst（int）：发送“object_list”的目标 rank。</span>
<span class="sd">目标 rank 基于全局进程组（无论“group”参数如何）。</span>
<span class="sd">group: (ProcessGroup, 可选): 要工作的进程组。如果为 None，则</span>
<span class="sd">默认将使用默认进程组。默认为 ``None``。</span>
<span class="sd">device (``torch.device``，可选): 如果不为 None，则将对象</span>
<span class="sd">序列化并转换为张量，然后将这些张量移动到</span>
<span class="sd">在发送之前 ``device``。默认为 ``None``。</span>
<span class="sd">group_dst（int，可选）：在 ``group`` 上的目标 rank。</span>
<span class="sd">必须指定 ``dst`` 和 ``group_dst`` 中的一个，但不能同时指定两个。</span>
<span class="sd">返回：</span>
<span class="sd">``None``。</span>

<span class="sd">.. 注意：对于基于 NCCL 的进程组，内部张量表示</span>
<span class="sd">对象必须在通信之前移动到 GPU 设备上</span>
<span class="sd">地点。在这种情况下，所使用的设备由</span>
<span class="sd">``torch.cuda.current_device()``给出，并且用户有责任确保</span>
<span class="sd">确保每个等级都分配了独立的 GPU</span>
<span class="sd">torch.cuda.set_device()</span>

<span class="sd">.. 警告::</span>
<span class="sd">`:func:`send_object_list` 隐式使用 `pickle` 模块，其中</span>
<span class="sd">已知不安全。可能构建恶意的 pickle</span>
<span class="sd">数据将在反序列化期间执行任意代码。仅调用此</span>
<span class="sd">使用您信任的数据。</span>

<span class="sd">.. 警告::</span>
<span class="sd">使用 GPU 张量调用:func:`send_object_list`不受良好支持</span>
<span class="sd">并且效率低下，因为它会引发 GPU -&gt; CPU 的传输，因为张量将被</span>
<span class="sd">请考虑使用:func:`send`代替。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">&gt;&gt;&gt; # 假设后端不是 NCCL</span>
<span class="sd">&gt;&gt;&gt; 设备 = torch.device("cpu")</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt;     # 假设 world_size 为 2.</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = ["foo", 12, {1: 2}] # 任何可序列化的对象</span>
<span class="sd">        &gt;&gt;&gt;     dist.send_object_list(objects, dst=1, device=device)</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = [None, None, None]</span>
<span class="sd">        &gt;&gt;&gt;     dist.recv_object_list(objects, src=0, device=device)</span>
<span class="sd">&gt;&gt;&gt; 对象</span>
<span class="sd">        ['foo', 12, {1: 2}]</span>
<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">group_dst</span> <span class="o">=</span> <span class="n">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</span><span class="p">)</span>
    <span class="n">_检查非自身排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目的地</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">发送对象列表</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="c1">当前设备选择。</span>
    <span class="c1">为了保持向后兼容性，`device` 默认为 `None`</span>
    <span class="c1">在这种情况下，我们运行设备选择的当前逻辑，即</span>
    <span class="c1">当前设备是 CUDA，如果后端是 NCCL，否则是 CPU 设备。</span>
    <span class="c1">如果它不是 `None`，我们将大小和对象张量移动</span>
    <span class="c1">发送到该设备。</span>
    <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="c1">在源 rank 上序列化 object_list 元素为张量</span>
    <span class="n">张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小列表</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="o">*</span><span class="p">[</span><span class="n">_object_to_tensor</span><span class="p">(</span><span class="n">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象列表</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">对象尺寸张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">猫</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">尺寸列表</span><span class="p">)</span>

    <span class="c1"># 发送对象尺寸</span>
    <span class="n">发送</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>

    <span class="c1">将序列化对象张量连接并发送</span>
    <span class="c1"># 注意：如果 tensor_list 为空，torch.cat 将不会执行任何操作</span>
    <span class="c1"># 只有一个元素，我们可以跳过复制。</span>
    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
        <span class="n">对象张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">对象张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">猫</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">)</span>

    <span class="n">发送</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span></div>


<div class="viewcode-block" id="recv_object_list"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.recv_object_list">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收对象列表</span><span class="p">(</span>
    <span class="n">对象列表</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="n">源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">同步接收可序列化的对象，存储在 `object_list` 中。</span>

<span class="sd">类似于 :func:`recv`，但可以接收 Python 对象。</span>

<span class="sd">参数：</span>
<span class="sd">object_list (List[Any]): 要接收的对象列表。</span>
<span class="sd">必须提供与发送的列表大小相等的尺寸列表。</span>
<span class="sd">src（int，可选）：从其中接收 ``object_list`` 的源排名。</span>
<span class="sd">源排名基于全局进程组（无论 ``group`` 参数如何）</span>
<span class="sd">如果设置为 None，则将从任何排名接收。默认为 ``None``。</span>
<span class="sd">group: (ProcessGroup, 可选): 要工作的进程组。如果为 None，则</span>
<span class="sd">默认将使用默认进程组。默认为 ``None``。</span>
<span class="sd">device (``torch.device``，可选): 如果不为 None，则在此设备上接收。</span>
<span class="sd">默认为 ``None``。</span>
<span class="sd">group_src（int，可选）：在 ``group`` 上的目标排名。不能同时指定 ``src`` 和 ``group_src``。</span>

<span class="sd">返回：</span>
<span class="sd">发送者排名。如果排名不属于该组，则为 -1。如果排名属于该组，</span>
<span class="sd">``object_list`` 将包含来自 ``src`` 排名的发送对象。</span>

<span class="sd">.. 注意：对于基于 NCCL 的进程组，内部张量表示</span>
<span class="sd">对象必须在通信之前移动到 GPU 设备上</span>
<span class="sd">地点。在这种情况下，所使用的设备由</span>
<span class="sd">``torch.cuda.current_device()``给出，并且用户有责任确保</span>
<span class="sd">确保每个等级都分配了独立的 GPU</span>
<span class="sd">torch.cuda.set_device()</span>

<span class="sd">.. 警告::</span>
<span class="sd">`:func:`recv_object_list` 隐式使用 `pickle` 模块，其中</span>
<span class="sd">已知不安全。可能构建恶意的 pickle</span>
<span class="sd">数据将在反序列化期间执行任意代码。仅调用此</span>
<span class="sd">使用您信任的数据。</span>

<span class="sd">.. 警告::</span>
<span class="sd">使用 GPU 张量调用:func:`recv_object_list`不受良好支持</span>
<span class="sd">并且效率低下，因为它会引发 GPU -&gt; CPU 的传输，因为张量将被</span>
<span class="sd">请考虑使用:func:`recv`代替。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">&gt;&gt;&gt; # 假设后端不是 NCCL</span>
<span class="sd">&gt;&gt;&gt; 设备 = torch.device("cpu")</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt;     # 假设 world_size 为 2.</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = ["foo", 12, {1: 2}] # 任何可序列化的对象</span>
<span class="sd">        &gt;&gt;&gt;     dist.send_object_list(objects, dst=1, device=device)</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = [None, None, None]</span>
<span class="sd">        &gt;&gt;&gt;     dist.recv_object_list(objects, src=0, device=device)</span>
<span class="sd">&gt;&gt;&gt; 对象</span>
<span class="sd">        ['foo', 12, {1: 2}]</span>
<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"接收对象列表"</span><span class="p">)</span>
        <span class="k">返回</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1">当前设备选择。</span>
    <span class="c1">为了保持向后兼容性，`device` 默认为 `None`</span>
    <span class="c1">在这种情况下，我们运行设备选择的当前逻辑，即</span>
    <span class="c1">当前设备是 CUDA，如果后端是 NCCL，否则是 CPU 设备。</span>
    <span class="c1">如果它不是 `None`，我们将大小和对象张量移动</span>
    <span class="c1">接收到此设备。</span>
    <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">对象尺寸张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>
        <span class="nb">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象列表</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span>
    <span class="p">)</span>

    <span class="c1"># 接收对象大小</span>
    <span class="n">排序大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</span><span class="p">)</span>

    <span class="c1"># 接收序列化对象进入的张量。</span>
    <span class="n">对象张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>  <span class="c1"># type: ignore[call-overload]</span>
        <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">总和</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">(),</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="n">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="n">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">对象等级</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</span><span class="p">)</span>
    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序大小</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序对象</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">"返回排名中对象大小和对象不匹配。"</span>
    <span class="p">)</span>
    <span class="c1">使用存储的大小反序列化对象。</span>
    <span class="n">偏移</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_size</span> <span class="ow">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</span><span class="p">):</span>
        <span class="n">对象视图</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象张量</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">偏移</font></font></font></span> <span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">偏移</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小</span><span class="p">]</span>
        <span class="n">对象视图</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象视图</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">偏移</span> <span class="o">+=</span> <span class="n">obj_size</span>
        <span class="n">对象列表</font></font></font></span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tensor_to_object</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象视图</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序对象</span></div>


<div class="viewcode-block" id="broadcast_object_list"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.broadcast_object_list">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">广播对象列表</span><span class="p">(</span>
    <span class="n">对象列表</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="n">源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">将 `object_list` 中的可序列化对象广播到整个组。</span>

<span class="sd">与 :func:`broadcast` 类似，但可以传递 Python 对象。</span>
<span class="sd">注意，为了发送，`object_list` 中的所有对象都必须是可序列化的。</span>
<span class="sd">广播</span>

<span class="sd">参数：</span>
<span class="sd">object_list (List[Any]): 要广播的输入对象列表。</span>
<span class="sd">每个对象都必须是可序列化的。只有 ``src`` 级别的对象将被分散，</span>
<span class="sd">但每个端点都必须提供大小相等的列表。</span>
<span class="sd">源 (int): 从哪个源排名广播 ``object_list``。</span>
<span class="sd">源排名基于全局进程组（无论 ``group`` 参数如何）</span>
<span class="sd">group: (ProcessGroup, 可选): 要工作的进程组。如果为 None，则</span>
<span class="sd">默认将使用默认进程组。默认为 ``None``。</span>
<span class="sd">device (``torch.device``，可选): 如果不为 None，则将对象</span>
<span class="sd">序列化并转换为张量，然后将这些张量移动到</span>
<span class="sd">``device``。默认为``None``。</span>
<span class="sd">group_src（整型）：在``group``上的源 rank。不得指定``group_src``中的一个。</span>
<span class="sd">且 ``src`` 但不同时。</span>

<span class="sd">返回：</span>
<span class="sd">``None``。如果排名是组的一部分，``object_list`` 将包含</span>
<span class="sd">从 ``src`` 排名广播的对象。</span>

<span class="sd">.. 注意：对于基于 NCCL 的进程组，内部张量表示</span>
<span class="sd">对象必须在通信之前移动到 GPU 设备上</span>
<span class="sd">地点。在这种情况下，所使用的设备由</span>
<span class="sd">``torch.cuda.current_device()``给出，并且用户有责任确保</span>
<span class="sd">确保每个等级都分配了独立的 GPU</span>
<span class="sd">torch.cuda.set_device()</span>

<span class="sd">注意，此 API 与 :func:`broadcast` 略有不同，</span>
<span class="sd">因为它不提供 ``async_op`` 处理句柄，因此</span>
<span class="sd">将是一个阻塞调用。</span>

<span class="sd">.. 警告::</span>
<span class="sd">`broadcast_object_list`函数隐式使用`pickle`模块，这</span>
<span class="sd">已知不安全。可能构建恶意的 pickle</span>
<span class="sd">数据将在反序列化期间执行任意代码。仅调用此</span>
<span class="sd">使用您信任的数据。</span>

<span class="sd">.. 警告::</span>
<span class="sd">使用 GPU 张量调用 :func:`broadcast_object_list` 不受良好支持</span>
<span class="sd">并且效率低下，因为它会引发 GPU -&gt; CPU 的传输，因为张量将被</span>
<span class="sd">序列化。请考虑使用 :func:`broadcast` 代替。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt;     # 假设 world_size 为 3。</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = ["foo", 12, {1: 2}] # 任何可序列化的对象</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = [None, None, None]</span>
<span class="sd">&gt;&gt;&gt; # 假设后端不是 NCCL</span>
<span class="sd">&gt;&gt;&gt; 设备 = torch.device("cpu")</span>
<span class="sd">        &gt;&gt;&gt; dist.broadcast_object_list(objects, src=0, device=device)</span>
<span class="sd">&gt;&gt;&gt; 对象</span>
<span class="sd">        ['foo', 12, {1: 2}]</span>
<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">源</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">全局源</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"广播对象列表"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="c1">当前设备选择。</span>
    <span class="c1">为了保持向后兼容性，`device` 默认为 `None`</span>
    <span class="c1">在这种情况下，我们运行设备选择的当前逻辑，即</span>
    <span class="c1">当前设备是 CUDA，如果后端是 NCCL，否则是 CPU 设备。</span>
    <span class="c1">如果它不是 `None`，我们将大小和对象张量移动</span>
    <span class="c1">发送到此设备</span>
    <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="n">我的全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="c1">在源 rank 上序列化 object_list 元素为张量</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</span><span class="p">:</span>
        <span class="n">张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小列表</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span><span class="n">_object_to_tensor</span><span class="p">(</span><span class="n">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span> <span class="k">for</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象列表</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">对象尺寸张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">猫</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">尺寸列表</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">对象尺寸张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>
            <span class="nb">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象列表</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span>
        <span class="p">)</span>

    <span class="c1"># 广播对象大小</span>
    <span class="n">广播</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>

    <span class="c1"># 连接并广播序列化对象张量</span>
    <span class="c1"># 注意：如果 tensor_list 为空，torch.cat 将不会执行任何操作</span>
    <span class="c1"># 只有一个元素，我们可以跳过复制。</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
            <span class="n">对象张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">对象张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">猫</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">对象张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>  <span class="c1"># type: ignore[call-overload]</span>
            <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">总和</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">(),</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
            <span class="n">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">广播</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="c1">使用存储的大小反序列化对象。</span>
    <span class="n">偏移</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj_size</span> <span class="ow">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">物体尺寸张量</span><span class="p">):</span>
            <span class="n">对象视图</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象张量</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">偏移</font></font></font></span> <span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">偏移</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小</span><span class="p">]</span>
            <span class="n">对象视图</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象视图</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">偏移</span> <span class="o">+=</span> <span class="n">obj_size</span>
            <span class="n">对象列表</font></font></font></span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tensor_to_object</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象视图</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span></div>


<div class="viewcode-block" id="scatter_object_list"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.scatter_object_list">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散列对象列表</span><span class="p">(</span>
    <span class="n">散射对象输出列表</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="n">散列对象输入列表</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">将 `scatter_object_input_list` 中的可散列对象散列到整个组中。</span>

<span class="sd">类似于 :func:`scatter`，但可以传递 Python 对象。在</span>
<span class="sd">每个等级，分散的对象将被存储为第一个元素</span>
<span class="sd">``scatter_object_output_list``。注意，所有在</span>
<span class="sd">``scatter_object_input_list``中的对象都必须是可序列化的，以便进行分散。</span>

<span class="sd">参数：</span>
<span class="sd">scatter_object_output_list（Any 类型的列表）：非空列表，其第一个</span>
<span class="sd">该元素将存储分配到此级别的对象。</span>
<span class="sd">scatter_object_input_list (List[Any], optional): 要分散的输入对象列表。</span>
<span class="sd">每个对象都必须是可序列化的。只有 ``src`` 级别的对象将被分散，</span>
<span class="sd">并且对于非-src 级别，参数可以是 ``None``。</span>
<span class="sd">源 (int): 从哪个源排名散布 ``scatter_object_input_list``。</span>
<span class="sd">源排名基于全局进程组（无论 ``group`` 参数如何）。</span>
<span class="sd">（如果 ``src`` 和 ``group_src`` 都为 None，则默认为全局排名 0）</span>
<span class="sd">group: (ProcessGroup, 可选): 要工作的进程组。如果为 None，则</span>
<span class="sd">默认将使用默认进程组。默认为 ``None``。</span>
<span class="sd">group_src (int, 可选): ``group`` 上的源排名。不能同时指定 ``src`` 和 ``group_src``。</span>

<span class="sd">返回：</span>
<span class="sd">``None``。如果排名是组的一部分，``scatter_object_output_list``</span>
<span class="sd">将具有此等级的散列对象设置为第一个元素。</span>

<span class="sd">.. 注意:: 注意，此 API 与 scatter collective 略有不同</span>
<span class="sd">由于它不提供 `async_op` 处理句柄，因此将不会是</span>
<span class="sd">阻塞调用。</span>

<span class="sd">.. 警告::</span>
<span class="sd">`:func:`scatter_object_list` 隐式使用 `pickle` 模块，其中</span>
<span class="sd">已知不安全。可能构建恶意的 pickle</span>
<span class="sd">数据将在反序列化期间执行任意代码。仅调用此</span>
<span class="sd">使用您信任的数据。</span>

<span class="sd">.. 警告::</span>
<span class="sd">使用 GPU 张量调用:func:`scatter_object_list`不受良好支持</span>
<span class="sd">并且效率低下，因为它会引发 GPU -&gt; CPU 的传输，因为张量将被</span>
<span class="sd">请考虑使用:func:`scatter`代替。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt;     # 假设 world_size 为 3。</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = ["foo", 12, {1: 2}] # 任何可序列化的对象</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">&gt;&gt;&gt;     # 在非源 rank 上可以是任何列表，元素不使用。</span>
<span class="sd">&gt;&gt;&gt;     对象列表 = [None, None, None]</span>
<span class="sd">&gt;&gt;&gt; 输出列表 = [None]</span>
<span class="sd">        &gt;&gt;&gt; dist.scatter_object_list(output_list, objects, src=0)</span>
<span class="sd">&gt;&gt;&gt; # 排名 i 获取 objects[i]。例如，在排名 2：</span>
<span class="sd">&gt;&gt;&gt; 输出列表</span>
<span class="sd">        [{1: 2}]</span>
<span class="sd">    """</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">源</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">全局源</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"散射对象列表"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="k">如果</span> <span class="p">(</span>
        <span class="ow">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散射对象输出列表</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</span><span class="p">)</span>
        <span class="ow">或者</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散射对象输出列表</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">预期参数 scatter_object_output_list 至少为大小为 1 的列表。</span>
        <span class="p">)</span>

    <span class="n">我的全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="n">PG 设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取对象集合设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散射对象输入列表</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                <span class="s2">"源排名必须提供非 None 的散射对象输入列表"</span>
            <span class="p">)</span>
        <span class="n">张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[</span>
                <span class="n">_object_to_tensor</span><span class="p">(</span><span class="n">对象</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 设备</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">对象</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散射对象输入列表</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</font></font></font></span><span class="p">),</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</span><span class="p">)</span>

        <span class="c1"># 源秩广播最大张量大小。这是因为所有秩都</span>
        <span class="c1"># 预期以大小相等的张量调用 scatter()。</span>
        <span class="n">最大张量大小</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大值</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</span><span class="p">)</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
        <span class="k">for</span> <span class="n">张量</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">:</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
            <span class="n">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调整大小</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大张量大小</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">最大张量大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="mi">0</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 设备</span><span class="p">)</span>
    <span class="n">广播</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大张量大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>

    <span class="c1"># 散列实际序列化对象</span>
    <span class="n">输出张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">(</span>
        <span class="n">最大张量大小</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</font></font></font></span><span class="p">(),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PG 设备</span>
    <span class="p">)</span>
    <span class="n">分散</span><span class="p">(</span>
        <span class="n">输出张量</span><span class="p">,</span>
        <span class="n">scatter_list</span><span class="o">=</span><span class="kc">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局源</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span><span class="p">,</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
        <span class="n">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</span><span class="p">,</span>
        <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">在反序列化回对象时分散对象大小以修剪张量</span>
    <span class="n">obj_tensor_size</span> <span class="o">=</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="mi">0</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 设备</span><span class="p">)</span>
    <span class="n">分散</span><span class="p">(</span>
        <span class="n">对象张量大小</span><span class="p">,</span>
        <span class="n">scatter_list</span><span class="o">=</span><span class="kc">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局源</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量大小</span><span class="p">,</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
        <span class="n">源</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球源</span><span class="p">,</span>
        <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">反序列化回对象</span>
    <span class="n">散射对象输出列表</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tensor_to_object</span><span class="p">(</span>
        <span class="n">输出张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象张量大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="all_gather"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.all_gather">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局聚合</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">从整个组中收集张量到一个列表中。</span>

<span class="sd">支持复杂和不均匀大小的张量。</span>

<span class="sd">参数：</span>
<span class="sd">tensor_list (list[Tensor]): 输出列表。它应该包含</span>
<span class="sd">正确大小的张量，用于集体输出。</span>
<span class="sd">支持不同大小的张量。</span>
<span class="sd">张量（Tensor）：当前进程要广播的张量。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否将此操作设置为异步操作</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 以下所有张量均为 torch.int64 数据类型。</span>
<span class="sd">&gt;&gt;&gt; # 我们有 2 个进程组，2 个 rank。</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(f"cuda:{rank}")</span>
<span class="sd">        &gt;&gt;&gt; tensor_list = [</span>
<span class="sd">        ...     torch.zeros(2, dtype=torch.int64, device=device) for _ in range(2)</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; tensor_list</span>
<span class="sd">        [tensor([0, 0], device='cuda:0'), tensor([0, 0], device='cuda:0')] # Rank 0</span>
<span class="sd">        [tensor([0, 0], device='cuda:1'), tensor([0, 0], device='cuda:1')] # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.arange(2, dtype=torch.int64, device=device) + 1 + 2 * rank</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([1, 2], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([3, 4], device='cuda:1') # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; dist.all_gather(tensor_list, tensor)</span>
<span class="sd">        &gt;&gt;&gt; tensor_list</span>
<span class="sd">        [tensor([1, 2], device='cuda:0'), tensor([3, 4], device='cuda:0')] # Rank 0</span>
<span class="sd">        [tensor([1, 2], device='cuda:1'), tensor([3, 4], device='cuda:1')] # Rank 1</span>

<span class="sd">&gt;&gt;&gt; # 所有下面的张量都是 torch.cfloat 类型。</span>
<span class="sd">&gt;&gt;&gt; # 我们有 2 个进程组，2 个 rank。</span>
<span class="sd">        &gt;&gt;&gt; tensor_list = [</span>
<span class="sd">        ...     torch.zeros(2, dtype=torch.cfloat, device=device) for _ in range(2)</span>
<span class="sd">        ... ]</span>
<span class="sd">        &gt;&gt;&gt; tensor_list</span>
<span class="sd">        [tensor([0.+0.j, 0.+0.j], device='cuda:0'), tensor([0.+0.j, 0.+0.j], device='cuda:0')] # Rank 0</span>
<span class="sd">        [tensor([0.+0.j, 0.+0.j], device='cuda:1'), tensor([0.+0.j, 0.+0.j], device='cuda:1')] # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.tensor(</span>
<span class="sd">        ...     [1 + 1j, 2 + 2j], dtype=torch.cfloat, device=device</span>
<span class="sd">        ... ) + 2 * rank * (1 + 1j)</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([1.+1.j, 2.+2.j], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([3.+3.j, 4.+4.j], device='cuda:1') # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; dist.all_gather(tensor_list, tensor)</span>
<span class="sd">        &gt;&gt;&gt; tensor_list</span>
<span class="sd">        [tensor([1.+1.j, 2.+2.j], device='cuda:0'), tensor([3.+3.j, 4.+4.j], device='cuda:0')] # Rank 0</span>
<span class="sd">        [tensor([1.+1.j, 2.+2.j], device='cuda:1'), tensor([3.+3.j, 4.+4.j], device='cuda:1')] # Rank 1</span>

<span class="sd">    """</span>
    <span class="c1">Dynamo 内置逻辑将旧版分布式操作映射到功能集体。</span>
    <span class="c1">让我们重定向到一个可以模拟此逻辑的 torch 函数模式，该模式在 Dynamo 之外。</span>
    <span class="c1">（例如，非严格导出实现了这样的 torch 函数模式）。</span>
    <span class="n">相关参数</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有 torch 功能</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">):</span>
        <span class="k">返回</span> <span class="n">handle_torch_function</span><span class="p">(</span>
            <span class="n">全局聚合</span><span class="p">,</span>
            <span class="n">relevant_args</span><span class="p">,</span>
            <span class="n">张量列表</span><span class="p">,</span>
            <span class="n">张量</span><span class="p">,</span>
            <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
            <span class="n">async_op</span><span class="o">=</span><span class="n">async_op</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"tensor 列表"</span><span class="p">)</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"张量"</span><span class="p">)</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"全局聚合"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="n">张量列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</span>
    <span class="p">]</span>
    <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局收集</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量列表</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">])</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<div class="viewcode-block" id="all_gather_into_tensor"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.all_gather_into_tensor">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf">all_gather_into_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">从所有进程收集张量并将它们放入单个输出张量中。</span>

<span class="sd">此函数要求每个进程上的所有张量大小必须相同。</span>

<span class="sd">参数：</span>
<span class="sd">输出张量（Tensor）：用于容纳张量元素的输出张量</span>
<span class="sd">从所有阶层。它必须正确尺寸，以便有一个</span>
<span class="sd">以下形式：</span>
<span class="sd">(i) 所有输入张量的连接</span>
<span class="sd">维度；关于“连接”的定义，请参阅 ``torch.cat()``；</span>
<span class="sd">（ii）所有输入张量沿主维度的堆叠；</span>
<span class="sd">关于“堆叠”的定义，请参阅 ``torch.stack()``。</span>
<span class="sd">下面的示例可能更能说明支持的输出形式。</span>
<span class="sd">输入张量（Tensor）：从当前 rank 收集的张量。</span>
<span class="sd">与`all_gather` API 不同，此 API 的输入张量在所有 rank 上必须具有相同的大小。</span>
<span class="sd">API 必须具有相同的大小。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否将此操作设置为异步操作</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 以下所有张量均为 torch.int64 数据类型，且位于 CUDA 设备上。</span>
<span class="sd">&gt;&gt;&gt; 我们有两个等级。</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(f"cuda:{rank}")</span>
<span class="sd">        &gt;&gt;&gt; tensor_in = torch.arange(2, dtype=torch.int64, device=device) + 1 + 2 * rank</span>
<span class="sd">        &gt;&gt;&gt; tensor_in</span>
<span class="sd">        tensor([1, 2], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([3, 4], device='cuda:1') # Rank 1</span>
<span class="sd">&gt;&gt;&gt; # 输出拼接形式</span>
<span class="sd">        &gt;&gt;&gt; tensor_out = torch.zeros(world_size * 2, dtype=torch.int64, device=device)</span>
<span class="sd">        &gt;&gt;&gt; dist.all_gather_into_tensor(tensor_out, tensor_in)</span>
<span class="sd">        &gt;&gt;&gt; tensor_out</span>
<span class="sd">        tensor([1, 2, 3, 4], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([1, 2, 3, 4], device='cuda:1') # Rank 1</span>
<span class="sd">&gt;&gt;&gt; # 输出为栈形式</span>
<span class="sd">        &gt;&gt;&gt; tensor_out2 = torch.zeros(world_size, 2, dtype=torch.int64, device=device)</span>
<span class="sd">        &gt;&gt;&gt; dist.all_gather_into_tensor(tensor_out2, tensor_in)</span>
<span class="sd">        &gt;&gt;&gt; tensor_out2</span>
<span class="sd">        tensor([[1, 2],</span>
<span class="sd">                [3, 4]], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([[1, 2],</span>
<span class="sd">                [3, 4]], device='cuda:1') # Rank 1</span>

<span class="sd">.. 警告::</span>
<span class="sd">Gloo 后端不支持此 API。</span>

<span class="sd">    """</span>
    <span class="c1">Dynamo 内置逻辑将旧版分布式操作映射到功能集体。</span>
    <span class="c1">让我们重定向到一个可以模拟此逻辑的 torch 函数模式，该模式在 Dynamo 之外。</span>
    <span class="c1">（例如，非严格导出实现了这样的 torch 函数模式）。</span>
    <span class="n">相关参数</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</span><span class="p">,)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有 torch 功能</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">):</span>
        <span class="k">返回</span> <span class="n">handle_torch_function</span><span class="p">(</span>
            <span class="n">all_gather_into_tensor</span><span class="p">,</span>
            <span class="n">relevant_args</span><span class="p">,</span>
            <span class="n">输出张量</span><span class="p">,</span>
            <span class="n">输入张量</span><span class="p">,</span>
            <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
            <span class="n">async_op</span><span class="o">=</span><span class="n">async_op</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</span><span class="p">)</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"所有聚合到张量中"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="n">输出张量</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">输出张量</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</span><span class="p">()</span>
        <span class="k">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">输入张量</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">输入张量</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</span><span class="p">()</span>
        <span class="k">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">Allgather 选项</span><span class="p">()</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异步操作</span> <span class="o">=</span> <span class="n">async_op</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
        <span class="c1">我们处于合并上下文，不要执行单个操作，只需追加集体表示</span>
        <span class="n">合并</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_集合操作</font></font></font></span><span class="p">(</span><span class="n">all_gather_into_tensor</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</span><span class="p">)</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</span><span class="p">)</span>
        <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非法工作</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">_allgather_base</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<span class="nd">@_exception_logger</span>
<span class="nd">@deprecated</span><span class="p">(</span>
    <span class="s2">"`torch.distributed._all_gather_base` 是一个私有函数，并将被弃用。"</span>
    <span class="s2">"请使用 `torch.distributed.all_gather_into_tensor` 代替。"</span><span class="p">,</span>
    <span class="n">分类</font></font></font></span><span class="o">=</span><span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未来警告</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">定义</font></font></font></span> <span class="nf">_all_gather_base</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">单个张量全聚合。从所有进程收集单个张量，并将它们放入单个输出张量中。</span>

<span class="sd">参数：</span>
<span class="sd">输出张量（Tensor）：输出张量。它应包含</span>
<span class="sd">正确大小的张量，用于集体输出。</span>
<span class="sd">输入张量（Tensor）：当前进程要广播的张量。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否将此操作设置为异步操作</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">.. 警告::</span>
<span class="sd">`_all_gather_base`是一个私有函数。用户应使用</span>
<span class="sd">`all_gather_into_tensor`代替。</span>

<span class="sd">    """</span>
    <span class="k">返回</font></font></font></span> <span class="n">all_gather_into_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span> <span class="n">async_op</span><span class="p">)</span>


<span class="nd">@_exception_logger</span>
<span class="nd">@deprecated</span><span class="p">(</span>
    <span class="s2">"`torch.distributed.all_gather_coalesced` 将被弃用。如果必须使用，请稍后重新查阅我们的文档。"</span>
    <span class="s2">"请稍后在我们的文档中查阅。"</span>
    <span class="s2">https://pytorch.org/docs/main/分布式.html#集体函数</span><span class="p">,</span>
    <span class="n">分类</font></font></font></span><span class="o">=</span><span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未来警告</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局聚合合并</span><span class="p">(</span>
    <span class="n">输出张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">以合并方式从整个组收集输入张量到列表中。</span>

<span class="sd">支持复杂张量。</span>

<span class="sd">参数：</span>
<span class="sd">output_tensor_lists (list[list[Tensor]]): 输出列表。它应包含</span>
<span class="sd">正确大小的张量，用于集体输出。</span>
<span class="sd">input_tensor_list (list[Tensor]): 要从当前进程广播的张量。</span>
<span class="sd">至少有一个张量不能为空。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否此操作应为异步操作。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">示例：</span>
<span class="sd">我们有 2 个进程组，2 个进程等级。</span>
<span class="sd">        rank 0 passes:</span>
<span class="sd">            input_tensor_list = [[[1, 1], [1, 1]], [2], [3, 3]]</span>
<span class="sd">            output_tensor_lists =</span>
<span class="sd">[[[-1, -1], [-1, -1]], [-1], [-1, -1]]</span>
<span class="sd">[[[-1, -1], [-1, -1]], [-1], [-1, -1]]</span>
<span class="sd">排名 1 通过数：</span>
<span class="sd">            input_tensor_list = [[[3, 3], [3, 3]], [5], [1, 1]]</span>
<span class="sd">            output_tensor_lists =</span>
<span class="sd">[[[-1, -1], [-1, -1]], [-1], [-1, -1]]</span>
<span class="sd">[[[-1, -1], [-1, -1]], [-1], [-1, -1]]</span>
<span class="sd">两个都获得排名 0 和 1：</span>
<span class="sd">            output_tensor_lists =</span>
<span class="sd">               [[[1, 1], [1, 1]], [2], [3, 3]],</span>
<span class="sd">                [[3, 3], [3, 3]], [5], [1, 1]]].</span>

<span class="sd">警告：目前尚未在节点间实现单个形状检查。</span>
<span class="sd">例如，如果 0 阶节点传递[torch.rand(4), torch.rand(2)]和</span>
<span class="sd">排名 1 的节点通过 [torch.rand(2), torch.rand(2), torch.rand(2)]</span>
<span class="sd">all_gather_coalesced 操作将无怨无悔地进行并返回</span>
<span class="sd">错误的输出。这种缺乏形状检查导致性能显著提升，但使用此函数的用户应格外小心</span>
<span class="sd">这将带来显著的性能提升，但使用此函数的用户应格外小心</span>
<span class="sd">确保每个节点传递的张量形状在节点间匹配。</span>
<span class="sd">    """</span>
    <span class="c1">在这里我们仅检查与 C++参数的基本兼容性，C++代码将</span>
    <span class="c1">执行形状和类型检查。</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">all_gather_coalesced</span><span class="p">)</span>
        <span class="k">返回</span>
    <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span><span class="p">)</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
            <span class="s2">"无效的函数参数：output_tensor_lists 应该是一个列表"</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">输出张量列表</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</span><span class="p">:</span>
        <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</span><span class="p">)</span>
        <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</span><span class="p">)</span>

    <span class="n">输出张量列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="n">t</span> <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">l</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</span>
    <span class="p">]</span>
    <span class="n">输入张量列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span>
    <span class="p">]</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局聚合合并</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取未来</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">验证输出列表以排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">):</span>
    <span class="k">如果</font></font></font></span> <span class="n">dst</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                <span class="s2">"必须在目标排名上指定参数 ``收集列表``。"</span>
            <span class="p">)</span>
    <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="s2">参数 `gather_list` 在非目标节点上不得指定。</span>
        <span class="p">)</span>


<div class="viewcode-block" id="gather"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.gather">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">收集</span><span class="p">(</span>
    <span class="n">张量</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
    <span class="n">gather 列表</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">目标</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">async_op</span><span class="p">:</span> <span class="nb">布尔值</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
    <span class="n">群组目标</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">在单个进程中收集张量列表。</span>

<span class="sd">此函数要求每个进程上的所有张量大小必须相同。</span>

<span class="sd">参数：</span>
<span class="sd">张量（Tensor）：输入张量。</span>
<span class="sd">收集列表（list[Tensor]，可选）：适当列表</span>
<span class="sd">相同大小的张量用于收集数据</span>
<span class="sd">(默认为 None，必须在目标排名上指定)</span>
<span class="sd">dst (int, 可选): 目标全局进程组中的进程排名（无论 ``group`` 参数如何）。</span>
<span class="sd">（如果 ``dst`` 和 ``group_dst`` 都为 None，则默认为全局排名 0）</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否将此操作设置为异步操作</span>
<span class="sd">group_dst（int，可选）：在 ``group`` 上的目标排名。不能同时指定 ``dst`` 和 ``group_dst``。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">.. 注意:: 注意，gather_list 中的所有张量必须具有相同的大小。</span>

<span class="sd">示例::</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP("no rank")</span>
<span class="sd">&gt;&gt;&gt; # 我们有 2 个进程组，2 个 rank。</span>
<span class="sd">        &gt;&gt;&gt; tensor_size = 2</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(f'cuda:{rank}')</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.ones(tensor_size, device=device) + rank</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt; gather_list = [torch.zeros_like(tensor, device=device) for i in range(2)]</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">        &gt;&gt;&gt;     gather_list = None</span>
<span class="sd">        &gt;&gt;&gt; dist.gather(tensor, gather_list, dst=0)</span>
<span class="sd">&gt;&gt;&gt; # Rank 0 获取数据。</span>
<span class="sd">        &gt;&gt;&gt; gather_list</span>
<span class="sd">        [tensor([1., 1.], device='cuda:0'), tensor([2., 2.], device='cuda:0')] # Rank 0</span>
<span class="sd">        None                                                                   # Rank 1</span>

<span class="sd">    """</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"张量"</span><span class="p">)</span>

    <span class="c1">参数 ``gather_list`` 在非目标 rank 上可以不指定。</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">:</span>
        <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">,</span> <span class="s2">"gather_list"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">收集列表</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">)</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"聚集"</span><span class="p">)</span>
        <span class="k">返回</span>
    <span class="k">如果</font></font></font></span> <span class="n">dst</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n">group_dst</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">global_dst</span> <span class="o">=</span> <span class="n">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span><span class="p">)</span>
    <span class="n">group_dst</span> <span class="o">=</span> <span class="n">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">)</span>
    <span class="n">我的全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="n">验证输出列表以排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球目标</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gather 列表</span><span class="p">)</span>
    <span class="n">output_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">gather 列表</font></font></font></span><span class="p">]</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n">global_dst</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
    <span class="n">input_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">张量</span><span class="p">]</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">收集选项</span><span class="p">()</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根等级</span> <span class="o">=</span> <span class="n">group_dst</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">收集</font></font></font></span><span class="p">(</span><span class="n">output_tensors</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<div class="viewcode-block" id="scatter"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.scatter">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分散</span><span class="p">(</span>
    <span class="n">张量</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span>
    <span class="n">scatter_list</span><span class="p">:</span> <span class="n">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">async_op</span><span class="p">:</span> <span class="nb">布尔值</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
    <span class="n">群组源</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">将张量列表分散到组中的所有进程。</span>

<span class="sd">每个进程将恰好接收一个张量并将数据存储在</span>
<span class="sd">``tensor``参数中。</span>

<span class="sd">支持复杂张量。</span>

<span class="sd">参数：</span>
<span class="sd">索引张量（Tensor）：输出张量。</span>
<span class="sd">散列列表（list[Tensor]）：要散列的张量列表（默认为空，必须在源 rank 上指定）。</span>
<span class="sd">None，必须在全局进程组上的源 rank 上指定。</span>
<span class="sd">src（int）：全局进程组上的源 rank（无论``group``参数如何）。</span>
<span class="sd">（如果 ``src`` 和 ``group_src`` 都为 None，则默认为全局排名 0）</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否将此操作设置为异步操作</span>
<span class="sd">group_src (int, 可选): ``group`` 上的源排名。不能同时指定 ``src`` 和 ``group_src``。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">.. 注意:: 注意 scatter_list 中的所有张量必须具有相同的大小。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">        &gt;&gt;&gt; tensor_size = 2</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(f'cuda:{rank}')</span>
<span class="sd">        &gt;&gt;&gt; output_tensor = torch.zeros(tensor_size, device=device)</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt;     # 假设 world_size 为 2.</span>
<span class="sd">&gt;&gt;&gt;     # 只需张量，所有张量的大小必须相同。</span>
<span class="sd">        &gt;&gt;&gt;     t_ones = torch.ones(tensor_size, device=device)</span>
<span class="sd">        &gt;&gt;&gt;     t_fives = torch.ones(tensor_size, device=device) * 5</span>
<span class="sd">        &gt;&gt;&gt;     scatter_list = [t_ones, t_fives]</span>
<span class="sd">        &gt;&gt;&gt; else:</span>
<span class="sd">        &gt;&gt;&gt;     scatter_list = None</span>
<span class="sd">        &gt;&gt;&gt; dist.scatter(output_tensor, scatter_list, src=0)</span>
<span class="sd">&gt;&gt;&gt; # Rank i 获取 scatter_list[i].</span>
<span class="sd">        &gt;&gt;&gt; output_tensor</span>
<span class="sd">        tensor([1., 1.], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([5., 5.], device='cuda:1') # Rank 1</span>

<span class="sd">    """</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"张量"</span><span class="p">)</span>
    <span class="c1"># 参数 `scatter_list` 在非源 rank 上可以不指定。</span>
    <span class="k">如果</span> <span class="n">scatter_list</span><span class="p">:</span>
        <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n">scatter_list</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散点列表</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">散点列表</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">,</span> <span class="n">scatter_list</span><span class="p">)</span>
    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组或默认群组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">源</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">全局源</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span><span class="p">)</span>
    <span class="n">群组源</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标准化群组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回全局</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"散射"</span><span class="p">)</span>
        <span class="k">返回</span>
    <span class="n">散点列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散点列表</span>
    <span class="p">]</span>
    <span class="n">张量</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">张量</span><span class="p">)</span>

    <span class="n">我的全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局源</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的全球排名</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</span> <span class="n">scatter_list</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                <span class="s2">"必须在源端指定参数 ``散列列表``。"</span>
            <span class="p">)</span>
        <span class="n">input_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">scatter_list</span><span class="p">]</span>
        <span class="n">output_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">张量</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">如果</span> <span class="n">scatter_list</span><span class="p">:</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                <span class="s2">"``scatter_list`` 参数必须在非源节点上不指定。"</span>
            <span class="p">)</span>
        <span class="n">input_tensors</span> <span class="o">=</span> <span class="p">输入文本为空，请提供需要翻译的文本</span>
        <span class="n">output_tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">张量</span><span class="p">]</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">散点选项</span><span class="p">()</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根等级</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组源</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异步操作</span> <span class="o">=</span> <span class="n">async_op</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分散</font></font></font></span><span class="p">(</span><span class="n">output_tensors</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<div class="viewcode-block" id="reduce_scatter"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@_exception_logger
def reduce_scatter(output, input_list, op=ReduceOp.SUM, group=None, async_op=False):
"""
将张量列表减少并分散到组中的所有进程。

Args:
输出（张量）：输出张量。
输入列表（列表[张量]）：要减少和散布的张量列表。
op（可选）：以下值之一
torch.distributed.ReduceOp
枚举。指定用于逐元素减少的操作。
group（进程组，可选）：要工作的进程组。如果为 None，
则将使用默认进程组。
async_op (bool, 可选): 是否将此操作设置为异步操作。

返回：
异步工作句柄，如果 async_op 设置为 True。
如果不是 async_op 或不是组的一部分，则为 None。

"""
_check_single_tensor(output, "output")
_check_tensor_list(input_list, "input_list")
_ensure_all_tensors_same_dtype(output, input_list)
如果_rank_not_in_group(group):
_warn_not_in_group("reduce_scatter")
返回

opts = ReduceScatterOptions()
opts.reduceOp = op

group = group or _get_default_group()
work = group.reduce_scatter([output], [input_list], opts)

if async_op:
返回工作
else:
work.wait()</font></font></font></div>


<div class="viewcode-block" id="reduce_scatter_tensor"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.reduce_scatter_tensor">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf">reduce_scatter_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">减少后，将张量分散到组中的所有等级。</span>

<span class="sd">参数：</span>
<span class="sd">输出（张量）：输出张量。它应该在所有方面都具有相同的大小。</span>
<span class="sd">排名。</span>
<span class="sd">输入（张量）：要减少和散布的输入张量。其大小</span>
<span class="sd">应该是输出张量大小乘以全局大小。输入张量</span>
<span class="sd">可以具有以下形状之一：</span>
<span class="sd">（i）输出张量沿主轴的连接</span>
<span class="sd">维度，或</span>
<span class="sd">（ii）沿主维度输出的张量堆栈。</span>
<span class="sd">关于“连接”的定义，请参阅 ``torch.cat()``。</span>
<span class="sd">关于“堆叠”的定义，请参阅 ``torch.stack()``。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否此操作应为异步操作。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 以下所有张量均为 torch.int64 数据类型，且位于 CUDA 设备上。</span>
<span class="sd">&gt;&gt;&gt; 我们有两个等级。</span>
<span class="sd">        &gt;&gt;&gt; device = torch.device(f"cuda:{rank}")</span>
<span class="sd">        &gt;&gt;&gt; tensor_out = torch.zeros(2, dtype=torch.int64, device=device)</span>
<span class="sd">&gt;&gt;&gt; # 输入拼接形式</span>
<span class="sd">        &gt;&gt;&gt; tensor_in = torch.arange(world_size * 2, dtype=torch.int64, device=device)</span>
<span class="sd">        &gt;&gt;&gt; tensor_in</span>
<span class="sd">tensor([0, 1, 2, 3], device='cuda:0') # 级别 0</span>
<span class="sd">tensor([0, 1, 2, 3], device='cuda:1') # 1 级</span>
<span class="sd">        &gt;&gt;&gt; dist.reduce_scatter_tensor(tensor_out, tensor_in)</span>
<span class="sd">        &gt;&gt;&gt; tensor_out</span>
<span class="sd">        tensor([0, 2], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([4, 6], device='cuda:1') # Rank 1</span>
<span class="sd">&gt;&gt;&gt; # 栈输入</span>
<span class="sd">        &gt;&gt;&gt; tensor_in = torch.reshape(tensor_in, (world_size, 2))</span>
<span class="sd">        &gt;&gt;&gt; tensor_in</span>
<span class="sd">        tensor([[0, 1],</span>
<span class="sd">[[2, 3]], device='cuda:0' # Rank 0</span>
<span class="sd">        tensor([[0, 1],</span>
<span class="sd">[[2, 3]], device='cuda:1' # Rank 1</span>
<span class="sd">        &gt;&gt;&gt; dist.reduce_scatter_tensor(tensor_out, tensor_in)</span>
<span class="sd">        &gt;&gt;&gt; tensor_out</span>
<span class="sd">        tensor([0, 2], device='cuda:0') # Rank 0</span>
<span class="sd">        tensor([4, 6], device='cuda:1') # Rank 1</span>

<span class="sd">.. 警告::</span>
<span class="sd">Gloo 后端不支持此 API。</span>

<span class="sd">    """</span>
    <span class="c1">Dynamo 内置逻辑将旧版分布式操作映射到功能集体。</span>
    <span class="c1">让我们重定向到一个可以模拟此逻辑的 torch 函数模式，该模式在 Dynamo 之外。</span>
    <span class="c1">（例如，非严格导出实现了这样的 torch 函数模式）。</span>
    <span class="n">相关参数</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">,)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有 torch 功能</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">):</span>
        <span class="k">返回</span> <span class="n">handle_torch_function</span><span class="p">(</span>
            <span class="n">reduce_scatter_tensor</span><span class="p">,</span>
            <span class="n">relevant_args</span><span class="p">,</span>
            <span class="n">输出</span><span class="p">,</span>
            <span class="nb">输入</span><span class="p">,</span>
            <span class="n">操作</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span>
            <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
            <span class="n">async_op</span><span class="o">=</span><span class="n">async_op</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</span><span class="p">)</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"reduce_scatter_tensor"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">减少散布选项</span><span class="p">()</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">减少操作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</span>
    <span class="n">选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异步操作</span> <span class="o">=</span> <span class="n">async_op</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>

    <span class="c1"># 检查我们是否处于合并上下文</span>
    <span class="c1"># 如果我们处于合并上下文，则不要发出单个操作，只需附加一个集体表示</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">():</span>
        <span class="n">合并</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_集合操作</font></font></font></span><span class="p">(</span><span class="n">reduce_scatter_tensor</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
        <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg_coalesce_state_合并状态</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</span><span class="p">)</span>
        <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">非法工作</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">_reduce_scatter_base</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<span class="nd">@deprecated</span><span class="p">(</span>
    <span class="s2">"`torch.distributed._reduce_scatter_base` 是一个私有函数，并将被弃用。"</span>
    <span class="s2">"请使用 `torch.distributed.reduce_scatter_tensor` 代替。"</span><span class="p">,</span>
    <span class="n">分类</font></font></font></span><span class="o">=</span><span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未来警告</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">定义</font></font></font></span> <span class="nf">_reduce_scatter_base</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">=</span><span class="n">ReduceOp</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">将展平的 tensor 分散到组中的所有进程中。</span>

<span class="sd">参数：</span>
<span class="sd">输出（Tensor）：输出 tensor。</span>
<span class="sd">输入（Tensor）：输入 tensor 的大小为输出 tensor 大小乘以全局大小。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否此操作应为异步操作。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">.. 警告::</span>
<span class="sd">`_reduce_scatter_base` 是一个私有函数。用户应使用</span>
<span class="sd">`reduce_scatter_tensor` 代替。</span>

<span class="sd">    """</span>
    <span class="k">返回</font></font></font></span> <span class="n">reduce_scatter_tensor</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span> <span class="n">async_op</span><span class="p">)</span>


<div class="viewcode-block" id="all_to_all_single"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.all_to_all_single">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全向单播</span><span class="p">(</span>
    <span class="n">输出</span><span class="p">,</span>
    <span class="nb">输入</span><span class="p">,</span>
    <span class="n">输出分割大小</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">输入分割大小</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">async_op</span><span class="o">=</span><span class="kc">错误</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">将输入张量分割，然后将分割后的列表分散到组中的所有进程中。</span>

<span class="sd">然后将所有进程中接收到的张量连接起来。</span>
<span class="sd">并将其作为单个输出张量返回。</span>

<span class="sd">支持复杂张量。</span>

<span class="sd">参数：</span>
<span class="sd">输出（张量）：收集的连接输出张量。</span>
<span class="sd">输入（张量）：散列的输入张量。</span>
<span class="sd">output_split_sizes：（可选的[int]列表）：dim 0 的输出分割大小</span>
<span class="sd">如果指定为 None 或空，则 ``output`` 张量的 dim 0 必须能被分割</span>
<span class="sd">由 `world_size` 均等分配。</span>
<span class="sd">输入分割大小：(list[Int], 可选)：维度 0 的输入分割大小</span>
<span class="sd">如果指定为 None 或空，则 `input` 张量的维度 0 必须能被 `world_size` 整除</span>
<span class="sd">由 `world_size` 均等分配。</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否此操作应为异步操作。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">.. 警告::</span>
<span class="sd">`all_to_all_single`是实验性的，可能会更改。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("未定义的 rank")</span>
<span class="sd">        &gt;&gt;&gt; input = torch.arange(4) + rank * 4</span>
<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">        tensor([0, 1, 2, 3])     # Rank 0</span>
<span class="sd">        tensor([4, 5, 6, 7])     # Rank 1</span>
<span class="sd">        tensor([8, 9, 10, 11])   # Rank 2</span>
<span class="sd">        tensor([12, 13, 14, 15]) # Rank 3</span>
<span class="sd">        &gt;&gt;&gt; output = torch.empty([4], dtype=torch.int64)</span>
<span class="sd">        &gt;&gt;&gt; dist.all_to_all_single(output, input)</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        tensor([0, 4, 8, 12])    # Rank 0</span>
<span class="sd">        tensor([1, 5, 9, 13])    # Rank 1</span>
<span class="sd">        tensor([2, 6, 10, 14])   # Rank 2</span>
<span class="sd">        tensor([3, 7, 11, 15])   # Rank 3</span>

<span class="sd">&gt;&gt;&gt; # 类似于以下操作：</span>
<span class="sd">        &gt;&gt;&gt; scatter_list = list(input.chunk(world_size))</span>
<span class="sd">        &gt;&gt;&gt; gather_list = list(output.chunk(world_size))</span>
<span class="sd">        &gt;&gt;&gt; for i in range(world_size):</span>
<span class="sd">        &gt;&gt;&gt;     dist.scatter(gather_list[i], scatter_list if i == rank else [], src = i)</span>

<span class="sd">&gt;&gt;&gt; # 另一个不均匀分割的例子</span>
<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">        tensor([0, 1, 2, 3, 4, 5])                                       # Rank 0</span>
<span class="sd">        tensor([10, 11, 12, 13, 14, 15, 16, 17, 18])                     # Rank 1</span>
<span class="sd">        tensor([20, 21, 22, 23, 24])                                     # Rank 2</span>
<span class="sd">        tensor([30, 31, 32, 33, 34, 35, 36])                             # Rank 3</span>
<span class="sd">&gt;&gt;&gt; 输入分割</span>
<span class="sd">[2, 2, 1, 1]                                                     # 排名 0</span>
<span class="sd">[3, 2, 2, 2]                                                     # 排名 1</span>
<span class="sd">[2, 1, 1, 1]                                                     # 排名 2</span>
<span class="sd">[2, 2, 2, 1] # 排名 3</span>
<span class="sd">&gt;&gt;&gt; 输出分割</span>
<span class="sd">[2, 3, 2, 2] # 排名 0</span>
<span class="sd">[2, 2, 1, 2] # 排名 1</span>
<span class="sd">[1, 2, 1, 2] # 排名 2</span>
<span class="sd">[1, 2, 1, 1] # 排名 3</span>
<span class="sd">        &gt;&gt;&gt; output = ...</span>
<span class="sd">        &gt;&gt;&gt; dist.all_to_all_single(output, input, output_splits, input_splits)</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        tensor([ 0,  1, 10, 11, 12, 20, 21, 30, 31])                     # Rank 0</span>
<span class="sd">        tensor([ 2,  3, 13, 14, 22, 32, 33])                             # Rank 1</span>
<span class="sd">        tensor([ 4, 15, 16, 23, 34, 35])                                 # Rank 2</span>
<span class="sd">        tensor([ 5, 17, 18, 24, 36])                                     # Rank 3</span>


<span class="sd">&gt;&gt;&gt; # 另一个示例，使用 torch.cfloat 类型的张量。</span>
<span class="sd">        &gt;&gt;&gt; input = torch.tensor(</span>
<span class="sd">[..., [1 + 1j, 2 + 2j, 3 + 3j, 4 + 4j], dtype=torch.cfloat]</span>
<span class="sd">        ... ) + 4 * rank * (1 + 1j)</span>
<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">tensor([1+i, 2+2i, 3+3i, 4+4i])                                # Rank 0</span>
<span class="sd">tensor([5+5i, 6+6i, 7+7i, 8+8i])                                # Rank 1</span>
<span class="sd">        tensor([9+9j, 10+10j, 11+11j, 12+12j])                          # Rank 2</span>
<span class="sd">        tensor([13+13j, 14+14j, 15+15j, 16+16j])                        # Rank 3</span>
<span class="sd">        &gt;&gt;&gt; output = torch.empty([4], dtype=torch.int64)</span>
<span class="sd">        &gt;&gt;&gt; dist.all_to_all_single(output, input)</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        tensor([1+1j, 5+5j, 9+9j, 13+13j])                              # Rank 0</span>
<span class="sd">        tensor([2+2j, 6+6j, 10+10j, 14+14j])                            # Rank 1</span>
<span class="sd">        tensor([3+3j, 7+7j, 11+11j, 15+15j])                            # Rank 2</span>
<span class="sd">        tensor([4+4j, 8+8j, 12+12j, 16+16j])                            # Rank 3</span>
<span class="sd">    """</span>
    <span class="c1">Dynamo 内置逻辑将旧版分布式操作映射到功能集体。</span>
    <span class="c1">让我们重定向到一个可以模拟此逻辑的 torch 函数模式，该模式在 Dynamo 之外。</span>
    <span class="c1">（例如，非严格导出实现了这样的 torch 函数模式）。</span>
    <span class="n">相关参数</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">,)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有 torch 功能</span><span class="p">(</span><span class="n">relevant_args</span><span class="p">):</span>
        <span class="k">返回</span> <span class="n">handle_torch_function</span><span class="p">(</span>
            <span class="n">全向单播</span><span class="p">,</span>
            <span class="n">relevant_args</span><span class="p">,</span>
            <span class="n">输出</span><span class="p">,</span>
            <span class="nb">输入</span><span class="p">,</span>
            <span class="n">输出分割大小</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出分割大小</span><span class="p">,</span>
            <span class="n">输入分割大小</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入分割大小</span><span class="p">,</span>
            <span class="n">组</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">,</span>
            <span class="n">async_op</span><span class="o">=</span><span class="n">async_op</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">全向单播</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">AllToAll 选项</span><span class="p">()</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</span><span class="p">)</span>
    <span class="n">_检查单个张量</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">)</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</span><span class="p">():</span>
        <span class="nb">输入</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</span><span class="p">():</span>
        <span class="n">输出</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出</span><span class="p">)</span>

    <span class="n">输出分割大小</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出分割大小</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出分割大小</span>
    <span class="n">输入分割大小</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入分割大小</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入分割大小</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="o">.</span><span class="n">alltoall_base</span><span class="p">(</span>
        <span class="n">输出</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出分割大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入分割大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span>
    <span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<div class="viewcode-block" id="all_to_all"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.all_to_all">[文档]</a><span class="nd">@_exception_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全部到全部</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n">async_op</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">将输入张量的散列列表分配到组中的所有进程，并返回输出列表中收集的张量列表。</span>

<span class="sd">支持复杂张量。</span>

<span class="sd">参数：</span>
<span class="sd">output_tensor_list (list[Tensor]): 需要收集的每个 rank 的张量列表</span>
<span class="sd">            per rank.</span>
<span class="sd">input_tensor_list (list[Tensor]): 每个 rank 散列的张量列表</span>
<span class="sd">group（ProcessGroup，可选）：要工作的进程组。如果为 None，</span>
<span class="sd">则使用默认进程组。</span>
<span class="sd">async_op (bool, 可选): 是否此操作应为异步操作。</span>

<span class="sd">返回：</span>
<span class="sd">异步工作处理，如果 async_op 设置为 True。</span>
<span class="sd">如果不是 async_op 或不是组的一部分，则为 None。</span>

<span class="sd">.. 警告::</span>
<span class="sd">`all_to_all`是实验性的，可能会更改。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("未定义的 rank")</span>
<span class="sd">        &gt;&gt;&gt; input = torch.arange(4) + rank * 4</span>
<span class="sd">        &gt;&gt;&gt; input = list(input.chunk(4))</span>
<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">        [tensor([0]), tensor([1]), tensor([2]), tensor([3])]     # Rank 0</span>
<span class="sd">        [tensor([4]), tensor([5]), tensor([6]), tensor([7])]     # Rank 1</span>
<span class="sd">        [tensor([8]), tensor([9]), tensor([10]), tensor([11])]   # Rank 2</span>
<span class="sd">[tensor([12]), tensor([13]), tensor([14]), tensor([15])] # 程序秩为 3</span>
<span class="sd">        &gt;&gt;&gt; output = list(torch.empty([4], dtype=torch.int64).chunk(4))</span>
<span class="sd">        &gt;&gt;&gt; dist.all_to_all(output, input)</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">[tensor([0]), tensor([4]), tensor([8]), tensor([12])]    # 零阶</span>
<span class="sd">        [tensor([1]), tensor([5]), tensor([9]), tensor([13])]    # Rank 1</span>
<span class="sd">        [tensor([2]), tensor([6]), tensor([10]), tensor([14])]   # Rank 2</span>
<span class="sd">        [tensor([3]), tensor([7]), tensor([11]), tensor([15])]   # Rank 3</span>

<span class="sd">&gt;&gt;&gt; # 类似于以下操作：</span>
<span class="sd">        &gt;&gt;&gt; scatter_list = input</span>
<span class="sd">        &gt;&gt;&gt; gather_list = output</span>
<span class="sd">        &gt;&gt;&gt; for i in range(world_size):</span>
<span class="sd">        &gt;&gt;&gt;     dist.scatter(gather_list[i], scatter_list if i == rank else [], src=i)</span>

<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">        tensor([0, 1, 2, 3, 4, 5])                                       # Rank 0</span>
<span class="sd">        tensor([10, 11, 12, 13, 14, 15, 16, 17, 18])                     # Rank 1</span>
<span class="sd">        tensor([20, 21, 22, 23, 24])                                     # Rank 2</span>
<span class="sd">        tensor([30, 31, 32, 33, 34, 35, 36])                             # Rank 3</span>
<span class="sd">&gt;&gt;&gt; 输入分割</span>
<span class="sd">[2, 2, 1, 1]                                                     # 排名 0</span>
<span class="sd">[3, 2, 2, 2]                                                     # 排名 1</span>
<span class="sd">[2, 1, 1, 1]                                                     # 排名 2</span>
<span class="sd">[2, 2, 2, 1] # 排名 3</span>
<span class="sd">&gt;&gt;&gt; 输出分割</span>
<span class="sd">[2, 3, 2, 2] # 排名 0</span>
<span class="sd">[2, 2, 1, 2] # 排名 1</span>
<span class="sd">[1, 2, 1, 2] # 排名 2</span>
<span class="sd">[1, 2, 1, 1] # 排名 3</span>
<span class="sd">&gt;&gt;&gt; 输入 = 列表(输入.split(输入分割))</span>
<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">        [tensor([0, 1]), tensor([2, 3]), tensor([4]), tensor([5])]                   # Rank 0</span>
<span class="sd">        [tensor([10, 11, 12]), tensor([13, 14]), tensor([15, 16]), tensor([17, 18])] # Rank 1</span>
<span class="sd">        [tensor([20, 21]), tensor([22]), tensor([23]), tensor([24])]                 # Rank 2</span>
<span class="sd">        [tensor([30, 31]), tensor([32, 33]), tensor([34, 35]), tensor([36])]         # Rank 3</span>
<span class="sd">        &gt;&gt;&gt; output = ...</span>
<span class="sd">        &gt;&gt;&gt; dist.all_to_all(output, input)</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        [tensor([0, 1]), tensor([10, 11, 12]), tensor([20, 21]), tensor([30, 31])]   # Rank 0</span>
<span class="sd">        [tensor([2, 3]), tensor([13, 14]), tensor([22]), tensor([32, 33])]           # Rank 1</span>
<span class="sd">        [tensor([4]), tensor([15, 16]), tensor([23]), tensor([34, 35])]              # Rank 2</span>
<span class="sd">        [tensor([5]), tensor([17, 18]), tensor([24]), tensor([36])]                  # Rank 3</span>

<span class="sd">&gt;&gt;&gt; # 另一个示例，使用 torch.cfloat 类型的张量。</span>
<span class="sd">        &gt;&gt;&gt; input = torch.tensor(</span>
<span class="sd">[..., [1 + 1j, 2 + 2j, 3 + 3j, 4 + 4j], dtype=torch.cfloat]</span>
<span class="sd">        ... ) + 4 * rank * (1 + 1j)</span>
<span class="sd">        &gt;&gt;&gt; input = list(input.chunk(4))</span>
<span class="sd">        &gt;&gt;&gt; input</span>
<span class="sd">        [tensor([1+1j]), tensor([2+2j]), tensor([3+3j]), tensor([4+4j])]            # Rank 0</span>
<span class="sd">        [tensor([5+5j]), tensor([6+6j]), tensor([7+7j]), tensor([8+8j])]            # Rank 1</span>
<span class="sd">        [tensor([9+9j]), tensor([10+10j]), tensor([11+11j]), tensor([12+12j])]      # Rank 2</span>
<span class="sd">        [tensor([13+13j]), tensor([14+14j]), tensor([15+15j]), tensor([16+16j])]    # Rank 3</span>
<span class="sd">        &gt;&gt;&gt; output = list(torch.empty([4], dtype=torch.int64).chunk(4))</span>
<span class="sd">        &gt;&gt;&gt; dist.all_to_all(output, input)</span>
<span class="sd">        &gt;&gt;&gt; output</span>
<span class="sd">        [tensor([1+1j]), tensor([5+5j]), tensor([9+9j]), tensor([13+13j])]          # Rank 0</span>
<span class="sd">        [tensor([2+2j]), tensor([6+6j]), tensor([10+10j]), tensor([14+14j])]        # Rank 1</span>
<span class="sd">        [tensor([3+3j]), tensor([7+7j]), tensor([11+11j]), tensor([15+15j])]        # Rank 2</span>
<span class="sd">        [tensor([4+4j]), tensor([8+8j]), tensor([12+12j]), tensor([16+16j])]        # Rank 3</span>

<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">全对全</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">AllToAll 选项</span><span class="p">()</span>
    <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</span><span class="p">)</span>
    <span class="n">`_check_tensor_list`</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span><span class="p">)</span>
    <span class="n">确保所有张量具有相同的数据类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span><span class="p">)</span>

    <span class="n">输入张量列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</span>
    <span class="p">]</span>
    <span class="n">输出张量列表</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n">t</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是复杂的</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实查看</font></font></font></span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</span>
    <span class="p">]</span>

    <span class="n">群组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">工作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="o">.</span><span class="n">alltoall</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输出张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入张量列表</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">)</span>

    <span class="k">如果</span> <span class="n">async_op</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">工作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待</span><span class="p">()</span></div>


<div class="viewcode-block" id="barrier"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@_异常记录器
def 障碍(
group: Optional[ProcessGroup] = GroupMember.WORLD, 异步操作=False, 设备 ID=None
):
"""
同步所有进程。

此集体块将阻止进程，直到整个组进入此函数，
如果 async_op 为 False，或者如果在 wait() 上调用异步工作处理程序。

Args:
进程组（ProcessGroup，可选）：要工作的进程组。如果为 None，
将使用默认进程组。
async_op（布尔值，可选）：此操作是否应为异步操作
设备 ID 列表 ([int]，可选)：设备/GPU ID 列表。

返回：
异步工作句柄，如果 async_op 设置为 True。
如果不是 async_op 或不是组的一部分，则为 None。

.. 注意:: `ProcessGroupNCCL` 现在会阻塞 CPU 线程直到屏障集体操作完成。
"""
if _rank_not_in_group(group):
_warn_not_in_group("barrier")
返回

opts = BarrierOptions()
opts.device = torch.device(_get_object_coll_device(group))
如果 device_ids 不为 None:
如果 device_ids 是列表类型：
opts.device_ids = device_ids
else:
raise TypeError(
"无效的函数参数：device_ids 类型应为 List[int]"
            )

group = group or _get_default_group()
work = group.barrier(opts=opts)

if async_op:
返回工作
else:
work.wait()</font></font></font></div>


<div class="viewcode-block" id="monitored_barrier"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.monitored_barrier">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">监控屏障</span><span class="p">(</span>
    <span class="n">组</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组成员</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界</span><span class="p">,</span>
    <span class="n">超时</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">等待所有 rank</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">类似于 `torch.distributed.barrier` 的进程同步，但考虑可配置的超时时间。</span>

<span class="sd">能够报告在提供超时时间内未通过此屏障的等级。</span>
<span class="sd">特别是对于非零等级，将阻塞直到从等级 0 处理完发送/接收操作。</span>
<span class="sd">Rank 0 将阻塞，直到所有来自其他 rank 的发送/接收操作处理完毕，并将报告</span>
<span class="sd">失败信息给未能及时响应的 rank。注意，如果一个 rank 没有达到监控屏障（例如由于挂起），则所有其他 rank 都会在监控屏障中失败。</span>
<span class="sd">此集体操作将阻塞组中所有进程/rank，直到</span>

<span class="sd">所有进程/rank 都完成操作。</span>
<span class="sd">整个组成功退出函数，使其对调试很有用</span>
<span class="sd">然而，它可能会影响性能，并且仅应</span>
<span class="sd">用于调试或需要主机端完整同步点的场景</span>
<span class="sd">为了调试目的，可以在该屏障处插入</span>
<span class="sd">在应用程序的集体调用检查是否有任何排名</span>
<span class="sd">不同步。</span>

<span class="sd">.. 注意:: 注意，此集体仅支持 GLOO 后端。</span>

<span class="sd">参数：</span>
<span class="sd">群组（ProcessGroup，可选）：要工作的进程组。如果</span>
<span class="sd">如果为 ``None``，将使用默认进程组。</span>
<span class="sd">超时（datetime.timedelta，可选）：监控屏障的超时时间。</span>
<span class="sd">如果为 ``None``，将使用默认进程组超时时间。</span>
<span class="sd">wait_all_ranks（布尔值，可选）：是否收集所有失败的进程。</span>
<span class="sd">默认情况下，这是 ``False``，并且 ``monitored_barrier`` 在 0 级别</span>
<span class="sd">将在遇到第一个失败的级别时抛出异常，以失败结束</span>
<span class="sd">快速。通过设置 ``wait_all_ranks=True``，``monitored_barrier`` 将</span>
<span class="sd">收集所有失败的级别并抛出一个包含信息的错误</span>
<span class="sd">关于所有失败的排名。</span>

<span class="sd">返回：</span>
<span class="sd">``None``。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">&gt;&gt;&gt; # 注意：每个进程的进程组初始化被省略。</span>
<span class="sd">&gt;&gt;&gt; 导入 torch.distributed 作为 dist</span>
<span class="sd">        &gt;&gt;&gt; if dist.get_rank() != 1:</span>
<span class="sd">&gt;&gt;&gt;     dist.monitored_barrier() # 抛出异常，指示 rank 1 未调用 monitored_barrier。</span>
<span class="sd">&gt;&gt;&gt; # rank 1 未调用 monitored_barrier。</span>
<span class="sd">&gt;&gt;&gt; # 示例：wait_all_ranks=True</span>
<span class="sd">&gt;&gt;&gt; 如果 dist.get_rank() 等于 0:</span>
<span class="sd">&gt;&gt;&gt;     dist.monitored_barrier(wait_all_ranks=True) # 抛出异常</span>
<span class="sd">&gt;&gt;&gt; # 表示 rank 1, 2, ... world_size - 1 没有调用</span>
<span class="sd">&gt;&gt;&gt; # 监控屏障.</span>
<span class="sd">    """</span>
    <span class="c1"># 在使用组之前需要调用不在组中的 rank，否则</span>
    <span class="c1"># 会抛出“无效进程组”错误。</span>
    <span class="k">如果</font></font></font></span> <span class="n">_rank_not_in_group</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">):</span>
        <span class="n">_warn_not_in_group</span><span class="p">(</span><span class="s2">"monitored_barrier"</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</font></font></font></span><span class="p">)</span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">GLOO</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">监控屏障仅对 GLOO 后端进行了实现。</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取默认超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组</span><span class="p">))</span>
    <span class="k">如果...否则</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="c1">显然，某些现有的测试用例对于 monitored_barrier 在浮点格式下超时通过？</span>
        <span class="n">警告</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span><span class="p">(</span>
            <span class="s2">请指定超时参数为 timedelta。</span>
            <span class="sa">f</span><span class="s2">转换当前值为</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假设它代表秒"</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">秒数</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>

    <span class="n">_检查有效超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>

    <span class="n">要使用的组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">监控屏障</font></font></font></span><span class="p">(</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 类型：忽略[未定义]</span>
        <span class="n">超时时间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待所有 rank</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等待所有等级</span>
    <span class="p">)</span></div>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建进程组包装器</span><span class="p">(</span>
    <span class="n">包装的 PG</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_分布式_c10d</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span>
    <span class="n">存储前缀</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">,</span>
    <span class="n">店铺</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</span><span class="p">,</span>
    <span class="n">排名</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">世界大小</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">超时时间</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认 PG 超时</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_GLOO 可用</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"ProcessGroupWrapper 不支持 GLOO 后端。"</span>

    <span class="c1"># (whc) 这似乎仅适用于 gloo 后端？如果是这样，`default_pg_timeout`是合适的...</span>

    <span class="c1">为辅助进程组创建一个独立的存储前缀。</span>
    <span class="n">前缀</font></font></font></span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PG 包装器存储前缀</font></font></font></span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储前缀</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</span><span class="p">)</span>
    <span class="n">辅助 PG</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">网格流程组 Gloo</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">店铺</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时时间</span><span class="p">)</span>
    <span class="c1">将底层 pg 包装为 ProcessGroupWrapper。</span>
    <span class="n">包裹的页面</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组包装器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包装的 PG</span><span class="p">,</span> <span class="n">helper_pg</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包裹的页面</span>


<span class="c1"># 确定性散列一系列排名到唯一</span>
<span class="c1"># 字符串</span>
<span class="k">定义</font></font></font></span> <span class="nf">_hash_ranks_to_str</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
    <span class="n">排名连接</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“_”</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">连接</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">地图</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">))</span>
    <span class="c1"># 如果已经存在具有相同排名组合的 PG</span>
    <span class="n">unique_str</span> <span class="o">=</span> <span class="s2">“_”</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">连接</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">[</font></font></font></span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名连接</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</span><span class="p">))])</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="nb">字节</font></font></font></span><span class="p">(</span><span class="n">unique_str</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">utf-8</font></font></font></span><span class="p">),</span> <span class="n">usedforsecurity</span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">摘要</span><span class="p">()</span>


<span class="c1"># 计算一个整数颜色，输入一个排名列表</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_处理组颜色</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># 将列表转换为元组以使其可哈希</span>
    <span class="n">排名</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
    <span class="n">哈希值</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">哈希</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
    <span class="c1">分割颜色必须为：</span>
    <span class="c1">非负整数；</span>
    <span class="c1">与 C 语言的 int 类型兼容，因为我们绑定到后者。</span>
    <span class="c1">因此，我们将哈希值限制在 c_int 的最大值内。</span>
    <span class="n">最大整型</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">颜色</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绝对值</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">哈希值</font></font></font></span><span class="p">)</span> <span class="o">%</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大整型</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">颜色</span>


<span class="k">定义</font></font></font></span> <span class="nf">_process_group_name</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用哈希名称</span><span class="p">):</span>
    <span class="c1">为进程组创建名称。</span>
    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用哈希名称</span><span class="p">:</span>
        <span class="n">pg_name</span> <span class="o">=</span> <span class="n">_hash_ranks_to_str</span><span class="p">(</span><span class="n">排名</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pg_name</span> <span class="o">=</span> <span class="nb">字符串</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组计数</span><span class="p">)</span>
        <span class="n">_世界</span><span class="o">.</span><span class="n">group_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># TODO: 为什么只在 else 路径中增加组计数？</span>
    <span class="k">return</span> <span class="n">pg_name</span>


<span class="k">定义</font></font></font></span> <span class="nf">_get_backend_from_str</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">:</span>
    <span class="c1">默认使用与全局进程组相同的后端</span>
    <span class="c1">如果未指定后端。</span>
    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>


<span class="k">定义</font></font></font></span> <span class="nf">_is_safe_to_split</span><span class="p">()</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</span><span class="p">:</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">检查在世界上是否可以安全地拆分任何进程组。</span>
<span class="sd">这只在默认的 pg 有绑定设备 ID 时才安全，否则</span>
<span class="sd">用户必须意识到，在第一个集体发布后，pg 才能分割。</span>
<span class="sd">才可以发行。</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="kc">假</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>


<span class="nd">@_time_logger</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</span><span class="p">(</span>
    <span class="n">父页面</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">分割等级</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">超时</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">时间差</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">pg 选项</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组描述</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">从给定的父进程组创建一个新的进程组。</span>

<span class="sd">警告：这是一个实验性 API，仅支持`NCCL`后端。</span>
<span class="sd">其他后端将引发错误。</span>
<span class="sd">使用此 API 的用户必须保证父组中的所有 rank 都进入此 API 调用。</span>
<span class="sd">子组的分割在父组中所有等级都是相同的。</span>

<span class="sd">参数：</span>
<span class="sd">parent_pg (ProcessGroup, 可选): 父进程组。如果为 None，则</span>
<span class="sd">将使用默认进程组。用户需要保证</span>
<span class="sd">父组已完全初始化（例如，通信器已初始化）</span>
<span class="sd">split_ranks (list[list[int]]): 分割等级，即等级的列表列表。</span>
<span class="sd">用户需要确保分割排名的有效性，以便一个</span>
<span class="sd">分割（由一个整数内部列表表示）不与其他分割重叠。</span>
<span class="sd">请注意，每个分组的排名是组内排名（而不是全局排名）</span>
<span class="sd">在父页。例如，如果父组有 4 个等级，并且 split_ranks 可以为</span>
<span class="sd">[[0, 1], [2, 3]]. 注意 [[0,1]] 也是一个有效的分割，在这种情况下，排名 2、3 的返回值将</span>
<span class="sd">返回一个非组成员。</span>
<span class="sd">timeout (timedelta, 可选): 请参阅 `init_process_group` 了解详细信息及默认值。</span>
<span class="sd">pg_options（ProcessGroupOptions，可选）：目前仅支持 ProcessGroupNCCLOptions。</span>
<span class="sd">在构建特定进程组时需要指定哪些附加选项</span>
<span class="sd">特定进程组的构建。例如：``is_high_priority_stream``</span>
<span class="sd">可以指定，以便进程组可以拾取高优先级的 CUDA 流。</span>
<span class="sd">对于配置 NCCL 的其他可用选项，</span>
<span class="sd">请见 https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/api/types.html#ncclconfig-t</span>
<span class="sd">group_desc (str, 可选)：用于描述进程组的字符串。</span>

<span class="sd">返回：</span>
<span class="sd">当前排名在 split_ranks 指定的一个 split/subgroup 内时，使用 ProcessGroup；如果当前排名不属于任何 split_ranks，则使用 None。</span>
<span class="sd">或 None，如果当前排名不属于任何 split_ranks。</span>

<span class="sd">    """</span>
    <span class="c1"># 检查输入</span>
    <span class="k">如果</font></font></font></span> <span class="n">split_ranks</span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"split_ranks 不能为空"</span><span class="p">)</span>

    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>
    <span class="n">默认页面</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="n">设备 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span>
    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">:</span>
        <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
            <span class="s2">"默认 pg 没有关联设备，拆分任何进程组不安全"</span>
        <span class="p">)</span>
    <span class="n">_default_backend</span><span class="p">,</span> <span class="n">默认商店</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span><span class="p">]</span>
    <span class="n">全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">()</span>
    <span class="n">全球世界大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">()</span>

    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父页面</span><span class="p">:</span>
        <span class="n">父级页面</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级页面</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"组"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父页面</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未注册</span><span class="p">)</span>

    <span class="n">父全局到组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父页面</span><span class="p">]</span>
    <span class="n">父组到全局排名</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">群组排名</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</span>
        <span class="k">for</span> <span class="n">全球排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级全局到组排名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级全局到组排名</span><span class="p">:</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">全球排名</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不属于父组</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父页面</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>

    <span class="n">父级组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级全局到组排名</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</span><span class="p">]</span>
    <span class="n">父级后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">))</span>

    <span class="c1"># 如果父级后端不支持拆分，则抛出错误</span>
    <span class="c1">当前此 API 仅支持 NCCL 后端</span>
    <span class="k">如果</span> <span class="p">(</span>
        <span class="ow">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级后端</span>
        <span class="ow">或者</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">支持拆分</span>
        <span class="ow">或者</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父后端</span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
            <span class="s2">"父进程组没有后端，或者其后端不支持分割"</span>
        <span class="p">)</span>

    <span class="c1">在设置分组描述之前设置颜色或无颜色分割</span>
    <span class="n">群组描述</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">父页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割:</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分区数量</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
        <span class="k">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span>
    <span class="p">)</span>

    <span class="n">父后端字符串</font></font></font></span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父页面</span><span class="p">]</span>
    <span class="c1">与父进程组相同的后端类型</span>
    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父后端字符串</span><span class="p">)</span>
    <span class="n">backend_config</span> <span class="o">=</span> <span class="n">后端配置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 选项</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PG 选项</font></font></font></span><span class="p">,</span> <span class="n">ProcessGroupNCCL</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">期望 pg_options 参数为 ProcessGroupNCCL.Options 类型</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># 默认的 pg_options 与父进程组相同</span>
        <span class="n">pg 选项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项</span>

    <span class="c1"># 此超时默认/验证用于所有 new_groups/new_subgroups 变体</span>
    <span class="c1"># 可能只是传递了它们的超时值（或 None）</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取默认超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
    <span class="n">_检查有效超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">)</span>

    <span class="c1">在 split_ranks 中查找我的组等级和我的组本地等级</span>
    <span class="n">我的组</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="n">组排名</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">为</font></font></font></span> <span class="n">split_group</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割等级</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"split 组不能为空"</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</font></font></font></span><span class="p">)</span> <span class="o">&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球世界大小</span><span class="p">:</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"分割组的数量应小于或等于由 init_process_group 设置的 world_size"</span>
            <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</font></font></font></span><span class="p">)</span> <span class="o">!=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</span><span class="p">)):</span>
            <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分组不能有重复的排名</span><span class="p">)</span>
        <span class="n">split_group</span> <span class="o">=</span> <span class="nb">排序</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级组排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</span><span class="p">:</span>
            <span class="n">我的组</span> <span class="o">=</span> <span class="n">split_group</span>
            <span class="n">组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级组排名</span><span class="p">)</span>
            <span class="k">断开</span>
    <span class="c1">如果我的排名不属于任何子组，</span>
    <span class="c1">应该调用 no_color 分割</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的组</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组排名</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">父后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">执行无颜色分割</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="n">group_name</span> <span class="o">=</span> <span class="n">_process_group_name</span><span class="p">(</span><span class="n">我的组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用哈希名称</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">)</span>
    <span class="n">我组中的全局排名</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父组到全局排名</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">]</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的组</span><span class="p">]</span>

    <span class="n">前缀存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">前缀存储</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“”</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认商店</span><span class="p">)</span>
    <span class="c1">我们在初始化后注册后端，并在 pg_options 中设置超时。</span>
    <span class="n">pg</span><span class="p">:</span> <span class="n">进程组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">(</span>
        <span class="n">prefix_store</span><span class="p">,</span>
        <span class="n">群组排名</span><span class="p">,</span>
        <span class="nb">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的组</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">后端类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="o">.</span><span class="n">BackendType</span><span class="o">.</span><span class="n">NCCL</span>
    <span class="n">pg</span><span class="o">.</span><span class="n">绑定设备 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span>
    <span class="n">pg</span><span class="o">.</span><span class="n">_设置默认后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型</span><span class="p">)</span>

    <span class="n">PG 选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
    <span class="n">PG 选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割从</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">父级后端</span>
    <span class="n">PG 选项</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割颜色</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_处理组颜色</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的组</span><span class="p">)</span>
    <span class="n">PG 选项</font></font></font></span><span class="o">.</span><span class="n">global_ranks_in_group</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我组中的全局排名</span>
    <span class="n">PG 选项</span><span class="o">.</span><span class="n">group_name</span> <span class="o">=</span> <span class="n">group_name</span>
    <span class="n">backend_class</span> <span class="o">=</span> <span class="n">ProcessGroupNCCL</span><span class="p">(</span>
        <span class="n">prefix_store</span><span class="p">,</span> <span class="n">群组排名</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的组</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 选项</span>
    <span class="p">)</span>
    <span class="n">后端类</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为组设置序列号</span><span class="p">()</span>

    <span class="n">pg</span><span class="o">.</span><span class="n">注册后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端类</span><span class="p">)</span>

    <span class="c1">将 group_name 和 group_desc 设置为后端</span>
    <span class="k">断言</font></font></font></span> <span class="n">group_name</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="n">pg</span><span class="o">.</span><span class="n">设置群组名称</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">)</span>
    <span class="n">pg</span><span class="o">.</span><span class="n">设置群组描述</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span><span class="p">)</span>

    <span class="c1">在 split_group 中始终积极初始化后端</span>
    <span class="n">贪婪后端</font></font></font></span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">)</span>
    <span class="n">贪婪后端</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">主动连接单个设备</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">)</span>

    <span class="c1">更新全局状态</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span> <span class="n">prefix_store</span><span class="p">)</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_name</span>
    <span class="n">_注册进程组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="p">,</span> <span class="n">pg</span><span class="p">)</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 后端配置</font></font></font></span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端配置</span><span class="p">)</span>
    <span class="n">pg_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">ptd:</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</span><span class="si">}</span><span class="s2">"</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">pg_tag</span><span class="p">,</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空列表</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>
    <span class="n">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="n">pg_tag</span>

    <span class="c1">创建全局排名到组排名的映射</span>
    <span class="n">_世界</span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">全球排名</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组排名</span>
        <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局排名在我组中</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">pg</span>


<div class="viewcode-block" id="new_group"><a class="viewcode-back" href="../../../distributed.html#torch.distributed.new_group">[文档]</a><span class="nd">@_time_logger</span>
<span class="k">def</span> <span class="nf">创建新组</span><span class="p">(</span>
    <span class="n">排名</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">超时</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">后端</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">PG 选项</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">使用本地同步</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
    <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备 ID</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">创建一个新的分布式组。</span>

<span class="sd">此功能要求主组（即所有）中的所有进程（即所有</span>
<span class="sd">分布式作业中的进程进入此函数，即使</span>
<span class="sd">如果他们不是该组成员。此外，群组</span>
<span class="sd">应在所有进程中以相同的顺序创建。</span>

<span class="sd">.. 警告::</span>
<span class="sd">安全的并发使用：</span>
<span class="sd">当使用具有 ``NCCL`` 后端的多个进程组时，用户</span>
<span class="sd">必须确保集体操作的执行顺序在全球范围内保持一致。</span>
<span class="sd">排名。</span>

<span class="sd">如果一个进程内的多个线程发出集体操作，显式</span>
<span class="sd">同步是确保一致顺序的必要条件。</span>

<span class="sd">当使用 torch.distributed 通信 API 的异步变体时</span>
<span class="sd">返回一个工作对象，并将通信内核</span>
<span class="sd">放入单独的 CUDA 流中，允许通信</span>
<span class="sd">和计算的并行执行。一旦在一个进程组上</span>
<span class="sd">发起了一个或多个异步操作，它们必须通过调用</span>
<span class="sd">在使用另一个进程组之前。</span>

<span class="sd">查看《同时使用多个 NCCL 通信器 `__》</span>
<span class="sd">ia.com/deeplearning/nccl/user-guide/docs/使用/通信器.html#使用</span>
<span class="sd">-同时使用多个 NCCL 通信器，更多详情请参阅。</span>

<span class="sd">参数：</span>
<span class="sd">ranks (list[int]): 群成员的等级列表。如果为 ``None``，则将所有等级设置为。默认为 ``None``。</span>
<span class="sd">将所有等级设置为。默认为 ``None``。</span>
<span class="sd">timeout (timedelta, 可选): 请参阅 `init_process_group` 了解详细信息及默认值。</span>
<span class="sd">后端（str 或 Backend，可选）：要使用的后端。根据构建时配置，有效值包括`mpi`、`gloo`、`nccl`、`ucc`或由第三方插件注册的值。</span>
<span class="sd">构建时配置，有效值为 ``gloo`` 和 ``nccl``。</span>
<span class="sd">默认使用与全局组相同的后端。此字段</span>
<span class="sd">应该以小写字符串的形式提供（例如，``"gloo"``），也可以</span>
<span class="sd">通过：class:`Backend`属性访问（例如，</span>
<span class="sd">``Backend.GLOO``）。如果传入``None``，则后端</span>
<span class="sd">对应默认进程组将被使用。默认为</span>
<span class="sd">``None``。</span>
<span class="sd">pg_options（ProcessGroupOptions，可选）：进程组选项</span>
<span class="sd">在构建特定进程组时需要指定哪些附加选项</span>
<span class="sd">特定过程组的构建。例如，对于 ``nccl``</span>
<span class="sd">可以指定 ``is_high_priority_stream`` 以确保</span>
<span class="sd">进程组可以拾取高优先级 CUDA 流。对于配置 NCCL 的其他可用选项，</span>
<span class="sd">请见 https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/api/types.html#ncclconfig-t</span>
<span class="sd">使用本地同步（bool，可选）：执行组内本地同步</span>
<span class="sd">过程组创建末尾的障碍。这不同</span>
<span class="sd">那些非成员等级无需调用 API，也不需要加入屏障。</span>
<span class="sd">。</span>
<span class="sd">group_desc (str, 可选)：用于描述进程组的字符串。</span>
<span class="sd">device_id（torch.device，可选）：一个单独的、特定的设备。</span>
<span class="sd">绑定此进程的，`new_group` 调用将尝试初始化</span>
<span class="sd">设备立即提供通信后端，如果此字段给出。</span>

<span class="sd">返回：</span>
<span class="sd">可以分配给集体通话的分布式组句柄。</span>
<span class="sd">如果等级不是 ``等级`` 的一部分，则为 GroupMember.NON_GROUP_MEMBER。</span>

<span class="sd">注意：use_local_synchronization 与 MPI 不兼容。</span>

<span class="sd">请注意。当 use_local_synchronization=True 时，对于较大的</span>
<span class="sd">集群和小型进程组，必须小心，因为它会改变集群行为</span>
<span class="sd">作为非成员等级不加入群组屏障()</span>

<span class="sd">请注意，将 use_local_synchronization=True 设置为真可能导致每个进程创建时出现死锁。</span>
<span class="sd">多个重叠的过程组。为了避免这种情况，请确保所有进程都遵循相同的全局创建顺序。</span>
<span class="sd">相同的全局创建顺序。</span>
<span class="sd">    """</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_带有标签的新组</span><span class="p">(</span>
        <span class="n">排名</span><span class="p">,</span>
        <span class="n">超时</span><span class="p">,</span>
        <span class="n">后端</span><span class="p">,</span>
        <span class="n">PG 选项</span><span class="p">,</span>
        <span class="kc">无</span><span class="p">,</span>
        <span class="n">使用本地同步</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用本地同步</span><span class="p">,</span>
        <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span><span class="p">,</span>
        <span class="n">设备 ID</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">,</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_带有标签的新组</span><span class="p">(</span>
    <span class="n">排名</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">超时</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">后端</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">后端选项</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">pg_tag</span><span class="o">=</span><span class="kc">无</span><span class="p">,</span>
    <span class="n">使用本地同步</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
    <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">设备 ID</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">``new_group`` 的变体，用于暴露标签创建。</span>

<span class="sd">注意。该机制是实验性的，并与功能集体努力相关联，请参阅</span>
<span class="sd">``torch.distributed._functional_collectives`` 用于了解如何使用它的参考。</span>
<span class="sd">    """</span>
    <span class="k">全局</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span>

    <span class="n">默认页面</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取默认组</span><span class="p">()</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">设备 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span>
    <span class="k">如果...否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">绑定设备 ID</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">"新 pg 与默认 pg 之间存在不匹配的绑定设备。"</span>
        <span class="p">)</span>
    <span class="n">默认后端</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认商店</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</span><span class="p">]</span>
    <span class="n">全球排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">()</span>
    <span class="n">全球世界大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认页面</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</span><span class="p">()</span>

    <span class="c1">默认使用与全局进程组相同的后端</span>
    <span class="c1">如果后端未指定。</span>
    <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">:</span>
        <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认后端</span>
    <span class="n">后端</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>

    <span class="c1"># 此超时默认/验证用于所有 new_groups/new_subgroups 变体</span>
    <span class="c1"># 可能只是传递了它们的超时值（或 None）</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取默认超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">)</span>
    <span class="n">_检查有效超时</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用本地同步</span><span class="p">:</span>
        <span class="c1"># MPI 后端没有执行部分同步的方法</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">MPI</span><span class="p">:</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">MPI 后端不支持 use_local_synchronization=True</span>
            <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="c1">检查输入排名</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">排名</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
        <span class="n">群组世界大小</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组世界大小</font></font></font></span> <span class="o">&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球世界大小</span><span class="p">:</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"新组的全球大小应该小于或等于"</span>
                <span class="s2">"由 init_process_group 设置的全球大小"</span>
                <span class="s2">"检查 rank 的合理性"</span>
            <span class="p">)</span>
        <span class="c1">#检查 rank 的合理性</span>
        <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">≥</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球世界大小</span><span class="p">:</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"新组的排名应在 "</span>
                    <span class="s2">"由 init_process_group 设置的世界大小 "</span>
                <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">:</span>
            <span class="n">组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">组排名</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">排名</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球世界大小</span><span class="p">))</span>
        <span class="n">群组世界大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球世界大小</span>
        <span class="n">组排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</span>

    <span class="n">group_name</span> <span class="o">=</span> <span class="n">_process_group_name</span><span class="p">(</span><span class="n">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用哈希名称</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用本地同步</span><span class="p">)</span>

    <span class="n">pg</span><span class="p">,</span> <span class="n">pg 存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">新流程组助手</span><span class="p">(</span>
        <span class="n">世界组大小</span><span class="p">,</span>
        <span class="n">群组排名</span><span class="p">,</span>
        <span class="n">排名</span><span class="p">,</span>
        <span class="n">后端</span><span class="p">,</span>
        <span class="n">默认商店</span><span class="p">,</span>
        <span class="n">群组名称</span><span class="p">,</span>
        <span class="n">后端选项</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端选项</span><span class="p">,</span>
        <span class="n">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">,</span>
        <span class="n">pg_tag</span><span class="o">=</span><span class="n">pg_tag</span><span class="p">,</span>
        <span class="n">设备 ID</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备 ID</span><span class="p">,</span>
        <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">创建全局排名到组排名的映射</span>
    <span class="n">_世界</span><span class="o">.</span><span class="n">pg_group_ranks</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">全球排名</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组排名</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全球排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">如果</span> <span class="n">_is_barrier_after_init</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># 防止在从该方法返回时出现问题的障碍</span>
        <span class="c1">处理包括全局变量（如有）在内的进程组</span>
        <span class="c1">正确地在所有等级上。</span>
        <span class="c1"># 更新 2023 年 4 月：对于大规模运行，这个障碍（尤其是基于存储的）</span>
        <span class="c1"># 障碍可能代价高昂且/或无法扩展。此外，在许多情况下，</span>
        <span class="c1">这些障碍可能是不必要的，因为绿色 CI 已经证明</span>
        <span class="c1">移除后。已添加环境变量 `TORCH_DIST_INIT_BARRIER`，当设置为 1 时才启用此障碍。</span>
        <span class="c1">仅在初始化 ProcessGroup 后执行屏障。</span>
        <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">(</span>
            <span class="s2">由于 "Performing barrier after ProcessGroup initialization since "</span>
            <span class="s2">"TORCH_DIST_INIT_BARRIER = 1"</span>
        <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="o">.</span><span class="n">MPI</span><span class="p">:</span>
            <span class="c1">MPI 没有存储。</span>
            <span class="n">障碍</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">障碍存储</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 存储</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用本地同步</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认商店</span>
            <span class="n">世界大小</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">)</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用本地同步</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取世界大小</span><span class="p">()</span>
            <span class="c1"># 由于 barrier()使用了多个默认设备，这里使用基于 store 的 barrier()。</span>
            <span class="c1"># 默认设备会导致 NCCL 内部状态混乱。</span>
            <span class="n">基于商店的屏障</span><span class="p">(</span>
                <span class="n">全球排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">障碍存储</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
            <span class="p">)</span>

    <span class="k">返回</span> <span class="n">pg</span>


<span class="k">def</span> <span class="nf">新子组</span><span class="p">(</span>
    <span class="n">组大小</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">超时</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">后端</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">PG 选项</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">创建大小相等的子组。</span>

<span class="sd">默认情况下，它创建机器内部的子组，</span>
<span class="sd">其中每个子组都包含机器的所有等级，基于每个机器具有相同数量的设备的假设，</span>
<span class="sd">这是一个便利的 API，它调用 `new_group` 来生成多个子组。</span>

<span class="sd">这是一个便捷的 API，用于调用`new_group`生成多个子组。</span>
<span class="sd">它要求主组中的所有进程（即所有</span>
<span class="sd">分布式作业中的进程进入此函数，即使</span>
<span class="sd">如果他们不是该组成员。</span>

<span class="sd">.. 警告::</span>
<span class="sd">如果传入 `group_size`，则世界大小必须能被 `group_size` 整除。</span>
<span class="sd">如果没有传入 `group_size`，则认为您正在基于 CUDA 创建组，并通过 CUDA 设备数量确定组大小，如果所有机器的设备数量不同，则节点之间的子组划分将不同，可能会引起意外的行为。因此，如果您正在</span>
<span class="sd">基于 CUDA 创建组，并通过 CUDA 设备数量确定组大小，如果所有机器的设备数量不同，则节点之间的子组划分将不同，可能会引起意外的行为。因此，如果您正在</span>
<span class="sd">基于 CUDA 创建组，并通过 CUDA 设备数量确定组大小，如果所有机器的设备数量不同，则节点之间的子组划分将不同，可能会引起意外的行为。因此，如果您正在</span>
<span class="sd">基于 CUDA 创建组，并通过 CUDA 设备数量确定组大小，如果所有机器的设备数量不同，则节点之间的子组划分将不同，可能会引起意外的行为。因此，如果您正在</span>
<span class="sd">创建一个不依赖于 CUDA 的子组（例如 CPU 上的 Gloo），请正确传入`group_size`。</span>
<span class="sd">请正确传入`group_size`。</span>

<span class="sd">.. 警告::</span>
<span class="sd">请参阅关于`安全并发使用`的警告 `new_group` API，以获取关于以安全方式同时使用多个进程组的重要细节。</span>
<span class="sd">使用多个进程组的同时进行安全操作。</span>

<span class="sd">参数：</span>
<span class="sd">group_size (int, 可选): 每个子组的尺寸。如果为 ``None``，则默认子组大小等于每台机器上的设备数量。</span>
<span class="sd">默认子组大小等于每台机器上的设备数量。</span>
<span class="sd">基于每个机器完全相同的假设</span>
<span class="sd">设备数量。默认为 ``None``。</span>
<span class="sd">timeout (timedelta, 可选): 请参阅 `init_process_group` 了解详细信息及默认值。</span>
<span class="sd">后端（str 或 Backend，可选）：要使用的后端。根据构建时配置，有效值包括`mpi`、`gloo`、`nccl`、`ucc`或由第三方插件注册的值。</span>
<span class="sd">构建时配置，有效值为 ``gloo`` 和 ``nccl``。</span>
<span class="sd">默认使用与全局组相同的后端。此字段</span>
<span class="sd">应该以小写字符串的形式提供（例如，``"gloo"``），也可以</span>
<span class="sd">通过：class:`Backend`属性访问（例如，</span>
<span class="sd">``Backend.GLOO``）。如果传入``None``，则后端</span>
<span class="sd">对应默认进程组将被使用。默认为</span>
<span class="sd">``None``。</span>
<span class="sd">pg_options（ProcessGroupOptions，可选）：进程组选项</span>
<span class="sd">在构建特定进程组时需要指定哪些附加选项</span>
<span class="sd">特定过程组的构建。例如，对于 ``nccl``</span>
<span class="sd">可以指定 ``is_high_priority_stream`` 以确保</span>
<span class="sd">进程组可以拾取高优先级 CUDA 流。</span>
<span class="sd">group_desc (str, optional): 描述组的字符串。每个子组将</span>
<span class="sd">继承其分组描述</span>

<span class="sd">返回：</span>
<span class="sd">包含当前等级的所有子群组以及用于清理的所有子群组。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; # 创建机器内部子组。</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">        &gt;&gt;&gt; cur_subgroup, subgroups = dist.new_subgroups()</span>
<span class="sd">&gt;&gt;&gt; # 在机器内进行 Allreduce 操作。</span>
<span class="sd">        &gt;&gt;&gt; rank = dist.get_rank()</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.ones(1, device=rank) * rank</span>
<span class="sd">        &gt;&gt;&gt; dist.all_reduce(tensor, group=cur_subgroup)</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">tensor([28])  # 假设每台机器有 8 个 CUDA 设备。28 是 range(8)的和。</span>
<span class="sd">&gt;&gt;&gt; # 清理。</span>
<span class="sd">        &gt;&gt;&gt; for subgroup in subgroups:</span>
<span class="sd">        &gt;&gt;&gt;     dist.destroy_process_group(subgroup)</span>
<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否可用</span><span class="p">():</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"默认组大小仅在 CUDA 可用时生效。"</span>
                <span class="s2">"如果您的子组使用不依赖 CUDA 的后端，"</span>
                <span class="s2">"请正确传入 'group_size'。"</span>
            <span class="p">)</span>
        <span class="n">组大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备数量</span><span class="p">()</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"参数 'group_size' ("</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">) 必须为正数</span><span class="p">)</span>

    <span class="n">世界大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取世界大小</span><span class="p">()</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span> <span class="o">&lt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">:</span>
        <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"参数 'group_size' ("</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">）必须不大于世界大小（</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</span><span class="si">}</span><span class="s2">)"</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span> <span class="o">%</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"世界大小必须能被 '群组大小' 整除"</span><span class="p">)</span>

    <span class="n">子组</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
    <span class="n">当前子组</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子组 ID</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span> <span class="o">//</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span><span class="p">):</span>
        <span class="n">开始排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子组 ID</font></font></font></span> <span class="o">*</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span>
        <span class="n">结束排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">开始排名</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">组大小</span>
        <span class="n">子群排名</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">开始排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">结束排名</span><span class="p">))</span>
        <span class="n">子组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建新组</span><span class="p">(</span>
            <span class="n">排名</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在子组中的排名</span><span class="p">,</span>
            <span class="n">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">,</span>
            <span class="n">后端</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span>
            <span class="n">pg 选项</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PG 选项</span><span class="p">,</span>
            <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">子组</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子分组</span><span class="p">)</span>

        <span class="n">排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在子组中的排名</span><span class="p">:</span>
            <span class="n">当前子组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子组</span>
            <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">被分配到子组</font></font></font></span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在子组中的排名</span><span class="p">)</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前子组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子组</span>


<span class="k">def</span> <span class="nf">新子组按枚举</span><span class="p">(</span>
    <span class="n">ranks_per_subgroup_list</span><span class="p">,</span>
    <span class="n">超时</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">后端</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">pg 选项</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">```python
# 假设输入文本为：
input_text = """Immersive Translate"""

# 翻译函数（此处仅为示例，实际翻译功能需要调用真实的翻译 API）
def translate_to_simplified_chinese(text):
    # 这里应该调用真实的翻译 API 进行翻译
    # 由于示例中不使用真实的 API，以下为模拟翻译结果
    return text  # 假设翻译结果与原文相同

# 输出翻译结果
translated_text = translate_to_simplified_chinese(input_text)
print(translated_text)
```

输出：
```
Immersive Translate
```</font></font></font></span>
<span class="sd">通过划分全球世界创建子组。</span>

<span class="sd">该分区由嵌套的等级列表指定。子组不能有</span>
<span class="sd">重叠，并且某些排名可能不需要在任何子组中。</span>

<span class="sd">这是一个便捷的 API，用于调用`new_group`生成多个子组。</span>
<span class="sd">它要求主组中的所有进程（即所有</span>
<span class="sd">分布式作业中的进程进入此函数，即使</span>
<span class="sd">如果他们不是该组成员。</span>

<span class="sd">.. 警告::</span>
<span class="sd">请参阅关于`安全并发使用`的警告 `new_group` API，以获取关于以安全方式同时使用多个进程组的重要细节。</span>
<span class="sd">使用多个进程组的同时进行安全操作。</span>

<span class="sd">参数：</span>
<span class="sd">ranks_per_subgroup_list（列表[列表[int]]）：一个嵌套列表，包含子组的秩。</span>
<span class="sd">群组成员。</span>
<span class="sd">timeout (timedelta, 可选): 请参阅 `init_process_group` 了解详细信息及默认值。</span>
<span class="sd">后端（str 或 Backend，可选）：要使用的后端。根据构建时配置，有效值包括`mpi`、`gloo`、`nccl`、`ucc`或由第三方插件注册的值。</span>
<span class="sd">构建时配置，有效值为 ``gloo`` 和 ``nccl``。</span>
<span class="sd">默认使用与全局组相同的后端。此字段</span>
<span class="sd">应该以小写字符串的形式提供（例如，``"gloo"``），也可以</span>
<span class="sd">通过：class:`Backend`属性访问（例如，</span>
<span class="sd">``Backend.GLOO``）。如果传入``None``，则后端</span>
<span class="sd">对应默认进程组将被使用。默认为</span>
<span class="sd">``None``。</span>
<span class="sd">pg_options（ProcessGroupOptions，可选）：进程组选项</span>
<span class="sd">在构建特定进程组时需要指定哪些附加选项</span>
<span class="sd">特定过程组的构建。例如，对于 ``nccl``</span>
<span class="sd">可以指定 ``is_high_priority_stream`` 以确保</span>
<span class="sd">进程组可以拾取高优先级 CUDA 流。</span>
<span class="sd">group_desc (str, optional): 描述组的字符串。每个子组将</span>
<span class="sd">继承其 group_desc。</span>

<span class="sd">返回：</span>
<span class="sd">包含当前等级的所有子群组以及用于清理的所有子群组。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; 创建两个子群组，每个子群组包含 2 个进程。</span>
<span class="sd">&gt;&gt;&gt; # xdoctest: +SKIP("需要进程组初始化")</span>
<span class="sd">        &gt;&gt;&gt; cur_subgroup, subgroups = dist.new_subgroups(ranks=[[0, 2], [1, 3]])</span>
<span class="sd">        &gt;&gt;&gt; rank = dist.get_rank()</span>
<span class="sd">        &gt;&gt;&gt; tensor = torch.ones(1, device=rank) * rank</span>
<span class="sd">        &gt;&gt;&gt; dist.all_reduce(tensor, group=cur_subgroup)</span>
<span class="sd">        &gt;&gt;&gt; tensor</span>
<span class="sd">        tensor([2])     # Subgroup 0: ranks 0 and 2</span>
<span class="sd">        tensor([4])     # Subgroup 1: ranks 1 and 3</span>
<span class="sd">    """</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名_子组列表</font></font></font></span> <span class="ow">is</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</span><span class="p">(</span><span class="n">ranks_per_subgroup_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"参数 'ranks_per_subgroup_list' 不能为空"</span><span class="p">)</span>

    <span class="n">子组</font></font></font></span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
    <span class="n">当前子组</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
    <span class="c1"># 从排名到子组的映射创建，以检查是否存在子组重叠。</span>
    <span class="n">rank_to_ranks_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: ignore[var-annotated]</span>
    <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">ranks_per_subgroup_list</span><span class="p">:</span>
        <span class="n">子组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建新组</span><span class="p">(</span>
            <span class="n">排名</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">,</span>
            <span class="n">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">,</span>
            <span class="n">后端</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</span><span class="p">,</span>
            <span class="n">pg 选项</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pg 选项</span><span class="p">,</span>
            <span class="n">群组描述</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组描述</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">子组</font></font></font></span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子分组</span><span class="p">)</span>
        <span class="n">我的排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
        <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="n">rank_to_ranks_dict</span><span class="p">:</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">排名</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已出现在子组中</font></font></font></span><span class="si">{</span><span class="n">rank_to_ranks_dict</span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">]</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
            <span class="n">rank_to_ranks_dict</span><span class="p">[</span><span class="n">排名</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">:</span>
                <span class="n">当前子组</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子组</span>
                <span class="n">日志记录器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="si">%s</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">被分配到子组</font></font></font></span><span class="si">%s</span><span class="s2">"</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前子组</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">子组</span>


<span class="k">def</span> <span class="nf">_find_pg_by_ranks_and_tag</span><span class="p">(</span><span class="n">标签</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以...开头</font></font></font></span><span class="p">(</span><span class="s2">"ptd:"</span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以...开头</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"用户："</span><span class="p">):</span>
        <span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"用户："</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="si">}</span><span class="s2">"</span>

    <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签转 PostgreSQL</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">大小</font></font></font></span><span class="p">()</span> <span class="o">!=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">群组等级</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取进程组排名</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span><span class="p">)</span>
        <span class="n">好的</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">所有</font></font></font></span><span class="p">(</span><span class="n">r</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组等级</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">r</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">良好</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span>
    <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>


<span class="k">def</span> <span class="nf">根据排名和标签查找或创建 PG</span><span class="p">(</span>
    <span class="n">标签</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">步长</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">整型</span>
<span class="p">)</span> <span class="o">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">:</span>
    <span class="k">断言</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">)</span> <span class="o">%</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">步长</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">排名长度（</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">)</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">) 必须能被步长整除（</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">步长</span><span class="si">}</span><span class="s2">)"</span>
    <span class="p">)</span>

    <span class="n">我的排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="n">我的排名</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">步长</font></font></font></span> <span class="o">==</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span><span class="p">):</span>
        <span class="n">我的排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">复制</span><span class="p">()</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"rankset 不包含当前节点"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">为</font></font></font></span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">步长</span><span class="p">):</span>
            <span class="n">等级集合</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</font></font></font></span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">步长</span><span class="p">]</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等级集合</span><span class="p">:</span>
                <span class="n">我的排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">等级集合</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"rankset 不包含当前节点"</span>

    <span class="n">我的排名</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排序</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</span><span class="p">)</span>

    <span class="n">pg</span> <span class="o">=</span> <span class="n">_find_pg_by_ranks_and_tag</span><span class="p">(</span><span class="n">标签</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n">pg</span> <span class="ow">is</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</span> <span class="n">pg</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">:</span>
        <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无法自动创建带有空标签的 PG</span><span class="p">)</span>
    <span class="c1"># TODO 从默认 PG 复制设置和超时</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_带有标签的新组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">我的排名</font></font></font></span><span class="p">,</span> <span class="n">pg_tag</span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">获取组标签</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"返回与 ``pg`` 相关的标签。"</span>
    <span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PostgreSQL 转标签</span><span class="p">[</span><span class="n">pg</span><span class="p">]</span>
    <span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">去前缀</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"用户："</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span>


<span class="k">def</span> <span class="nf">获取进程组名称</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">:</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据库名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_获取进程组存储</font></font></font></span><span class="p">(</span><span class="n">pg</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</font></font></font></span><span class="p">)</span> <span class="o"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">翻译</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">存储</span><span class="p">:</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_世界</span><span class="o">.</span><span class="n">pg_map</span><span class="p">[</span><span class="n">pg</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]
[</font></font></font></span><span class="mi">1</span><span class="p">]</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>© 版权所有 PyTorch 贡献者。</p>
  </div>
    
      <div>使用 Sphinx 构建，并使用 Read the Docs 提供的主题。</div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../_static/doctools.js"></script>
         <script src="../../../_static/clipboard.min.js"></script>
         <script src="../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script="" type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0">


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>文档</h2>
          <p>查看 PyTorch 的全面开发者文档</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">查看文档</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>教程</h2>
          <p>深入了解初学者和高级开发者的教程</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">查看教程</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>资源</h2>
          <p>查找开发资源，获取您的疑问解答</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">查看资源</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">开始使用</a></li>
            <li><a href="https://pytorch.org/features">功能</a></li>
            <li><a href="https://pytorch.org/ecosystem">生态系统</a></li>
            <li><a href="https://pytorch.org/blog/">博客</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">贡献</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">资源</a></li>
            <li><a href="https://pytorch.org/tutorials">教程</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">文档</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">讨论</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github 问题</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">品牌指南</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">保持更新</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">推特</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">领英</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch 播客</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">苹果</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">谷歌</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">亚马逊</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">条款</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">隐私</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© 版权所有 Linux 基金会。PyTorch 基金会是 Linux 基金会的一个项目。有关 PyTorch 基金会的网站使用条款、商标政策以及其他适用政策，请参阅 www.linuxfoundation.org/policies/。PyTorch 基金会支持 PyTorch 开源项目，该项目已被确立为 LF Projects, LLC 的 PyTorch 项目系列。有关适用于 PyTorch 项目系列 LF Projects, LLC 的政策，请参阅 www.lfprojects.org/policies/。</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">为了分析流量并优化您的体验，我们在本网站上使用 cookies。通过点击或导航，您同意允许我们使用 cookies。作为本网站的当前维护者，适用 Facebook 的 Cookies 政策。了解更多信息，包括关于可用控制的信息：Cookies 政策。</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg" width="16" height="16">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>学习</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/get-started">开始使用</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials">教程</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">学习基础知识</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">PyTorch 食谱</a>
             </li>
             <li>
               <a href="https://pytorch.org/tutorials/beginner/introyt.html">PyTorch 入门 - YouTube 系列</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>生态系统</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/ecosystem">工具</a>
             </li>
             <li>
               <a href="https://pytorch.org/#community-module">社区</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">论坛</a>
             </li>
             <li>
               <a href="https://pytorch.org/resources">开发者资源</a>
             </li>
             <li>
               <a href="https://pytorch.org/ecosystem/contributor-awards-2023">贡献者奖项 - 2024</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>边缘</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://pytorch.org/edge">关于 PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://pytorch.org/executorch-overview">ExecuTorch</a>
             </li>
             <li>
               <a href="https://pytorch.org/executorch/stable/index.html">ExecuTorch 文档</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>文档</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/pytorch-domains">PyTorch 领域</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>博客 &amp; 新闻</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/blog/">PyTorch 博客</a>
            </li>
            <li>
              <a href="https://pytorch.org/community-blog">社区博客</a>
            </li>

            <li>
              <a href="https://pytorch.org/videos">视频</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">社区故事</a>
            </li>
            <li>
              <a href="https://pytorch.org/events">活动</a>
            </li>
            <li>
               <a href="https://pytorch.org/newsletter">通讯</a>
             </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>关于</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/foundation">PyTorch 基金会</a>
            </li>
            <li>
              <a href="https://pytorch.org/governing-board">管理委员会</a>
            </li>
            <li>
               <a href="https://pytorch.org/credits">云信用计划</a>
            </li>
            <li>
               <a href="https://pytorch.org/tac">技术咨询委员会</a>
            </li>
            <li>
               <a href="https://pytorch.org/staff">员工</a>
            </li>
            <li>
               <a href="https://pytorch.org/contact-us">联系我们</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>

</body></html>