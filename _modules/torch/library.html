<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.library — PyTorch main documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://maskerprc.github.io/docs/stable/_modules/torch/library.html">
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css">
  <!-- <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css">
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css">
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css">
  <link rel="stylesheet" href="../../_static/katex-math.css" type="text/css">
  <link rel="stylesheet" href="../../_static/sphinx-dropdown.css" type="text/css">
  <link rel="stylesheet" href="../../_static/panels-bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="../../_static/css/jit.css" type="text/css">
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css">
    <link rel="index" title="Index" href="../../genindex.html">
    <link rel="search" title="Search" href="../../search.html">

<!--
  Search engines should not index the main version of documentation.
  Stable documentation are built without release == 'main'.
-->
<meta name="robots" content="noindex">


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head><body class="pytorch-body"><div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://maskerprc.github.io/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">学习</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/get-started">
                  <span class="dropdown-title">开始使用</span>
                  <p>在本地运行 PyTorch 或快速开始使用支持的云平台之一</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials">
                  <span class="dropdown-title">教程</span><p></p>
                  <p>PyTorch 教程中的新内容</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">学习基础知识</span><p></p>
                  <p>熟悉 PyTorch 概念和模块</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch 烹饪技巧</span><p></p>
                  <p>精简型、可直接部署的 PyTorch 代码示例</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">PyTorch 入门 - YouTube 系列</span><p></p>
                  <p>通过我们引人入胜的 YouTube 教程系列掌握 PyTorch 基础知识</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">生态系统</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/ecosystem">
                  <span class="dropdown-title">工具</span><p></p>
                  <p>了解 PyTorch 生态系统中的工具和框架</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/#community-module">
                  <span class="dropdown-title">社区</span>
                  <p>加入 PyTorch 开发者社区，贡献、学习并获得问题解答</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">论坛</span>
                  <p>讨论 PyTorch 代码、问题、安装、研究的地方</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/resources">
                  <span class="dropdown-title">开发者资源</span>
                  <p>查找资源并解答问题</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/ecosystem/contributor-awards-2024">
                  <span class="dropdown-title">2024 年度贡献者奖项</span><p></p>
                  <p>本届 PyTorch 会议揭晓获奖者</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">
                Edge
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/edge">
                  <span class="dropdown-title">关于 PyTorch Edge</span><p></p>
                  <p>为边缘设备构建创新和隐私感知的 AI 体验</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span><p></p>
                  <p>针对移动和边缘设备实现设备端推理能力的端到端解决方案</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/executorch/stable/index.html">
                  <span class="dropdown-title">ExecuTorch 文档</span><p></p>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">文档</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span><p></p>
                  <p>探索文档以获取如何使用 PyTorch 的全面指南</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/pytorch-domains">
                  <span class="dropdown-title">PyTorch 领域</span><p></p>
                  <p>阅读 PyTorch 领域的文档以了解更多关于特定领域的库</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">博客与新闻</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/blog/">
                  <span class="dropdown-title">PyTorch 博客</span><p></p>
                  <p>跟上最新的技术新闻和动态</p>
                </a>
                 <a class="nav-dropdown-item" href="https://maskerprc.github.io/community-blog">
                  <span class="dropdown-title">社区博客</span><p></p>
                  <p>PyTorch 生态系统故事</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/videos">
                  <span class="dropdown-title">视频</span><p></p>
                  <p>了解最新的 PyTorch 教程、新内容等</p>
                </a><a class="nav-dropdown-item" href="https://maskerprc.github.io/community-stories">
                  <span class="dropdown-title">社区故事</span><p></p>
                  <p>了解我们的社区如何使用 PyTorch 解决真实、日常的机器学习问题</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/events">
                  <span class="dropdown-title">活动</span><p></p>
                  <p>查找活动、网络研讨会和播客</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/newsletter">
                  <span class="dropdown-title">通讯</span><p></p>
                  <p>保持最新更新</p>
                </a>
            </div>
          </div></li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">关于</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/foundation">
                  <span class="dropdown-title">PyTorch 基金会</span><p></p>
                  <p>了解更多关于 PyTorch 基金会的信息</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/governing-board">
                  <span class="dropdown-title">管理委员会</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/credits">
                  <span class="dropdown-title">云信用计划</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tac">
                  <span class="dropdown-title">技术顾问委员会</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/staff">
                  <span class="dropdown-title">员工</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/contact-us">
                  <span class="dropdown-title">联系我们</span><p></p>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://maskerprc.github.io/join" data-cta="join">成为会员</a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>



   

    

    <div class="table-of-contents-link-wrapper">
      <span>目录</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href="https://maskerprc.github.io/docs/versions.html">主页 (2.7.0+cpu ) ▼</a>
    </div>
    <div id="searchBox">
    <div class="searchbox" id="googleSearchBox">
      <script async="" src="https://cse.google.com/cse.js?cx=e65585f8c3ea1440e"></script>
      <div class="gcse-search"></div>
    </div>
    <div id="sphinxSearchBox" style="display: none;">
      <div role="search">
        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
          <input type="text" name="q" placeholder="Search Docs">
          <input type="hidden" name="check_keywords" value="yes">
          <input type="hidden" name="area" value="default">
        </form>
      </div>
    </div>
  </div>
  <form id="searchForm">
    <label style="margin-bottom: 1rem">
      <input type="radio" name="searchType" value="google" checked="">Google 搜索</label>
    <label style="margin-bottom: 1rem">
      <input type="radio" name="searchType" value="sphinx">经典搜索</label>
  </form>

  <script>
     document.addEventListener('DOMContentLoaded', function() {
      const searchForm = document.getElementById('searchForm');
      const googleSearchBox = document.getElementById('googleSearchBox');
      const sphinxSearchBox = document.getElementById('sphinxSearchBox');
      // Function to toggle search box visibility
      function toggleSearchBox(searchType) {
        googleSearchBox.style.display = searchType === 'google' ? 'block' : 'none';
        sphinxSearchBox.style.display = searchType === 'sphinx' ? 'block' : 'none';
      }
      // Determine the default search type
      let defaultSearchType;
      const currentUrl = window.location.href;
      if (currentUrl.startsWith('https://maskerprc.github.io/docs/stable')) {
        // For the stable documentation, default to Google
        defaultSearchType = localStorage.getItem('searchType') || 'google';
      } else {
        // For any other version, including docs-preview, default to Sphinx
        defaultSearchType = 'sphinx';
      }
      // Set the default search type
      document.querySelector(`input[name="searchType"][value="${defaultSearchType}"]`).checked = true;
      toggleSearchBox(defaultSearchType);
      // Event listener for changes in search type
      searchForm.addEventListener('change', function(event) {
        const selectedSearchType = event.target.value;
        localStorage.setItem('searchType', selectedSearchType);
        toggleSearchBox(selectedSearchType);
      });
      // Set placeholder text for Google search box
      window.onload = function() {
        var placeholderText = "Search Docs";
        var googleSearchboxText = document.querySelector("#gsc-i-id1");
        if (googleSearchboxText) {
          googleSearchboxText.placeholder = placeholderText;
          googleSearchboxText.style.fontFamily = 'FreightSans';
          googleSearchboxText.style.fontSize = "1.2rem";
          googleSearchboxText.style.color = '#262626';
        }
      };
    });
  </script>

          </div>

          

<div>
  <a style="color:#F05732" href="https://maskerprc.github.io/docs/stable/_modules/torch/library.html">您正在查看不稳定开发者预览文档。请点击此处查看最新稳定版本的文档。</a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">社区</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../community/build_ci_governance.html">PyTorch 治理 | 构建 + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/contribution_guide.html">PyTorch 贡献指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/design.html">PyTorch 设计哲学</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/governance.html">PyTorch 治理 | 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/persons_of_interest.html">PyTorch 治理 | 维护者</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发者笔记</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notes/amp_examples.html">自动混合精度示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/autograd.html">Autograd 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/broadcasting.html">广播语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/cpu_threading_torchscript_inference.html">CPU 线程和 TorchScript 推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/cuda.html">CUDA 语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/custom_operators.html">PyTorch 自定义操作着陆页面</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/ddp.html">分布式数据并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/extending.html">扩展 PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/extending.func.html">扩展 torch.func 与 autograd.Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/fsdp.html">FSDP 笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/get_start_xpu.html">在英特尔 GPU 上入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/gradcheck.html">毕业审核力学</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/hip.html">HIP (ROCm) 语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/large_scale_deployments.html">大规模部署功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/libtorch_stable_abi.html">LibTorch 稳定 ABI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/modules.html">模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/mps.html">MPS 后端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/multiprocessing.html">多进程最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/numerical_accuracy.html">数值精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/randomness.html">可复现性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/serialization.html">序列化语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notes/windows.html">Windows 常见问题解答</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">语言绑定</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor_attributes.html">Tensor 属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensor_view.html">张量视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accelerator.html">torch 加速器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu.html">torch.cpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html">理解 CUDA 内存使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html#generating-a-snapshot">生成快照</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html#using-the-visualizer">使用可视化器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_cuda_memory.html#snapshot-api-reference">快照 API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xpu.html">torch.xpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mtia.html">torch.mtia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mtia.memory.html">torch.mtia.memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../meta.html">元设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../export.html">torch.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.tensor.html">torch.distributed.tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.fsdp.fully_shard.html">torch.distributed.fsdp.fully_shard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.pipelining.html">torch.distributed.pipelining</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch.compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fx.experimental.html">torch.fx.experimental</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nn.attention.html">torch.nn.attention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../complex_numbers.html">复数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ddp_comm_hooks.html">DDP 通信钩子</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quantization.html">量化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rpc.html">分布式 RPC 框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../size.html">torch.Size</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../storage.html">torch 存储</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utils.html">torch.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deterministic.html">torch.utils.deterministic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module_tracker.html">torch.utils.module_tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../type_info.html">类型信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../named_tensor.html">命名张量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../name_inference.html">命名张量操作覆盖率</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../future_mod.html">torch.__future__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">torch._logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../torch_environment_variables.html">火炬环境变量</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">图书馆</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/torchrec">火炬推荐</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/xla/">PyTorch 在 XLA 设备上</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/ao">torchao</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        文档 &gt;</li>

        
          <li>模块代码 &gt;</li>
        
          <li><a href="../torch.html">torch</a> &gt;</li>
        
      <li>torch.library</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">快捷键</div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>torch.library 的源代码</font></font></font></h1><div class="highlight"><pre><span></span><span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># mypy: 允许未类型化定义</span>
<span class="kn">导入</span> <span class="nn">contextlib</span>
<span class="kn">导入</span> <span class="nn">functools</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">正则表达式</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">系统</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">跟踪回溯</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">弱引用</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span>
<span class="kn">from</span> <span class="nn">打字</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="p">(</span>
    <span class="n">任何</span><span class="p">,</span>
    <span class="n">可调用</span><span class="p">,</span>
    <span class="n">直接</span><span class="p">,</span>
    <span class="n">可选</span><span class="p">,</span>
    <span class="n">过载</span><span class="p">,</span>
    <span class="n">类型检查</span><span class="p">,</span>
    <span class="n">类型变量</span><span class="p">,</span>
    <span class="n">联合</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已弃用</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数规范</span>

<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch._库</font></font></font></span> <span class="k">as</span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span>
<span class="kn">from</span> <span class="nn">torch._库.custom_ops</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="p">(</span>
    <span class="n">_类型转换</span><span class="p">,</span>
    <span class="n">可能获取操作定义</span><span class="p">,</span>
    <span class="n">自定义操作</span><span class="p">,</span>
    <span class="n">自定义运算定义</span><span class="p">,</span>
    <span class="n">设备类型_t</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch._library.infer_schema</span> <span class="kn">导入</span> <span class="n">infer_schema</span>  <span class="c1"># noqa: F401</span>
<span class="kn">from</span> <span class="nn">torch._library.triton</span> <span class="kn">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">triton 操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">triton 包装</span>
<span class="kn">from</span> <span class="nn">torch._ops</span> <span class="kn">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运算符重载</span>
<span class="kn">from</span> <span class="nn">torch 的类型</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="n">_dtype</span>


<span class="n">全部</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">图书馆</span><span class="p">,</span>
    <span class="s2">实现</span><span class="p">,</span>
    <span class="s2">定义</span><span class="p">,</span>
    <span class="s2">"fallthrough_kernel"</span><span class="p">,</span>
    <span class="s2">"impl_abstract"</span><span class="p">,</span>
    <span class="s2">"register_autocast"</span><span class="p">,</span>
    <span class="s2">"register_fake"</span><span class="p">,</span>
    <span class="s2">注册 torch 调度</span><span class="p">,</span>
    <span class="s2">注册 vmap</span><span class="p">,</span>
    <span class="s2">获取上下文</span><span class="p">,</span>
    <span class="s2">自定义操作</span><span class="p">,</span>
    <span class="s2">triton 操作</span><span class="p">,</span>
    <span class="s2">wrap_triton</span><span class="p">,</span>
    <span class="s2">推理模式</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_T</span> <span class="o">=</span> <span class="n">类型变量</span><span class="p">(</span><span class="s2">"_T"</span><span class="p">)</span>
<span class="n">_P</span> <span class="o">=</span> <span class="n">参数规范</span><span class="p">(</span><span class="s2">"_P"</span><span class="p">)</span>

<span class="c1"># 为新注册的内核设置的（命名空间，操作符，DispatchKey）组合集合</span>
<span class="c1"># 集合中的键的形式为 `namespace + "/" + op_name + "/" + dispatch_key`。</span>
<span class="c1"># 维护此集合是为了确保两个库不会尝试覆盖完全相同的功能，以避免</span>
<span class="c1">调用非预期被调用的内核的库。</span>
<span class="n">_impls</span><span class="p">:</span> <span class="nb">设置</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</span><span class="p">()</span>
<span class="n">_定义</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</span><span class="p">()</span>

<span class="c1"># prim 是由 TorchScript 解释器保留的。</span>
<span class="n">_保留命名空间</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">prim</span><span class="p">]</span>


<div class="viewcode-block" id="fallthrough_kernel"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def fallthrough_kernel():
"""
用于注册跳转的示例函数，传递给 `Library.impl`
""
抛出未实现异常("fallthrough_kernel() 不应该被调用。")</font></font></font></div>


<div class="viewcode-block" id="Library"><a class="viewcode-back" href="../../library.html#torch.library.Library">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span><span class="p">:</span>
<span class="w">    </span><span class="sd">""</span>
<span class="sd">用于创建库的类，这些库可以用来注册新的操作符或</span>
<span class="sd">在现有的 Python 库中重载运算符。</span>
<span class="sd">用户可以选择传递一个调度键名，如果他们只想注册对应一个特定调度键的内核。</span>
<span class="sd">要创建一个库以重载现有库（名称为 ns）中的运算符，请将类型设置为"IMPL"。</span>

<span class="sd">    To create a library to override operators in an existing library (with name ns), set the kind to "IMPL".</span>
<span class="sd">创建一个新的库（名称为 ns）以注册新操作员，将类型设置为"DEF"。</span>
<span class="sd">要创建可能存在的库的片段以注册操作员（并绕过</span>
<span class="sd">给定命名空间只有一个库的限制），将类型设置为</span>
<span class="sd">"FRAGMENT"。</span>

<span class="sd">参数：</span>
<span class="sd">库名称</span>
<span class="sd">类型: "DEF", "IMPL"（默认: "IMPL"）, "FRAGMENT"</span>
<span class="sd">调度键: PyTorch 调度键（默认: ""）</span>
<span class="sd">    """</span>

    <span class="k">定义</font></font></font></span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">仁慈</font></font></font></span> <span class="ow">not</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">,</span> <span class="s2">"DEF"</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">):</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"不支持的类型："</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_保留命名空间</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以及</font></font></font></span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">仁慈</font></font></font></span> <span class="o">==</span> <span class="s2">"DEF"</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或者</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">仁慈</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">):</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
                <span class="n">ns</span><span class="p">,</span>
                <span class="s2">"是一个保留的命名空间。请尝试使用其他名称创建库。"</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_运行时使用部署</span><span class="p">():</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告部署</span><span class="p">()</span>
            <span class="k">返回</span>

        <span class="n">框架</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">跟踪回溯</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">提取堆栈</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">限制</font></font></font></span><span class="o">=</span><span class="mi">3</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">文件名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">行号</font></font></font></span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">文件名</font></font></font></span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">行号</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_调度库</span><span class="p">(</span>
            <span class="n">类型</font></font></font></span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">文件名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">行号</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">命名空间</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_操作定义</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op_impls</span><span class="p">:</span> <span class="nb">设置</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_注册处理句柄</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册句柄</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">仁慈</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">仁慈</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">分发键</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span>
        <span class="c1">使用终结器设置“析构函数”而不是 __del__。</span>
        <span class="c1">Python 中的 __del__ 可能会导致奇怪的事情发生（全局变量和局部变量可能在 __del__ 实际被调用时已经消失！）。</span>
        <span class="c1">终结器有助于这种情况，因为它让我们捕获引用并保持它们存活。</span>
        <span class="c1"># 最终化器有助于这种情况，因为它让我们捕获引用并保持它们存活。</span>
        <span class="n">弱引用</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">完成</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">_del_library</span><span class="p">,</span>
            <span class="n">_impls</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_op_impls</span><span class="p">,</span>
            <span class="n">_定义</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_操作定义</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_注册处理句柄</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">定义</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">返回</font></font></font></span> <span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"库(类型=</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">, 命名空间=</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">,调度键=</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span><span class="si">}</span><span class="s2">)&gt;"</span>

<div class="viewcode-block" id="Library.define"><a class="viewcode-back" href="../../library.html#torch.library.Library.define">[文档]</font></font></font></a>    <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="o">=</span><span class="p">()):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">在 ns 命名空间中定义了一个新操作符及其语义。</span>

<span class="sd">参数：</span>
<span class="sd">schema：定义新操作符的函数 schema。</span>
<span class="sd">别名分析（可选）：指示操作符参数的别名属性是否可以</span>
<span class="sd">从模式推断（默认行为）或不可推断（"CONSERVATIVE"）。</span>
<span class="sd">标签（Tag | Sequence[Tag]）：应用于此的一个或多个 torch.Tag</span>
<span class="sd">标记操作符会改变操作符在各种 PyTorch 子系统中的行为</span>
<span class="sd">请在应用 torch.Tag 之前仔细阅读文档。</span>
<span class="sd">请仔细阅读 torch.Tag 文档后再应用。</span>

<span class="sd">返回值：</span>
<span class="sd">从模式推断出的算子名称。</span>

<span class="sd">示例::</span>
<span class="sd">            &gt;&gt;&gt; my_lib = Library("mylib", "DEF")</span>
<span class="sd">            &gt;&gt;&gt; my_lib.define("sum(Tensor self) -&gt; Tensor")</span>
<span class="sd">        """</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_运行时使用部署</span><span class="p">():</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告部署</span><span class="p">()</span>
            <span class="k">返回</span>

        <span class="c1"># 这是因为我们还想禁止 PURE_FUNCTION 别名分析，这是一个有效的</span>
        <span class="c1"># C++中的 AliasAnalysis 类型</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</font></font></font></span> <span class="ow">not</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">FROM_SCHEMA</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">保守的</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
            <span class="k">抛出</font></font></font></span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无效的别名分析类型</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">):</span>
            <span class="n">标签</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">,)</span>

        <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“（”</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">数据包名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“。”</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</font></font></font></span><span class="mi">0</span><span class="p">]</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="s2">"."</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
        <span class="n">已存在数据包</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以及</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据包名称</span>
        <span class="p">)</span>

        <span class="n">结果</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">))</span>
        <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“（”</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qualname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">命名空间</font></font></font></span> <span class="o">+</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“::”</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>

        <span class="c1">如果 OpOverloadPacket 已经存在，那么这意味着我们在添加</span>
        <span class="c1">为它添加新的 OpOverload。刷新数据包以包含新的 OpOverload。</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已存在数据包</span><span class="p">:</span>
            <span class="n">命名空间</font></font></font></span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">)</span>
            <span class="n">数据包</font></font></font></span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据包名称</span><span class="p">)</span>
            <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_刷新包</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据包</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
        <span class="n">_定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">结果</span></div>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册模拟实现</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">_stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">注册库中定义的操作符的模拟实现。</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_运行时使用部署</span><span class="p">():</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告部署</span><span class="p">()</span>
            <span class="k">返回</span>

        <span class="n">源</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取源</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_堆栈级别</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">框架</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">系统模块</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">_stacklevel</span><span class="p">)</span>
        <span class="n">caller_module</span> <span class="o">=</span> <span class="n">检查</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取模块</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="c1"># 可能为空，如果从没有模块的地方调用 register_fake</span>
        <span class="c1"># （例如 __main__）</span>
        <span class="n">调用模块名称</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n">caller_module</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</span> <span class="n">caller_module</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># TODO(rzou): 我们需要将这个更改与 torchvision 一起进行阶段化，</span>
        <span class="c1"># 因为 torchvision 是 GitHub 优先。</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调用模块名称</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以及</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调用模块名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">以...开头</span><span class="p">(</span>
            <span class="s2">"torchvision."</span>
        <span class="p">):</span>
            <span class="n">调用模块名称</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>

        <span class="n">qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">::</span><span class="si">{</span><span class="n">操作符名称</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">条目</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">简单注册表</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">单例</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">找到</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调用模块名称</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">注册函数</font></font></font></span> <span class="o">=</span> <span class="n">_check_pystubs_once</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调用模块名称</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">注册函数</span> <span class="o">=</span> <span class="n">fn</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="n">条目</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">模拟实现</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_注册处理句柄</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">处理</span><span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_注册 torch 调度规则</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch 调度类</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">注册给定操作符和 torch_dispatch_class 的 torch_dispatch 规则。</span>

<span class="sd">这允许开放注册以指定操作员之间的行为</span>
<span class="sd">无需修改 torch_dispatch_class 即可使用 torch_dispatch_class</span>
<span class="sd">或直接操作员。</span>

<span class="sd">torch_dispatch_class 是一个具有 `__torch_dispatch__` 的 Tensor 子类或</span>
<span class="sd">        TorchDispatchMode.</span>

<span class="sd">如果它是一个 Tensor 子类，我们期望 fn 具有以下签名：</span>
<span class="sd">        (cls, func: OpOverload, types: Tuple[type, ...], args, kwargs) -&gt; Any</span>

<span class="sd">如果它是一个 TorchDispatchMode，我们期望 fn 具有以下签名：</span>
<span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">(mode, func: OpOverload, types: Tuple[type, ...], args, kwargs) -&gt; Any
(模式，func: 操作重载，types: 类型元组[type, ...]，args，kwargs) -&gt; 任意</font></font></font></span>
<span class="sd">        """</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_运行时使用部署</span><span class="p">():</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告部署</span><span class="p">()</span>
            <span class="k">返回</span>

        <span class="n">qualname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">::</span><span class="si">{</span><span class="n">操作符名称</span><span class="si">}</span><span class="s2">"</span>
        <span class="n">条目</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">简单注册表</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">单例</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">找到</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">条目</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">PyTorch 调度规则</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch 调度类</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_注册处理句柄</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">处理</span><span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_使用 AOT 编译实现</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">注册操作符以使用 AOTI 编译的实现。</span>

<span class="sd">参数：</span>
<span class="sd">操作名称：操作符名称（包括重载）或 OpOverload 对象。</span>
<span class="sd">dispatch_key: 输入函数应注册的 dispatch key。默认情况下，它使用</span>
<span class="sd">创建库时使用的 dispatch key。</span>

<span class="sd">示例::</span>
<span class="sd">            &gt;&gt;&gt; my_lib = Library("aten", "IMPL")</span>
<span class="sd">            &gt;&gt;&gt; my_lib._impl_with_aoti_compile("div.Tensor", "CPU")</span>
<span class="sd">        """</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_运行时使用部署</span><span class="p">():</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告部署</span><span class="p">()</span>
            <span class="k">返回</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">:</span>
            <span class="n">分发键</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span>
        <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键集</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">稠密</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">操作符名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
            <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
            <span class="n">重载名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</font></font></font></span> <span class="o">!=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">:</span>
                <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">"_impl_with_aoti_compile 应传递一个名称或一个 OpOverload 对象"</span>
                <span class="s2">作为第一个参数</span>
            <span class="p">)</span>

        <span class="n">键</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span> <span class="o">+</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根目录</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">双冒号</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</font></font></font></span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根目录</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</span> <span class="n">_impls</span><span class="p">:</span>
            <span class="c1"># TODO: 在未来，添加更多关于现有函数注册位置的信息（此信息是</span>
            <span class="c1"># 在调用 _impl_with_aoti_compile 时已由 C++ 警告返回，但我们在此之前出错）</span>
            <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">"这不被允许，因为已经有一个从 Python 注册的内核覆盖了</span><span class="si">{}</span><span class="s2">"</span>
                <span class="s2">的行为了</font></font></font></span><span class="si">{}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键和</font></font></font></span><span class="si">{}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间。"</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">格式</span><span class="p">(</span>
                    <span class="n">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">双冒号</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</font></font></font></span><span class="o">-</span><span class="mi">1</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
        <span class="n">实现函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现带 AOT 编译</span>
        <span class="n">实现函数</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">双冒号</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</font></font></font></span><span class="o">-</span><span class="mi">1</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span><span class="p">)</span>

        <span class="n">_impls</span><span class="o">.</span><span class="n">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op_impls</span><span class="o">.</span><span class="n">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span>

<div class="viewcode-block" id="Library.impl"><a class="viewcode-back" href="../../library.html#torch.library.Library.impl">[文档]</font></font></font></a>    <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">带有密钥集</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">注册库中定义的操作符的功能实现。</span>

<span class="sd">参数：</span>
<span class="sd">操作名称：操作符名称（包括重载）或 OpOverload 对象。</span>
<span class="sd">fn: 输入分发键的运算符实现函数或：func:`~fallthrough_kernel`</span>
<span class="sd">注册一个跳转。</span>
<span class="sd">dispatch_key: 输入函数应注册的 dispatch key。默认情况下，它使用</span>
<span class="sd">创建库时使用的 dispatch key。</span>
<span class="sd">with_keyset: 控制当前调度器调用 keyset 是否应作为第一个参数传递的标志</span>
<span class="sd">在调用时使用：attr:`fn`。这应该用于创建适当的键集以进行重派调用。</span>

<span class="sd">示例::</span>
<span class="sd">            &gt;&gt;&gt; my_lib = Library("aten", "IMPL")</span>
<span class="sd">            &gt;&gt;&gt; def div_cpu(self, other):</span>
<span class="sd">&gt;&gt;&gt;     返回 self * (1 / other)</span>
<span class="sd">            &gt;&gt;&gt; my_lib.impl("div.Tensor", div_cpu, "CPU")</span>
<span class="sd">        """</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_运行时使用部署</span><span class="p">():</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告部署</span><span class="p">()</span>
            <span class="k">返回</span>

        <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"输入函数必须是一个可调用对象，但找到的类型为"</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
            <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">:</span>
            <span class="n">分发键</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span>

        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">操作符名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
            <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
            <span class="n">重载名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</font></font></font></span> <span class="o">!=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">:</span>
                <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">"实现应该将名称或 OpOverload 对象作为第一个参数传递"</span>
            <span class="p">)</span>

        <span class="n">键</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span> <span class="o">+</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根目录</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">双冒号</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</font></font></font></span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">根目录</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</span> <span class="n">_impls</span><span class="p">:</span>
            <span class="c1"># TODO: 在未来，添加更多关于现有函数注册位置的信息（此信息是</span>
            <span class="c1"># 当前的 C++警告在调用 impl 时返回的，但我们在此之前就出错）</span>
            <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">"这不被允许，因为已经有一个从 Python 注册的内核覆盖了</span><span class="si">{}</span><span class="s2">"</span>
                <span class="s2">的行为了</font></font></font></span><span class="si">{}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键和</font></font></font></span><span class="si">{}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间。"</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">格式</span><span class="p">(</span>
                    <span class="n">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">双冒号</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</font></font></font></span><span class="o">-</span><span class="mi">1</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元数据</span><span class="p">:</span>
            <span class="n">分发器操作名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
            <span class="k">如果</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“::”</font></font></font></span> <span class="ow">not</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</span> <span class="n">dispatcher_op_name</span><span class="p">:</span>
                <span class="n">分发器操作名称</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">::</span><span class="si">{</span><span class="n">dispatcher_op_name</span><span class="si">}</span><span class="s2">"</span>

            <span class="c1">我们内部不应该为任何具有复合隐式自动微分核的算子注册元核。</span>
            <span class="c1">相反，我们应该让这些分解运行，并且只为基本算子编写元核。</span>
            <span class="c1">而不是，我们应该让那些分解运行，并且只为基本算子编写元核。</span>
            <span class="c1">只为基本算子编写元核。</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_dispatch_has_kernel_for_dispatch_key</span><span class="p">(</span>
                <span class="n">dispatcher_op_name</span><span class="p">,</span> <span class="s2">"复合隐式自动微分"</span>
            <span class="p">):</span>
                <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"我们不应直接将元内核注册到算子'"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">'，'</span>
                    <span class="s2">"因为它在核心中有一个 CompositeImplicitAutograd 内核。"</span>
                    <span class="s2">"相反，我们应该让操作符分解，并确保我们有元内核"</span>
                    <span class="s2">"用于它分解成的基操作。"</span>
                <span class="p">)</span>

        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">实现</span><span class="p">(</span>
            <span class="n">姓名</span><span class="p">,</span>
            <span class="n">分发键</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span> <span class="o">!=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">请提供需要翻译的文本</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">否则</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">复合隐式自动微分</span><span class="p">,</span>
            <span class="n">fn</span><span class="p">,</span>
            <span class="n">带有密钥集</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_impls</span><span class="o">.</span><span class="n">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op_impls</span><span class="o">.</span><span class="n">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span></div>

<div class="viewcode-block" id="Library.fallback"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]    def fallback(self, fn, dispatch_key="", *, with_keyset=False):
r"""将函数实现注册为给定键的回退函数。"""

此函数仅适用于具有全局命名空间（"_"）的库。

参数:
fn: 作为给定分发键或 :func:`~fallthrough_kernel` 的后备函数
注册一个穿透。
输入函数应注册的 dispatch key。默认情况下，它使用
分配给库创建时的按键。
with_keyset: 控制当前分发器调用是否将键集作为第一个参数传递的标志
在调用时使用 `to :attr:`fn`。这应该用于创建适当的键集以进行重定向调用。

示例::
&gt;&gt;&gt; my_lib = Library("_", "IMPL")
&gt;&gt;&gt; def fallback_kernel(op, *args, **kwargs):
&gt;&gt;&gt;     # 处理所有自动类型转换操作
&gt;&gt;&gt;     # ...
&gt;&gt;&gt; my_lib.fallback(fallback_kernel, "Autocast")
"""
if torch._running_with_deploy():
_library.utils.warn_deploy()
return

如果 dispatch_key == ""
dispatch_key = self.dispatch_key

if self.ns != "_":
raise RuntimeError(
Fallback 只能使用全局命名空间"_"上的库片段进行注册，但它是{self.ns}
            )

断言 dispatch_key 不为空字符串
断言 self.m 不为 None

self.m.fallback(dispatch_key, fn, with_keyset)</font></font></font></div>

    <span class="k">定义</span> <span class="nf">_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">重置</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="kc">无</span>
        <span class="k">对于</font></font></font></span> <span class="n">handle</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_注册处理句柄</span><span class="p">:</span>
            <span class="n">处理</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">摧毁</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_注册处理句柄</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">清晰</span><span class="p">()</span>
        <span class="k">全局</span> <span class="n">_impls</span>
        <span class="n">_impls</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op_impls</span>
        <span class="k">对于</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_操作定义</span><span class="p">:</span>
            <span class="c1"># 删除已注册的 torch.ops.ns.foo 缓存。</span>
            <span class="c1">否则，访问它会导致段错误。</span>
            <span class="c1">有可能我们只在这个库中注册了一个重载。</span>
            <span class="c1">另一个库拥有一个活动的重载。</span>
            <span class="c1">没关系 - 下次调用 torch.ops.ns.foo 时，它将会是</span>
            <span class="c1"># recomputed to point at the right collection of overloads.</span>
            <span class="n">ns</span><span class="p">,</span> <span class="n">带重载的名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">双冒号</span><span class="p">)</span>
            <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n">name_with_overload</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分割</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“。”</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">命名空间</font></font></font></span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</span><span class="p">)</span>
            <span class="n">命名空间</font></font></font></span><span class="o">.</span><span class="n">_dir</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</span><span class="p">)</span></div>


<span class="k">定义</span> <span class="nf">_del_library</span><span class="p">(</span>
    <span class="n">捕获实现</span><span class="p">,</span>
    <span class="n">操作实现</span><span class="p">,</span>
    <span class="n">捕获定义</span><span class="p">,</span>
    <span class="n">操作定义</span><span class="p">,</span>
    <span class="n">注册句柄</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">捕获实现</font></font></font></span> <span class="o">-=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作实现</span>
    <span class="n">捕获定义</font></font></font></span> <span class="o">-=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</span>
    <span class="k">对于</font></font></font></span> <span class="n">handle</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册句柄</span><span class="p">:</span>
        <span class="n">处理</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">摧毁</span><span class="p">()</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">定义</span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_scoped_library
（无翻译内容）</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">):</span>
    <span class="k">尝试</span><span class="p">:</span>
        <span class="n">库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">)</span>
        <span class="k">产生</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span>
    <span class="k">最后</span><span class="p">:</span>
        <span class="n">库</span><span class="o">.</span><span class="n">_destroy</span><span class="p">()</span>


<span class="n">_保持活跃</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本为空，请提供需要翻译的文本</span>


<span class="n">NAMELESS_SCHEMA</span> <span class="o">=</span> <span class="n">正则表达式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">编译</font></font></font></span><span class="p">(</span><span class="sa">r</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">\(.*\) -&gt; .*</span><span class="p">)</span>


<div class="viewcode-block" id="define"><a class="viewcode-back" href="../../library.html#torch.library.define">[文档]</font></font></font></a><span class="nd">@functools</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">单例分发</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span><span class="p">(</span><span class="n">qualname</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="o">=</span><span class="p">()):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">定义一个新的运算符。</span>

<span class="sd">在 PyTorch 中，定义一个运算符（简称“op”）是一个两步过程：</span>
<span class="sd">- 我们需要定义运算符（通过提供运算符名称和模式）</span>
<span class="sd">- 我们需要实现运算符如何与其他元素交互的行为</span>
<span class="sd">各种 PyTorch 子系统，如 CPU/CUDA 张量、Autograd 等。</span>

<span class="sd">此入口定义自定义操作（第一步）</span>
<span class="sd">然后您必须通过调用各种</span>
<span class="sd">``impl_*`` API，如 :func:`torch.library.impl` 或</span>
<span class="sd">`torch.library.register_fake`.</span>

<span class="sd">参数：</span>
<span class="sd">qualname (str): 操作符的限定名称。应为</span>
<span class="sd">看起来像 "命名空间::名称" 的字符串，例如 "aten::sin"。</span>
<span class="sd">PyTorch 中的操作符需要一个命名空间来</span>
<span class="sd">避免名称冲突；一个操作符只能创建一次。</span>
<span class="sd">如果您正在编写一个 Python 库，我们建议命名空间为</span>
<span class="sd">您顶级模块的名称。</span>
<span class="sd">schema (str): 操作符的模式。例如：(Tensor x) -&gt; Tensor</span>
<span class="sd">用于接受一个张量并返回一个张量的操作。它不包含操作名称（该名称通过 `qualname` 传入）。</span>
<span class="sd">不包含操作名称（即通过 `qualname` 传入的操作名称）。</span>
<span class="sd">lib（可选[Library]）：如果提供，则此操作的生命周期将与 Library 对象的生命周期绑定。</span>
<span class="sd">将会绑定到库对象的生命周期。</span>
<span class="sd">标签（Tag | Sequence[Tag]）：应用于此的一个或多个 torch.Tag</span>
<span class="sd">标记操作符会改变操作符在各种 PyTorch 子系统中的行为</span>
<span class="sd">请在应用 torch.Tag 之前仔细阅读文档。</span>
<span class="sd">请仔细阅读 torch.Tag 文档后再应用。</span>

<span class="sd">示例::</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 定义操作符</span>
<span class="sd">        &gt;&gt;&gt; torch.library.define("mylib::sin", "(Tensor x) -&gt; Tensor")</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 添加操作符的实现</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.impl("mylib::sin", "cpu")</span>
<span class="sd">        &gt;&gt;&gt; def f(x):</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(np.sin(x.numpy()))</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 从 torch.ops 调用新操作符。</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; y = torch.ops.mylib.sin(x)</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(y, x.sin())</span>

<span class="sd">    """</span>
    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qualname</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"define(qualname, schema): 预期 qualname "</span>
            <span class="sa">f</span><span class="s2">"为 str 的实例，却得到了 "</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
        <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无名称模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">完全匹配</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"define(qualname, 模式, ...): 预期模式 "</span>
            <span class="sa">f</span><span class="s1">'看起来像 e.g. "(Tensor x) -&gt; Tensor" 但 '</span>
            <span class="sa">f</span><span class="s1">'得到 '</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="si">}</span><span class="s1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">''</span>
        <span class="p">)</span>
    <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</font></font></font></span> <span class="o">+</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">标签</span><span class="p">)</span></div>


<span class="nd">@define</span><span class="o">.</span><span class="n">注册</span>
<span class="k">定义</font></font></font></span> <span class="nf">_</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""旧版的 torch.library.define.</span>
<span class="sd">我们保留这部分是为了向后兼容的原因</span>
<span class="sd">    """</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包裹</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">别名分析</span><span class="p">)</span>
        <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">返回</span> <span class="n">f</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包装</span>


<span class="nd">@overload</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">qualname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">直接</font></font></font></span><span class="p">[</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">可调用</font></font></font></span><span class="p">[[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">]],</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span> <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">qualname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">无</span><span class="p">:</span> <span class="o">...</span>


<span class="c1"># 已废弃的 BC API</span>
<span class="nd">@overload</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span><span class="p">,</span>
    <span class="n">姓名</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">分发键</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入文本翻译为简体中文为：""</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">可调用</font></font></font></span><span class="p">[[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]],</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span> <span class="o">...</span>


<div class="viewcode-block" id="impl"><a class="viewcode-back" href="../../library.html#torch.library.impl">[文档]</font></font></font></a><span class="nd">@functools</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">单例分发</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">qualname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">对象</span><span class="p">:</span>
<span class="w">    </span><span class="sd">为此操作员注册设备类型的实现。</span>

<span class="sd">您可以将 "default" 传递给 ``types`` 以将此实现注册为所有设备类型的默认实现。</span>
<span class="sd">请仅在此实现真正支持所有设备类型时使用。</span>
<span class="sd">请仅在此实现真正支持所有设备类型时使用。</span>
<span class="sd">例如，如果它是内置 PyTorch 运算符的组合，则此条件为真。</span>

<span class="sd">此 API 可以用作装饰器。您可以使用嵌套装饰器</span>
<span class="sd">只要它们返回一个函数并且放在此 API 内部</span>
<span class="sd">（请参阅示例 2）。</span>

<span class="sd">一些有效的类型包括："cpu"、"cuda"、"xla"、"mps"、"ipu"、"xpu"。</span>

<span class="sd">参数：</span>
<span class="sd">qualname（字符串）：应是一个类似于 "namespace::operator_name" 的字符串。</span>
<span class="sd">types（字符串 | 字符串序列）：要将 impl 注册到的设备类型。</span>
<span class="sd">lib（可选[库]）：如果提供，则此注册的生命周期</span>
<span class="sd">将会绑定到库对象的生命周期。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">&gt;&gt;&gt; # 示例 1：注册函数。</span>
<span class="sd">&gt;&gt;&gt; # 定义操作符</span>
<span class="sd">        &gt;&gt;&gt; torch.library.define("mylib::mysin", "(Tensor x) -&gt; Tensor")</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 为 cpu 设备添加实现</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.impl("mylib::mysin", "cpu")</span>
<span class="sd">        &gt;&gt;&gt; def f(x):</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(np.sin(x.numpy()))</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; y = torch.ops.mylib.mysin(x)</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(y, x.sin())</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 示例 2：使用装饰器注册函数。</span>
<span class="sd">        &gt;&gt;&gt; def custom_decorator(func):</span>
<span class="sd">        &gt;&gt;&gt;     def wrapper(*args, **kwargs):</span>
<span class="sd">&gt;&gt;&gt;         返回 func(*args, **kwargs) + 1</span>
<span class="sd">&gt;&gt;&gt;     返回 wrapper</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 定义操作符</span>
<span class="sd">        &gt;&gt;&gt; torch.library.define("mylib::sin_plus_one", "(Tensor x) -&gt; Tensor")</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 添加操作符的实现</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.impl("mylib::sin_plus_one", "cpu")</span>
<span class="sd">        &gt;&gt;&gt; @custom_decorator</span>
<span class="sd">        &gt;&gt;&gt; def f(x):</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(np.sin(x.numpy()))</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 从 torch.ops 调用新操作符。</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; y1 = torch.ops.mylib.sin_plus_one(x)</span>
<span class="sd">        &gt;&gt;&gt; y2 = torch.sin(x) + 1</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(y1, y2)</span>
<span class="sd">    """</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n">qualname</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">禁用 Dynamo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型检查</span><span class="p">:</span>

    <span class="nd">@impl</span><span class="o">.</span><span class="n">注册</span>
    <span class="k">定义</span> <span class="nf">_</span><span class="p">(</span>
        <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">请提供需要翻译的文本</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">可调用</font></font></font></span><span class="p">[[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">]],</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
<span class="w">        </span><span class="sd">旧版 torch.library.impl API。保留以供向后兼容</span>

        <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包裹</font></font></font></span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="n">_P</span><span class="p">,</span> <span class="n">_T</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
            <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分发键</span><span class="p">)</span>
            <span class="k">返回</span> <span class="n">f</span>

        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">包装</span>


<span class="nd">@overload</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">qualname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">直接</font></font></font></span><span class="p">[</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">禁用 Dynamo</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔值</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">可调用</font></font></font></span><span class="p">[[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">]],</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span> <span class="o">...</span>


<span class="nd">@overload</span>
<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">qualname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">禁用 Dynamo</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔值</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">无</span><span class="p">:</span> <span class="o">...</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</span><span class="p">(</span>
    <span class="n">qualname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">禁用 Dynamo</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔值</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">]],</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]]</span>
    <span class="c1"># See impl()</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">类型</font></font></font></span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">,)</span>
    <span class="n">键</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置</span><span class="p">({})</span>
    <span class="k">对于</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</span><span class="p">:</span>
        <span class="n">is_dispatch_key</span> <span class="o">=</span> <span class="n">火炬</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_parse_dispatch_key</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否为分发键</span><span class="p">:</span>
            <span class="c1">我们还支持传递一个 DispatchKey 给 impl。请优先使用更高层次的 torch.library APIs，并且只将 DispatchKey 传递给 torch.library.impl，请谨慎使用（或者更好的选择，不要使用这个选项，并在 GitHub 上提交一个关于你需要解决的问题的 issue）。</span>
            <span class="c1"># the higher-level torch.library APIs and only pass DispatchKey to</span>
            <span class="c1"># torch.library.impl with caution (or even better, don't use this</span>
            <span class="c1"># option and file an issue on GitHub for what you need).</span>
            <span class="c1">我们不向用户宣传这一点，因为</span>
            <span class="c1"># 很容易自己打自己的脚。</span>
            <span class="n">键</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">键</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_设备类型转键</span><span class="p">(</span><span class="n">typ</span><span class="p">))</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册_</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">对象</font></font></font></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">使用库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
            <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用库</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">使用库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">禁用 Dynamo</span><span class="p">:</span>

            <span class="nd">@torch</span><span class="o">.</span><span class="n">禁用 dynamo</span>
            <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无 Dynamo 功能</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">):</span>
                <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">)</span>

            <span class="k">对于</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">:</span>
                <span class="n">使用库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n">qualname</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无 Dynamo 功能</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">对于</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">:</span>
                <span class="n">使用库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n">qualname</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册_</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="n">注册_</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span>


<span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_设备类型转键</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认</span><span class="p">:</span>
        <span class="c1">这不是技术上的正确做法，因为尽管所有设备类型</span>
        <span class="c1"># 处理键包含在 CompositeExplicitAutograd 中</span>
        <span class="c1"># CompositeExplicitAutograd 中并非所有内容都与显式自动微分相关联</span>
        <span class="c1">设备类型。我并不真的那么在乎这些区别。</span>
        <span class="k">返回</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"复合显式自动微分"</span>
    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_设备调度键</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</span><span class="p">)</span>


<div class="viewcode-block" id="impl_abstract"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]@已弃用(
"``torch.library.impl_abstract`` 已重命名为 ``torch.library.register_fake``。请使用它 "
未来版本中，我们将移除 `torch.library.impl_abstract`。
category=未来警告，
)
def impl_abstract(qualname, func=None, *, lib=None, _stacklevel=1):
此 API 在 PyTorch 2.4 版本中更名为：func:`torch.library.register_fake`。
请使用它代替。
""
如果 func 不是 None：
_stacklevel = _stacklevel + 1
返回 register_fake(qualname, func, lib=lib, _stacklevel=_stacklevel)</font></font></font></div>


<span class="n">_op_identifier</span> <span class="o">=</span> <span class="n">联合</span><span class="p">[</span>
    <span class="nb">str</span><span class="p">,</span> <span class="s2">"torch._ops.操作重载"</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"torch._library.custom_ops.自定义操作定义"</span>
<span class="p">]</span>


<div class="viewcode-block" id="register_kernel"><a class="viewcode-back" href="../../library.html#torch.library.register_kernel">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册内核</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_op 标识符</span><span class="p">,</span>
    <span class="n">设备类型</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型_t</span><span class="p">,</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">为此操作员注册设备类型的实现。</span>

<span class="sd">一些有效的设备类型包括："cpu"、"cuda"、"xla"、"mps"、"ipu"、"xpu"。</span>
<span class="sd">此 API 可以用作装饰器。</span>

<span class="sd">参数：</span>
<span class="sd">op (str | OpOverload): 要注册实现的运算符。</span>
<span class="sd">device_types (None | str | Sequence[str]): 要注册实现的设备类型。</span>
<span class="sd">如果为空，我们将注册到所有设备类型 -- 请仅使用</span>
<span class="sd">此选项适用于您的实现真正与设备类型无关。</span>
<span class="sd">func (Callable): 将注册为实现的函数</span>
<span class="sd">给定的设备类型。</span>
<span class="sd">lib（可选[库]）：如果提供，则此注册的生命周期</span>

<span class="sd">示例::</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CUDA)</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">&gt;&gt;&gt; 从 torch 导入 Tensor</span>
<span class="sd">        &gt;&gt;&gt; from torch.library import custom_op</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 创建一个在 cpu 上工作的自定义操作</span>
<span class="sd">        &gt;&gt;&gt; @custom_op("mylib::numpy_sin", mutates_args=(), device_types="cpu")</span>
<span class="sd">        &gt;&gt;&gt; def numpy_sin(x: Tensor) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     x_np = x.numpy()</span>
<span class="sd">        &gt;&gt;&gt;     y_np = np.sin(x_np)</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(y_np)</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 添加对 cuda 设备的实现</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.register_kernel("mylib::numpy_sin", "cuda")</span>
<span class="sd">        &gt;&gt;&gt; def _(x):</span>
<span class="sd">        &gt;&gt;&gt;     x_np = x.cpu().numpy()</span>
<span class="sd">        &gt;&gt;&gt;     y_np = np.sin(x_np)</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(y_np).to(device=x.device)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x_cpu = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; x_cuda = x_cpu.cuda()</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(numpy_sin(x_cpu), x_cpu.sin())</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(numpy_sin(x_cuda), x_cuda.sin())</span>

<span class="sd">    """</span>

    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">操作</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"注册内核（"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">): 预期外的类型对于 op:</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
    <span class="n">操作定义</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能获取操作定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册内核</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span>
    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">设备类型</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"复合显式自动微分"</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">禁用 Dynamo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_autocast"><a class="viewcode-back" href="../../library.html#torch.library.register_autocast">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册自动转换</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_op 标识符</span><span class="p">,</span>
    <span class="n">设备类型</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">输入设备</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">注册此自定义操作的自动广播调度规则。</span>

<span class="sd">有效的 `device_type` 包括: "cpu" 和 "cuda"。</span>

<span class="sd">参数：</span>
<span class="sd">op (str | OpOverload): 要注册自动广播调度规则的运算符。</span>
<span class="sd">device_type(str):  要使用的设备类型。'cuda' 或 'cpu'。</span>
<span class="sd">类型与 :class:`torch.device` 的 `type` 属性相同。</span>
<span class="sd">因此，您可以使用 `Tensor.device.type` 获取张量的设备类型。</span>
<span class="sd">cast_inputs (:class:`torch.dtype`): 当自定义操作在自动类型转换区域运行时，</span>
<span class="sd">将传入的浮点型张量转换为目标数据类型（非浮点型张量）</span>
<span class="sd">这些不受影响），然后执行禁用自动转换的自定义操作。</span>
<span class="sd">lib（可选[库]）：如果提供，则此注册的生命周期</span>

<span class="sd">示例::</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CUDA)</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">&gt;&gt;&gt; 从 torch 导入 Tensor</span>
<span class="sd">        &gt;&gt;&gt; from torch.library import custom_op</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 创建一个在 cuda 上工作的自定义操作</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::my_sin", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def my_sin(x: Tensor) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     return torch.sin(x)</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 注册针对 cuda 设备的 autocast 调度规则</span>
<span class="sd">        &gt;&gt;&gt; torch.library.register_autocast("mylib::my_sin", "cuda", torch.float16)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3, dtype=torch.float32, device="cuda")</span>
<span class="sd">        &gt;&gt;&gt; with torch.autocast("cuda", dtype=torch.float16):</span>
<span class="sd">        &gt;&gt;&gt;     y = torch.ops.mylib.my_sin(x)</span>
<span class="sd">        &gt;&gt;&gt; assert y.dtype == torch.float16</span>

<span class="sd">    """</span>
    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">操作</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">register_autocast(</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">): 预期外的类型对于 op:</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span> <span class="ow">not</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进入</font></font></font></span> <span class="p">[</span><span class="s2">"cpu"</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"未知设备类型："</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
    <span class="n">操作定义</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能获取操作定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册自动转换</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入设备</span><span class="p">)</span>

    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">qualname</span> <span class="o">=</span> <span class="n">操作符</span>
    <span class="n">_操作</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">查找操作</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>

    <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
        <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span><span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内核</font></font></font></span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">):</span>
        <span class="k">断言</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</font></font></font></span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"自定义操作目前尚不支持 kwargs。"</span>
        <span class="n">autocast_keyset</span> <span class="o">=</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键集</span><span class="p">(</span>
            <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动转换 CPU</span>
        <span class="p">)</span> <span class="o">|</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键集</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送键</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动将 CUDA</span><span class="p">)</span>
        <span class="k">替换为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_排除调度键保护</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动铸件键集</span><span class="p">):</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_操作</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_类型转换</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">输入设备</span><span class="p">))</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设备类型</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内核</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动转换 CUDA</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">带有密钥集</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="c1"># 设备类型为 "cpu"</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内核</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动转换 CPU</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">带有密钥集</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_fake"><a class="viewcode-back" href="../../library.html#torch.library.register_fake">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册伪造</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_op 标识符</span><span class="p">,</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">_stacklevel</span><span class="p">:</span> <span class="nb">整型</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">注册此运算符的 FakeTensor 实现（"fake impl"）。</span>

<span class="sd">也被称为“元内核”、“抽象实现”。</span>

<span class="sd">"FakeTensor 实现"指定了此运算符在</span>
<span class="sd">不携带数据（"FakeTensor"）的 Tensors 上的行为。</span>
<span class="sd">指定某些属性（大小/步长/存储偏移/设备），它指定了</span>
<span class="sd">输出张量的属性是什么。</span>

<span class="sd">FakeTensor 实现与操作符具有相同的签名。</span>
<span class="sd">它对 FakeTensors 和元张量都进行运行。为了编写一个 FakeTensor</span>
<span class="sd">实现，假设操作符的所有 Tensor 输入都是</span>
<span class="sd">正常的 CPU/CUDA/Meta 张量，但它们没有存储，并且</span>
<span class="sd">您尝试返回常规的 CPU/CUDA/Meta 张量作为输出。</span>
<span class="sd">FakeTensor 的实现必须仅由 PyTorch 操作组成</span>
<span class="sd">（并且不能直接访问任何输入或</span>
<span class="sd">中间张量）。</span>

<span class="sd">此 API 可以用作装饰器（请参阅示例）。</span>

<span class="sd">有关自定义操作的详细指南，请参阅</span>
<span class="sd">    https://maskerprc.github.io/tutorials/advanced/custom_ops_landing_page.html</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">&gt;&gt;&gt; 从 torch 导入 Tensor</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 示例 1：一个没有数据依赖输出形状的操作符</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::custom_linear", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def custom_linear(x: Tensor, weight: Tensor, bias: Tensor) -&gt; Tensor:</span>
<span class="sd">&gt;&gt;&gt;     raise NotImplementedError("实现将在此处进行")</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.register_fake("mylib::custom_linear")</span>
<span class="sd">        &gt;&gt;&gt; def _(x, weight, bias):</span>
<span class="sd">        &gt;&gt;&gt;     assert x.dim() == 2</span>
<span class="sd">        &gt;&gt;&gt;     assert weight.dim() == 2</span>
<span class="sd">&gt;&gt;&gt;     断言 bias 的维度等于 1</span>
<span class="sd">&gt;&gt;&gt;     断言 x 的形状[1] 等于 weight 的形状[1]</span>
<span class="sd">&gt;&gt;&gt;     断言 weight 的形状[0] 等于 bias 的形状[0]</span>
<span class="sd">&gt;&gt;&gt;     断言 x 的设备等于 weight 的设备</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; 返回 (x @ weight.t()) + bias</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; 使用 torch._subclasses.fake_tensor.FakeTensorMode()</span>
<span class="sd">&gt;&gt;&gt; x = torch.randn(2, 3)</span>
<span class="sd">&gt;&gt;&gt; w = torch.randn(3, 3)</span>
<span class="sd">        &gt;&gt;&gt;     b = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt;     y = torch.ops.mylib.custom_linear(x, w, b)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; assert y.shape == (2, 3)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; # Example 2: an operator with data-dependent output shape</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::custom_nonzero", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def custom_nonzero(x: Tensor) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     x_np = x.numpy(force=True)</span>
<span class="sd">        &gt;&gt;&gt;     res = np.stack(np.nonzero(x_np), axis=1)</span>
<span class="sd">        &gt;&gt;&gt;     return torch.tensor(res, device=x.device)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.register_fake("mylib::custom_nonzero")</span>
<span class="sd">        &gt;&gt;&gt; def _(x):</span>
<span class="sd">        &gt;&gt;&gt; # Number of nonzero-elements is data-dependent.</span>
<span class="sd">&gt;&gt;&gt; # 由于我们无法查看模拟实现中的数据，</span>
<span class="sd">&gt;&gt;&gt; # 我们使用 ctx 对象来构建一个新的 symint，</span>
<span class="sd">&gt;&gt;&gt; # 表示数据依赖的大小。</span>
<span class="sd">        &gt;&gt;&gt;     ctx = torch.library.get_ctx()</span>
<span class="sd">        &gt;&gt;&gt;     nnz = ctx.new_dynamic_size()</span>
<span class="sd">        &gt;&gt;&gt;     shape = [nnz, x.dim()]</span>
<span class="sd">        &gt;&gt;&gt;     result = x.new_empty(shape, dtype=torch.int64)</span>
<span class="sd">        &gt;&gt;&gt;     return result</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; from torch.fx.experimental.proxy_tensor import make_fx</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.tensor([0, 1, 2, 3, 4, 0])</span>
<span class="sd">        &gt;&gt;&gt; trace = make_fx(torch.ops.mylib.custom_nonzero, tracing_mode="symbolic")(x)</span>
<span class="sd">        &gt;&gt;&gt; trace.print_readable()</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; 断言 torch.allclose(trace(x), torch.ops.mylib.custom_nonzero(x))</span>

<span class="sd">    """</span>
    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">操作</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"注册伪造（"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">): 预期外的类型对于 op:</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
    <span class="n">操作定义</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能获取操作定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册伪造</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册伪造</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span>
    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="n">栈级别</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_堆栈级别</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">):</span>
        <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">使用库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
            <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用库</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">使用库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span>
        <span class="n">使用库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册模拟实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n">_stacklevel</span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">栈级别</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="n">栈级别</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_autograd"><a class="viewcode-back" href="../../library.html#torch.library.register_autograd">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册自动微分</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_op 标识符</span><span class="p">,</span>
    <span class="n">反向</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">设置上下文</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">无</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">注册此自定义操作的逆向公式。</span>

<span class="sd">为了使操作符能够与 autograd 一起工作，您需要注册</span>
<span class="sd">一个反向公式：</span>
<span class="sd">1. 您必须告诉我们如何在反向传播过程中计算梯度</span>
<span class="sd">通过为我们提供一个“反向”函数。</span>
<span class="sd">2. 如果您需要从正向计算梯度时使用任何正向的值，您可以</span>
<span class="sd">使用 `setup_context` 来保存向后传递的值。</span>

<span class="sd">``backward`` 在反向传播过程中运行。它接受 `(ctx, *grads)`:</span>
<span class="sd">- ``grads`` 是一个或多个梯度。梯度的数量与</span>
<span class="sd">操作符的输出数量相匹配。</span>
<span class="sd">``ctx``对象与``_中使用的`ctx`对象相同。</span>
<span class="sd">`torch.autograd.Function`的语义与`backward_fn`相同。</span>
<span class="sd">`setup_context(ctx, inputs, output)`在正向传播期间运行。</span>

<span class="sd">`torch.autograd.Function.backward`的语义相同。</span>
<span class="sd">请将所需的数量反向保存到“ctx”对象中</span>
<span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">either :meth:`torch.autograd.function.FunctionCtx.save_for_backward` 
翻译为：either :meth:`torch.autograd.function.FunctionCtx.save_for_backward`</font></font></font></span>
<span class="sd">将它们作为 ``ctx`` 的属性分配。如果你的自定义操作</span>
<span class="sd">仅支持关键字参数，我们期望`setup_context`的签名</span>
<span class="sd">`setup_context(ctx, inputs, keyword_only_inputs, output)` 需要设置上下文。</span>

<span class="sd">`setup_context_fn` 和 `backward_fn` 必须可追踪。也就是说，</span>
<span class="sd">它们不能直接访问 :meth:`torch.Tensor.data_ptr`，并且不能</span>
<span class="sd">依赖于或修改全局状态。如果您需要不可追踪的反向操作，</span>
<span class="sd">你可以将其制作为一个独立的 custom_op，在 backward_fn 中调用。</span>

<span class="sd">如果您需要在不同的设备上实现不同的 autograd 行为，那么我们建议创建两个不同的自定义算子，每个设备一个，并在运行时切换它们。</span>
<span class="sd">推荐为需要不同行为的每个设备创建两个不同的自定义算子，并在运行时进行切换。</span>
<span class="sd">需要不同行为的设备，建议创建两个不同的自定义算子，并在运行时进行切换。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">&gt;&gt;&gt; 从 torch 导入 Tensor</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::numpy_sin", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def numpy_sin(x: Tensor) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     x_np = x.cpu().numpy()</span>
<span class="sd">        &gt;&gt;&gt;     y_np = np.sin(x_np)</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(y_np).to(device=x.device)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def setup_context(ctx, inputs, output) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     x, = inputs</span>
<span class="sd">        &gt;&gt;&gt;     ctx.save_for_backward(x)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def backward(ctx, grad):</span>
<span class="sd">        &gt;&gt;&gt;     x, = ctx.saved_tensors</span>
<span class="sd">        &gt;&gt;&gt;     return grad * x.cos()</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; torch.library.register_autograd(</span>
<span class="sd">        ...     "mylib::numpy_sin", backward, setup_context=setup_context</span>
<span class="sd">        ... )</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3, requires_grad=True)</span>
<span class="sd">        &gt;&gt;&gt; y = numpy_sin(x)</span>
<span class="sd">        &gt;&gt;&gt; (grad_x,) = torch.autograd.grad(y, x, torch.ones_like(y))</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(grad_x, x.cos())</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; # 示例：仅使用关键字参数</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::numpy_mul", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def numpy_mul(x: Tensor, *, val: float) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     x_np = x.cpu().numpy()</span>
<span class="sd">        &gt;&gt;&gt;     y_np = x_np * val</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(y_np).to(device=x.device)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def setup_context(ctx, inputs, keyword_only_inputs, output) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     ctx.val = keyword_only_inputs["val"]</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def backward(ctx, grad):</span>
<span class="sd">        &gt;&gt;&gt;     return grad * ctx.val</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; torch.library.register_autograd(</span>
<span class="sd">        ...     "mylib::numpy_mul", backward, setup_context=setup_context</span>
<span class="sd">        ... )</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3, requires_grad=True)</span>
<span class="sd">        &gt;&gt;&gt; y = numpy_mul(x, val=3.14)</span>
<span class="sd">        &gt;&gt;&gt; (grad_x,) = torch.autograd.grad(y, x, torch.ones_like(y))</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(grad_x, torch.full_like(x, 3.14))</span>

<span class="sd">    """</span>
    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">操作</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">register_autograd(</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">): 预期外的类型对于 op:</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
    <span class="n">操作定义</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能获取操作定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册自动微分</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">反向</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置上下文</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置上下文</span><span class="p">)</span>
        <span class="k">返回</span>

    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">qualname</span> <span class="o">=</span> <span class="n">操作符</span>
    <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">查找操作</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
    <span class="n">架构</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_架构</span>
    <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">功能性模式</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</span><span class="p">):</span>
        <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"无法为非功能性算子注册自动微分公式"</span>
            <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">与模式</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">请创建 "</span>
            <span class="sa">f</span><span class="s2">一个功能操作符并为该操作符注册一个自动求导公式。</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">只有关键字参数的张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不支持的操作异常</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">使用仅关键字参数的 Tensor 参数注册自动求导。在原始 "</span>
            <span class="sa">f</span><span class="s2">的定义中，请确保您的张量不是仅关键字参数的。</span>
            <span class="sa">f</span><span class="s2">"获取："</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>

    <span class="n">信息</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动微分</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">反向</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置上下文</span><span class="p">)</span>
    <span class="n">自动微分内核</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动微分</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建自动微分实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">)</span>
    <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
        <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span><span class="p">)</span>
    <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动微分内核</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动微分</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">带有密钥集</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_torch_dispatch"><a class="viewcode-back" href="../../library.html#torch.library.register_torch_dispatch">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册 torch 分派</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_op 标识符</span><span class="p">,</span>
    <span class="n">torch 调度类</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</span><span class="p">,</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">注册给定操作符和 `torch_dispatch_class` 的 torch_dispatch 规则。</span>

<span class="sd">这允许开放注册以指定操作员之间的行为</span>
<span class="sd">无需修改的 `torch_dispatch_class`</span>
<span class="sd">或直接操作员。</span>

<span class="sd">torch_dispatch_class 可以是具有__torch_dispatch__的 Tensor 子类</span>
<span class="sd">    TorchDispatchMode.</span>

<span class="sd">如果它是一个 Tensor 子类，我们期望 func 具有以下签名：</span>
<span class="sd">(cls, func: OpOverload, types: Tuple[type, ...], args, kwargs) -&gt; Any</span>

<span class="sd">如果它是一个 TorchDispatchMode，我们期望 func 具有以下签名：</span>
<span class="sd">``(模式，func: OpOverload，types: Tuple[type, ...]，args，kwargs) -&gt; Any``</span>

<span class="sd">``args`` 和 ``kwargs`` 将以与它们相同的方式进行归一化</span>
<span class="sd">在 ``__torch_dispatch__`` 中（参见 :ref:`torch-dispatch-calling-convention`）。</span>

<span class="sd">示例：</span>

<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::foo", mutates_args={})</span>
<span class="sd">        &gt;&gt;&gt; def foo(x: torch.Tensor) -&gt; torch.Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     return x.clone()</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; class MyMode(torch.utils._python_dispatch.TorchDispatchMode):</span>
<span class="sd">        &gt;&gt;&gt;     def __torch_dispatch__(self, func, types, args=(), kwargs=None):</span>
<span class="sd">&gt;&gt;&gt;         返回 func(*args, **kwargs)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.register_torch_dispatch("mylib::foo", MyMode)</span>
<span class="sd">        &gt;&gt;&gt; def _(mode, func, types, args, kwargs):</span>
<span class="sd">        &gt;&gt;&gt;     x, = args</span>
<span class="sd">&gt;&gt;&gt; 返回 x + 1</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; y = foo(x)</span>
<span class="sd">&gt;&gt;&gt; 断言 torch.allclose(y, x)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; with MyMode():</span>
<span class="sd">&gt;&gt;&gt; y = foo(x)</span>
<span class="sd">        &gt;&gt;&gt; assert torch.allclose(y, x + 1)</span>

<span class="sd">    """</span>
    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">操作</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"注册 torch 分派("</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">): 预期外的类型对于 op:</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
    <span class="n">操作定义</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能获取操作定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册 torch 分派</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch 调度类</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span>
    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">):</span>
        <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">使用库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
            <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">使用库</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">使用库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span>
        <span class="n">使用库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_注册 torch 调度规则</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符名称</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch 调度类</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span></div>


<div class="viewcode-block" id="register_vmap"><a class="viewcode-back" href="../../library.html#torch.library.register_vmap">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册_vmap</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_op 标识符</span><span class="p">,</span>
    <span class="n">函数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">库</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">注册一个 vmap 实现，以支持此自定义操作的:func:`torch.vmap`。</span>

<span class="sd">此 API 可以用作装饰器（请参阅示例）。</span>

<span class="sd">为了使操作员能够使用 :func:`torch.vmap`，您可能需要注册</span>
<span class="sd">vmap 实现如下签名：</span>

<span class="sd">vmap_func(info, in_dims: 可选[int] 元组, *args, **kwargs)</span>

<span class="sd">``*args`` 和 ``**kwargs`` 是 ``op`` 的参数和关键字参数。</span>
<span class="sd">我们不支持仅关键字参数的 Tensor 参数。</span>

<span class="sd">它指定了在给定具有额外维度（由`in_dims`指定）的输入时，如何计算`op`的批处理版本。</span>
<span class="sd">对于`args`中的每个参数，`in_dims`都有一个对应的`Optional[int]`。它是`None`。</span>

<span class="sd">对于`args`中的每个参数，`in_dims`都有一个对应的`Optional[int]`。它是`None`。</span>
<span class="sd">如果参数不是张量或者参数没有被 vmapped，否则它是一个整数</span>
<span class="sd">指定正在被 vmapped 操作覆盖的张量的哪个维度</span>

<span class="sd">``info`` 是一个可能包含有用额外元数据的集合：</span>
<span class="sd">``info.batch_size`` 指定了正在被 vmapped 覆盖的维度的尺寸，同时</span>
<span class="sd">``info.randomness`` 是传递给 :func:`torch.vmap` 的 ``randomness`` 选项。</span>

<span class="sd">函数 ``func`` 的返回值是一个包含 ``output, out_dims`` 的元组。与 ``in_dims`` 类似，</span>
<span class="sd">``out_dims`` 应与 ``output`` 具有相同的结构，并包含一个 ``out_dim``，</span>
<span class="sd">每个输出指定该输出是否具有 vmapped 维度以及它在其中的索引。</span>

<span class="sd">示例：</span>
<span class="sd">&gt;&gt;&gt; 导入 torch</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">&gt;&gt;&gt; 从 torch 导入 Tensor</span>
<span class="sd">&gt;&gt;&gt; 从 typing 导入 Tuple</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; 定义 to_numpy(tensor)函数</span>
<span class="sd">&gt;&gt;&gt;     返回 tensor.cpu().numpy()</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; lib = torch.library.Library("mylib", "FRAGMENT")</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::numpy_cube", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def numpy_cube(x: Tensor) -&gt; Tuple[Tensor, Tensor]:</span>
<span class="sd">        &gt;&gt;&gt;     x_np = to_numpy(x)</span>
<span class="sd">        &gt;&gt;&gt;     dx = torch.tensor(3 * x_np ** 2, device=x.device)</span>
<span class="sd">        &gt;&gt;&gt;     return torch.tensor(x_np ** 3, device=x.device), dx</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def numpy_cube_vmap(info, in_dims, x):</span>
<span class="sd">        &gt;&gt;&gt;     result = numpy_cube(x)</span>
<span class="sd">&gt;&gt;&gt; 返回结果，(in_dims[0]，in_dims[0])</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; torch.library.register_vmap(numpy_cube, numpy_cube_vmap)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; torch.vmap(numpy_cube)(x)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::numpy_mul", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def numpy_mul(x: Tensor, y: Tensor) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     return torch.tensor(to_numpy(x) * to_numpy(y), device=x.device)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.register_vmap("mylib::numpy_mul")</span>
<span class="sd">        &gt;&gt;&gt; def numpy_mul_vmap(info, in_dims, x, y):</span>
<span class="sd">        &gt;&gt;&gt;     x_bdim, y_bdim = in_dims</span>
<span class="sd">        &gt;&gt;&gt;     x = x.movedim(x_bdim, -1) if x_bdim is not None else x.unsqueeze(-1)</span>
<span class="sd">        &gt;&gt;&gt;     y = y.movedim(y_bdim, -1) if y_bdim is not None else y.unsqueeze(-1)</span>
<span class="sd">        &gt;&gt;&gt;     result = x * y</span>
<span class="sd"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">&gt;&gt;&gt;     result = result.movedim(-1, 0)

结果 = 结果.movedim(-1, 0)</font></font></font></span>
<span class="sd">&gt;&gt;&gt; 返回结果，0</span>
<span class="sd">...</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; x = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; y = torch.randn(3)</span>
<span class="sd">        &gt;&gt;&gt; torch.vmap(numpy_mul)(x, y)</span>

<span class="sd">.. 注意::</span>
<span class="sd">vmap 函数应旨在保留整个自定义算子的语义。</span>
<span class="sd">即，应将 `grad(vmap(op))` 替换为 `grad(map(op))`。</span>

<span class="sd">如果您的自定义算子在反向传播中具有任何自定义行为，请记住这一点。</span>
<span class="sd">请注意这一点。</span>

<span class="sd">    """</span>
    <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">操作</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">值错误</font></font></font></span><span class="p">(</span><span class="sa">f</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">register_vmap(</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">): 预期外的类型对于 op:</font></font></font></span><span class="si">{</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</span><span class="p">):</span>
        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">名称</span>
    <span class="n">操作定义</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能获取操作定义</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作定义</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册_vmap</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span>
    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">qualname</span> <span class="o">=</span> <span class="n">操作符</span>
    <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">查找操作</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
    <span class="n">架构</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_架构</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">只有关键字参数的张量</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</span><span class="p">):</span>
        <span class="k">抛出</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不支持的操作异常</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">在原始操作符的定义中，请确保您的张量不是仅关键字参数的。</span>
            <span class="sa">f</span><span class="s2">的定义中，请确保您的张量不是仅关键字参数的。</span>
            <span class="sa">f</span><span class="s2">"获取："</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">架构</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">)</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">):</span>
        <span class="k">非局部</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span>

        <span class="n">命名空间</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">解析命名空间</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">库</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"碎片"</span><span class="p">)</span>
            <span class="n">_保持活跃</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">添加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">torch._functorch.autograd_function</span> <span class="kn">导入</span> <span class="n">custom_function_call_vmap_helper</span>
        <span class="kn">from</span> <span class="nn">torch._functorch.pyfunctorch</span> <span class="kn">导入</span> <span class="n">retrieve_current_functorch_interpreter</span>

        <span class="k">定义</font></font></font></span> <span class="nf">wrapped_func</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">键集</font></font></font></span><span class="p">,</span> <span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">):</span>
            <span class="n">解释器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取当前 functorch 解释器</span><span class="p">()</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义函数调用_vmap 辅助器</span><span class="p">(</span>
                <span class="n">解释器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="p">,</span> <span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="n">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实现</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作名称</font></font></font></span><span class="p">,</span> <span class="n">wrapped_func</span><span class="p">,</span> <span class="s2">"FuncTorchBatched"</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">带有密钥集</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</span><span class="p">)</span></div>


<span class="c1">如果操作是在 C++中定义的，那么我们需要确保存在</span>
<span class="c1">m.set_python_module(module, ...) 调用，并且该模块是</span>
<span class="c1">与调用 torch.library.register_fake 的模块相同。</span>
<span class="k">定义</font></font></font></span> <span class="nf">_check_pystubs_once</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">,</span> <span class="n">qualname</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实际模块名</span><span class="p">):</span>
    <span class="n">已检查</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>

    <span class="k">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内部</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">):</span>
        <span class="k">非局部</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已检查</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已检查</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">)</span>

        <span class="n">操作符</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">查找操作</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在 Python 中定义</span><span class="p">:</span>
            <span class="n">已检查</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">)</span>

        <span class="n">maybe_pystub</span> <span class="o">=</span> <span class="n">火炬</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_dispatch_pystub</span><span class="p">(</span>
            <span class="n">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">姓名</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_模式</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重载名称</span>
        <span class="p">)</span>
        <span class="k">如果</font></font></font></span> <span class="n">maybe_pystub</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">库</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</span><span class="o">.</span><span class="n">requires_set_python_module</span><span class="p">():</span>
                <span class="n">命名空间</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</span>
                <span class="n">cpp_filename</span> <span class="o">=</span> <span class="n">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">处理</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试</span><span class="p">()</span>
                <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"操作员 '"</font></font></font></span><span class="si">{</span><span class="n">qualname</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">'在 C++中被定义，并且 Python '</span>
                    <span class="sa">f</span><span class="s2">"需要也存在一个“假的实现。在这种情况下，我们要求"</span>
                    <span class="sa">f</span><span class="s1">'的 C++ `m.set_python_module("'</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实际模块名</font></font></font></span><span class="si">}</span><span class="s1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">")` ' "</span>
                    <span class="sa">f</span><span class="s2">"调用，但我们找不到一个。请将其添加到 "</span>
                    <span class="sa">f</span><span class="s2">"到 C++ TORCH_LIBRARY() 的顶部 "</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名空间</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">， ...) 阻塞的 </span>
                    <span class="sa">f</span><span class="s2">"操作符已注册在 ("</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpp 文件名</span><span class="si">}</span><span class="s2">)"</span>
                <span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">pystub_module</span> <span class="o">=</span> <span class="n">maybe_pystub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">如果</font></font></font></span> <span class="n">actual_module_name</span> <span class="o">!=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pystub 模块</span><span class="p">:</span>
                <span class="n">cpp_filename</span> <span class="o">=</span> <span class="n">操作</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">处理</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">调试</span><span class="p">()</span>
                <span class="k">抛出</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"操作员 '"</font></font></font></span><span class="si">{</span><span class="n">qualname</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">'指定了其 Python 模拟实现" '</span>
                    <span class="sa">f</span><span class="s2">"实际上位于 Python 模块 '"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">pystub 模块</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">'但实际上找到的是 " '</span>
                    <span class="sa">f</span><span class="s2">'在 '</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">实际模块名</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">'. 请移动假的实现 "</span>
                    <span class="sa">f</span><span class="s2">"或修正 m.set_python_module 调用 ('</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpp 文件名</span><span class="si">}</span><span class="s2">)"</span>
                <span class="p">)</span>
        <span class="n">已检查</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">函数</font></font></font></span><span class="p">(</span><span class="o">*</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">参数</font></font></font></span><span class="p">,</span> <span class="o">**</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关键字参数</span><span class="p">)</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内部</span>


<span class="c1"># 注意 [ctx 在伪造实现内部]</span>
<span class="c1">如果用户有一个具有数据依赖输出形状的操作符，那么在编写一个伪造实现时，他们必须查询当前 ctx 并使用 ctx 上的方法来构造一个新的未绑定 symint。</span>
<span class="c1">这通过我们在每次设置 fake ctx 时设置全局 ctx_getter 函数来完成。</span>
<span class="c1">这通过我们在每次设置 fake ctx 时设置全局 ctx_getter 函数来完成。</span>
<span class="c1">#</span>
<span class="c1">这通过我们在每次设置 fake ctx 时设置全局 ctx_getter 函数来完成。</span>
<span class="c1">调用实现。</span>
<div class="viewcode-block" id="get_ctx"><font class=" " lang="zh-CN"><br hidden=""><font class="    "><font class="  ">[文档]def get_ctx() -&gt; "torch._library.fake_impl.FakeImplCtx":
"""get_ctx() 返回当前的 AbstractImplCtx 对象。

在模拟实现内部调用 ``get_ctx()`` 是有效的。
（详见 :func:`torch.library.register_fake` 以获取更多使用细节。
"""
返回 torch._library.fake_impl.global_ctx_getter()</font></font></font></div>


<span class="n">_OPCHECK_DEFAULT_UTILS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">测试模式</span><span class="p">,</span>
    <span class="s2">测试自动注册</span><span class="p">,</span>
    <span class="s2">测试_faketensor</span><span class="p">,</span>
    <span class="s2">测试_aot_dispatch_dynamic</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="opcheck"><a class="viewcode-back" href="../../library.html#torch.library.opcheck">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">定义</font></font></font></span> <span class="nf"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作检查</span><span class="p">(</span>
    <span class="n">操作</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符重载</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作符</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作重载数据包</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义运算定义</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="n">参数</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元组</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">,</span> <span class="o">...</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
    <span class="n">关键字参数</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任何</font></font></font></span><span class="p">]]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">测试工具</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">序列</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_OPCHECK_DEFAULT_UTILS</span><span class="p">,</span>
    <span class="n">抛出异常</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔值</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">atol</span><span class="o">=</span><span class="kc">无</span><span class="p">,</span>
    <span class="n">相对误差</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">字典</font></font></font></span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
<span class="w">    </span><span class="sd">给定一个操作符和一些示例参数，测试该操作符是否</span>
<span class="sd">注册正确。</span>

<span class="sd">这就是说，当您使用 torch.library/TORCH_LIBRARY API 创建</span>
<span class="sd">自定义操作，您指定了关于自定义操作的元数据（例如可变性信息）</span>
<span class="sd">并且这些 API 要求您传递给它们的函数满足某些属性（例如在 fake/meta/abstract 内核中不允许访问数据指针）</span>
<span class="sd">``opcheck`` 测试这些元数据和属性。</span>
<span class="sd">``opcheck`` 测试这些元数据和属性。</span>

<span class="sd">具体来说，我们测试以下内容：</span>

<span class="sd">- test_schema: 如果模式与操作符的实现匹配</span>
<span class="sd">操作符。例如：如果模式指定 Tensor 被修改，那么我们检查实现是否修改了 Tensor。如果模式</span>
<span class="sd">指定 Tensor 被修改，那么我们检查实现是否修改了 Tensor。如果模式</span>
<span class="sd">指定我们返回一个新的张量，然后我们检查该</span>
<span class="sd">实现返回一个新的张量（而不是现有的一个或</span>
<span class="sd">一个现有视图的查看。</span>
<span class="sd">- test_autograd_registration：如果算子支持训练</span>
<span class="sd">(autograd)：我们检查其自动微分公式是否已注册</span>
<span class="sd">torch.library.register_autograd 或手动注册到一</span>
<span class="sd">或更多 DispatchKey::Autograd 键。任何其他基于 DispatchKey 的</span>
<span class="sd">注册可能导致未定义的行为。</span>
<span class="sd">- test_faketensor：如果运算符具有 FakeTensor 内核</span>
<span class="sd">（并且它是正确的）。FakeTensor 内核对于运算符与 PyTorch 编译</span>
<span class="sd">API（torch.compile/export/FX）的配合工作是必要的（</span>
<span class="sd">但并不充分）。我们检查一个 FakeTensor 内核</span>
<span class="sd">（有时也称为元内核）已注册用于</span>
<span class="sd">操作符，并且它是正确的。这个测试将操作符在真实张量上的运行结果与在 FakeTensors 上的运行结果进行比较</span>
<span class="sd">运行操作符在真实张量上的结果与运行</span>
<span class="sd">操作符在 FakeTensors 上的结果进行比较，以检查它们是否相同</span>
<span class="sd">索引元数据（大小/步长/数据类型/设备等）。</span>
<span class="sd">- test_aot_dispatch_dynamic：如果操作符具有正确的行为</span>
<span class="sd">使用 PyTorch 编译 API（torch.compile/export/FX）。</span>
<span class="sd">这将检查输出（以及如果适用的话，梯度）是否是</span>
<span class="sd">在 eager-mode PyTorch 和 torch.compile 下相同。</span>
<span class="sd">此测试是`test_faketensor`的超集，并且是一个端到端测试；</span>
<span class="sd">其他它测试的是操作符支持</span>
<span class="sd">函数化和反向传播（如果存在）也</span>
<span class="sd">支持 FakeTensor 和函数化。</span>

<span class="sd">为了获得最佳结果，请多次调用`opcheck`，使用具有代表性的输入集。</span>
<span class="sd">如果您的操作符支持 autograd，请使用`opcheck`与`requires_grad = True`的输入。</span>
<span class="sd">如果您的操作符支持 autograd，请使用`opcheck`与`requires_grad = True`的输入。</span>
<span class="sd">如果您的运营商支持多设备（例如 CPU 和 CUDA），请</span>
<span class="sd">使用 `opcheck` 在所有支持的设备上输入。</span>

<span class="sd">参数：</span>
<span class="sd">操作符：操作符。必须是装饰过的函数。</span>
<span class="sd">`:func:`torch.library.custom_op` 或 OpOverload/OpOverloadPacket</span>
<span class="sd">在 torch.ops.*中找到（例如 torch.ops.aten.sin, torch.ops.mylib.foo）</span>
<span class="sd">args：算子的参数</span>
<span class="sd">kwargs：算子的关键字参数</span>
<span class="sd">test_utils：我们应该运行的测试。默认：所有测试</span>
<span class="sd">示例：("test_schema", "test_faketensor")</span>
<span class="sd">raise_exception：如果我们在第一次错误时引发异常</span>
<span class="sd">error。如果为 False，我们将返回一个字典，其中包含有关每个测试是否通过的信息</span>
<span class="sd">的信息。</span>
<span class="sd">rtol（可选浮点数）：浮点数比较的相对容差。</span>
<span class="sd">如果指定了，则必须也指定 atol。</span>
<span class="sd">如果省略，则根据 dtype 选择默认值。</span>
<span class="sd">（请参阅 :func:`torch.testing.assert_close` 中的表格）。</span>
<span class="sd">atol（可选 float）：浮点数比较的绝对容差。</span>
<span class="sd">如果指定了 ``rtol``，则必须也指定 ``rtol``。</span>
<span class="sd">如果省略，则根据 dtype 选择默认值。</span>
<span class="sd">（请参阅 :func:`torch.testing.assert_close` 中的表格）。</span>

<span class="sd">..警告：</span>

<span class="sd">opcheck 和 :func:`torch.autograd.gradcheck` 测试的是不同的事情；</span>
<span class="sd">opcheck 测试的是您对 torch.library API 的使用是否正确，</span>
<span class="sd">func:`torch.autograd.gradcheck` 测试的是您的自动微分公式是否正确，</span>
<span class="sd">数学上正确。两者都用来测试支持自定义操作的梯度计算。</span>
<span class="sd">梯度计算。</span>

<span class="sd">示例：</span>

<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CUDA)</span>
<span class="sd">        &gt;&gt;&gt; @torch.library.custom_op("mylib::numpy_mul", mutates_args=())</span>
<span class="sd">        &gt;&gt;&gt; def numpy_mul(x: Tensor, y: float) -&gt; Tensor:</span>
<span class="sd">        &gt;&gt;&gt;     x_np = x.numpy(force=True)</span>
<span class="sd">        &gt;&gt;&gt;     z_np = x_np * y</span>
<span class="sd">        &gt;&gt;&gt;     return torch.from_numpy(z_np).to(x.device)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; @numpy_mul.register_fake</span>
<span class="sd">        &gt;&gt;&gt; def _(x, y):</span>
<span class="sd">        &gt;&gt;&gt;     return torch.empty_like(x)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def setup_context(ctx, inputs, output):</span>
<span class="sd">&gt;&gt;&gt; y, = inputs</span>
<span class="sd">&gt;&gt;&gt; ctx.y = y</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; def backward(ctx, grad):</span>
<span class="sd">        &gt;&gt;&gt;     return grad * ctx.y, None</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; numpy_mul.register_autograd(backward, setup_context=setup_context)</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; sample_inputs = [</span>
<span class="sd">        &gt;&gt;&gt;     (torch.randn(3), 3.14),</span>
<span class="sd">        &gt;&gt;&gt;     (torch.randn(2, 3, device='cuda'), 2.718),</span>
<span class="sd">&gt;&gt;&gt; (torch.randn(1, 10, requires_grad=True), 1.234),</span>
<span class="sd">&gt;&gt;&gt; (torch.randn(64, 64, device='cuda', requires_grad=True), 90.18),</span>
<span class="sd">        &gt;&gt;&gt; ]</span>
<span class="sd">...</span>
<span class="sd">        &gt;&gt;&gt; for args in sample_inputs:</span>
<span class="sd">&gt;&gt;&gt; torch.library.opcheck(numpy_mul, 参数)</span>

<span class="sd">    """</span>
    <span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">torch.testing._internal.选项测试</font></font></font></span> <span class="k">as</span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项测试</span>

    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">选项测试</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作检查</span><span class="p">(</span>
        <span class="n">操作</span><span class="p">,</span>
        <span class="n">参数</span><span class="p">,</span>
        <span class="n">关键字参数</span><span class="p">,</span>
        <span class="n">测试工具</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">测试工具</span><span class="p">,</span>
        <span class="n">抛出异常</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">抛出异常</span><span class="p">,</span>
        <span class="n">相对误差</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">相对误差</span><span class="p">,</span>
        <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">,</span>
    <span class="p">)</span></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>© 版权所有 PyTorch 贡献者。</p>
  </div>
    
      <div>使用 Sphinx 构建，并使用 Read the Docs 提供的主题。</div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
         <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
         <script src="../../_static/jquery.js"></script>
         <script src="../../_static/underscore.js"></script>
         <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../_static/doctools.js"></script>
         <script src="../../_static/clipboard.min.js"></script>
         <script src="../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script="" type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0">


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>文档</h2>
          <p>PyTorch 的全面开发者文档</p>
          <a class="with-right-arrow" href="https://maskerprc.github.io/docs/stable/index.html">查看文档</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>教程</h2>
          <p>深入了解初学者和高级开发者的教程</p>
          <a class="with-right-arrow" href="https://maskerprc.github.io/tutorials">查看教程</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>资源</h2>
          <p>查找开发资源，获取您的疑问解答</p>
          <a class="with-right-arrow" href="https://maskerprc.github.io/resources">查看资源</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://maskerprc.github.io/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://maskerprc.github.io/">PyTorch</a></li>
            <li><a href="https://maskerprc.github.io/get-started">开始使用</a></li>
            <li><a href="https://maskerprc.github.io/features">功能</a></li>
            <li><a href="https://maskerprc.github.io/ecosystem">生态系统</a></li>
            <li><a href="https://maskerprc.github.io/blog/">博客</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">贡献</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://maskerprc.github.io/resources">资源</a></li>
            <li><a href="https://maskerprc.github.io/tutorials">教程</a></li>
            <li><a href="https://maskerprc.github.io/docs/stable/index.html">文档</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">讨论</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github 问题</a></li>
            <li><a href="https://maskerprc.github.io/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">品牌指南</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">保持更新</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">脸书</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">推特</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">领英</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch 播客</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">苹果</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">谷歌</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">亚马逊</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">条款</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">隐私</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© 版权所有 Linux 基金会。PyTorch 基金会是 Linux 基金会的一个项目。有关 PyTorch 基金会的网站使用条款、商标政策以及其他适用政策，请参阅 www.linuxfoundation.org/policies/。PyTorch 基金会支持 PyTorch 开源项目，该项目已被确立为 LF Projects, LLC 的 PyTorch 项目系列。有关适用于 PyTorch 项目系列 LF Projects, LLC 的政策，请参阅 www.lfprojects.org/policies/。</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">为了分析流量并优化您的体验，我们在本网站上使用 cookies。通过点击或导航，您同意允许我们使用 cookies。作为本网站的当前维护者，适用 Facebook 的 Cookies 政策。了解更多信息，包括关于可用控制的信息：Cookies 政策。</p>
    <img class="close-button" src="../../_static/images/pytorch-x.svg" width="16" height="16">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://maskerprc.github.io/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>学习</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://maskerprc.github.io/get-started">开始使用</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials">教程</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials/beginner/basics/intro.html">学习基础知识</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials/recipes/recipes_index.html">PyTorch 食谱</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials/beginner/introyt.html">PyTorch 入门 - YouTube 系列</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>生态系统</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://maskerprc.github.io/ecosystem">工具</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/#community-module">社区</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">论坛</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/resources">开发者资源</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/ecosystem/contributor-awards-2023">贡献者奖项 - 2024</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>Edge</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://maskerprc.github.io/edge">关于 PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://maskerprc.github.io/executorch-overview">执行火炬</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/executorch/stable/index.html">ExecuTorch 文档</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>文档</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://maskerprc.github.io/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://maskerprc.github.io/pytorch-domains">PyTorch 领域</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>博客 &amp; 新闻</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://maskerprc.github.io/blog/">PyTorch 博客</a>
            </li>
            <li>
              <a href="https://maskerprc.github.io/community-blog">社区博客</a>
            </li>

            <li>
              <a href="https://maskerprc.github.io/videos">视频</a>
            </li>

            <li>
              <a href="https://maskerprc.github.io/community-stories">社区故事</a>
            </li>
            <li>
              <a href="https://maskerprc.github.io/events">活动</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/newsletter">新闻简报</a>
             </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>关于</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://maskerprc.github.io/foundation">PyTorch 基金会</a>
            </li>
            <li>
              <a href="https://maskerprc.github.io/governing-board">治理委员会</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/credits">云信用计划</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/tac">技术咨询委员会</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/staff">员工</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/contact-us">联系我们</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>

</body></html>