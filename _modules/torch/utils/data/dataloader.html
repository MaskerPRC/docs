<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torch.utils.data.dataloader — PyTorch main documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://maskerprc.github.io/docs/stable/_modules/torch/utils/data/dataloader.html">
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css">
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/katex-math.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/sphinx-dropdown.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/panels-bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/css/jit.css" type="text/css">
  <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css">
    <link rel="index" title="Index" href="../../../../genindex.html">
    <link rel="search" title="Search" href="../../../../search.html">

<!--
  Search engines should not index the main version of documentation.
  Stable documentation are built without release == 'main'.
-->
<meta name="robots" content="noindex">


  <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');</script>
    <!-- End Google Tag Manager -->
  


  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head><body class="pytorch-body"><div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://maskerprc.github.io/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>

          <li class="main-menu-item">
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">学习</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/get-started">
                  <span class="dropdown-title">开始使用</span>
                  <p>在本地运行 PyTorch 或快速开始使用支持的云平台之一</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials">
                  <span class="dropdown-title">教程</span><p></p>
                  <p>PyTorch 教程中的新内容是什么</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials/beginner/basics/intro.html">
                  <span class="dropdown-title">学习基础知识</span><p></p>
                  <p>熟悉 PyTorch 的概念和模块</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials/recipes/recipes_index.html">
                  <span class="dropdown-title">PyTorch 食谱</span><p></p>
                  <p>小而全，即用即部署的 PyTorch 代码示例</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tutorials/beginner/introyt.html">
                  <span class="dropdown-title">PyTorch 入门 - YouTube 系列教程</span><p></p>
                  <p>通过我们引人入胜的 YouTube 教程系列掌握 PyTorch 基础知识</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">生态系统</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/ecosystem">
                  <span class="dropdown-title">工具</span><p></p>
                  <p>了解 PyTorch 生态系统中的工具和框架</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/#community-module">
                  <span class="dropdown-title">社区</span>
                  <p>加入 PyTorch 开发者社区，贡献、学习并获得问题解答</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">论坛</span>
                  <p>讨论 PyTorch 代码、问题、安装、研究的地方</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/resources">
                  <span class="dropdown-title">开发者资源</span>
                  <p>查找资源并获得问题解答</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/ecosystem/contributor-awards-2024">
                  <span class="dropdown-title">贡献者奖项 - 2024</span><p></p>
                  <p>本年 PyTorch 会议揭晓获奖者</p>
                </a>
              </div>
            </div>
          </li>

          <li>
          <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">边缘</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/edge">
                  <span class="dropdown-title">关于 PyTorch Edge</span><p></p>
                  <p>为边缘设备构建创新且注重隐私的 AI 体验</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/executorch-overview">
                  <span class="dropdown-title">ExecuTorch</span><p></p>
                  <p>针对移动和边缘设备实现端到端推理能力的解决方案</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/executorch/stable/index.html">
                  <span class="dropdown-title">ExecuTorch 文档</span><p></p>
                </a>
              </div>
            </div>  
          </li>

          <li class="main-menu-item">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">文档</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span><p></p>
                  <p>查阅文档以获取全面指导，了解如何使用 PyTorch</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/pytorch-domains">
                  <span class="dropdown-title">PyTorch 领域</span><p></p>
                  <p>阅读 PyTorch 领域文档，了解更多关于特定领域库的信息</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">博客与新闻</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/blog/">
                  <span class="dropdown-title">PyTorch 博客</span><p></p>
                  <p>跟上最新的技术新闻和动态</p>
                </a>
                 <a class="nav-dropdown-item" href="https://maskerprc.github.io/community-blog">
                  <span class="dropdown-title">社区博客</span><p></p>
                  <p>PyTorch 生态系统中的故事</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/videos">
                  <span class="dropdown-title">视频</span><p></p>
                  <p>了解最新的 PyTorch 教程、新内容等</p>
                </a><a class="nav-dropdown-item" href="https://maskerprc.github.io/community-stories">
                  <span class="dropdown-title">社区故事</span><p></p>
                  <p>了解我们的社区如何使用 PyTorch 解决真实、日常的机器学习问题</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/events">
                  <span class="dropdown-title">活动</span><p></p>
                  <p>查找活动、网络研讨会和播客</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/newsletter">
                  <span class="dropdown-title">通讯</span><p></p>
                  <p>跟踪最新更新</p>
                </a>
            </div>
          </div></li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="with-down-arrow">关于</a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/foundation">
                  <span class="dropdown-title">PyTorch 基金会</span><p></p>
                  <p>了解更多关于 PyTorch 基金会的信息</p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/governing-board">
                  <span class="dropdown-title">管理委员会</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/credits">
                  <span class="dropdown-title">云信用计划</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/tac">
                  <span class="dropdown-title">技术顾问委员会</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/staff">
                  <span class="dropdown-title">员工</span><p></p>
                </a>
                <a class="nav-dropdown-item" href="https://maskerprc.github.io/contact-us">
                  <span class="dropdown-title">联系我们</span><p></p>
                </a>
              </div>
            </div>
          </li>

          <li class="main-menu-item">
            <div class="no-dropdown">
              <a href="https://maskerprc.github.io/join" data-cta="join">成为会员</a>
            </div>
          </li>
          <li>
           <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="github-icon">
             </a>
           </div>
          </li>
          <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>



   

    

    <div class="table-of-contents-link-wrapper">
      <span>目录</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            
    <div class="version">
      <a href="https://maskerprc.github.io/docs/versions.html">主页 (2.7.0+cpu ) ▼</a>
    </div>
    <div id="searchBox">
    <div class="searchbox" id="googleSearchBox">
      <script async="" src="https://cse.google.com/cse.js?cx=e65585f8c3ea1440e"></script>
      <div class="gcse-search"></div>
    </div>
    <div id="sphinxSearchBox" style="display: none;">
      <div role="search">
        <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
          <input type="text" name="q" placeholder="Search Docs">
          <input type="hidden" name="check_keywords" value="yes">
          <input type="hidden" name="area" value="default">
        </form>
      </div>
    </div>
  </div>
  <form id="searchForm">
    <label style="margin-bottom: 1rem">
      <input type="radio" name="searchType" value="google" checked="">Google 搜索</label>
    <label style="margin-bottom: 1rem">
      <input type="radio" name="searchType" value="sphinx">经典搜索</label>
  </form>

  <script>
     document.addEventListener('DOMContentLoaded', function() {
      const searchForm = document.getElementById('searchForm');
      const googleSearchBox = document.getElementById('googleSearchBox');
      const sphinxSearchBox = document.getElementById('sphinxSearchBox');
      // Function to toggle search box visibility
      function toggleSearchBox(searchType) {
        googleSearchBox.style.display = searchType === 'google' ? 'block' : 'none';
        sphinxSearchBox.style.display = searchType === 'sphinx' ? 'block' : 'none';
      }
      // Determine the default search type
      let defaultSearchType;
      const currentUrl = window.location.href;
      if (currentUrl.startsWith('https://maskerprc.github.io/docs/stable')) {
        // For the stable documentation, default to Google
        defaultSearchType = localStorage.getItem('searchType') || 'google';
      } else {
        // For any other version, including docs-preview, default to Sphinx
        defaultSearchType = 'sphinx';
      }
      // Set the default search type
      document.querySelector(`input[name="searchType"][value="${defaultSearchType}"]`).checked = true;
      toggleSearchBox(defaultSearchType);
      // Event listener for changes in search type
      searchForm.addEventListener('change', function(event) {
        const selectedSearchType = event.target.value;
        localStorage.setItem('searchType', selectedSearchType);
        toggleSearchBox(selectedSearchType);
      });
      // Set placeholder text for Google search box
      window.onload = function() {
        var placeholderText = "Search Docs";
        var googleSearchboxText = document.querySelector("#gsc-i-id1");
        if (googleSearchboxText) {
          googleSearchboxText.placeholder = placeholderText;
          googleSearchboxText.style.fontFamily = 'FreightSans';
          googleSearchboxText.style.fontSize = "1.2rem";
          googleSearchboxText.style.color = '#262626';
        }
      };
    });
  </script>

          </div>

          

<div>
  <a style="color:#F05732" href="https://maskerprc.github.io/docs/stable/_modules/torch/utils/data/dataloader.html">您正在查看不稳定开发者预览文档。请点击此处查看最新稳定版本的文档。</a>
</div>


            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">社区</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../community/build_ci_governance.html">PyTorch 治理 | 构建 + CI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../community/contribution_guide.html">PyTorch 贡献指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../community/design.html">PyTorch 设计哲学</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../community/governance.html">PyTorch 治理 | 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../community/persons_of_interest.html">PyTorch 治理 | 维护者</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发者笔记</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/amp_examples.html">自动混合精度示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/autograd.html">Autograd 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/broadcasting.html">广播语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/cpu_threading_torchscript_inference.html">CPU 多线程和 TorchScript 推理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/cuda.html">CUDA 语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/custom_operators.html">PyTorch 自定义算子页面</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/ddp.html">分布式数据并行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/extending.html">扩展 PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/extending.func.html">使用 autograd.Function 扩展 torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/faq.html">常见问题解答</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/fsdp.html">FSDP 笔记</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/get_start_xpu.html">在 Intel GPU 上入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/gradcheck.html">Gradcheck 机制</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/hip.html">HIP (ROCm)语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/large_scale_deployments.html">大规模部署功能</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/libtorch_stable_abi.html">LibTorch 稳定 ABI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/modules.html">模块</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/mps.html">MPS 后端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/multiprocessing.html">多进程最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/numerical_accuracy.html">数值精度</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/randomness.html">可重复性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/serialization.html">序列化语义</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notes/windows.html">Windows 常见问题解答</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">语言绑定</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../cpp_index.html">C++</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/javadoc/">Javadoc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deploy.html">torch::deploy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch.html">torch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nn.html">torch.nn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nn.functional.html">torch.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tensors.html">torch.Tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tensor_attributes.html">索引属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tensor_view.html">张量视图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../amp.html">torch.amp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../autograd.html">torch.autograd</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../library.html">torch.library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../accelerator.html">torch.accelerator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cpu.html">torch.cpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cuda.html">torch.cuda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch_cuda_memory.html">理解 CUDA 内存使用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch_cuda_memory.html#generating-a-snapshot">生成快照</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch_cuda_memory.html#using-the-visualizer">使用可视化工具</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch_cuda_memory.html#snapshot-api-reference">摄像头 API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mps.html">torch.mps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../xpu.html">torch.xpu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mtia.html">torch.mtia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mtia.memory.html">torch.mtia.memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../meta.html">元设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../backends.html">torch.backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../export.html">torch.export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.html">torch.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.tensor.html">torch.distributed.tensor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.algorithms.join.html">torch.distributed.algorithms.join</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.elastic.html">torch.distributed.elastic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fsdp.html">torch.distributed.fsdp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.fsdp.fully_shard.html">torch.distributed.fsdp.fully_shard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.tensor.parallel.html">torch.distributed.tensor.parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.optim.html">torch.distributed.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.pipelining.html">torch.distributed.pipelining</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.checkpoint.html">torch.distributed.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributions.html">torch.distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch.compiler.html">torch.compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fft.html">torch.fft</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../func.html">torch.func</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../futures.html">torch.futures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fx.html">torch.fx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fx.experimental.html">torch.fx.experimental</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../hub.html">torch.hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../jit.html">torch.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../linalg.html">torch.linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitor.html">torch.monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../signal.html">torch.signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../special.html">torch.special</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch.overrides.html">torch.overrides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../package.html">torch.package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../profiler.html">torch.profiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nn.init.html">torch.nn.init</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nn.attention.html">torch.nn.attention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../onnx.html">torch.onnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../optim.html">torch.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../complex_numbers.html">复数</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ddp_comm_hooks.html">DDP 通信钩子</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quantization.html">量化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rpc.html">分布式 RPC 框架</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../random.html">torch.random</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../masked.html">torch.masked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nested.html">torch.nested</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../size.html">torch.Size</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sparse.html">torch.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../storage.html">torch.Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../testing.html">torch.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../utils.html">torch.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../benchmark_utils.html">torch.utils.benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bottleneck.html">torch.utils.bottleneck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../checkpoint.html">torch.utils.checkpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cpp_extension.html">torch.utils.cpp_extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data.html">torch.utils.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../deterministic.html">torch.utils.deterministic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../jit_utils.html">torch.utils.jit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dlpack.html">torch.utils.dlpack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mobile_optimizer.html">torch.utils.mobile_optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../model_zoo.html">torch.utils.model_zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tensorboard.html">torch.utils.tensorboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../module_tracker.html">torch.utils.module_tracker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../type_info.html">类型信息</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../named_tensor.html">命名张量</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../name_inference.html">命名张量操作覆盖率</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../config_mod.html">torch.__config__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../future_mod.html">torch.__future__</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../logging.html">torch._logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../torch_environment_variables.html">Torch 环境变量</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">库</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/audio/stable">torchaudio</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/data">TorchData</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/torchrec">火炬推荐</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/serve">TorchServe</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/text/stable">torchtext</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/vision/stable">torchvision</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/xla/">PyTorch on XLA Devices</a></li>
<li class="toctree-l1"><a class="reference external" href="https://maskerprc.github.io/ao">torchao</a></li>
</ul>

            
          

        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        文档 &gt;</li>

        
          <li>模块代码 &gt;</li>
        
          <li><a href="../../../torch.html">torch</a> &gt;</li>
        
          <li><a href="../../utils.html">torch.utils</a> &gt;</li>
        
      <li>torch.utils.data.dataloader</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">快捷键</div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        

          <!-- Google Tag Manager (noscript) -->
          <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
          <!-- End Google Tag Manager (noscript) -->
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>torch.utils.data.dataloader 的源代码</font></font></font></h1><div class="highlight"><pre><span></span><span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># mypy: 允许未类型化定义</span>
<span class="sa">r</span><span class="sd">DataLoader 和相关派生自 _BaseDataLoaderIter 的迭代器的定义。</span>

<span class="sd">为了支持这两个类，在 `./_utils` 中我们定义了许多实用方法。</span>
<span class="sd">多进程中的运行函数。例如，数据加载工作循环是</span>
<span class="sd">在 `./_utils/worker.py` 文件中。</span>
<span class="sd">""</span>

<span class="kn">导入</span> <span class="nn">functools</span>
<span class="kn">导入</span> <span class="nn">itertools</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">记录日志</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为</span> <span class="nn">python_multiprocessing</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作系统</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">队列</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">线程</span>
<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告</span>
<span class="kn">来自</font></font></font></span> <span class="nn">collections.abc</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span>
<span class="kn">来自</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打字</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任意</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可调用</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">通用</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型变量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联合</span>

<span class="kn">导入</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span>
<span class="kn">导入</font></font></font></span> <span class="nn">torch.distributed</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为</span> <span class="nn">dist</span>
<span class="kn">导入</span> <span class="nn">torch.utils.data.graph_settings</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch._utils</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常包装器</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch.utils.data</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="n">_utils</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch.utils.data.datapipes.datapipe</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="p">(</span>
    <span class="n">_IterDataPipe 序列化包装器</span><span class="p">,</span>
    <span class="n">_MapDataPipe 序列化包装器</span><span class="p">,</span>
    <span class="n">IterDataPipe</span><span class="p">,</span>
    <span class="n">MapDataPipe</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch.utils.data.dataset</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可迭代数据集</span>
<span class="kn">来自</font></font></font></span> <span class="nn">torch.utils.data.sampler</span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</span> <span class="p">(</span>
    <span class="n">批量采样器</span><span class="p">,</span>
    <span class="n">随机采样器</span><span class="p">,</span>
    <span class="n">采样器</span><span class="p">,</span>
    <span class="n">顺序采样器</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"数据加载器"</span><span class="p">,</span>
    <span class="s2">获取工作信息</span><span class="p">,</span>
    <span class="s2">默认合并</span><span class="p">,</span>
    <span class="s2">默认转换</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">_T</span> <span class="o">=</span> <span class="n">类型变量</span><span class="p">(</span><span class="s2">"_T"</span><span class="p">)</span>
<span class="n">_T_co</span> <span class="o">=</span> <span class="n">类型变量</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_T_co</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">协变</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_worker_init_fn_t</span> <span class="o">=</span> <span class="n">可调用</font></font></font></span><span class="p">[[</span><span class="nb">int</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">]</span>

<span class="c1">理想情况下，我们应该通过 `collate_fn` 的返回类型来参数化 `DataLoader`，但目前还没有办法设置一个默认值，如果用户没有传入自定义的 'collate_fn'。</span>
<span class="c1">如果用户没有传入自定义的 'collate_fn'，则可以将类型参数设置为默认值。</span>
<span class="c1">请参阅 https://github.com/python/mypy/issues/3737。</span>
<span class="n">_collate_fn_t</span> <span class="o">=</span> <span class="n">可调用</font></font></font></span><span class="p">[[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任意</span><span class="p">]</span>


<span class="c1">这些函数曾经定义在这个文件中。但是，它已经被移动到了</span>
<span class="c1"># _utils/collate.py。尽管从用户层面访问它相当困难</span>
<span class="c1"># （必须显式地直接导入 `import torch.utils.data.dataloader`），因此</span>
<span class="c1"># 可能是用户代码在使用它。这种别名保持向后兼容性。</span>
<span class="c1"># 方面。</span>
<span class="n">默认的 collate</font></font></font></span><span class="p">:</span> <span class="n">_collate_fn_t</span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">汇总</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认汇总</span>
<span class="n">默认转换</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">汇总</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认转换</span>

<span class="n">获取工作者信息</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取工作者信息</span>

<span class="n">日志记录器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">记录日志</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取日志记录器</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集类型</span><span class="p">:</span>
    <span class="n">地图</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">迭代器</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">创建获取器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动对齐</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">,</span> <span class="n">drop_last</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">仁慈</span> <span class="o">==</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n">Map</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</span><span class="o">.</span><span class="n">_MapDatasetFetcher</span><span class="p">(</span>
                <span class="n">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动归一化</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">归一化函数</span><span class="p">,</span> <span class="n">drop_last</span>
            <span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</span><span class="o">.</span><span class="n">_IterableDatasetFetcher</span><span class="p">(</span>
                <span class="n">dataset</span><span class="p">,</span> <span class="n">auto_collation</span><span class="p">,</span> <span class="n">collate_fn</span><span class="p">,</span> <span class="n">drop_last</span>
            <span class="p">)</span>


<span class="k">类</span> <span class="nc">_InfiniteConstantSampler</span><span class="p">(</span><span class="n">Sampler</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">类似于 `itertools.repeat(None, None)`。</span>

<span class="sd">用作 `torch.utils.data.IterableDataset` 的采样器。</span>
<span class="sd">"源代码"</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">产生</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_distributed_settings</span><span class="p">():</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已初始化</span><span class="p">():</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取世界大小</font></font></font></span><span class="p">(),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取排名</span><span class="p">()</span>
    <span class="k">否则</span><span class="p">:</span>
        <span class="k">返回</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">_sharding_worker_init_fn</span><span class="p">(</span><span class="n">工作器初始化函数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名 ID</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作器 ID</span><span class="p">):</span>
    <span class="n">全局工作器 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作 ID</span>
    <span class="n">信息</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取工人信息</span><span class="p">()</span>
    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">总工人数</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="o">.</span><span class="n">num_workers</span>
    <span class="n">数据管道</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span>
    <span class="k">断言</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据管道</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据管道</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">映射数据管道</span><span class="p">))</span>
    <span class="c1">为了使元素在分布式进程间均匀分布，我们应该在分布式上分片数据</span>
    <span class="c1">首先处理然后在工作进程中分片</span>
    <span class="n">总工作进程数</font></font></font></span> <span class="o">*=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</span>
    <span class="n">全局工作进程 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局工作进程 ID</font></font></font></span> <span class="o">*</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</span> <span class="o">+</span> <span class="n">rank_id</span>
    <span class="c1"># 对于 BC，使用默认的 SHARDING_PRIORITIES</span>
    <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">图设置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">应用分片</span><span class="p">(</span>
        <span class="n">数据管道</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">总工作进程数</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">全局工作进程 ID</span>
    <span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作进程初始化函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="n">worker_init_fn</span><span class="p">(</span><span class="n">worker_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_share_dist_seed</span><span class="p">(</span><span class="n">生成器</span><span class="p">,</span> <span class="n">pg</span><span class="p">):</span>
    <span class="n">_shared_seed</span> <span class="o">=</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</font></font></font></span><span class="p">((),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">随机</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span><span class="p">)</span>
    <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程组</span><span class="p">):</span>
        <span class="n">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">广播</font></font></font></span><span class="p">(</span><span class="n">_shared_seed</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">源</font></font></font></span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">群组</span><span class="o">=</span><span class="n">pg</span><span class="p">)</span>
    <span class="k">返回</font></font></font></span> <span class="n">_shared_seed</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">项目</span><span class="p">()</span>


<div class="viewcode-block" id="DataLoader"><a class="viewcode-back" href="../../../../data.html#torch.utils.data.DataLoader">[文档]</font></font></font></a><span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据加载器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">通用</font></font></font></span><span class="p">[</span><span class="n">_T_co</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)]</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">""</span>
<span class="sd">数据加载器将数据集和采样器结合，并为给定数据集提供可迭代的对象。</span>

<span class="sd">`torch.utils.data.DataLoader` 支持映射样式和可迭代样式的数据集，具有单进程或多进程加载，可自定义加载顺序以及可选的自动批处理（收集）和内存固定。</span>
<span class="sd">加载，自定义加载顺序以及可选的自动批处理（收集）和内存固定。</span>
<span class="sd">加载顺序以及可选的自动批处理（收集）和内存固定。</span>

<span class="sd">请参阅：py:mod:`torch.utils.data` 文档页面以获取更多详细信息。</span>

<span class="sd">参数：</span>
<span class="sd">dataset (Dataset)：从其中加载数据的数据集。</span>
<span class="sd">batch_size (int, 可选)：每次加载的批次样本数量</span>
<span class="sd">（默认：`1`）。</span>
<span class="sd">shuffle（布尔值，可选）：设置为 ``True`` 以在每次 epoch（默认：``False``）时重新排列数据</span>
<span class="sd">在每个 epoch（默认：``False``）时进行采样。</span>
<span class="sd">sampler（采样器或可迭代对象，可选）：定义从数据集中抽取样本的策略。可以是任何具有 ``__len__`` 的 ``Iterable`` 对象</span>
<span class="sd">可以是任何具有 ``__len__`` 的 ``Iterable`` 对象，用于从数据集中抽取样本。</span>
<span class="sd">实现。如果指定了，则不能指定：attr:`shuffle`。</span>
<span class="sd">批量采样器（采样器或可迭代对象，可选）：类似于 :attr:`sampler`，但</span>
<span class="sd">每次返回一批索引。与...互斥。</span>
<span class="sd">:attr:`batch_size`, :attr:`shuffle`, :attr:`sampler`</span>
<span class="sd">和：attr:`drop_last`。</span>
<span class="sd">num_workers（int，可选）：使用多少个子进程来加载数据。</span>
<span class="sd">``0`` 表示数据将在主进程中加载。</span>
<span class="sd">（默认：``0``）</span>
<span class="sd">collate_fn (Callable, 可选): 合并一系列样本</span>
<span class="sd">小批量张量。在从批量加载时使用。</span>
<span class="sd">地图样式数据集。</span>
<span class="sd">pin_memory（布尔值，可选）：如果为 ``True``，数据加载器将复制张量</span>
<span class="sd">在返回之前将数据元素放入设备/CUDA 固定内存中。如果您的数据元素是自定义类型，或者您的:attr:`collate_fn`返回的批次是自定义类型，请参阅下面的示例。</span>
<span class="sd">如果您的数据元素是自定义类型，或者您的:attr:`collate_fn`返回的批次是自定义类型，请参阅下面的示例。</span>
<span class="sd">请参阅下面的示例。</span>
<span class="sd">drop_last (布尔值，可选): 将其设置为 ``True`` 以丢弃最后一个不完整的批次，</span>
<span class="sd">如果数据集大小不能被批处理大小整除。如果 ``False``，</span>
<span class="sd">那么数据集的大小不能被批处理大小整除，则最后一个批次</span>
<span class="sd">的大小将更小。（默认：``False``）</span>
<span class="sd">超时时间（数值，可选）：如果为正数，则为收集一个批次的超时时间</span>
<span class="sd">来自工人。始终应为非负数。（默认：``0``）</span>
<span class="sd">worker_init_fn（Callable，可选）：如果不为 ``None``，则将在每个</span>
<span class="sd">工人子进程上调用，使用工人 ID（一个在 ``[0, num_workers - 1]`` 范围内的 int）作为</span>
<span class="sd">输入，在播种和加载数据之前。（默认：``None``）</span>
<span class="sd">multiprocessing_context (str 或 multiprocessing.context.BaseContext, 可选): 如果</span>
<span class="sd">``None`，您的操作系统的默认 `multiprocessing context`_ 将</span>
<span class="sd">被使用。（默认：`None`）</span>
<span class="sd">生成器（torch.Generator，可选）：如果不为 ``None``，则使用此随机数生成器</span>
<span class="sd">通过 RandomSampler 生成随机索引和通过多进程生成</span>
<span class="sd">`base_seed` 用于工作者。（默认：`None`）</span>
<span class="sd">prefetch_factor（int，可选，关键字参数）：预取批次数</span>
<span class="sd">提前由每个工人完成。``2``表示总共</span>
<span class="sd">2 * num_workers 个批次的预取数据跨所有工作者。默认值取决于 num_workers 的设置值。如果 num_workers=0，则默认为 ``None``。</span>
<span class="sd">如果 num_workers 的值为 0，则默认为 ``None``。</span>
<span class="sd">否则，如果 num_workers 的值大于 0，则默认为 ``2``）。</span>
<span class="sd">persistent_workers（布尔值，可选）：如果设置为 ``True``，数据加载器将不会关闭</span>
<span class="sd">数据集被消耗一次后的工作进程。这允许</span>
<span class="sd">维护工作进程的 `Dataset` 实例存活。（默认：``False``）</span>
<span class="sd">pin_memory_device（str，可选）：如果 ``pin_memory`` 为 ``True``，则将其固定在的设备上</span>
<span class="sd">。如果没有提供，则当前 :ref:`加速器` 将是</span>
<span class="sd">默认。此参数不建议使用，并可能被弃用。</span>
<span class="sd">in_order (bool, optional): 如果 ``False``，数据加载器将不会强制执行批次以先进先出顺序返回。仅在 ``num_workers &gt; 0`` 时适用。（默认：``True``）</span>
<span class="sd">..警告:: 如果使用 ``spawn`` 启动方法，:attr:`worker_init_fn`</span>


<span class="sd">..警告:: 如果使用 ``spawn`` 启动方法，:attr:`worker_init_fn`</span>
<span class="sd">无法是一个不可序列化的对象，例如 lambda 函数。详见</span>
<span class="sd">ref:`multiprocessing-best-practices` 了解更多与 PyTorch 中多进程相关的细节。</span>
<span class="sd">有关。</span>

<span class="sd">..警告:: ``len(dataloader)`` 指数基于所使用的采样器的长度。</span>
<span class="sd">当 :attr:`dataset` 是一个 :class:`~torch.utils.data.IterableDataset` 时，</span>
<span class="sd">它将返回一个基于 ``len(dataset) / batch_size`` 的估计值，根据 :attr:`drop_last` 进行适当的舍入，</span>
<span class="sd">无论多进程加载配置如何，这代表了 PyTorch 能做出的最佳猜测。</span>
<span class="sd">这代表了 PyTorch 能做出的最佳猜测，因为 PyTorch</span>
<span class="sd">信任用户正确处理多进程：attr:`数据集`代码，以避免重复数据。</span>
<span class="sd">加载以避免重复数据。</span>

<span class="sd">然而，如果分片导致多个工作进程拥有不完整的最后批次，</span>
<span class="sd">这个估计仍然可能不准确，因为（1）一个本应完整的批次可以</span>
<span class="sd">可以拆分成多个，并且（2）多个批次值的样本也可以被</span>
<span class="sd">当设置 :attr:`drop_last` 时会被丢弃。不幸的是，PyTorch 通常无法检测到这种情况。</span>
<span class="sd">的情况。</span>

<span class="sd">请参阅 `数据集类型`_ 了解这两种类型的数据集的更多详细信息以及如何</span>
<span class="sd">`torch.utils.data.IterableDataset` 类的交互</span>
<span class="sd">多进程数据加载_</span>

<span class="sd">请参阅 :ref:`可重现性`, 以及 :ref:`dataloader-workers-random-seed`, 和 :ref:`数据加载随机性` 相关的注意事项。</span>
<span class="sd">关于随机种子相关问题的说明，请参阅 :ref:`data-loading-randomness`。</span>

<span class="sd">..警告：将`in_order`设置为`False`可能会损害可重复性，并可能导致数据偏差</span>
<span class="sd">输入数据分布到训练器中的不平衡数据情况。</span>

<span class="sd">.. _多进程上下文:</span>
<span class="sd">        https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods</span>
<span class="sd">"源代码"</span>

    <span class="n">数据集</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span><span class="p">[</span><span class="n">_T_co</span><span class="p">]</span>
    <span class="n">批处理大小</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">整型</span>
    <span class="n">持久化内存</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔类型</span>
    <span class="n">drop_last</span><span class="p">:</span> <span class="nb">布尔类型</span>
    <span class="n">超时</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">浮点数</span>
    <span class="n">sampler</span><span class="p">:</span> <span class="n">联盟</font></font></font></span><span class="p">[</span><span class="n">Sampler</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span><span class="p">]</span>
    <span class="n">pin_memory_device</span><span class="p">:</span> <span class="nb">字符串</span>
    <span class="n">预取因子</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">_迭代器</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"_基础数据加载迭代器"</span><span class="p">]</span>
    <span class="n">__已初始化</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>

    <span class="k">def</span> <span class="fm">初始化</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">数据集</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">[</span><span class="n">_T_co</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="n">批大小</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">打乱顺序</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">样本器</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联盟</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">批量样本器</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">联盟</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本器</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</font></font></font></span><span class="p">[</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列表</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">整型</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="p">:</span> <span class="n">可选</font></font></font></span><span class="p">[</span><span class="n">_collate_fn_t</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">持久化内存</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔类型</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="p">:</span> <span class="nb">布尔类型</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
        <span class="n">超时</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">浮点数</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">worker_init_fn</span><span class="p">:</span> <span class="n">可选</font></font></font></span><span class="p">[</span><span class="n">_worker_init_fn_t</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">多进程上下文</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">生成器</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">预取因子</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可选</font></font></font></span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">,</span>
        <span class="n">持久化工作者</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔类型</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">,</span>
        <span class="n">内存设备</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
        <span class="n">按顺序</font></font></font></span><span class="p">:</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔类型</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">火炬</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_log_api_usage_once</span><span class="p">(</span><span class="s2">"python.data_loader"</span><span class="p">)</span>

        <span class="k">如果</span> <span class="n">num_workers</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">num_workers 选项应为非负数；</span>
                <span class="s2">"使用 num_workers=0 来禁用多进程。"</span>
            <span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"超时选项应该是非负数。"</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">预取因子</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">"prefetch_factor 选项只能在多进程模式下指定。"</span>
                <span class="s2">"请设置 num_workers &gt; 0 以启用多进程，否则将 prefetch_factor 设置为 None。"</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">和</font></font></font></span> <span class="n">prefetch_factor</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">prefetch_factor</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">预取因子</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">预取因子</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"预取因子选项应为非负"</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久工作进程</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"持久工作进程选项需要 num_workers &gt; 0"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">预取因子</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">预取因子</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">内存映射</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内存映射</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">内存映射设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内存映射设备</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker 初始化函数</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">worker 初始化函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">多进程上下文</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">按顺序</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">按顺序</span>

        <span class="c1"># 添加向前兼容性，以便经典 DataLoader 可以与 DataPipes 一起工作：</span>
        <span class="c1">#   _DataPipeSerializationWrapper 容器使得在不重新定义 pickler 的情况下进行序列化变得更加容易</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据处理管道</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_迭代数据管道序列化包装器</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">地图数据管道</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_地图数据管道序列化包装器</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span><span class="p">)</span>

        <span class="c1">在检查采样器之前先检查相关数据集，因为我们希望</span>
        <span class="c1">告诉用户可迭代式数据集与自定义采样器不兼容，</span>
        <span class="c1">因此，他们不会在修复自定义采样器错误后才发现这种组合不起作用。</span>
        <span class="c1">这会浪费他们修复自定义采样器错误的时间。</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可迭代数据集</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_数据集类型</font></font></font></span> <span class="o">=</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span>
            <span class="c1"># [自定义采样器和 IterableDataset]</span>
            <span class="c1">#</span>
            <span class="c1"># `IterableDataset` 不支持自定义 `batch_sampler` 或</span>
            <span class="c1"># `sampler` 因为键无关紧要（除非我们有一天支持</span>
            <span class="c1"># 生成器风格的 dataset...）。</span>
            <span class="c1">#</span>
            <span class="c1">对于`sampler`，我们始终创建一个虚拟采样器。这是一个</span>
            <span class="c1"># 无限采样器，即使数据集可能已实现</span>
            <span class="c1"># finite `__len__` 因为在多进程数据加载中，原始</span>
            <span class="c1">设置将返回重复数据（可能是有意的）</span>
            <span class="c1">因此使用与数据集长度匹配的采样器会导致数据丢失（你可能会看到前几批次的重复，但之后永远不会看到任何东西）。因此，`Iterabledataset` 总是使用无限采样器，即无限采样器的一个实例。</span>
            <span class="c1"># cause data lost (you may have duplicates of the first couple</span>
            <span class="c1"># batches, but never see anything afterwards). Therefore,</span>
            <span class="c1"># `Iterabledataset` always uses an infinite sampler, an instance of</span>
            <span class="c1"># 上文定义了 `_InfiniteConstantSampler`。</span>
            <span class="c1">#</span>
            <span class="c1"># 自定义 `batch_sampler` 实质上仅控制批大小。</span>
            <span class="c1">然而，由于不清楚它会有多有用，因此以可迭代方式</span>
            <span class="c1">数据集本身可以处理。此外，这样做毫无意义。</span>
            <span class="c1">在多进程数据加载中，批次的分配顺序是一个实现细节，因此用户无法控制</span>
            <span class="c1">因此我们禁用此选项。如果将来证明这个选项很有用，我们可以重新启用</span>
            <span class="c1">因此我们禁用此选项。如果将来证明这个选项很有用，我们可以重新启用</span>
            <span class="c1">因此我们禁用此选项。如果将来证明这个选项很有用，我们可以重新启用</span>
            <span class="c1"># 这，并支持指定分配的自定义采样器。</span>
            <span class="c1"># 指定特定工作者。</span>
            <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据管道</span><span class="p">):</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                    <span class="n">数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">图形设置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">应用打乱设置</span><span class="p">(</span>
                        <span class="n">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱</span>
                    <span class="p">)</span>
            <span class="c1"># 我们不能在这里检查 `shuffle is not None`，因为之前 `shuffle=False` 是默认值。</span>
            <span class="k">elif</span> <span class="n">打乱</font></font></font></span> <span class="ow">not</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="p">{</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">}:</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">DataLoader 与 IterableDataset：期望未指定打乱选项，但得到 shuffle=</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="c1">#参见 NOTE [自定义样本器和 IterableDataset]</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">DataLoader 与 IterableDataset：期望未指定采样器选项，但获取到 sampler=</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">采样器</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">批量采样器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="c1">#参见笔记[自定义采样器和 IterableDataset]</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">DataLoader 与 IterableDataset：期望未指定</span>
                    <span class="sa">f</span><span class="s2">batch_sampler 选项，但得到 batch_sampler=</span><span class="si">{</span><span class="n">batch_sampler</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">打乱顺序</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">布尔</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">数据集类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集类型</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">地图</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">随机播放</span><span class="p">:</span>
            <span class="k">提升</font></font></font></span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"样本选项与随机播放互斥"</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批量样本器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="c1">使用自定义批采样器进行自动对齐</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理大小</font></font></font></span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱顺序</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">丢弃最后</span><span class="p">:</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"batch_sampler 选项与 batch_size、shuffle、sampler 和 drop_last 互斥"</span>
                    <span class="s2">"以及 batch_size、shuffle、sampler 和 "</span>
                    <span class="s2">"drop_last"</span>
                <span class="p">)</span>
            <span class="n">批处理大小</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">drop_last</span> <span class="o">=</span> <span class="kc">假</span>
        <span class="k">elif</span> <span class="n">批处理大小</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="c1">无自动对齐</span>
            <span class="k">如果</span> <span class="n">drop_last</span><span class="p">:</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"batch_size=None 选项禁用自动批处理"</span>
                    <span class="s2">"且与 drop_last 互斥"</span>
                <span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">:</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 提供默认样本器</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集类型</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集类型</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span><span class="p">:</span>
                <span class="c1"># 注意 [自定义采样器和 IterableDataset]</span>
                <span class="n">采样器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_无限常量采样器</span><span class="p">()</span>
            <span class="k">否则</font></font></font></span><span class="p">:</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 地图样式</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">打乱</span><span class="p">:</span>
                    <span class="n">样本器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">随机样本器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
                <span class="k">否则</span><span class="p">:</span>
                    <span class="n">样本器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">顺序样本器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理大小</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理样本器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="c1">自动归一化无需自定义批量采样器</span>
            <span class="n">批量采样器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批量采样器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">采样器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理大小</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">丢弃最后</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">批处理大小</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理大小</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">删除最后</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除最后</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">样本器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本器</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">批量样本器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批量样本器</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">生成器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">合并函数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_自动合并</span><span class="p">:</span>
                <span class="n">collate_fn</span> <span class="o">=</span> <span class="n">_工具</span><span class="o">.</span><span class="n">collate</span><span class="o">.</span><span class="n">default_collate</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="n">collate_fn</span> <span class="o">=</span> <span class="n">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">汇总</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">默认转换</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">汇总函数</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">汇总函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">持久化工作者</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久化工作者</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__已初始化</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="o">=</span> <span class="p">(</span>
            <span class="kc">None</span>  <span class="c1"># 查看 NOTE [ IterableDataset 和 __len__ ]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">迭代器</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">检查工作数量合理性</span><span class="p">()</span>

        <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置生命体征</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据加载器</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">启用</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"真"</font></font></font></span><span class="p">)</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 类型: 忽略[attr-defined]</span>

    <span class="k">def</span> <span class="nf">_获取迭代器</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"_基础数据加载迭代器"</span><span class="p">:</span>
        <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_单进程数据加载迭代器</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">检查工作数量合理性</span><span class="p">()</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_多进程数据加载迭代器</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">多进程上下文</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">__多进程上下文</span>

    <span class="nd">@multiprocessing_context</span><span class="o">.</span><span class="n">设置器</span>
    <span class="k">def</span> <span class="nf">多进程上下文</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span><span class="p">,</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</span><span class="p">):</span>
                    <span class="n">有效的启动方法</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取所有启动方法</span><span class="p">()</span>
                    <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span> <span class="ow">not</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有效的启动方法</span><span class="p">:</span>
                        <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">"multiprocessing_context 选项 "</span>
                            <span class="sa">f</span><span class="s2">应指定一个有效的启动方法</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有效的启动方法</font></font></font></span><span class="si">!r}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">，但实际上得到了"</span>
                            <span class="sa">f</span><span class="s2">multiprocessing_context=</span><span class="si">{</span><span class="n">multiprocessing_context</span><span class="si">!r}</span><span class="s2">"</span>
                        <span class="p">)</span>
                    <span class="n">multiprocessing_context</span> <span class="o">=</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取上下文</span><span class="p">(</span>
                        <span class="n">multiprocessing_context</span>
                    <span class="p">)</span>

                <span class="k">如果</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                    <span class="n">多进程上下文</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">Python 多进程</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">上下文</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">基础上下文</span>
                <span class="p">):</span>
                    <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型错误</span><span class="p">(</span>
                        <span class="s2">"多进程上下文选项应是一个有效的上下文"</span>
                        <span class="s2">"对象或指定启动方法的字符串，但得到了"</span>
                        <span class="sa">f</span><span class="s2">"multiprocessing_context="</span><span class="si">{</span><span class="n">multiprocessing_context</span><span class="si">}</span><span class="s2">"</span>
                    <span class="p">)</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"multiprocessing_context 只能与"</span>
                    <span class="s2">"多进程加载（num_workers &gt; 0），但得到"</span>
                    <span class="sa">f</span><span class="s2">"num_workers="</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__多进程上下文</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">属性</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">__已初始化</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">属性</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="p">(</span>
            <span class="s2">批处理大小</span><span class="p">,</span>
            <span class="s2">批采样器</span><span class="p">,</span>
            <span class="s2">采样器</span><span class="p">,</span>
            <span class="s2">最后一个丢弃</span><span class="p">,</span>
            <span class="s2">"数据集"</span><span class="p">,</span>
            <span class="s2">"持久化工作者"</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">提升</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">属性</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">属性设置后不应更改</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</font></font></font></span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已初始化</span>
            <span class="p">)</span>

        <span class="nb">超级</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">属性</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># 我们引用 '_BaseDataLoaderIter'，因为它尚未定义，且定义不能上移</span>
    <span class="c1"># 因为 '_BaseDataLoaderIter' 引用了 'DataLoader'</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"_BaseDataLoaderIter"</span><span class="p">:</span>
        <span class="c1">当使用单个工作线程时，返回的迭代器应该是</span>
        <span class="c1">每次创建以避免重置其状态</span>
        <span class="c1">然而，在多个工作者迭代器的情况下</span>
        <span class="c1">迭代器在其生命周期中只创建一次</span>
        <span class="c1">DataLoader 对象，以便工作者可以被重用</span>
        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久工作者</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">迭代器</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取迭代器</span><span class="p">()</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">迭代器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重置</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取迭代器</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">自动归一化</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理采样器</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_index_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 实际用于为 `_DatasetFetcher` 生成索引的采样器</span>
        <span class="c1"># (请参阅 _utils/fetch.py) 在每次读取数据时。这将是</span>
        <span class="c1">`.batch_sampler` 如果处于自动合并模式，否则为 `.sampler`。</span>
        <span class="c1">我们不能更改 `.sampler` 和 `.batch_sampler` 属性以保持向后兼容。</span>
        <span class="c1">原因。</span>
        <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_collation</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理采样器</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">采样器</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集类型</font></font></font></span> <span class="o">==</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span><span class="p">:</span>
            <span class="c1"># NOTE [ IterableDataset 和 __len__ ]</span>
            <span class="c1">#</span>
            <span class="c1"># 对于 `IterableDataset`，`__len__` 可能不准确，当直接</span>
            <span class="c1">多进程加载数据，因为样本将被重复。</span>
            <span class="c1">然而，没有任何实际用例应该真正使用这种行为，所以</span>
            <span class="c1">它应该被视为用户错误。我们通常应该信任用户</span>
            <span class="c1">代码做正确的事情（例如，为每个副本配置不同的设置）</span>
            <span class="c1"># in `__iter__`), 并提供正确的 `__len__` 如果他们选择这样做</span>
            <span class="c1"># 实现（如果数据集没有实现，这仍然会抛出异常）</span>
            <span class="c1"># 为了提供进一步的警告，我们跟踪是否调用了 `__len__`</span>
            <span class="c1">#</span>
            <span class="c1"># ，如果 `__len__` 被调用，我们将提供额外的信息</span>
            <span class="c1"># `DataLoader`，将返回值保存到`self._len_called`中，并警告</span>
            <span class="c1"># 如果迭代器最终产生了超过这个数量的样本。</span>

            <span class="c1"># 无法静态验证数据集是否为 Sized</span>
            <span class="n">长度</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span><span class="p">)</span>  <span class="c1"># type: ignore[assignment, arg-type]</span>
            <span class="k">如果</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">批处理大小</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>  <span class="c1"># IterableDataset 不允许自定义采样器或批量采样器</span>
                <span class="kn">来自</font></font></font></span> <span class="nn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数学</font></font></font></span> <span class="kn"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">导入</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">向上取整</span>

                <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_last</span><span class="p">:</span>
                    <span class="n">长度</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批处理大小</span>
                <span class="k">否则</span><span class="p">:</span>
                    <span class="n">长度</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">向上取整</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">批量大小</span><span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_sampler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">检查工作进程数量合理性</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 此函数检查根据当前系统资源，数据加载器的工作进程数量是否合理。当前规则是，如果工作进程的数量为</span>
        <span class="c1"># 当前系统资源的倍数，则认为该数量是合理的。</span>
        <span class="c1"># 加载数据加载器创建的进程数大于允许的逻辑 CPU 数时</span>
        <span class="c1"># 我们将弹出警告提示用户注意。</span>
        <span class="c1">#</span>
        <span class="c1"># 例如，如果当前系统有 2 个物理 CPU，每个 CPU 有 16 个核心。并且每个核心支持 2</span>
        <span class="c1">#     个线程，那么这里的总逻辑 CPU 数就是 2 * 16 * 2 = 64。假设当前</span>
        <span class="c1">DataLoader 进程可以使用其中的一半，即 32 个，然后从该进程启动的 worker 的最大合理数量是 32。</span>
        <span class="c1">现在，假设创建的 DataLoader 具有 num_works = 40，这个数字大于 32。</span>
        <span class="c1">因此，会触发警告信息来通知用户降低 worker 的数量。</span>
        <span class="c1">所以会触发警告信息来通知用户降低 worker 的数量。</span>
        <span class="c1">#     必要的。</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="c1"># [注意] 请注意，此函数仅在 os.sched_getaffinity 可用时才尊重 `cpuset`。</span>
        <span class="c1">#        它在大多数 Linux 系统中可用，但在 OSX 和 Windows 中不可用。</span>
        <span class="c1">#        当 os.sched_getaffinity 不可用时，将调用 os.cpu_count()，但它不尊重 cpuset。</span>
        <span class="c1">#        它不尊重 cpuset。</span>
        <span class="c1">我们不考虑线程，因为每个工作进程是单线程的</span>
        <span class="c1">#        此时。</span>
        <span class="c1">#</span>
        <span class="c1">我们不设置任何线程标志（例如 OMP_NUM_THREADS, MKL_NUM_THREADS 等）</span>
        <span class="c1">除了在工作进程中将`torch.set_num_threads`设置为 1 之外，如果传递</span>
        <span class="c1">在函数中使用依赖于这些线程标志的第三方模块</span>
        <span class="c1">创建多少个线程（例如，numpy 等），然后是调用者的责任</span>
        <span class="c1">正确设置这些标志。</span>
        <span class="k">def</span> <span class="nf">创建警告信息</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">建议的 worker 数量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已创建的 worker 数量</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">检查了 cpuset</span><span class="p">):</span>
            <span class="n">建议的最大 worker 消息量</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">我们建议当前系统中最大工人数为</font></font></font></span><span class="si">{}{}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">, 是更小的 "</span>
                        <span class="s2">比这个 DataLoader 将要创建的内容。</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">格式</span><span class="p">(</span>
                        <span class="n">建议工作进程数</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="s2">请提供需要翻译的文本</span>
                            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpuset 已检查</span>
                            <span class="k">否则</font></font></font></span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"（`cpuset`不被考虑）"</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">建议工作进程数</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">否则</span> <span class="p">(</span>
                    <span class="s2">数据加载器无法计算当前系统建议的最大工作进程数。</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">警告信息</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">"此数据加载器将创建"</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建的进程数</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">总共的 worker 进程。</font></font></font></span><span class="si">{</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">建议的最大 worker 消息数</span><span class="si">}</span><span class="s2"> "</span>
                <span class="s2">"请注意，过度创建工作进程可能会导致 DataLoader 运行缓慢甚至冻结，"</span>
                <span class="s2">"如果需要，请降低工作进程数量以避免潜在的缓慢/冻结。"</span>
            <span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">警告信息</span>

        <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">返回</span>

        <span class="c1">尝试根据系统资源计算建议的最大工作线程数</span>
        <span class="n">最大工作线程数建议</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">检查 CPU 集</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作系统</font></font></font></span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"获取调度亲和性"</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">最大工作线程建议</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">操作系统</span><span class="o">.</span><span class="n">sched_getaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">cpuset_checked</span> <span class="o">=</span> <span class="kc">真实</span>
            <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常</span><span class="p">:</span>
                <span class="k">通过</span>
        <span class="k">如果</font></font></font></span> <span class="n">max_num_worker_suggest</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="c1"># os.cpu_count() 可能返回 Optional[int]</span>
            <span class="c1">首先获取 CPU 数量并检查是否为 None 以满足 mypy 检查</span>
            <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">操作系统</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="k">如果</font></font></font></span> <span class="n">cpu_count</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="ow">not</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="n">最大工作线程建议</span> <span class="o">=</span> <span class="n">cpu_count</span>

        <span class="k">如果</font></font></font></span> <span class="n">max_num_worker_suggest</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">警告</span><span class="p">(</span>
                <span class="n">创建警告信息</span><span class="p">(</span>
                    <span class="n">最大工作进程数建议</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">CPU 集检查</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">返回</span>

        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大工作进程数建议</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">警告</span><span class="p">(</span>
                <span class="n">创建警告信息</span><span class="p">(</span>
                    <span class="n">最大工作线程数建议</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cpuset 已检查</span>
                <span class="p">)</span>
            <span class="p">)</span></div>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_基础数据加载迭代器</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">初始化</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="p">:</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据加载器</font></font></font></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">共享种子</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据处理管道</span><span class="p">):</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否可用</font></font></font></span><span class="p">()</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已初始化</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pg</span> <span class="o">=</span> <span class="n">距离</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建新组</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">后端</font></font></font></span><span class="o">=</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">gluu</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">共享种子</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分享分布种子</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pg</span><span class="p">)</span>
            <span class="n">shared_rng</span> <span class="o">=</span> <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span><span class="p">()</span>
            <span class="n">shared_rng</span><span class="o">.</span><span class="n">手动播种</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shared_seed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">图设置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">应用随机种子</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">共享随机数生成器</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">数据集类型</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集类型</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="o">=</span> <span class="n">加载器</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">自动分词</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_自动对齐</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_丢弃最后一项</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">删除最后</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_sampler</span> <span class="o">=</span> <span class="n">加载器</span><span class="o">.</span><span class="n">_index_sampler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">=</span> <span class="n">加载器</span><span class="o">.</span><span class="n">num_workers</span>
        <span class="n">ws</span><span class="p">,</span> <span class="n">排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取分布式设置</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">世界大小</span> <span class="o">=</span> <span class="n">ws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_排名</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">排名</span>
        <span class="c1">如果未设置 pin_memory_device，则默认行为为当前加速器。</span>
        <span class="c1">如果 pin_memory_device 已设置但 pin_memory 未设置，则默认</span>
        <span class="c1"># 行为关闭。</span>
        <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</span><span class="o">.</span><span class="n">pin_memory_device</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内存映射</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="ow">not</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加速器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否可用</span><span class="p">():</span>
                <span class="n">警告信息</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">"将 'pin_memory' 参数设置为 true，但未找到加速器"</span>
                    <span class="s2">然后设备固定内存将不会被使用。</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">警告</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory</span> <span class="o">=</span> <span class="n">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内存映射</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加速器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否可用</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_device</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1">目前，pin_memory 在 MPS 后端会引发错误（参见</span>
            <span class="c1"># https://github.com/pytorch/pytorch/issues/86060），因此强制</span>
            <span class="c1"># 禁用 MPS 上的 pin_memory。一旦固定，请移除此限制</span>
            <span class="c1"># MPS 的内存分配是固定的。</span>
            <span class="k">如果</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_内存映射</span>
                <span class="ow">和</font></font></font></span> <span class="p">(</span><span class="n">acc</span> <span class="o">:=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加速器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前加速器</font></font></font></span><span class="p">())</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">和</font></font></font></span> <span class="n">acc</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类型</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">mps</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory</span> <span class="o">=</span> <span class="kc">假</span>
                <span class="n">警告信息</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">"'pin_memory' 参数设置为 true，但目前 MPS 不支持，"</span>
                    <span class="s2">"则不会使用设备固定内存。"</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">警告</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久化内存</span><span class="p">:</span>
                <span class="n">警告信息</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">"已设置 'pin_memory_device' 但未设置 'pin_memory' 参数，"</span>
                    <span class="s2">"设备固定内存将不会被使用。"</span>
                    <span class="s2">"如果需要使用设备固定内存，请将 'pin_memory' 设置为 true"</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">警告</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">固定内存</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内存映射</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">固定内存设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">内存映射设备</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_超时</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collate_fn</span> <span class="o">=</span> <span class="n">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">整理函数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sampler_iter</span> <span class="o">=</span> <span class="nb">迭代</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_sampler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_seed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</font></font></font></span><span class="p">((),</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据类型</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="o">.</span><span class="n">随机</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span><span class="p">)</span>
            <span class="o">.</span><span class="n">项目</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_persistent_workers</span> <span class="o">=</span> <span class="n">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久化工作者</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"enumerate(DataLoader)#</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">类</font></font></font></span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">.__next__</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"_基础数据加载迭代器"</span><span class="p">:</span>
        <span class="k">返回</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">重置</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">第一次迭代</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_采样迭代</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_索引采样</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_已产出数量</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="o">=</span> <span class="n">加载器</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据处理管道</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">共享种子</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分享分布种子</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_ pg</span><span class="p">)</span>
            <span class="n">共享随机数生成器</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">生成器</span><span class="p">()</span>
            <span class="n">共享随机数生成器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">手动播种</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_共享种子</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_数据集</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">图设置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">应用随机种子</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">数据集</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">共享随机数生成器</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">下一个索引</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">下一</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">样本迭代器</font></font></font></span><span class="p">)</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">可能引发 StopIteration</span>

    <span class="k">def</span> <span class="nf">_下一数据</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">未实现异常</span>

    <span class="k">def</span> <span class="fm">__下一__</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任意</span><span class="p">:</span>
        <span class="k">与</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自动微分</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">分析器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">记录功能</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_用户名</span><span class="p">):</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler_iter</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="c1"># TODO(https://github.com/pytorch/pytorch/issues/76750)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">重置</font></font></font></span><span class="p">()</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">忽略调用参数</span>
            <span class="n">数据</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">如果</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">数据集类型</font></font></font></span> <span class="o">==</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span>
                <span class="ow">和</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">和</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_yielded</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IterableDataset_len_called</span>
            <span class="p">):</span>
                <span class="n">警告信息</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">IterableDataset 的长度</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">被报告为是</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_可迭代数据集_len_被调用</span><span class="si">}</span><span class="s2">"</span>
                    <span class="sa">f</span><span class="s2">"(当访问 len(dataloader))时，但"</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_已获取的样本数"</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已获取样本。</span>
                <span class="p">)</span>
                <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">警告信息</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="s2">对于多进程数据加载，这可能是由于未正确配置“</span>
                        <span class="s2">"每个工作器上的可迭代数据集副本。请参阅"</span>
                        <span class="s2">"https://maskerprc.github.io/docs/stable/data.html#torch.utils.data.IterableDataset 以获取示例。"</span>
                    <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">警告</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">返回</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_sampler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: 为共享迭代器添加有限的序列化支持</span>
        <span class="c1"># 以跨多个线程用于 HOGWILD。</span>
        <span class="c1">可能是这样做最好的方法，就是移动样本推送</span>
        <span class="c1">将数据队列分离到单独的线程，然后仅共享数据队列</span>
        <span class="c1">但是，在没有非阻塞 API 的情况下发出结束信号很棘手</span>
        <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">不支持的操作异常</font></font></font></span><span class="p">(</span><span class="s2">"</span><span class="si">{}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无法序列化</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">类</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_单进程数据加载迭代器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_基础数据加载迭代器</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">初始化</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</span><span class="p">):</span>
        <span class="nb">超级</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="fm"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</span><span class="p">)</span>
        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_超时</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">断言</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># 添加向前兼容性，以便经典 DataLoader 可以与 DataPipes 一起工作：</span>
        <span class="c1">#   分布式分片处理</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据处理管道</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">地图数据管道</span><span class="p">)):</span>
            <span class="c1"># 对于 BC，使用默认的 SHARDING_PRIORITIES</span>
            <span class="n">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">图设置</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">应用分片</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_数据集</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">世界大小</font></font></font></span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_排名</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">数据集获取器</font></font></font></span> <span class="o">=</span> <span class="n">_DatasetKind</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">创建获取器</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">数据集类型</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_数据集</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_自动合并</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collate_fn</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drop_last</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_next_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">索引</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_index</span><span class="p">()</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 可能引发 StopIteration 异常</span>
        <span class="n">数据</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_dataset_fetcher
数据集获取器</font></font></font></span><span class="o">.</span><span class="n">获取</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span><span class="p">)</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 可能引发 StopIteration 异常</span>
        <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory</span><span class="p">:</span>
            <span class="n">数据</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久化内存</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久化内存</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_device</span><span class="p">)</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span>


<span class="k">类</font></font></font></span> <span class="nc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_多进程数据加载迭代器</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_基础数据加载迭代器</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">"""遍历一次 DataLoader 的数据集，由采样器指定。"""</span>

    <span class="c1"># 数据加载器多进程关闭逻辑</span>
    <span class="c1">#</span>
    <span class="c1"># 初步：</span>
    <span class="c1">#</span>
    <span class="c1"># 我们的数据模型如下（队列用花括号表示）：</span>
    <span class="c1">#</span>
    <span class="c1">#                主进程                              ||</span>
    <span class="c1">#                     |                                    ||</span>
    <span class="c1">#               {index_queue}                              ||</span>
    <span class="c1">#                     |                                    ||</span>
    <span class="c1">#              worker processes                            ||     DATA</span>
    <span class="c1">#                     |                                    ||</span>
    <span class="c1">#            {worker_result_queue}                         ||     FLOW</span>
    <span class="c1">#                     |                                    ||</span>
    <span class="c1">#      pin_memory_thread of main process                   ||   DIRECTION</span>
    <span class="c1">#                     |                                    ||</span>
    <span class="c1">#               {数据队列}                               ||</span>
    <span class="c1">#                     |                                    ||</span>
    <span class="c1">#                数据输出                               \/</span>
    <span class="c1">#</span>
    <span class="c1"># P.S. 如果 `worker_result_queue` 和 `pin_memory_thread` 部分可以省略，则</span>
    <span class="c1">#      `pin_memory=False`。</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># 终止多进程逻辑需要非常谨慎的设计。特别是，我们需要确保</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">当迭代器的最后一个引用消失或耗尽时，它将优雅地退出工作者。</span>
    <span class="c1">在这种情况下，应该优雅地退出工作者，因为主进程可能仍然需要继续运行，而我们希望进行清理。</span>
    <span class="c1">#</span>
    <span class="c1">在此情况下，工作者应该被优雅地退出，因为主进程可能仍然需要继续运行，我们希望进行清理。</span>
    <span class="c1">在这种情况下，应该优雅地退出工作者，因为主进程可能仍然需要继续运行，我们希望进行清理。</span>
    <span class="c1">#      在工作线程中执行释放 GPU 内存等操作代码。</span>
    <span class="c1">#      自然地，我们在`__del__`中实现了关闭逻辑。</span>
    <span class="c1">#      DataLoaderIterator。</span>
    <span class="c1">#</span>
    <span class="c1">#      我们将对此处的逻辑讨论推迟到以后。</span>
    <span class="c1">#</span>
    <span class="c1">2. 迭代器在加载进程和/或工作进程退出时终止</span>
    <span class="c1">进程正常退出或出现错误。</span>
    <span class="c1">#</span>
    <span class="c1">我们将所有工作者和`pin_memory_thread`设置为`daemon=True`。</span>
    <span class="c1">#</span>
    <span class="c1">您可能会问，为什么我们不能让工作进程非守护进程化，</span>
    <span class="c1">优雅地退出，使用与我们在 `__del__` 中相同的逻辑</span>
    <span class="c1">迭代器被删除了（参见上面第 1 点）？</span>
    <span class="c1">#</span>
    <span class="c1">首先，`__del__` 并不保证在调用时会被调用</span>
    <span class="c1"># 解释器退出。即使被调用，在它执行时，</span>
    <span class="c1">许多 Python 核心库资源可能已经被释放，甚至</span>
    <span class="c1">简单的事情，比如获取队列的内部锁，也可能挂起。</span>
    <span class="c1">因此，在这种情况下，我们实际上需要防止`__del__`的执行，</span>
    <span class="c1">并依赖于守护进程的自动终止。</span>
    <span class="c1">#      子代。</span>
    <span class="c1">#</span>
    <span class="c1">因此，我们注册了一个`atexit`钩子，该钩子设置了一个全局标志</span>
    <span class="c1">`#      `_utils.python_exit_status`。由于 `atexit` 钩子在</span>
    <span class="c1">注册顺序的逆序，我们保证这个标志是</span>
    <span class="c1">设置在释放我们使用的库资源之前（至少在</span>
    <span class="c1">CPython，是通过在 `atexit` 处理器中定义完成的</span>
    <span class="c1">`multiprocessing/util.py`</span>
    <span class="c1">https://github.com/python/cpython/blob/c606624af8d4cb3b4a052fb263bb983b3f87585b/Lib/multiprocessing/util.py#L320-L362</span>
    <span class="c1">当首次注册需要此机制的对象时</span>
    <span class="c1">#      创建，例如，`mp.Queue`</span>
    <span class="c1">#      https://github.com/python/cpython/blob/c606624af8d4cb3b4a052fb263bb983b3f87585b/Lib/multiprocessing/context.py#L100-L103</span>
    <span class="c1">#      https://github.com/python/cpython/blob/c606624af8d4cb3b4a052fb263bb983b3f87585b/Lib/multiprocessing/queues.py#L29</span>
    <span class="c1">#      )</span>
    <span class="c1">#</span>
    <span class="c1">#      因此在 `__del__` 中，我们检查 `_utils.python_exit_status` 是否已设置</span>
    <span class="c1">#      `None`（释放），如果为空则执行无操作。</span>
    <span class="c1">#</span>
    <span class="c1">#      然而，仅仅让库的清理代码运行也可能不好，</span>
    <span class="c1">#      因为这样的代码（例如，`multiprocessing.util._exit_function()`）</span>
    <span class="c1">#      包括为`mp.Queue`的线程加入操作，这可能会导致阻塞。</span>
    <span class="c1">因此，创建线程的主要过程被调用为</span>
    <span class="c1">#      在创建时取消加入线程。参见后续章节</span>
    <span class="c1">#      [ 3b. 将进程放入队列时不会挂起； ]</span>
    <span class="c1">#      查看更多详情。</span>
    <span class="c1">#</span>
    <span class="c1">这里是两个库清理代码可以运行的示例案例</span>
    <span class="c1">在调用 `__del__` 之前：</span>
    <span class="c1">#</span>
    <span class="c1">1. 如果我们保留对迭代器的引用，它更常</span>
    <span class="c1"># 不如尝试在 `multiprocessing` 库清理之前</span>
    <span class="c1">清除所有活跃的引用对象（https://github.com/pytorch/pytorch/issues/48666）</span>
    <span class="c1">因此阻止了我们的清理代码首先运行。</span>
    <span class="c1">#</span>
    <span class="c1">2. 当在子进程中使用 `DataLoader` 时，也会出现类似的问题。</span>
    <span class="c1">当进程结束时，它会关闭所有其守护进程子进程。</span>
    <span class="c1">#           将它们（而不是在超时前）一起退出。</span>
    <span class="c1">#           对于线程来说，情况类似，但机制不同。这个事实，</span>
    <span class="c1">#           以及多进程的一些实现细节，迫使我们让工作进程成为守护进程。所有的问题都源于当</span>
    <span class="c1">#           我们的工作进程在某个时候退出时。</span>
    <span class="c1"># 数据加载器在子进程中使用，由多进程引起</span>
    <span class="c1">#           看起来大致是这样的代码：</span>
    <span class="c1">#</span>
    <span class="c1">尝试：</span>
    <span class="c1"># 使用数据加载器调用你的函数()</span>
    <span class="c1">finally:</span>
    <span class="c1">#                   multiprocessing.util._退出函数()</span>
    <span class="c1">#</span>
    <span class="c1">上述提及的加入/终止发生在内部</span>
    <span class="c1">#           `_退出函数()`. 现在，如果 `your_function_using_a_dataloader()`</span>
    <span class="c1">抛出异常时，异常中存储的堆栈跟踪将阻止使用 `DataLoaderIter` 的帧被释放。如果该帧有任何对 `DataLoaderIter` 的引用（例如，在迭代器的方法中），则其 `__del__` 方法，它启动关闭程序，将不会执行。</span>
    <span class="c1">如果该帧有任何对 `DataLoaderIter` 的引用（例如，在迭代器的方法中），则其 `__del__` 方法，它启动关闭程序，将不会执行。</span>
    <span class="c1">如果该帧有任何对 `DataLoaderIter` 的引用（例如，在迭代器的方法中），则其 `__del__` 方法，它启动关闭程序，将不会执行。</span>
    <span class="c1">如果该帧有任何对 `DataLoaderIter` 的引用（例如，在迭代器的方法中），则其 `__del__` 方法，它启动关闭程序，将不会执行。</span>
    <span class="c1"># 被调用。这反过来意味着工人没有收到通知。尝试</span>
    <span class="c1">#           加入 `_exit_function` 将导致程序挂起。</span>
    <span class="c1">#</span>
    <span class="c1">#           为了上下文，`_exit_function` 也被注册为 `atexit` 调用。</span>
    <span class="c1">我不明白（@ssnl）为什么需要在 finally 块中这样做。</span>
    <span class="c1">这段代码可以追溯到 2008 年，原始代码中没有任何注释。</span>
    <span class="c1">PEP 371 或补丁 https://bugs.python.org/issue3050（包含 finally 块和`atexit`注册）对此进行了解释。</span>
    <span class="c1">这解释了为什么 finally 块和`atexit`注册需要同时存在。</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">最后，另一个选择是当我们在`next`中看到错误时，仅通过逻辑关闭工作者。这并不理想，因为</span>
    <span class="c1">a. 它阻止用户使用 try-catch 来恢复数据加载。</span>
    <span class="c1">b. 如果用户持有引用，则无法防止挂起。</span>
    <span class="c1">c. 它不会阻止用户在`next`中看到错误时使用 try-catch 来恢复数据加载。</span>
    <span class="c1">迭代器。</span>
    <span class="c1">#</span>
    <span class="c1">如果任何进程意外地因致命信号而死亡，则所有进程都将退出。</span>
    <span class="c1">#</span>
    <span class="c1">如上所示，工作进程被设置为父进程的守护进程子进程。</span>
    <span class="c1">然而，此类子进程的自动清理仅</span>
    <span class="c1">如果父进程优雅退出（例如，不是通过致命信号如 SIGKILL），则会出现这种情况。因此，我们必须确保每个进程都会退出，即使应该与之发送/接收数据的进程被杀掉，即，</span>
    <span class="c1">所以我们必须确保每个进程都会退出，即使应该与之发送/接收数据的进程被杀掉，即，</span>
    <span class="c1">所以我们必须确保每个进程都会退出，即使应该与之发送/接收数据的进程被杀掉，即，</span>
    <span class="c1">所以我们必须确保每个进程都会退出，即使应该与之发送/接收数据的进程被杀掉，即，</span>
    <span class="c1">#</span>
    <span class="c1">在从队列中获取时，进程不会挂起。</span>
    <span class="c1">#</span>
    <span class="c1">即使数据依赖关系设计得非常精心（即，`put()` 总是与 `get()` 相对应），当队列中的数据损坏时（例如，由于 ...），在 `get()` 上仍然可能会发生挂起。</span>
    <span class="c1">当队列中的数据损坏时（例如，由于 ...），在 `get()` 上仍然可能会发生挂起。</span>
    <span class="c1">当队列中的数据损坏时（例如，由于 ...），在 `get()` 上仍然可能会发生挂起。</span>
    <span class="c1">“取消加入线程”或意外退出。</span>
    <span class="c1">#</span>
    <span class="c1">对于子进程退出，我们每次尝试从`data_queue`获取数据时都会设置超时。</span>
    <span class="c1">并在每个超时和错误时检查工作进程的状态。</span>
    <span class="c1">出错。</span>
    <span class="c1">查看 `_DataLoaderiter._get_batch()` 和 `_DataLoaderiter._try_get_data()` 以获取详细信息。</span>
    <span class="c1">此外，对于非 Windows 平台上的子进程退出，我们还会注册一个 SIGCHLD 处理器（在 Windows 上受支持）。</span>
    <span class="c1">#</span>
    <span class="c1">另外，对于非 Windows 平台上的子进程退出，我们也会在 Windows 上注册一个 SIGCHLD 处理器。</span>
    <span class="c1">在 Windows 上注册一个 SIGCHLD 处理器。</span>
    <span class="c1">主流程，用于检查是否有任何工作进程失败，</span>
    <span class="c1">（Python）处理器。与仅使用上述机制相比，这种方法在检测工作进程失败方面更高效、更快。</span>
    <span class="c1">请参阅`DataLoader.cpp`和`_utils/signal_handling.py`以获取详细信息。</span>
    <span class="c1">请参阅`DataLoader.cpp`和`_utils/signal_handling.py`以获取详细信息。</span>
    <span class="c1">#</span>
    <span class="c1">对于不是工作者的发送者进行的 `.get()` 调用，我们用超时来保护它们，并在超时发生时检查发送者的状态：</span>
    <span class="c1">在工作者中，使用 `_utils.worker.ManagerWatchdog` 类</span>
    <span class="c1">当超时发生时：</span>
    <span class="c1">+ 在工作者中，使用 `_utils.worker.ManagerWatchdog` 类</span>
    <span class="c1">检查主进程状态。</span>
    <span class="c1">#             + 如果 `pin_memory=True`，从 `pin_memory_thread` 获取时</span>
    <span class="c1">定期检查 `pin_memory_thread` 状态</span>
    <span class="c1"># 返回或查看 `pin_memory_thread` 已死。</span>
    <span class="c1">#</span>
    <span class="c1">#        b. 将进程放入队列时不会挂起；</span>
    <span class="c1">#</span>
    <span class="c1">#           我们使用 `mp.Queue`，它有一个独立的后台线程将</span>
    <span class="c1">#           对象从无界缓冲数组中放入。后台线程是守护线程，</span>
    <span class="c1">#           通常在进程结束时自动结束。</span>
    <span class="c1">#           *退出*。</span>
    <span class="c1">#</span>
    <span class="c1">#           如果接收方在读取管道时突然结束，则连接将永远挂起。</span>
    <span class="c1">#           在 Python 中，解决这个问题通常是通过调用 `q.cancel_join_thread`。</span>
    <span class="c1">#           来实现的。</span>
    <span class="c1">这将防止在最终确定时自动将其连接</span>
    <span class="c1">（退出）。</span>
    <span class="c1">#</span>
    <span class="c1">然而，`cancel_join_thread` 只应在队列</span>
    <span class="c1">**不会**被其他进程读取或写入时调用</span>
    <span class="c1">#           处理过程，因为它可能持有锁或留下损坏的数据</span>
    <span class="c1"># 在队列中，导致其他读者/写者挂起。</span>
    <span class="c1">#</span>
    <span class="c1">因此，</span>
    <span class="c1">#             + 对于工作进程，我们只这样做（对于它们的输出）</span>
    <span class="c1">在退出前，请确保队列（例如，`worker_result_queue`）已被清空。</span>
    <span class="c1">对于`pin_memory_thread`，其输出队列`data_queue`是一个`queue.Queue`，如果队列已满，则会进行阻塞`put`操作。</span>
    <span class="c1">因此，不会出现上述问题，但结果是在</span>
    <span class="c1">因此，不会出现上述问题，但结果是在</span>
    <span class="c1">`_pin_memory_loop`，我们确实需要将`put`操作放在循环中</span>
    <span class="c1">那样不仅会在成功时跳出循环，还会在主进程停止读取时跳出，即正在关闭。</span>
    <span class="c1">对于加载进程，我们对所有进程调用`cancel_join_thread()`</span>
    <span class="c1">+ 对于加载进程，我们为所有进程调用`cancel_join_thread()`</span>
    <span class="c1">`_index_queues` 因为整个工作进程和 `pin_memory_thread` 的作用就是为了服务加载进程。如果加载进程已经正在退出，我们其实并不关心</span>
    <span class="c1">`pin_memory_thread` 是为了服务加载进程。如果加载进程已经正在退出，我们其实并不关心</span>
    <span class="c1">加载进程已经正在退出，我们其实并不关心它是否能够成功退出</span>
    <span class="c1">队列已损坏。</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">现在让我们回到 1：</span>
    <span class="c1">如何优雅地退出工作线程，当最后一个引用到</span>
    <span class="c1">迭代器已消失。</span>
    <span class="c1">#</span>
    <span class="c1">实现此目的，我们实现了以下逻辑以及设计</span>
    <span class="c1">如上所述的选择：</span>
    <span class="c1">#</span>
    <span class="c1">`workers_done_event`：</span>
    <span class="c1">在主进程和所有工作进程之间共享的 `multiprocessing.Event`</span>
    <span class="c1">#   处理进程。这用于通知工作进程迭代器正在关闭。</span>
    <span class="c1">#   关闭。设置后，它们将不再向队列发送处理过的数据，</span>
    <span class="c1">#   并且只等待最后的 `None` 才退出。</span>
    <span class="c1">#   `done_event` 并非必需。也就是说，我们只需检查 `None` 即可。</span>
    <span class="c1">从输入队列中取出，但允许我们跳过浪费资源</span>
    <span class="c1">正在关闭时处理数据。</span>
    <span class="c1">#</span>
    <span class="c1">`pin_memory_thread_done_event`: 粘性内存线程完成事件</span>
    <span class="c1">一个用于类似目的的 `threading.Event`</span>
    <span class="c1">`workers_done_event`，但它是为`pin_memory_thread`准备的。之所以需要单独的事件，是因为`pin_memory_thread`从</span>
    <span class="c1">工作进程的输出队列中读取。但是，当工作进程看到`workers_done_event`被设置时，它们只想看到最终的`None`，</span>
    <span class="c1">#   但工作进程，在看到`workers_done_event`被设置后，只想看到最终的`None`，并且是</span>
    <span class="c1">#   是因为`pin_memory_thread`需要读取工作进程的输出队列。但是，当工作进程看到`workers_done_event`被设置时，</span>
    <span class="c1">不需要刷新输出队列中的所有数据（例如，它可能调用该队列上的 `cancel_join_thread`，如果其 `IterableDataset` 迭代器偶然耗尽，这超出了主进程的控制）。因此，由于我们将在退出 `pin_memory_thread` 之前退出，所以</span>
    <span class="c1">`cancel_join_thread` 在该队列上（如果其 `IterableDataset` 迭代器偶然耗尽，这超出了主进程的控制）。因此，由于我们将在退出 `pin_memory_thread` 之前退出，所以</span>
    <span class="c1">`IterableDataset` 迭代器偶然耗尽，这超出了主进程的控制）。因此，由于我们将在退出 `pin_memory_thread` 之前退出，所以</span>
    <span class="c1">主进程的控制）。因此，由于我们将在退出 `pin_memory_thread` 之前退出，所以</span>
    <span class="c1">#   工作者（见下文），使用两个独立的事件。</span>
    <span class="c1">#</span>
    <span class="c1"># NOTE：简而言之，协议是主进程将设置这些</span>
    <span class="c1">#       `done_event`，然后相应的进程/线程接收到`None`，</span>
    <span class="c1">#       并且它们可以在收到`None`后随时退出。</span>
    <span class="c1">#</span>
    <span class="c1"># 注意：使用 `None` 作为最终信号是有效的，因为正常数据将</span>
    <span class="c1">始终是一个包含两个元素的元组，其中第一个元素是数据的索引</span>
    <span class="c1">#       转移（不同于数据集索引/键），第二个是</span>
    <span class="c1">#       数据集键或数据样本（取决于哪一部分）</span>
    <span class="c1">数据模型队列所在的位置。</span>
    <span class="c1">#</span>
    <span class="c1">[工作进程]</span>
    <span class="c1">当加载进程存活时：</span>
    <span class="c1">从 `index_queue` 获取。</span>
    <span class="c1">如果获取到其他任何内容，</span>
    <span class="c1">检查 `workers_done_event`。</span>
    <span class="c1">如果已设置，则继续到下一个迭代</span>
    <span class="c1">即，继续获取，直到看到 `None`，然后退出。</span>
    <span class="c1">否则，处理数据：</span>
    <span class="c1">如果是从`IterableDataset`中获取并迭代</span>
    <span class="c1"># 已耗尽，发送 `_IterableDatasetStopIteration`</span>
    <span class="c1">对象用于表示迭代结束。主进程，当</span>
    <span class="c1">接收此类对象时，将发送 `None` 到此</span>
    <span class="c1"># 工作者而不是使用相应的 `index_queue`</span>
    <span class="c1">#                    再也不了。</span>
    <span class="c1">如果超时，</span>
    <span class="c1">无论是否设置了`workers_done_event`（仍需要看到`None`）</span>
    <span class="c1">无论是否，都必须继续到下一个迭代。</span>
    <span class="c1">（循环外部）</span>
    <span class="c1">如果设置了`workers_done_event`（在`IterableDataset`中这可能是`False`）</span>
    <span class="c1">#     `data_queue.cancel_join_thread()`。  （一切都在这里结束：）</span>
    <span class="c1">主进程不会从中读取；</span>
    <span class="c1"># 其他工作者也将调用</span>
    <span class="c1"># 取消加入线程。</span>
    <span class="c1">#</span>
    <span class="c1"># [ 内存固定线程 ]</span>
    <span class="c1">#   # 无需检查主线程。如果此线程存活，则主加载</span>
    <span class="c1">#   # 线程必须存活，因为此线程被设置为守护线程。</span>
    <span class="c1">#   当 `pin_memory_thread_done_event` 事件未设置时：</span>
    <span class="c1">从 `worker_result_queue` 获取</span>
    <span class="c1">如果超时，继续在下一次迭代中获取。</span>
    <span class="c1">否则，处理数据。</span>
    <span class="c1">当`pin_memory_thread_done_event`未设置时：</span>
    <span class="c1">将处理过的数据放入`data_queue`（一个带有阻塞 put 的`queue.Queue`）</span>
    <span class="c1">如果超时，则继续在下一次迭代中输入。</span>
    <span class="c1">否则，中断，即继续到外部循环。</span>
    <span class="c1">#</span>
    <span class="c1">注意：我们不检查主线程的状态，因为</span>
    <span class="c1">1. 如果进程被致命信号终止，`pin_memory_thread`</span>
    <span class="c1">#              结束。</span>
    <span class="c1">#           2. 在其他情况下，无论是 __del__ 中的清理还是守护线程的自动退出都将处理它。</span>
    <span class="c1">#              这也不会忙等待，因为 `.get(timeout)` 不会</span>
    <span class="c1">#              这也不会忙等待，因为 `.get(timeout)` 不会</span>
    <span class="c1">#              繁忙等待。</span>
    <span class="c1">#</span>
    <span class="c1"># [主进程]</span>
    <span class="c1">#   在 DataLoader Iter 的 `__del__` 中</span>
    <span class="c1">#     b. 退出 `pin_memory_thread`</span>
    <span class="c1">#          i.   设置 `pin_memory_thread_done_event`。</span>
    <span class="c1">#          ii   在 `worker_result_queue` 中放入 `None`。</span>
    <span class="c1">#          iii. 等待 `pin_memory_thread` 完成。</span>
    <span class="c1">#          iv.  调用 `worker_result_queue.cancel_join_thread()`。</span>
    <span class="c1">#</span>
    <span class="c1">#     c. 退出工作进程。</span>
    <span class="c1">#          i.   设置 `workers_done_event`。</span>
    <span class="c1">#          ii.  在每个工作进程的 `index_queue` 中置为 `None`。</span>
    <span class="c1">#          iii. 等待工作进程结束。</span>
    <span class="c1">在各个工作者的 `index_queue` 上调用 `.cancel_join_thread()`。</span>
    <span class="c1">#</span>
    <span class="c1">注意：(c) 放在 (b) 之后更好，因为它可能会留下损坏</span>
    <span class="c1"># 工作结果队列中的数据，该数据由 `pin_memory_thread`</span>
    <span class="c1">从读取，在这种情况下，`pin_memory_thread`只能</span>
    <span class="c1">尽管在超时发生时会发生，这很慢，但如果是工人在不幸的时刻被信号杀死，情况也相同</span>
    <span class="c1">但是在其他情况下，我们最好让`worker_result_queue`对`pin_memory_thread`保持非损坏状态</span>
    <span class="c1">但是在其他情况下，我们最好让`worker_result_queue`对`pin_memory_thread`保持非损坏状态</span>
    <span class="c1">但是在其他情况下，我们最好让`worker_result_queue`对`pin_memory_thread`保持非损坏状态</span>
    <span class="c1">#</span>
    <span class="c1">#   如果 `pin_memory=False`，则没有 `pin_memory_thread`，并且（b）</span>
    <span class="c1">#         可以省略</span>
    <span class="c1">#</span>
    <span class="c1"># NB: `done_event`s 并不是严格必要的。例如，我们可以直接检查</span>
    <span class="c1">#     `index_queue` 中的 `None`，但这允许我们跳过浪费资源</span>
    <span class="c1">如果我们已经在关闭，则处理 `index_queue` 中已经存在的索引。</span>
    <span class="c1">。</span>

    <span class="k">def</span> <span class="fm">初始化</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</span><span class="p">):</span>
        <span class="nb">超级</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="fm"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">初始化</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_factor</span> <span class="o">=</span> <span class="n">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">预取因子</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_order</span> <span class="o">=</span> <span class="n">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">按顺序</span>

        <span class="k">断言</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">断言</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_factor</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
            <span class="n">多进程上下文</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="n">多进程上下文</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_init_fn</span> <span class="o">=</span> <span class="n">加载器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作进程初始化函数</span>

        <span class="c1"># 添加向前兼容性，以便经典 DataLoader 可以与 DataPipes 一起工作：</span>
        <span class="c1">#   额外的 worker 初始化函数将负责在 MP 和分布式中进行分片</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集</font></font></font></span><span class="p">,</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代数据处理管道</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">地图数据管道</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_init_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">偏函数</span><span class="p">(</span>
                <span class="n">_sharding_worker_init_fn</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_worker_init_fn</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_world_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">排名</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1">无法确定 multiprocessing_context 模块</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_工作结果队列</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">队列</span><span class="p">()</span>  <span class="c1"># type: ignore[var-annotated]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_工作进程 ID 集合</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">关闭</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">工人完成事件</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">活动</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index_queues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">为</font></font></font></span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">):</span>
            <span class="c1"># 没有确定性，multiprocessing_context 模块</span>
            <span class="n">索引队列</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">多进程上下文</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">队列</span><span class="p">()</span>  <span class="c1"># type: ignore[var-annotated]</span>
            <span class="c1">这里需要调用`cancel_join_thread`！</span>
            <span class="c1">请参阅上面的（2）和（3b）部分。</span>
            <span class="n">索引队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">取消加入线程</span><span class="p">()</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">多进程上下文</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">流程</span><span class="p">(</span>
                <span class="n">目标</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作循环</span><span class="p">,</span>
                <span class="n">参数</span><span class="o">=</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">数据集类型</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_数据集</span><span class="p">,</span>
                    <span class="n">索引队列</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_worker 结果队列</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_工作者完成事件</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_auto_collation</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_collate_fn</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drop_last</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_base_seed</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">工人初始化函数</span><span class="p">,</span>
                    <span class="n">i</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_持久化工作进程</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_共享种子</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">守护进程</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
            <span class="c1"># NB: Process.start() 实际上需要一些时间，因为它需要</span>
            <span class="c1">#     启动一个进程并通过管道传递参数。</span>
            <span class="c1">因此，我们只在它启动后将其添加到 self._workers 列表中，这样我们就不需要在程序死亡之前调用.join()，否则__del__尝试 join 时会得到：</span>
            <span class="c1">AssertionError: 只能 join 已启动的进程。</span>
            <span class="c1">因此，我们只在它启动后将其添加到 self._workers 列表中，这样我们就不需要在程序死亡之前调用.join()，否则__del__尝试 join 时会得到：</span>
            <span class="c1">AssertionError: 只能 join 已启动的进程。</span>
            <span class="n">w</span><span class="o">.</span><span class="n">开始</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_索引队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">追加</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引队列</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_工作者</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">追加</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_内存映射</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_内存线程完成事件</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">线程</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">活动</span><span class="p">()</span>

            <span class="c1">队列未进行类型注解</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_数据队列</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">队列</span><span class="p">()</span>  <span class="c1"># type: ignore[var-annotated]</span>
            <span class="n">当前设备</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_内存设备</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">cuda</span><span class="p">:</span>
                <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_内存设备</font></font></font></span> <span class="o">==</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">XPU</span><span class="p">:</span>
                <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n">xpu</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_内存设备</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_get_privateuse1_backend_name</span><span class="p">():</span>
                <span class="n">自定义设备模块</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="n">火炬</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_get_privateuse1_backend_name</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">自定义设备模块</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">当前设备</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_内存设备</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">:</span>
                <span class="n">当前设备</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">火炬</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加速器</span><span class="o">.</span><span class="n">current_device_index</span><span class="p">()</span>
            <span class="n">内存线程</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">线程</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">目标</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">持久化内存</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_内存循环</span><span class="p">,</span>
                <span class="n">参数</span><span class="o">=</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_工作结果队列</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_data_queue</span><span class="p">,</span>
                    <span class="n">当前设备</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_内存线程完成事件</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_内存设备</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">内存线程</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">守护进程</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
            <span class="n">针对内存线程</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">开始</span><span class="p">()</span>
            <span class="c1"># 与工作者类似（见上方注释），我们只注册</span>
            <span class="c1"># 一旦启动，就注册针对内存线程</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_thread</span> <span class="o">=</span> <span class="n">_pin_memory_thread</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_result_queue</span>  <span class="c1"># 类型：忽略[赋值]</span>

        <span class="c1">在某些罕见情况下，持久的工人（守护进程）</span>
        <span class="c1">在主进程退出之前会被终止</span>
        <span class="c1">当主进程退出时</span>
        <span class="c1">这会导致当 pin_memory_thread 尝试读取时失败</span>
        <span class="c1">工作结果队列中的损坏数据</span>
        <span class="c1">在主进程退出前正确顺序使用 atexit 关闭线程和子进程</span>
        <span class="c1">在主进程退出前正确顺序使用 atexit 关闭线程和子进程</span>
        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistent_workers</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory</span><span class="p">:</span>
            <span class="kn">导入</span> <span class="nn">atexit</span>

            <span class="k">为</font></font></font></span> <span class="n">w</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</span><span class="p">:</span>
                <span class="n">atexit</span><span class="o">.</span><span class="n">注册</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_多进程数据加载迭代器</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_清理工作进程</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

        <span class="c1"># .pid 可以仅在进程尚未启动时为 None（不是这种情况，所以忽略）</span>
        <span class="n">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信号处理</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_设置工作进程 ID</font></font></font></span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">元组</font></font></font></span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进程 ID</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">w</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工作者</font></font></font></span><span class="p">))</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 类型：忽略[杂项]</span>
        <span class="n">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信号处理</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">设置 SIGCHLD 处理程序</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">设置工作进程 ID</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">重置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">第一次迭代</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">重置</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">第一次迭代</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
        <span class="nb">超级</font></font></font></span><span class="p">()</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">重置</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加载器</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">第一次迭代</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">发送索引</font></font></font></span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 下一个要发送给工作者的任务索引</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcvd_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 下一个在 __next__ 中返回的任务索引</span>
        <span class="c1"># 尚未产生的数据信息，即索引在 [rcvd_idx, send_idx) 范围内的任务</span>
        <span class="c1"># 地图：任务索引 =&gt; - (工作者 ID,)        如果数据未获取（待处理）</span>
        <span class="c1">#                  \ (工作者 ID，数据)   如果数据已获取（顺序错误）</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_任务信息</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_待处理任务</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">0</span>  <span class="c1"># always equal to count(v for v in task_info.values() if len(v) == 1)</span>
        <span class="p">)</span>
        <span class="c1"># A list of booleans representing whether each worker still has work to</span>
        <span class="c1"># do, i.e., not having exhausted its iterable dataset object. It always</span>
        <span class="c1"># contains all `True`s if not using an iterable-style dataset</span>
        <span class="c1"># （即，如果 kind 不等于可迭代）。</span>
        <span class="c1"># 并不意味着这个工作者在这个 epoch 中还有工作要做。</span>
        <span class="c1"># 这并不意味着工作者已经死亡。在`_persistent_workers`的情况下，</span>
        <span class="c1"># 工作者将在下一个 epoch 中被重置为可用状态。</span>
        <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_workers_status
工人状态</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="kc">真实</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">)]</span>
        <span class="c1"># 每个工作者未完成的任务数量列表</span>
        <span class="c1"># 当任务分配给工作者时递增</span>
        <span class="c1">当那些数据已提供给主线程时递减</span>
        <span class="c1">每个工作线程最多应有 self._prefetch_factor 个挂起的任务</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">工人_num_tasks</font></font></font></span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
        <span class="c1">重置工作队列循环，以便在下一个 epoch 从工作器 0 开始</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_queue_idx_cycle</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">循环</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">))</span>
        <span class="c1"># 我们在启用的情况下继续预取</span>
        <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">第一次迭代</span><span class="p">:</span>
            <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index_queues</span><span class="p">[</span><span class="n">索引</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">放置</span><span class="p">(</span>
                    <span class="n">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_简历迭代</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_共享种子</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">简历迭代次数</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span>
            <span class="k">while</span> <span class="n">简历迭代次数</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">返回索引</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回数据</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_获取数据</span><span class="p">()</span>
                <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回索引</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_恢复迭代</span><span class="p">):</span>
                    <span class="k">断言</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">返回数据</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="kc">None</span>
                    <span class="n">简历迭代次数</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="c1">预先启动预取循环</span>
        <span class="k">为</font></font></font></span> <span class="n">_</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">尝试设置索引</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">尝试获取数据</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">MP 状态检查间隔</span><span class="p">):</span>
        <span class="c1">尝试在给定超时时间内从`self._data_queue`获取数据一次。</span>
        <span class="c1">这也可以用作无超时获取的内部循环。</span>
        <span class="c1">循环条件为发送者状态。</span>
        <span class="c1">#</span>
        <span class="c1">如果任何工作进程意外死亡，将引发 `RuntimeError`。此错误</span>
        <span class="c1"># 可来自 `_utils/signal_handling.py` 中的 SIGCHLD 处理程序</span>
        <span class="c1">#（仅适用于非 Windows 平台），或以下手动检查错误</span>
        <span class="c1"># 和超时。</span>
        <span class="c1">#</span>
        <span class="c1">返回一个 2 元组：</span>
        <span class="c1">（bool：是否成功获取数据，any：成功获取数据时的数据，否则为 None）</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">数据</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">)</span>
            <span class="k">返回</font></font></font></span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">)</span>
        <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">异常</font></font></font></span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">在超时和错误情况下，我们手动检查是否有任何工作进程</span>
            <span class="c1"># 失败。注意，这是 Windows 检测的唯一机制</span>
            <span class="c1"># 工作失败。</span>
            <span class="n">failed_workers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">为</font></font></font></span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">w</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">列举</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</span><span class="p">):</span>
                <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人状态</font></font></font></span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否存活</span><span class="p">():</span>
                    <span class="n">失败的工人</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">追加</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">标记工人为不可用</span><span class="p">(</span><span class="n">worker_id</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">失败的工人</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">进程 ID 字符串</font></font></font></span> <span class="o">=</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">“，”</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">加入</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">字符串</font></font></font></span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">进程 ID</font></font></font></span><span class="p">)</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">w</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">失败的工人</span><span class="p">)</span>
                <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"数据加载器工作进程（进程 ID（"</font></font></font></span><span class="si">{</span><span class="n">pids_str</span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">程序异常退出"</span>
                <span class="p">)</span> <span class="kn">来自</span> <span class="nn">e</span>
            <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">空的</span><span class="p">):</span>
                <span class="k">返回</font></font></font></span> <span class="p">(</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>

            <span class="kn">导入</span> <span class="nn">errno</span>
            <span class="kn">导入</span> <span class="nn">tempfile</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1">如果接近文件描述符限制，则抛出异常。</span>
                <span class="c1">显然，仅尝试打开一个文件是不够的</span>
                <span class="c1">测试。</span>
                <span class="c1">查看[ DataLoader 在 Linux 上和打开文件限制 ]</span>
                <span class="n">fds_limit_margin</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="p">[</span><span class="n">临时文件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">命名临时文件</font></font></font></span><span class="p">()</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">为</font></font></font></span> <span class="n">i</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="n">fds_limit_margin</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]</span>
            <span class="k">除了</font></font></font></span> <span class="ne">OSError</span> <span class="k"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">作为</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">如果</font></font></font></span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误号</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">文件描述过多</span><span class="p">:</span>
                    <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
                        <span class="s2">文件打开太多。与“的”通信</span>
                        <span class="s2">工人不再可能。请增加“”</span>
                        <span class="s2">"在 shell 中使用`ulimit -n`限制或更改"</span>
                        <span class="s2">"通过调用"</span>
                        <span class="s2">" `torch.multiprocessing.set_sharing_strategy('file_system')`"</span>
                        <span class="s2">"在代码开头"</span>
                    <span class="p">)</span> <span class="kn">来自</span> <span class="kc">None</span>
            <span class="k">提升</span>

    <span class="c1"># 注意 [Linux 上的 DataLoader 和打开文件限制]</span>
    <span class="c1">#</span>
    <span class="c1">在 Linux 系统中，当使用多进程与 DataLoader 一起使用时，我们传递数据之间</span>
    <span class="c1">通过 SHM 文件管理根进程和工作者。我们删除这些文件。</span>
    <span class="c1">文件系统一旦创建就立即加载，并通过它们保持活跃</span>
    <span class="c1">通过 AF_UNIX 套接字传递文件描述符。（参见</span>
    <span class="c1">文档/源/multiprocessing.rst 和维基百科中的'多进程技术笔记'。）</span>
    <span class="c1">（https://github.com/pytorch/pytorch/wiki）。）</span>
    <span class="c1">#</span>
    <span class="c1">这有时会导致我们超出打开文件的限制。当这种情况发生时，</span>
    <span class="c1">犯罪文件描述符是通过套接字传来的，Python 的 `socket`</span>
    <span class="c1"># 包无声地移除了文件描述符，只设置了</span>
    <span class="c1">`MSG_CTRUNC` 标志（可能有点误导，因为手册说明）</span>
    <span class="c1"># 表示由于空间不足而丢弃了一些控制数据</span>
    <span class="c1">辅助数据缓冲区）。这可能会反映 C 实现的</span>
    <span class="c1"># 阿福 UNIX 套接字。</span>
    <span class="c1">#</span>
    <span class="c1"># 这种行为可以通过下面的脚本和说明进行重现。</span>
    <span class="c1"># 请在笔记底部查看。</span>
    <span class="c1">#</span>
    <span class="c1"># 当发生这种情况时，标准的 Python `multiprocessing`（而不是）</span>
    <span class="c1"># `torch.multiprocessing`引发`RuntimeError: 收到 0 个 ancdata`项</span>
    <span class="c1">#</span>
    <span class="c1"># 有时，FD 没有被剥离，你可能会得到一个`OSError:`</span>
    <span class="c1"># 在下面的脚本和 DataLoader 中，你可能会得到一个`Too many open files`，然而</span>
    <span class="c1"># 这很罕见，并且似乎是非确定性的。</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#   #!/usr/bin/env python3</span>
    <span class="c1">#   import sys</span>
    <span class="c1">#   import socket</span>
    <span class="c1">#   import os</span>
    <span class="c1">#   导入数组</span>
    <span class="c1">#   导入 shutil 模块</span>
    <span class="c1">#   导入 socket 模块</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#   如果 sys.argv 的长度不等于 4：</span>
    <span class="c1">打印("用法: ", sys.argv[0], " tmp_dirname 迭代 (发送|接收)")</span>
    <span class="c1">sys.exit(1)</span>
    <span class="c1">#</span>
    <span class="c1">如果 __name__ == '__main__':</span>
    <span class="c1">dirname = sys.argv[1]</span>
    <span class="c1">#       sock_path = dirname + "/sock"</span>
    <span class="c1">#       iterations = int(sys.argv[2])</span>
    <span class="c1">#       def dummy_path(i):</span>
    <span class="c1">#           return dirname + "/" + str(i) + ".dummy"</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#       如果 sys.argv[3] == 'send':</span>
    <span class="c1">#           当 os.path.exists(sock_path) 为 False 时：</span>
    <span class="c1">#               空操作</span>
    <span class="c1">#           client = socket.socket(socket.AF_UNIX, socket.SOCK_DGRAM)</span>
    <span class="c1">#           客户端连接(sock_path)</span>
    <span class="c1">#           for i in range(iterations):</span>
    <span class="c1">#               fd = os.open(dummy_path(i), os.O_WRONLY | os.O_CREAT)</span>
    <span class="c1">#               ancdata = array.array('i', [fd])</span>
    <span class="c1">#               msg = bytes([i % 256])</span>
    <span class="c1">#               打印("发送 fd ", fd, " (迭代 #", i, ")")</span>
    <span class="c1">#               client.sendmsg([msg], [(socket.SOL_SOCKET, socket.SCM_RIGHTS, ancdata)])</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#       else:</span>
    <span class="c1">#           assert sys.argv[3] == 'recv'</span>
    <span class="c1">#</span>
    <span class="c1">#           如果 os.path.exists(dirname):</span>
    <span class="c1">#               抛出异常("目录存在")</span>
    <span class="c1">#</span>
    <span class="c1">#           os.mkdir(dirname)</span>
    <span class="c1">#</span>
    <span class="c1">打开套接字...</span>
    <span class="c1">#           服务器 = socket.socket(socket.AF_UNIX, socket.SOCK_DGRAM)</span>
    <span class="c1"># 服务器绑定到套接字路径</span>
    <span class="c1">#</span>
    <span class="c1">#           正在监听...</span>
    <span class="c1">#           for i in range(iterations):</span>
    <span class="c1">#               a = array.array('i')</span>
    <span class="c1">#               msg, ancdata, flags, addr = server.recvmsg(1, socket.CMSG_SPACE(a.itemsize))</span>
    <span class="c1">#               assert(len(ancdata) == 1)</span>
    <span class="c1">#               cmsg_level, cmsg_type, cmsg_data = ancdata[0]</span>
    <span class="c1">#               a.frombytes(cmsg_data)</span>
    <span class="c1">#               打印("收到 fd ", a[0], " (迭代 #", i, ")")</span>
    <span class="c1">#</span>
    <span class="c1">#           删除目录(dirname)</span>
    <span class="c1">#</span>
    <span class="c1"># 步骤重现：</span>
    <span class="c1">#</span>
    <span class="c1"># 1. 运行两个 shell，并在接收端设置文件描述符限制：</span>
    <span class="c1"># (shell1) ulimit -n 1020</span>
    <span class="c1"># (shell2) ulimit -n 1022</span>
    <span class="c1">#</span>
    <span class="c1"># 2. 在第一个 shell 中运行上面的脚本，使用`recv`选项</span>
    <span class="c1"># (shell1) ./test_socket.py sock_tmp 1017 recv</span>
    <span class="c1">#</span>
    <span class="c1"># 3. 在第二个 shell 中运行脚本，使用`send`选项</span>
    <span class="c1"># (shell2) ./test_socket.py sock_tmp 1017 send</span>

    <span class="k">def</span> <span class="nf">获取数据</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 从 `self._data_queue` 中获取数据。</span>
        <span class="c1">#</span>
        <span class="c1"># 我们每 `MP_STATUS_CHECK_INTERVAL` 秒检查一次工作者的状态，</span>
        <span class="c1"># 通过运行 `self._try_get_data(timeout=MP_STATUS_CHECK_INTERVAL)` 实现。</span>
        <span class="c1">在循环中。这是检测工作失败的唯一机制。</span>
        <span class="c1">对于 Windows。对于其他平台，也使用 SIGCHLD 处理程序来检测工作失败。</span>
        <span class="c1">工作失败检测。</span>
        <span class="c1">#</span>
        <span class="c1">如果`pin_memory=True`，我们还需要检查`pin_memory_thread`是否已</span>
        <span class="c1"># 在超时中死亡。</span>
        <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_超时</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">成功</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">尝试获取数据</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">成功</span><span class="p">:</span>
                <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">DataLoader 超时后</font></font></font></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span><span class="si">}</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">秒</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_内存映射</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_thread</span><span class="o">.</span><span class="n">是否存活</span><span class="p">():</span>
                <span class="n">成功</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_get_data</span><span class="p">()</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">成功</span><span class="p">:</span>
                    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="c1"># 当 while 条件为假时，即 pin_memory_thread 已死亡。</span>
                <span class="k">提升</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">运行时错误</font></font></font></span><span class="p">(</span><span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">"Pin 内存线程意外退出"</span><span class="p">)</span>
            <span class="c1">在此情况下，`self._data_queue` 是一个 `queue.Queue`，但我们不需要调用 `.task_done()`，因为我们没有使用 `.join()`。</span>
            <span class="c1">不需要调用 `.task_done()`，因为我们没有使用 `.join()`。</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">成功</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_get_data</span><span class="p">()</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">成功</span><span class="p">:</span>
                    <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span>

    <span class="k">def</span> <span class="nf">_next_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1">如果负责 `self._rcvd_idx` 的工作线程已经结束</span>
            <span class="c1">由于耗尽了一个 `IterableDataset`，无法完成此任务，</span>
            <span class="c1">我们尝试将 `self._rcvd_idx` 前进以找到下一个有效的索引。</span>
            <span class="c1">#</span>
            <span class="c1">这部分需要在循环中运行，因为 `self._get_data()` 调用和下面的 `_IterableDatasetStopIteration` 检查都可以标记</span>
            <span class="c1">这一部分需要在循环中运行，因为 `self._get_data()` 调用和下面的 `_IterableDatasetStopIteration` 检查都可以标记</span>
            <span class="c1">多余的工人已死亡。</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">接收索引</font></font></font></span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送索引</span><span class="p">:</span>
                <span class="n">信息</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任务信息</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收索引</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>
                <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">:</span>
                    <span class="n">工作者 ID</font></font></font></span> <span class="o">=</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">如果</span> <span class="p">(</span>
                        <span class="nb">长度</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信息</font></font></font></span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_workers 状态</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span>
                    <span class="p">):</span>  <span class="c1"># 有数据或仍在活动状态</span>
                        <span class="k">断开</span>
                    <span class="k">删除</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_任务信息</font></font></font></span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_接收索引</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcvd_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="c1"># 未找到有效的 `self._接收索引`（即未中断）</span>
                <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_持久化工作进程</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_关闭工作者</span><span class="p">()</span>
                <span class="k">提升</span> <span class="ne">StopIteration</span>

            <span class="c1">现在 self._rcvd_idx 是我们要获取的批次索引</span>

            <span class="c1">检查下一个样本是否已经被生成</span>
            <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任务信息</font></font></font></span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_接收索引</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">worker_id</span><span class="p">,</span> <span class="n">数据</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_任务信息</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">弹出</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_接收索引</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcvd_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_处理数据</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">)</span>

            <span class="k">断言</font></font></font></span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">和</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_待办任务</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">索引</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">获取数据</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">未完成任务</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据集类型</font></font></font></span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_数据集类型</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">迭代器</span><span class="p">:</span>
                <span class="c1">检查 IterableDatasetStopIteration</span>
                <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_可迭代数据集停止迭代</span><span class="p">):</span>
                    <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_持久化工作进程</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_工作者状态</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</font></font></font></span><span class="o">.</span><span class="n">worker_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
                    <span class="k">否则</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_标记工作者为不可用</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_尝试放入索引</span><span class="p">()</span>
                    <span class="k">继续</span>

            <span class="k">如果</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">接收索引</span><span class="p">:</span>
                <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">按顺序</span><span class="p">:</span>
                    <span class="c1">不要存储以备后用，立即处理</span>
                    <span class="c1">立即从 self._task_info 中删除</span>
                    <span class="c1"># 保持对象大小可控</span>
                    <span class="n">员工 ID</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任务信息</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">弹出</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">处理数据</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">)</span>
                <span class="c1"># 存储乱序样本</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_任务信息</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,)</span>
            <span class="k">否则</span><span class="p">:</span>
                <span class="n">工作器 ID</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">任务信息</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">弹出</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">)</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rcvd_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">返回</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">处理数据</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">尝试设置索引</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">最大任务</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span>
        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">待处理任务</font></font></font></span> <span class="o">&lt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大任务数</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">索引</font></font></font></span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">下一个索引</span><span class="p">()</span>
        <span class="k">除了</font></font></font></span> <span class="ne"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">StopIteration 异常</span><span class="p">:</span>
            <span class="k">返回</span>
        <span class="k">为</font></font></font></span> <span class="n">_</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_num_workers</span><span class="p">):</span>  <span class="c1"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  "># 查找下一个活跃的工作者（如果有）</span>
            <span class="n">工作队列索引</font></font></font></span> <span class="o">=</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">下一</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作队列索引循环</span><span class="p">)</span>
            <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人状态</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作队列索引</font></font></font></span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]：</span>
                <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_按顺序</span><span class="p">:</span>
                    <span class="k">断开</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_工作者任务数</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作队列索引</font></font></font></span><span class="p">]</span> <span class="o">&lt;</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">最大任务数</font></font></font></span> <span class="o">//</span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">总和</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">工作者状态</span>
                <span class="p">):</span>
                    <span class="c1">当 self._in_order 为 False 时，如果工作者有容量，则分配工作给工作者</span>
                    <span class="c1">_workers_status 只在此线程中更新，因此总和保证大于 0</span>
                    <span class="k">断开</span>
        <span class="k">否则</span><span class="p">:</span>
            <span class="c1">未找到（即未中断）</span>
            <span class="k">返回</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_index_queues</span><span class="p">[</span><span class="n">工作队列索引</font></font></font></span><span class="p">]</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">放置</font></font></font></span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送索引</font></font></font></span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">索引</span><span class="p">))</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">任务信息</font></font></font></span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">发送索引</font></font></font></span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作队列索引</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">工作者任务数</font></font></font></span><span class="p">[</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工作队列索引</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">未完成任务数</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">发送索引</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">处理数据</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,</span> <span class="n">worker_idx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_workers_num_tasks</span><span class="p">[</span><span class="n">worker_idx</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">尝试设置索引</span><span class="p">()</span>
        <span class="k">如果</font></font></font></span> <span class="nb">isinstance</span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span><span class="p">,</span> <span class="n">ExceptionWrapper</span><span class="p">):</span>
            <span class="n">数据</span><span class="o">.</span><span class="n">reraise</span><span class="p">()</span>
        <span class="k">返回</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">数据</span>

    <span class="k">def</span> <span class="nf">标记工人为不可用</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</font></font></font></span><span class="o">=</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">错误</span><span class="p">):</span>
        <span class="c1">标记一个工作进程已完成其工作，例如，由于耗尽一个 `IterableDataset`。</span>
        <span class="c1">这应在 `_MultiProcessingDataLoaderIter` 继续运行时使用。</span>
        <span class="c1"># `_MultiProcessingDataLoaderIter` 即将运行。</span>

        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人状态</font></font></font></span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_persistent_workers</span> <span class="ow">和</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</span>
        <span class="p">)</span>

        <span class="c1"># 向特定工作者发送终止信号。</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_queues</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span>
        <span class="c1"># 表示当前进程不再向该队列添加更多数据。</span>
        <span class="c1"># 结束。</span>
        <span class="n">q</span><span class="o">.</span><span class="n">放置</font></font></font></span><span class="p">(</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">)</span>

        <span class="c1">注意这里我们并没有在这里连接工作线程，也没有从 C 侧结构中移除工作线程的进程 ID，因为（1）连接可能很慢，并且</span>
        <span class="c1"># （2）由于我们不连接，工作线程可能仍然会引发错误，而我们更愿意捕获这些错误，而不是忽略它们，即使它们</span>
        <span class="c1"># （3）可能不会立即影响主线程的执行</span>
        <span class="c1"># ，我们仍然希望记录这些错误，以便于后续分析</span>
        <span class="c1">在工人完成其工作后引发。</span>
        <span class="c1">将连接推迟到 `_shutdown_workers`，它在调用时执行</span>
        <span class="c1">所有工作者完成他们的工作（例如，`IterableDataset`副本）</span>
        <span class="c1">当这个迭代器被垃圾回收时。</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">工人状态</font></font></font></span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>

        <span class="k">断言</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工作者完成事件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">已设置</font></font></font></span><span class="p">()</span> <span class="o">==</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</span>

    <span class="k">def</span> <span class="nf">_关闭工作者</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 当关闭此 `_MultiProcessingDataLoaderIter` 时调用。</span>
        <span class="c1"># 详细请参阅 NOTE [数据加载器多进程关闭逻辑]。</span>
        <span class="c1"># 该函数的逻辑请参阅。</span>
        <span class="k">如果</span> <span class="p">(</span>
            <span class="n">_utils</span> <span class="ow">是</span> <span class="kc">None</span>
            <span class="ow">或</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">python 退出状态</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</font></font></font></span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
            <span class="ow">或</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">python 退出状态</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="c1"># 参考第（2）条注释。如果 Python 正在关闭，则执行无操作。</span>
            <span class="k">返回</span>
        <span class="c1"># 当最后一个引用消失/迭代器耗尽时正常退出。</span>
        <span class="c1"># 查看（1）和笔记的第二部分。</span>
        <span class="k">如果</font></font></font></span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">关闭</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">真实</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 当最后一个引用消失/迭代器耗尽时正常退出。</span>
                <span class="c1"># 查看（1）和笔记的第二部分。</span>

                <span class="c1">首先退出 `pin_memory_thread`，因为退出工作进程可能会在 `worker_result_queue` 中留下</span>
                <span class="c1">被损坏的数据，而 `pin_memory_thread` 会从中读取。</span>
                <span class="c1">。</span>
                <span class="k">如果</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">有属性</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_pin_memory_thread</span><span class="p">):</span>
                    <span class="c1"># 使用 hasattr 以防在设置属性之前发生错误。</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_内存线程完成事件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</span><span class="p">()</span>
                    <span class="c1"># 如果 pin_memory_thread 正在等待，则发送信息给它。</span>
                    <span class="c1"># 这样它可以醒来并检查 `pin_memory_thread_done_event`。</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_工作结果队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">放置</font></font></font></span><span class="p">((</span><span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</font></font></font></span><span class="p">,</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">无</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pin_memory_thread</span><span class="o">.</span><span class="n">加入</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_工作结果队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">取消加入线程</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_工作结果队列</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</span><span class="p">()</span>

                <span class="c1">立即退出工作者。</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_工作者完成事件</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">集合</span><span class="p">()</span>
                <span class="k">为</font></font></font></span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">员工 ID</font></font></font></span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">范围</font></font></font></span><span class="p">(</span><span class="nb"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">长度</font></font></font></span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</span><span class="p">)):</span>
                    <span class="c1">应从 `len(self._workers)` 获取工作者数量，而不是从 `self._num_workers`，以防在启动所有工作者之前发生错误。</span>
                    <span class="c1">`self._num_workers`，以防在启动所有工作者之前发生错误。</span>
                    <span class="c1"># workers.</span>
                    <span class="c1">如果我们使用带有持久工作者的 workers_status</span>
                    <span class="c1">我们必须将其关闭，因为工作器已暂停</span>
                    <span class="k">如果</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n">_persistent_workers</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">或</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人状态</font></font></font></span><span class="p">[</span><span class="n">worker_id</span><span class="p"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">]：</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">标记工人为不可用</font></font></font></span><span class="p">(</span><span class="n">worker_id</span><span class="p">,</span> <span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">关闭</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">为</font></font></font></span> <span class="n">w</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</span><span class="p">:</span>
                    <span class="c1">我们应该能够在这里连接，但如果出了问题，</span>
                    <span class="c1">我们设置了一个超时，如果工作者未能连接，</span>
                    <span class="c1">它们将在`finally`块中被杀死。</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">加入</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">MP 状态检查间隔</span><span class="p">)</span>
                <span class="k">为</font></font></font></span> <span class="n">q</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_queues</span><span class="p">:</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">取消加入线程</span><span class="p">()</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">关闭</span><span class="p">()</span>
            <span class="k">最后</span><span class="p">:</span>
                <span class="c1">即使这个函数所做的只是将任务放入队列，</span>
                <span class="c1">即使我们在其上调用`cancel_join_thread`，当工作进程被信号杀死时，</span>
                <span class="c1">例如，在`Event.set()`中挂起时，也可能发生奇怪的事情。</span>
                <span class="c1">因此，我们需要用 SIGCHLD 处理程序来保护这一点。</span>
                <span class="c1">仅从 C 侧数据结构中删除 pids</span>
                <span class="c1">结束。</span>
                <span class="c1">#</span>
                <span class="c1"># FIXME: 很遗憾，对于 Windows，我们缺少一个工作进程</span>
                <span class="c1"># 此函数中包含错误检测机制，如下</span>
                <span class="c1"># 不提供 SIGCHLD 处理程序。</span>
                <span class="k">如果</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_pids_set</span><span class="p">:</span>
                    <span class="n">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">信号处理</span><span class="o">.</span><span class="n">_remove_worker_pids</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_工作进程 ID 集合</font></font></font></span> <span class="o">=</span> <span class="kc"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">假</span>
                <span class="k">为</font></font></font></span> <span class="n">w</span> <span class="ow"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">在</font></font></font></span> <span class="bp">self</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">工人</span><span class="p">:</span>
                    <span class="k">如果</font></font></font></span> <span class="n">w</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否存活</span><span class="p">():</span>
                        <span class="c1"># 现有的机制试图让工作进程退出</span>
                        <span class="c1">平静地，但不幸的是，如果我们不幸达到</span>
                        <span class="c1">这里，我们不应该到达的（例如，pytorch/pytorch#39570），</span>
                        <span class="c1">我们会杀死这个工作进程。</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">终止</span><span class="p">()</span>

    <span class="c1">静态方法用于移除对 `_MultiProcessingDataLoaderIter` 的引用</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">清理工作线程</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">加入</font></font></font></span><span class="p">(</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">超时</font></font></font></span><span class="o">=</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">_工具</font></font></font></span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">MP 状态检查间隔</span><span class="p">)</span>
        <span class="k">最后</span><span class="p">:</span>
            <span class="k">如果</font></font></font></span> <span class="n">w</span><span class="o">.</span><span class="n"><font class=" " lang="zh-CN"><br hidden=""><font class="   "><font class="  ">是否存活</span><span class="p">():</span>
                <span class="n">w</span><span class="o">.</span><span class="n">终止</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">关闭工作线程</span><span class="p">()</span>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>© 版权所有 PyTorch 贡献者。</p>
  </div>
    
      <div>使用 Sphinx 构建，并使用 Read the Docs 提供的主题。</div>
     

</footer>

          </div>
<script>

var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
</script>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/jquery.js"></script>
         <script src="../../../../_static/underscore.js"></script>
         <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/clipboard.min.js"></script>
         <script src="../../../../_static/copybutton.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script script="" type="text/javascript">
  var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
</script>

<img height="1" width="1" style="border-style:none;" alt="" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0">


  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>文档</h2>
          <p>查看 PyTorch 的全面开发者文档</p>
          <a class="with-right-arrow" href="https://maskerprc.github.io/docs/stable/index.html">查看文档</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>教程</h2>
          <p>深入了解初学者和高级开发者的教程</p>
          <a class="with-right-arrow" href="https://maskerprc.github.io/tutorials">查看教程</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>资源</h2>
          <p>查找开发资源，获取您的疑问解答</p>
          <a class="with-right-arrow" href="https://maskerprc.github.io/resources">查看资源</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://maskerprc.github.io/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://maskerprc.github.io/">PyTorch</a></li>
            <li><a href="https://maskerprc.github.io/get-started">开始使用</a></li>
            <li><a href="https://maskerprc.github.io/features">功能</a></li>
            <li><a href="https://maskerprc.github.io/ecosystem">生态系统</a></li>
            <li><a href="https://maskerprc.github.io/blog/">博客</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">贡献</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://maskerprc.github.io/resources">资源</a></li>
            <li><a href="https://maskerprc.github.io/tutorials">教程</a></li>
            <li><a href="https://maskerprc.github.io/docs/stable/index.html">文档</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">讨论</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github 问题</a></li>
            <li><a href="https://maskerprc.github.io/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">品牌指南</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">保持更新</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">推特</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">领英</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch 播客</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">苹果</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">谷歌</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">亚马逊</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">条款</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">隐私</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© 版权所有 Linux 基金会。PyTorch 基金会是 Linux 基金会的一个项目。有关 PyTorch 基金会的网站使用条款、商标政策以及其他适用政策，请参阅 www.linuxfoundation.org/policies/。PyTorch 基金会支持 PyTorch 开源项目，该项目已被确立为 LF Projects, LLC 的 PyTorch 项目系列。有关适用于 PyTorch 项目系列 LF Projects, LLC 的政策，请参阅 www.lfprojects.org/policies/。</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">为了分析流量并优化您的体验，我们在本网站上使用 cookies。通过点击或导航，您同意允许我们使用 cookies。作为本网站的当前维护者，适用 Facebook 的 Cookies 政策。了解更多信息，包括关于可用控制的信息：Cookies 政策。</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg" width="16" height="16">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://maskerprc.github.io/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
           <li class="resources-mobile-menu-title">
             <a>学习</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://maskerprc.github.io/get-started">开始使用</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials">教程</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials/beginner/basics/intro.html">学习基础知识</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials/recipes/recipes_index.html">PyTorch 食谱</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/tutorials/beginner/introyt.html">PyTorch 入门 - YouTube 系列</a>
             </li>
           </ul>
           <li class="resources-mobile-menu-title">
             <a>生态系统</a>
           </li>
           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://maskerprc.github.io/ecosystem">工具</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/#community-module">社区</a>
             </li>
             <li>
               <a href="https://discuss.pytorch.org/">论坛</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/resources">开发者资源</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/ecosystem/contributor-awards-2023">贡献者奖项 - 2024</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>边缘</a>
           </li>

           <ul class="resources-mobile-menu-items">
             <li>
               <a href="https://maskerprc.github.io/edge">关于 PyTorch Edge</a>
             </li>
             
             <li>
               <a href="https://maskerprc.github.io/executorch-overview">ExecuTorch</a>
             </li>
             <li>
               <a href="https://maskerprc.github.io/executorch/stable/index.html">ExecuTorch 文档</a>
             </li>
           </ul>

           <li class="resources-mobile-menu-title">
             <a>文档</a>
           </li>

           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://maskerprc.github.io/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://maskerprc.github.io/pytorch-domains">PyTorch 领域</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            <a>博客 &amp; 新闻</a>
          </li>
            
           <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://maskerprc.github.io/blog/">PyTorch 博客</a>
            </li>
            <li>
              <a href="https://maskerprc.github.io/community-blog">社区博客</a>
            </li>

            <li>
              <a href="https://maskerprc.github.io/videos">视频</a>
            </li>

            <li>
              <a href="https://maskerprc.github.io/community-stories">社区故事</a>
            </li>
            <li>
              <a href="https://maskerprc.github.io/events">活动</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/newsletter">通讯</a>
             </li>
          </ul>
          
          <li class="resources-mobile-menu-title">
            <a>关于</a>
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://maskerprc.github.io/foundation">PyTorch 基金会</a>
            </li>
            <li>
              <a href="https://maskerprc.github.io/governing-board">管理委员会</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/credits">云信用计划</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/tac">技术咨询委员会</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/staff">员工</a>
            </li>
            <li>
               <a href="https://maskerprc.github.io/contact-us">联系我们</a>
            </li>
          </ul>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>

</body></html>